<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="KSS Coach">
<link rel="apple-touch-icon" href="kss_coach_192.png">
<link rel="icon" type="image/png" href="kss_coach_192.png">
<link rel="manifest" href="manifest.json">
<title>KSS Coach</title>
<style>
:root {
  --bg-primary: #0a0f1a;
  --bg-card: #111827;
  --bg-input: #0d1321;
  --border: #1e2a3a;
  --border-focus: #0ea5e9;
  --text-primary: #e8ecf1;
  --text-secondary: #7a8599;
  --text-muted: #4a556b;
  --accent: #0ea5e9;
  --accent-glow: rgba(14,165,233,.15);
  --green: #22c55e;
  --green-bg: rgba(34,197,94,.12);
  --yellow: #eab308;
  --yellow-bg: rgba(234,179,8,.12);
  --red: #ef4444;
  --red-bg: rgba(239,68,68,.12);
  --orange: #f97316;
  --radius: 10px;
  --radius-sm: 6px;
  --nav-h: 64px;
  --safe-b: env(safe-area-inset-bottom, 0px);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html{overscroll-behavior:none;height:100%}
body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','Segoe UI',sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100%;padding-bottom:calc(var(--nav-h) + var(--safe-b) + 8px);overscroll-behavior:none;-webkit-user-select:none;user-select:none;font-size:15px;line-height:1.5}
input,textarea,select,button{font-family:inherit;-webkit-user-select:text;user-select:text}
button{cursor:pointer;border:none;background:none;color:inherit}

/* === VIEWS === */
.view{display:none;padding:16px 16px 24px;animation:fadeIn .2s ease}
.view.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

/* === NAV === */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;height:calc(var(--nav-h) + var(--safe-b));padding-bottom:var(--safe-b);background:var(--bg-card);border-top:1px solid var(--border);display:flex;z-index:100}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;font-size:10px;color:var(--text-muted);font-weight:600;letter-spacing:.03em;transition:color .15s}
.nav-btn.active{color:var(--accent)}
.nav-btn.disabled{opacity:.3;pointer-events:none}
.nav-btn svg{width:24px;height:24px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round}

/* === CARDS === */
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px}
.card-header{font-size:13px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.06em;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.card-header svg{width:16px;height:16px}

/* === FORMS === */
.field{margin-bottom:16px}
.field-label{display:block;font-size:12px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px}
.field-input{width:100%;padding:12px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-size:15px;transition:border-color .15s}
.field-input:focus{outline:none;border-color:var(--border-focus)}
select.field-input{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%237a8599'%3E%3Cpath d='M2 4l4 4 4-4'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}

/* === BUTTONS === */
.btn{padding:14px 24px;border-radius:var(--radius-sm);font-size:15px;font-weight:700;text-align:center;transition:all .15s;width:100%;display:block}
.btn-accent{background:var(--accent);color:#fff}
.btn-accent:active{transform:scale(.98);opacity:.9}
.btn-outline{border:1px solid var(--border);color:var(--text-secondary)}
.btn-danger{background:var(--red);color:#fff}
.btn-sm{padding:10px 16px;font-size:13px}

/* === SEGMENT CONTROL === */
.seg-row{display:flex;gap:6px;margin-bottom:16px}
.seg-btn{flex:1;padding:10px 4px;border-radius:var(--radius-sm);border:1px solid var(--border);font-size:13px;font-weight:700;text-align:center;transition:all .15s;color:var(--text-secondary)}
.seg-btn.selected{border-color:var(--accent);color:var(--accent);background:var(--accent-glow)}
.disc-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:16px}
.disc-btn{display:flex;flex-direction:column;align-items:center;gap:4px;padding:10px 4px;border-radius:var(--radius-sm);border:1px solid var(--border);font-size:11px;font-weight:700;text-align:center;transition:all .15s;color:var(--text-secondary);background:transparent}
.disc-btn .disc-icon{font-size:20px;line-height:1}
.disc-btn .disc-label{font-size:10px;font-weight:600;line-height:1.2}
.disc-icon-img{width:32px;height:32px;object-fit:contain}
.disc-btn.selected{border-color:var(--accent);color:var(--accent);background:var(--accent-glow)}
.disc-badge{display:inline-flex;align-items:center;gap:3px;font-size:10px;font-weight:700;padding:2px 6px;border-radius:4px;line-height:1.3}
.disc-badge img{width:14px;height:14px;object-fit:contain;vertical-align:middle}

/* === SEMAPHORE (Crowd) === */
.sem-row{display:flex;gap:8px}
.sem-btn{flex:1;padding:12px 4px;border-radius:var(--radius-sm);border:2px solid var(--border);font-size:22px;text-align:center;transition:all .15s}
.sem-btn.selected{transform:scale(1.05)}
.sem-btn[data-v="empty"].selected{border-color:var(--green);background:var(--green-bg)}
.sem-btn[data-v="medium"].selected{border-color:var(--yellow);background:var(--yellow-bg)}
.sem-btn[data-v="crowded"].selected{border-color:var(--red);background:var(--red-bg)}

/* === STAR RATING === */
.stars{display:flex;gap:4px}
.star{font-size:28px;color:var(--text-muted);cursor:pointer;transition:color .1s;line-height:1}
.star.active{color:var(--yellow)}

/* === ATHLETE CHIPS === */
.athlete-grid{display:flex;flex-wrap:wrap;gap:8px}
.athlete-chip{padding:10px 16px;border-radius:20px;border:1.5px solid var(--border);font-size:14px;font-weight:600;transition:all .15s;display:flex;align-items:center;gap:6px}
.athlete-chip.selected{border-color:var(--green);background:var(--green-bg);color:var(--green)}
.athlete-chip .avi{width:26px;height:26px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;color:#fff}

/* === TACTICAL IQ === */
.tac-header{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:var(--bg-card);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:50}
.tac-athlete-name{font-size:20px;font-weight:800;letter-spacing:-.02em}
.tac-nav-arrow{padding:8px 16px;font-size:22px;color:var(--text-secondary)}
.tac-stat-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
.tac-stat{text-align:center;padding:16px;border-radius:var(--radius);background:var(--bg-card);border:1px solid var(--border)}
.tac-stat-val{font-size:36px;font-weight:800;letter-spacing:-.03em}
.tac-stat-label{font-size:11px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.06em;font-weight:700;margin-top:2px}
.tac-catch{font-size:48px;font-weight:800;text-align:center;padding:20px;border-radius:var(--radius);margin-bottom:16px}
.tac-catch.good{color:var(--green);background:var(--green-bg);border:1px solid rgba(34,197,94,.2)}
.tac-catch.mid{color:var(--yellow);background:var(--yellow-bg);border:1px solid rgba(234,179,8,.2)}
.tac-catch.low{color:var(--red);background:var(--red-bg);border:1px solid rgba(239,68,68,.2)}
.tac-catch-label{font-size:12px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.08em;font-weight:700}

/* Big counters */
.counter-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:16px}
.counter-btn{padding:20px 8px;border-radius:var(--radius);border:2px solid var(--border);text-align:center;font-weight:800;font-size:15px;transition:all .1s;display:flex;flex-direction:column;align-items:center;gap:4px;min-height:90px;justify-content:center}
.counter-btn:active{transform:scale(.95)}
.counter-btn .cnt-icon{font-size:28px}
.counter-btn .cnt-val{font-size:28px;font-weight:800}
.counter-btn.c-paddle{border-color:var(--accent);color:var(--accent);background:rgba(14,165,233,.06)}
.counter-btn.c-catch{border-color:var(--green);color:var(--green);background:rgba(34,197,94,.06)}
.counter-btn.c-fall{border-color:var(--red);color:var(--red);background:rgba(239,68,68,.06)}

/* Eval buttons */
.eval-section{margin-bottom:14px}
.eval-label{font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px}
.eval-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
.eval-btn{padding:10px 6px;border-radius:var(--radius-sm);border:1.5px solid var(--border);font-size:12px;font-weight:700;text-align:center;transition:all .12s}
.eval-btn:active{transform:scale(.95)}
.eval-btn.sel-r{border-color:var(--red);color:var(--red);background:var(--red-bg)}
.eval-btn.sel-y{border-color:var(--yellow);color:var(--yellow);background:var(--yellow-bg)}
.eval-btn.sel-g{border-color:var(--green);color:var(--green);background:var(--green-bg)}
.eval-btn.sel-b{border-color:var(--accent);color:var(--accent);background:rgba(14,165,233,.12)}
.eval-btn.sel-a{border-color:#f97316;color:#f97316;background:rgba(249,115,22,.12)}
.eval-btn.sel-m{border-color:var(--text-secondary);color:var(--text-secondary);background:rgba(148,163,184,.12)}

/* Maneuver tags */
.tag-row{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px}
.tag-btn{padding:8px 14px;border-radius:16px;border:1.5px solid var(--border);font-size:12px;font-weight:700;transition:all .12s}
.tag-btn.selected{border-color:var(--accent);color:var(--accent);background:var(--accent-glow)}

/* Undo toast */
.undo-toast{position:fixed;bottom:calc(var(--nav-h) + var(--safe-b) + 16px);left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 20px;border-radius:20px;font-size:13px;font-weight:600;z-index:200;display:none;animation:slideUp .25s ease}
.undo-toast.show{display:flex;align-items:center;gap:12px}
.undo-toast button{color:var(--accent);font-weight:800;font-size:13px}
@keyframes slideUp{from{opacity:0;transform:translateX(-50%) translateY(12px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}

/* === OVERVIEW === */
.ov-row{display:flex;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border);gap:12px}
.ov-row:last-child{border:none}
.ov-name{flex:1;font-weight:700;font-size:15px}
.ov-stats{font-size:13px;color:var(--text-secondary);font-weight:600}
.ov-ratio{font-size:18px;font-weight:800;min-width:50px;text-align:right}
.ov-bar{width:100%;height:4px;background:var(--border);border-radius:2px;margin-top:6px}
.ov-bar-fill{height:100%;border-radius:2px;transition:width .3s}

/* === DEBRIEF === */
.db-condition{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.db-tag{padding:6px 12px;border-radius:14px;background:var(--bg-input);border:1px solid var(--border);font-size:12px;font-weight:600;color:var(--text-secondary)}
.db-athlete-card{border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:10px;background:var(--bg-card)}
.db-athlete-name{font-size:16px;font-weight:800;margin-bottom:8px}
.db-stat-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:8px}
.db-stat{text-align:center}
.db-stat-v{font-size:20px;font-weight:800}
.db-stat-l{font-size:10px;color:var(--text-secondary);text-transform:uppercase;font-weight:700}
.db-xp{font-size:13px;color:var(--accent);font-weight:700;margin-top:6px}

/* === ATHLETES LIST === */
.ath-item{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid var(--border)}
.ath-item:last-child{border:none}
.ath-avi{width:40px;height:40px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:800;color:#fff;flex-shrink:0}
.ath-info{flex:1}
.ath-name{font-weight:700;font-size:15px}
.ath-sub{font-size:12px;color:var(--text-secondary)}

/* === MODAL === */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:300;display:none;align-items:flex-end;justify-content:center}
.modal-overlay.active{display:flex}
.modal-sheet{background:var(--bg-card);border-radius:16px 16px 0 0;width:100%;max-width:500px;max-height:85vh;overflow-y:auto;padding:24px 20px calc(20px + var(--safe-b));animation:sheetUp .25s ease}
@keyframes sheetUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:36px;height:4px;background:var(--text-muted);border-radius:2px;margin:0 auto 20px}
.modal-title{font-size:18px;font-weight:800;margin-bottom:16px}

/* === TIMER === */
.session-bar{position:sticky;top:0;z-index:50;background:var(--bg-primary);padding:8px 16px;display:none;border-bottom:1px solid var(--border)}
.session-bar.active{display:flex;align-items:center;justify-content:space-between}
.sb-info{font-size:12px;color:var(--text-secondary);font-weight:600}
.sb-time{font-size:18px;font-weight:800;font-variant-numeric:tabular-nums;color:var(--accent)}

/* === UTILITIES === */
.empty-state{text-align:center;padding:40px 20px;color:var(--text-muted)}
.empty-state svg{width:48px;height:48px;margin-bottom:12px;opacity:.4}
.empty-state p{font-size:14px;margin-bottom:16px}
.mt-4{margin-top:16px}.mb-4{margin-bottom:16px}
.text-center{text-align:center}
.text-sm{font-size:13px}
.text-muted{color:var(--text-secondary)}
.flex-between{display:flex;justify-content:space-between;align-items:center}
.gap-2{gap:8px}
/* === JUDGE MODE === */
.jm-setup{padding:16px}
.jm-meta-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.jm-surfer-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
.jm-surfer-item{display:flex;flex-direction:column;gap:4px}
.jm-surfer-item label{font-size:11px;font-weight:700;padding:3px 8px;border-radius:4px}
.jm-surfer-item input{padding:8px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-size:13px}
.jm-surfer-item input:focus{outline:none;border-color:var(--border-focus)}
.jm-surfer-item select{padding:8px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-size:13px;-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center}
.jm-surfer-item select:focus{outline:none;border-color:var(--border-focus)}

.jm-timer-bar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--green);border-radius:var(--radius);margin-bottom:12px}
.jm-timer-bar.warning{background:var(--yellow)}
.jm-timer-bar.critical{background:var(--red);animation:pulse 1s infinite}
.jm-timer{font-size:36px;font-weight:800;font-variant-numeric:tabular-nums;color:#fff}
.jm-timer-btns{display:flex;gap:6px}
.jm-timer-btn{padding:8px 14px;border-radius:var(--radius-sm);font-size:12px;font-weight:700;color:#fff;border:1px solid rgba(255,255,255,.3)}

.jm-grid-wrap{overflow-x:auto;margin-bottom:12px;-webkit-overflow-scrolling:touch}
.jm-grid{border-collapse:separate;border-spacing:3px;min-width:900px}
.jm-grid th{background:#1e2a3a;color:var(--text-secondary);padding:6px 4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.04em;border-radius:4px;text-align:center;white-space:nowrap}
.jm-grid td{text-align:center;position:relative}
.jm-color-cell{font-weight:700;font-size:12px;padding:10px 6px;border-radius:6px;cursor:pointer;position:relative;white-space:nowrap;transition:transform .1s}
.jm-color-cell:active{transform:scale(.95)}
.jm-color-red{background:#991b1b;color:#fecaca;border:1px solid #7f1d1d}
.jm-color-yellow{background:#854d0e;color:#fef08a;border:1px solid #713f12}
.jm-color-black{background:#0f172a;color:#e2e8f0;border:1px solid #334155}
.jm-color-white{background:#f0f0f0;color:#0f172a;border:1px solid #d1d5db}
.jm-color-blue{background:#1e3a8a;color:#bfdbfe;border:1px solid #1e40af}

.jm-int-badge{position:absolute;bottom:2px;right:2px;font-size:8px;padding:1px 4px;border-radius:3px;font-weight:800;background:#475569;color:#cbd5e1}
.jm-int-badge.l1{background:#f59e0b;color:#fff}
.jm-int-badge.l2{background:#ef4444;color:#fff}
.jm-int-badge.l3{background:#dc2626;color:#fff}
.jm-int-badge.l4{background:#991b1b;color:#fff}
.jm-int-badge.l5{background:#7f1d1d;color:#fff}
.jm-int-badge.l6{background:#000;color:#fff;border:1px solid #ef4444}

.jm-score-input{width:46px;padding:7px 3px;font-size:13px;font-weight:700;text-align:center;border:1px solid var(--border);border-radius:4px;background:var(--bg-input);color:var(--text-primary);-webkit-user-select:text;user-select:text}
.jm-score-input:focus{outline:none;border-color:var(--border-focus);background:var(--bg-card)}
.jm-score-input:disabled{opacity:.25;cursor:not-allowed;background:#060a12}
.jm-score-input.best{background:linear-gradient(135deg,#fbbf24,#f59e0b);border-color:#d97706;color:#78350f}
.jm-score-input.locked{border-color:#475569;opacity:.85}
.jm-score-input.recent{border-color:var(--accent);box-shadow:0 0 4px rgba(14,165,233,.3)}
.jm-score-input.int-marked{border:2px solid var(--red);background:rgba(239,68,68,.1)}
.jm-tri{position:absolute;top:0;right:2px;color:var(--red);font-size:14px;pointer-events:none;display:none}

.jm-rankings{margin-bottom:12px}
.jm-rank-item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;margin-bottom:6px;border-radius:8px;font-weight:700;font-size:14px}
.jm-rank-item:nth-child(1){background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#78350f}
.jm-rank-item:nth-child(2){background:linear-gradient(135deg,#94a3b8,#cbd5e1);color:#0f172a}
.jm-rank-item:nth-child(3){background:linear-gradient(135deg,#d97706,#f59e0b);color:#78350f}
.jm-rank-item:nth-child(n+4){background:#1e2a3a;color:#cbd5e1}
.jm-rank-waves{font-size:11px;opacity:.8;font-weight:500;margin-top:2px}
.jm-rank-need{font-size:11px;font-style:italic;font-weight:700;margin-top:2px}
.jm-rank-int{font-size:11px;padding:1px 5px;border-radius:3px;background:rgba(239,68,68,.2);color:#fca5a5;margin-left:4px}
.jm-priority{display:flex;gap:6px;margin-bottom:12px}
.jm-pri-item{flex:1;text-align:center;padding:10px 4px;border-radius:8px;font-weight:700;cursor:pointer;transition:all .15s}
.jm-pri-item:nth-child(1){background:linear-gradient(135deg,#10b981,#059669);color:#fff}
.jm-pri-item:nth-child(2){background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff}
.jm-pri-item.tied{background:#475569;color:#cbd5e1}
.jm-pri-num{font-size:20px;font-weight:800}
.jm-pri-col{font-size:12px}
.jm-pri-lbl{font-size:9px;text-transform:uppercase;letter-spacing:.04em;opacity:.8}

.jm-results{margin-top:16px}
.jm-meta-collapsed{font-size:12px;color:var(--text-secondary);font-weight:600;margin-bottom:10px;display:none}
.jm-meta-collapsed.active{display:block}
.jm-setup-form.hidden{display:none}
.jm-notes-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:300;display:none;align-items:center;justify-content:center}
.jm-notes-modal.active{display:flex}
.jm-notes-box{background:var(--bg-card);border-radius:12px;padding:20px;width:90%;max-width:500px;border:1px solid var(--border)}

/* ===== PHASE 2: PLAYER CARD ===== */
.pc-header{text-align:center;padding:20px 0 16px}
.pc-avi{width:72px;height:72px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#6366f1);display:inline-flex;align-items:center;justify-content:center;font-size:26px;font-weight:800;color:#fff;margin-bottom:8px}
.pc-name{font-size:22px;font-weight:800}
.pc-sub{font-size:13px;color:var(--text-secondary);margin-top:2px}
.pc-level-tag{display:inline-block;background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;font-size:11px;font-weight:800;padding:3px 10px;border-radius:20px;margin-top:6px;letter-spacing:.04em}
.pc-xp-bar{height:6px;background:var(--bg-input);border-radius:3px;margin:8px auto 0;width:70%;overflow:hidden}
.pc-xp-fill{height:100%;background:linear-gradient(90deg,var(--accent),#6366f1);border-radius:3px;transition:width .4s}
.pc-xp-text{font-size:10px;color:var(--text-muted);margin-top:4px}

.pc-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px}
.pc-stat{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:10px 4px;text-align:center}
.pc-stat-val{font-size:20px;font-weight:800;font-variant-numeric:tabular-nums}
.pc-stat-lbl{font-size:10px;color:var(--text-secondary);margin-top:2px;text-transform:uppercase;letter-spacing:.03em}

.pc-badges{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.pc-badge{display:flex;align-items:center;gap:6px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:8px 10px;font-size:12px}
.pc-badge.earned{border-color:var(--yellow);background:rgba(245,158,11,.08)}
.pc-badge-icon{font-size:20px}
.pc-badge-info{text-align:left}
.pc-badge-name{font-weight:700;font-size:11px}
.pc-badge-desc{font-size:10px;color:var(--text-muted)}
.pc-badge.locked{opacity:.4}

.pc-chart{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:12px}
.pc-chart-title{font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px}
.pc-bar-row{display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:12px}
.pc-bar-label{width:50px;text-align:right;color:var(--text-secondary);font-size:11px;flex-shrink:0}
.pc-bar-track{flex:1;height:14px;background:var(--bg-input);border-radius:7px;overflow:hidden}
.pc-bar-fill{height:100%;border-radius:7px;min-width:2px}
.pc-bar-val{width:35px;font-weight:700;font-variant-numeric:tabular-nums;font-size:11px}

.pc-history{margin-bottom:16px}
.pc-hist-item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px}
.pc-hist-item:last-child{border-bottom:none}

/* ===== DRILL BANK ===== */
.drill-card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px}
.drill-card.assigned{border-color:var(--accent);border-width:2px}
.drill-header{display:flex;justify-content:space-between;align-items:center}
.drill-name{font-weight:700;font-size:14px}
.drill-cat{font-size:10px;color:var(--text-secondary);background:var(--bg-input);padding:2px 8px;border-radius:4px;text-transform:uppercase;letter-spacing:.04em}
.drill-desc{font-size:12px;color:var(--text-secondary);margin-top:6px;line-height:1.4}
.drill-meta{display:flex;gap:12px;margin-top:8px;font-size:11px;color:var(--text-muted)}
.drill-actions{display:flex;gap:6px;margin-top:10px}
.drill-cat-filter{display:flex;gap:6px;overflow-x:auto;padding-bottom:8px;margin-bottom:12px;-webkit-overflow-scrolling:touch}
.drill-cat-btn{padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;background:var(--bg-card);border:1px solid var(--border);color:var(--text-secondary);white-space:nowrap;cursor:pointer}
.drill-cat-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}

/* ===== PHASE 3: TECH LAB ===== */
.lab-video-wrap{position:relative;background:#000;border-radius:10px;overflow:hidden;margin-bottom:0;touch-action:none;-webkit-user-select:none;user-select:none}
.lab-video{width:100%;display:block;max-height:55vh}
.lab-canvas{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;touch-action:none}
.lab-canvas.drawing{pointer-events:auto;cursor:crosshair;touch-action:none}

/* Gesture layer - transparent overlay for touch */
.lab-gesture{position:absolute;top:0;left:0;right:0;bottom:0;z-index:5;touch-action:none;-webkit-tap-highlight-color:transparent}
.lab-gesture.disabled{pointer-events:none}
.lab-gest-indicator{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:48px;opacity:0;transition:opacity .15s;pointer-events:none;text-shadow:0 2px 12px rgba(0,0,0,.8)}
.lab-gest-indicator.show{opacity:1}
.lab-gest-skip{position:absolute;top:50%;transform:translateY(-50%);width:50%;height:80%;display:flex;align-items:center;justify-content:center;pointer-events:none;opacity:0;transition:opacity .15s}
.lab-gest-skip.show{opacity:1}
.lab-gest-skip.left{left:0;border-radius:50% 0 0 50%}
.lab-gest-skip.right{right:0;border-radius:0 50% 50% 0}
.lab-gest-skip-inner{background:rgba(255,255,255,.15);border-radius:50%;width:60px;height:60px;display:flex;align-items:center;justify-content:center;font-size:22px}
.lab-gest-scrub{position:absolute;top:40%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.8);border-radius:12px;padding:10px 20px;pointer-events:none;opacity:0;transition:opacity .12s;text-align:center}
.lab-gest-scrub.show{opacity:1}
.lab-gest-scrub-time{font-size:24px;font-weight:800;color:#fff;font-variant-numeric:tabular-nums}
.lab-gest-scrub-delta{font-size:12px;color:var(--accent);font-weight:700;margin-top:2px}
.lab-gest-speed{position:absolute;top:12px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.8);border-radius:8px;padding:6px 14px;pointer-events:none;opacity:0;transition:opacity .12s;font-size:14px;font-weight:700;color:var(--accent)}
.lab-gest-speed.show{opacity:1}

/* Controls overlay - auto-hides */
.lab-controls-wrap{transition:opacity .3s;padding:6px 0 0}
.lab-controls-wrap.hidden{opacity:0;pointer-events:none}
.lab-controls{display:flex;align-items:center;gap:8px;padding:8px 0}
.lab-ctrl-btn{width:40px;height:40px;border-radius:8px;background:var(--bg-card);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:18px;color:var(--text-primary);cursor:pointer;flex-shrink:0}
.lab-ctrl-btn.active{background:var(--accent);border-color:var(--accent);color:#fff}
.lab-ctrl-btn:active{transform:scale(.92)}
.lab-timeline{flex:1;height:6px;background:var(--bg-input);border-radius:3px;cursor:pointer;position:relative;-webkit-appearance:none;appearance:none}
.lab-timeline::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--accent);cursor:pointer}
.lab-time{font-size:12px;color:var(--text-secondary);font-variant-numeric:tabular-nums;min-width:42px;text-align:center}
.lab-tools{display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap}
.lab-tool{padding:8px 12px;border-radius:8px;background:var(--bg-card);border:1px solid var(--border);font-size:12px;font-weight:600;cursor:pointer;color:var(--text-secondary)}
.lab-tool.active{background:var(--accent);border-color:var(--accent);color:#fff}
.lab-color-dot{width:20px;height:20px;border-radius:50%;border:2px solid var(--border);cursor:pointer}
.lab-color-dot.active{border-color:#fff;box-shadow:0 0 0 2px var(--accent)}
.lab-szrow{display:flex;gap:4px;margin-bottom:10px;align-items:center;justify-content:center;flex-wrap:nowrap}
.lab-szrow .lab-ctrl-btn{font-size:11px;width:auto;padding:0 7px;height:32px}
.lab-sz-sep{width:1px;height:20px;background:var(--border);margin:0 4px;flex-shrink:0}
.lab-sz-label{font-size:10px;color:var(--text-muted);font-weight:600;flex-shrink:0}
.lab-zoom-level{font-size:11px;font-weight:700;color:var(--text-secondary);min-width:32px;text-align:center;font-variant-numeric:tabular-nums}

/* Sticker mini-bar (collapsed) */
.lab-stk-bar{display:none;align-items:center;gap:6px;padding:6px 10px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;margin-bottom:10px}
.lab-stk-bar.active{display:flex}
.lab-stk-bar-preview{width:32px;height:32px;border-radius:6px;border:1px solid var(--border);overflow:hidden;flex-shrink:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.3)}
.lab-stk-bar-preview img{max-width:100%;max-height:100%;object-fit:contain}
.lab-stk-bar-name{font-size:11px;font-weight:700;color:var(--text-primary);flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lab-stk-bar-btn{width:32px;height:32px;border-radius:6px;background:var(--bg-input);border:1px solid var(--border);color:var(--text-primary);font-size:15px;font-weight:700;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0}
.lab-stk-bar-btn:active{transform:scale(.9)}
.lab-stk-bar-btn.accent{background:var(--accent);border-color:var(--accent);color:#fff;font-size:10px;width:auto;padding:0 10px;font-weight:700}

/* Sticker full panel - modal overlay */
.lab-stk-modal{display:none;position:fixed;bottom:0;left:0;right:0;z-index:10001;background:rgba(15,23,42,.96);backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px);border-top:1px solid rgba(255,255,255,.12);padding:16px 16px calc(var(--safe-b) + 16px);border-radius:16px 16px 0 0;max-height:40vh;animation:labStkSlide .2s ease}
.lab-stk-modal.active{display:block}
@keyframes labStkSlide{from{transform:translateY(100%)}to{transform:translateY(0)}}
.lab-stk-modal-title{font-size:13px;font-weight:800;color:#fff;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center}
.lab-stk-modal-close{background:none;border:none;color:rgba(255,255,255,.5);font-size:22px;cursor:pointer;padding:4px}
.lab-stk-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(72px,1fr));gap:10px}
.lab-stk-item{display:flex;flex-direction:column;align-items:center;cursor:pointer}
.lab-stk-item-img{width:64px;height:64px;border-radius:10px;border:2px solid rgba(255,255,255,.12);padding:4px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.04);transition:all .15s}
.lab-stk-item-img:active{transform:scale(.92)}
.lab-stk-item-img.selected{border-color:var(--accent);background:rgba(99,102,241,.15)}
.lab-stk-item-img img{max-width:100%;max-height:100%;object-fit:contain;pointer-events:none}
.lab-stk-item-name{font-size:9px;color:rgba(255,255,255,.5);margin-top:3px;text-align:center}

/* Lab Fullscreen Mode */
.lab-fullscreen{position:fixed!important;top:0;left:0;right:0;bottom:0;z-index:9999;background:#000;display:flex;flex-direction:column;border-radius:0;margin:0;padding:0;padding-top:var(--safe-t);padding-bottom:var(--safe-b)}
.lab-fullscreen .lab-video-wrap{flex:1;border-radius:0;margin:0;min-height:0}
.lab-fullscreen .lab-video{max-height:none;height:100%;object-fit:contain}
.lab-fullscreen .lab-controls-wrap{background:rgba(0,0,0,.85);padding:4px 12px}
.lab-fullscreen .lab-controls{padding:6px 0}
.lab-fullscreen .lab-tools{padding:0 12px;margin-bottom:6px;background:rgba(0,0,0,.85);justify-content:center}
.lab-fullscreen .lab-tool{background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.2);color:#fff;padding:10px 14px;font-size:13px}
.lab-fullscreen .lab-tool.active{background:var(--accent);border-color:var(--accent)}
.lab-fullscreen .lab-szrow{background:rgba(0,0,0,.85);padding:4px 12px;margin-bottom:0}
.lab-fullscreen .lab-szrow .lab-ctrl-btn{background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.2);color:#fff}
.lab-fullscreen .lab-color-row{display:flex;gap:8px;padding:4px 12px;background:rgba(0,0,0,.85);align-items:center;justify-content:center}
.lab-fullscreen .lab-timeline{background:rgba(255,255,255,.15)}
.lab-fullscreen .lab-time{color:rgba(255,255,255,.7)}
.lab-fullscreen .lab-ctrl-btn{background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.2);color:#fff;width:44px;height:44px}
.lab-fullscreen .lab-stk-bar{background:rgba(0,0,0,.85);border-color:rgba(255,255,255,.15)}
.lab-fs-close{position:absolute;top:calc(var(--safe-t) + 8px);right:12px;z-index:10000;background:rgba(0,0,0,.7);border:1px solid rgba(255,255,255,.3);color:#fff;width:40px;height:40px;border-radius:50%;font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;-webkit-tap-highlight-color:transparent}
.lab-fs-close:active{transform:scale(.9)}
.lab-fs-expand{position:absolute;top:8px;right:8px;z-index:10;background:rgba(0,0,0,.6);border:none;color:#fff;width:36px;height:36px;border-radius:8px;font-size:16px;display:flex;align-items:center;justify-content:center;cursor:pointer;-webkit-tap-highlight-color:transparent}
.lab-fs-expand:active{transform:scale(.9)}

.lab-frames{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px}
.lab-frame{border-radius:8px;overflow:hidden;border:1px solid var(--border);cursor:pointer;position:relative}
.lab-frame img{width:100%;display:block;aspect-ratio:16/9;object-fit:cover}
.lab-frame-time{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.7);font-size:10px;color:#fff;padding:3px 6px;text-align:center}
.lab-compare{display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:12px}
.lab-compare img{width:100%;border-radius:8px;border:1px solid var(--border)}
.lab-clip{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:10px}
.lab-clip-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.lab-clip-name{font-weight:700;font-size:14px}
.lab-clip-meta{font-size:11px;color:var(--text-muted)}

/* Video wrapper zoom support */
.lab-video-inner{transform-origin:center center;will-change:transform;position:relative}

/* ===== BEGINNER MODE ===== */
.beg-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;position:sticky;top:0;z-index:10;background:var(--bg)}
.beg-wave-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:14px;margin:0 16px 10px}
.beg-eval-row{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.beg-eval-label{font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.05em;width:70px;flex-shrink:0}
.beg-eval-opts{display:flex;gap:5px;flex:1;flex-wrap:wrap}
.beg-eval-btn{padding:6px 10px;border-radius:8px;background:var(--bg-input);border:1px solid var(--border);font-size:11px;font-weight:600;color:var(--text-secondary);cursor:pointer;white-space:nowrap;transition:all .12s}
.beg-eval-btn:active{transform:scale(.94)}
.beg-eval-btn.selected{background:var(--accent);border-color:var(--accent);color:#fff}
.beg-eval-btn.green.selected{background:var(--green);border-color:var(--green)}
.beg-eval-btn.yellow.selected{background:#f59e0b;border-color:#f59e0b}
.beg-eval-btn.red.selected{background:var(--red);border-color:var(--red)}
.beg-summary{margin:0 16px 12px;padding:14px;background:var(--bg-card);border:1px solid var(--border);border-radius:12px}
.beg-sum-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0;font-size:13px}
.beg-sum-label{color:var(--text-secondary);font-weight:600}
.beg-sum-val{font-weight:800;color:var(--text-primary)}
.beg-wave-mini{display:flex;align-items:center;gap:8px;padding:8px;background:var(--bg-input);border-radius:8px;margin-bottom:6px;font-size:12px}
.beg-wave-num{width:24px;height:24px;border-radius:50%;background:var(--accent);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;flex-shrink:0}
.beg-wave-tags{display:flex;gap:4px;flex-wrap:wrap;flex:1}
.beg-wave-tag{padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600}
.beg-graduate-badge{text-align:center;padding:20px;margin:0 16px 12px;background:linear-gradient(135deg,#22c55e,#059669);border-radius:12px;color:#fff}
.beg-graduate-badge .icon{font-size:40px;margin-bottom:6px}

/* ===== KSS BRANDING ===== */
.kss-header{display:flex;align-items:center;gap:10px;margin-bottom:16px}
.kss-logo{width:36px;height:36px;border-radius:50%;object-fit:cover;flex-shrink:0}
.kss-logo-sm{width:28px;height:28px;border-radius:50%;object-fit:cover;flex-shrink:0}
.kss-logo-lg{width:48px;height:48px;border-radius:50%;object-fit:cover;flex-shrink:0}
.kss-title{font-size:20px;font-weight:800;color:var(--text-primary)}
.kss-subtitle{font-size:11px;color:var(--text-secondary);font-weight:600}
.kss-watermark{position:absolute;bottom:8px;left:8px;z-index:5;opacity:.35;pointer-events:none;width:40px;height:40px;border-radius:50%}
.lab-fullscreen .kss-watermark{width:52px;height:52px;bottom:12px;left:12px;opacity:.3}
.kss-global-wm{position:fixed;bottom:calc(var(--nav-h) + var(--safe-b) + 10px);right:12px;width:32px;height:32px;border-radius:50%;opacity:.08;pointer-events:none;z-index:90}
.share-btn{display:inline-flex;align-items:center;gap:6px;padding:10px 18px;border-radius:var(--radius-sm);font-size:13px;font-weight:700;color:var(--accent);border:1px solid var(--accent);background:transparent;cursor:pointer;transition:all .15s}
.share-btn:active{background:var(--accent-glow);transform:scale(.97)}
.pwa-banner{position:fixed;bottom:calc(var(--nav-h) + var(--safe-b) + 6px);left:12px;right:12px;background:linear-gradient(135deg,#0c4a6e,#0369a1);border:1px solid var(--accent);border-radius:var(--radius);padding:12px 14px;display:flex;align-items:center;gap:10px;z-index:200;box-shadow:0 8px 30px rgba(0,0,0,.5);animation:slideUp .3s ease}
@keyframes slideUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:none}}
.pwa-banner-logo{width:36px;height:36px;border-radius:50%;flex-shrink:0}
.pwa-banner-text{flex:1;font-size:13px;font-weight:600;color:#fff;line-height:1.3}
.pwa-banner-text small{font-size:11px;color:rgba(255,255,255,.7);display:block;margin-top:2px}
.pwa-banner-install{padding:8px 16px;border-radius:6px;background:#fff;color:#0369a1;font-size:12px;font-weight:800;border:none;cursor:pointer;flex-shrink:0}
.pwa-banner-close{padding:4px 8px;color:rgba(255,255,255,.6);font-size:18px;cursor:pointer;border:none;background:none;flex-shrink:0}
.kss-db-header{display:flex;flex-direction:column;align-items:center;gap:6px;margin-bottom:16px}
.kss-db-logo{width:56px;height:56px;border-radius:50%;object-fit:cover}

/* ===== BIOMETRICS ===== */
.bio-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:12px}
.bio-card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center}
.bio-val{font-size:22px;font-weight:800;font-variant-numeric:tabular-nums}
.bio-lbl{font-size:10px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.04em;margin-top:2px}
.bio-trend{display:flex;align-items:flex-end;gap:3px;height:40px;justify-content:center;margin-top:6px}
.bio-bar{width:6px;border-radius:3px;min-height:3px}

/* ===== PHASE 4: DASHBOARD ===== */
.dash-hero{text-align:center;padding:12px 0 16px}
.dash-hero-title{font-size:28px;font-weight:800;letter-spacing:-.03em}
.dash-hero-sub{font-size:13px;color:var(--text-secondary);margin-top:2px}
.dash-row{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px}
.dash-kpi{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:10px 6px;text-align:center}
.dash-kpi-val{font-size:20px;font-weight:800;font-variant-numeric:tabular-nums}
.dash-kpi-lbl{font-size:9px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.05em;margin-top:2px}
.dash-section{margin-bottom:14px}
.dash-section-title{font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.dash-feed-item{display:flex;gap:10px;align-items:flex-start;padding:10px 0;border-bottom:1px solid var(--border)}
.dash-feed-item:last-child{border-bottom:none}
.dash-feed-icon{font-size:18px;margin-top:1px}
.dash-feed-text{font-size:13px;line-height:1.4}
.dash-feed-time{font-size:11px;color:var(--text-muted)}
.dash-ath-mini{display:flex;gap:8px;overflow-x:auto;padding-bottom:6px;-webkit-overflow-scrolling:touch}
.dash-ath-chip{flex-shrink:0;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:10px 12px;text-align:center;min-width:80px;cursor:pointer}
.dash-ath-chip:active{transform:scale(.96)}
.dash-ath-avi{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#6366f1);display:inline-flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;color:#fff;margin-bottom:4px}
.dash-ath-name{font-size:11px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:70px}
.dash-ath-stat{font-size:10px;color:var(--text-muted)}

.tpl-card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:8px;cursor:pointer}
.tpl-card:active{transform:scale(.98)}
.tpl-card-name{font-weight:700;font-size:14px}
.tpl-card-meta{font-size:11px;color:var(--text-secondary);margin-top:3px}

.db-chart{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:12px}
.db-chart canvas{width:100%;height:120px}

/* ===== WORKOUT MODULE ===== */
.wo-ath-card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:10px}
.wo-ath-name{font-weight:700;font-size:14px;margin-bottom:8px}
.wo-drill-row{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px}
.wo-drill-row:last-child{border-bottom:none}
.wo-drill-name{flex:1;font-weight:600}
.wo-check{width:36px;height:36px;border-radius:8px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;flex-shrink:0;-webkit-tap-highlight-color:transparent}
.wo-check:active{transform:scale(.9)}
.wo-check.done{background:var(--green);border-color:var(--green);color:#fff}
.wo-check.fail{background:var(--red);border-color:var(--red);color:#fff}
.wo-quality{display:flex;gap:6px}
.wo-q-btn{width:36px;height:36px;border-radius:8px;border:1px solid var(--border);font-size:14px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:var(--bg-input);-webkit-tap-highlight-color:transparent}
.wo-q-btn:active{transform:scale(.9)}
.wo-q-btn.active{font-weight:800;border-width:2px}

/* ===== HISTORY & PROGRESSION ===== */
.hist-card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px;cursor:pointer;-webkit-tap-highlight-color:transparent}
.hist-card:active{background:var(--bg-input)}
.hist-spot{font-weight:800;font-size:15px}
.hist-date{font-size:12px;color:var(--text-muted)}
.hist-stats{display:flex;gap:12px;margin-top:6px;font-size:12px;color:var(--text-secondary)}
.hist-badge{display:inline-flex;align-items:center;gap:3px;background:var(--bg-input);padding:2px 8px;border-radius:6px;font-size:11px;font-weight:600}
.spark-line{position:relative;width:100%;height:100%}
.spark-line svg{width:100%;height:100%}
.sd-ath-card{border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:10px;background:var(--bg-card)}
/* Analytics Engine CSS */
.anl-card-title{font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;margin-bottom:10px}
.anl-time-btn{padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;border:1px solid var(--border);background:transparent;color:var(--text-muted);transition:all .15s}
.anl-time-btn.active{border-color:var(--accent);color:var(--accent);background:rgba(56,189,248,.08)}
.anl-bar-row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.anl-bar-label{width:70px;font-size:11px;font-weight:600;color:var(--text-secondary);text-align:right;flex-shrink:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.anl-bar-track{flex:1;height:18px;background:var(--bg-input);border-radius:4px;overflow:hidden;position:relative}
.anl-bar-fill{height:100%;border-radius:4px;transition:width .4s ease;min-width:2px}
.anl-bar-val{width:36px;font-size:11px;font-weight:700;text-align:right;flex-shrink:0}
.anl-donut{border-radius:50%;position:relative;display:flex;align-items:center;justify-content:center}
.anl-donut-center{position:absolute;width:50px;height:50px;background:var(--bg-card);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:800}
.anl-legend-item{display:flex;align-items:center;gap:6px;margin-bottom:4px}
.anl-legend-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}
.anl-cmp-row{display:flex;align-items:center;gap:6px;margin-bottom:8px}
.anl-cmp-label{width:70px;font-size:11px;font-weight:600;color:var(--text-secondary);text-align:center;flex-shrink:0}
.anl-cmp-bar{flex:1;height:20px;background:var(--bg-input);border-radius:4px;overflow:hidden;position:relative}
.anl-cmp-fill-a{position:absolute;left:0;top:0;height:100%;background:var(--accent);border-radius:4px 0 0 4px;transition:width .4s}
.anl-cmp-fill-b{position:absolute;right:0;top:0;height:100%;background:var(--green);border-radius:0 4px 4px 0;transition:width .4s}
.anl-spot-row{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)}
.anl-spot-row:last-child{border-bottom:none}
</style>
</head>
<body>

<!-- SESSION BAR (visible during active session) -->
<div class="session-bar" id="sessionBar">
  <div class="sb-info" id="sbInfo">Parguito ¬∑ 3-4ft</div>
  <div class="sb-time" id="sbTime">00:00</div>
  <div style="display:flex;gap:4px">
    <button class="btn-sm btn-outline" onclick="showView('session-hub')" style="padding:6px 10px;font-size:11px;border-radius:4px;border:1px solid var(--border)">Hub</button>
    <button class="btn-sm btn-outline" onclick="showView('overview')" style="padding:6px 10px;font-size:11px;border-radius:4px;border:1px solid var(--border)">All</button>
  </div>
</div>

<!-- ==================== HOME ==================== -->
<div class="view active" id="view-home">
  <div class="dash-hero" style="display:flex;flex-direction:column;align-items:center">
    <img class="kss-db-logo" id="homeLogoImg" alt="KSS">
    <div class="dash-hero-title">KSS Coach</div>
    <div class="dash-hero-sub" id="homeGreeting">Surf Coaching System</div>
  </div>

  <button class="btn btn-accent" onclick="startNewSession()" id="homeStartBtn" style="margin-bottom:16px;font-size:17px;padding:18px">
    ‚ö° Nueva Sesi√≥n
  </button>

  <!-- KPI Row -->
  <div class="dash-row" id="homeKPIs" style="display:none"></div>

  <!-- Analytics Quick Access -->
  <div id="homeAnalyticsBtn" style="display:none;margin-bottom:12px">
    <button onclick="showView('analytics')" style="width:100%;padding:12px 16px;border-radius:var(--radius);border:1px solid var(--border);background:linear-gradient(135deg,rgba(56,189,248,.06),rgba(139,92,246,.06));display:flex;align-items:center;gap:10px;text-align:left">
      <span style="font-size:24px">üìä</span>
      <div style="flex:1">
        <div style="font-size:13px;font-weight:700;color:var(--text-primary)">Analytics</div>
        <div style="font-size:11px;color:var(--text-secondary)">Tendencias, comparaciones y insights</div>
      </div>
      <span style="color:var(--text-muted);font-size:14px">‚Ä∫</span>
    </button>
  </div>

  <!-- Quick Athletes Strip -->
  <div class="dash-section" id="homeAthSection" style="display:none">
    <div class="dash-section-title">üë• Equipo</div>
    <div class="dash-ath-mini" id="homeAthStrip"></div>
  </div>

  <!-- Templates -->
  <div class="dash-section" id="homeTplSection" style="display:none">
    <div class="dash-section-title">üìã Templates <button class="text-sm" style="color:var(--accent);font-weight:700;margin-left:auto" onclick="showView('settings')">Gestionar</button></div>
    <div id="homeTplList"></div>
  </div>

  <!-- Needs Attention -->
  <div class="dash-section" id="homeAttentionSection" style="display:none">
    <div class="dash-section-title">‚ö†Ô∏è Necesitan Atenci√≥n</div>
    <div id="homeAttention"></div>
  </div>

  <!-- Recent Activity -->
  <div class="dash-section" id="homeFeedSection" style="display:none">
    <div class="dash-section-title" style="display:flex;justify-content:space-between;align-items:center">
      <span>üì∞ Actividad Reciente</span>
      <button style="font-size:12px;color:var(--accent);font-weight:700" onclick="showView('history')">Ver todo ‚Ä∫</button>
    </div>
    <div class="card" style="padding:10px 12px" id="homeFeed"></div>
  </div>

  <div id="homeEmpty" class="empty-state" style="margin-top:20px">
    <svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="1.5"><path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707"/></svg>
    <p>No tienes sesiones a√∫n.<br>Agrega atletas y arranca tu primera sesi√≥n.</p>
    <button class="btn btn-outline btn-sm" onclick="showView('athletes')" style="width:auto;display:inline-block">Agregar Atletas</button>
  </div>
</div>

<!-- ==================== SESSION CREATOR ==================== -->
<div class="view" id="view-session-setup">
  <div class="flex-between mb-4">
    <button class="text-sm text-muted" onclick="cancelSession()">‚Üê Cancelar</button>
    <div style="display:flex;align-items:center;gap:8px"><img class="kss-logo-sm" id="ssLogoImg" alt="KSS" style="opacity:.6"><span style="font-size:17px;font-weight:800">Nueva Sesi√≥n</span></div>
    <div style="width:60px"></div>
  </div>

  <!-- Spot -->
  <div class="field">
    <label class="field-label">üìç Spot</label>
    <select class="field-input" id="ssSpot"></select>
  </div>

  <!-- Conditions -->
  <div class="card">
    <div class="card-header">üåä Condiciones</div>
    
    <div class="field">
      <label class="field-label">Tama√±o</label>
      <div class="seg-row" id="ssSize">
        <button class="seg-btn" data-v="1" onclick="segSelect('ssSize',this)">1<br><span style="font-size:10px;font-weight:400">Flat</span></button>
        <button class="seg-btn" data-v="2" onclick="segSelect('ssSize',this)">2<br><span style="font-size:10px;font-weight:400">Small</span></button>
        <button class="seg-btn selected" data-v="3" onclick="segSelect('ssSize',this)">3<br><span style="font-size:10px;font-weight:400">Fun</span></button>
        <button class="seg-btn" data-v="4" onclick="segSelect('ssSize',this)">4<br><span style="font-size:10px;font-weight:400">Solid</span></button>
        <button class="seg-btn" data-v="5" onclick="segSelect('ssSize',this)">5<br><span style="font-size:10px;font-weight:400">Huge</span></button>
      </div>
    </div>

    <div class="field">
      <label class="field-label">Calidad</label>
      <div class="stars" id="ssQuality">
        <span class="star" onclick="starSelect('ssQuality',1)">‚òÖ</span>
        <span class="star" onclick="starSelect('ssQuality',2)">‚òÖ</span>
        <span class="star active" onclick="starSelect('ssQuality',3)">‚òÖ</span>
        <span class="star" onclick="starSelect('ssQuality',4)">‚òÖ</span>
        <span class="star" onclick="starSelect('ssQuality',5)">‚òÖ</span>
      </div>
    </div>

    <div class="field">
      <label class="field-label">Viento</label>
      <select class="field-input" id="ssWind">
        <option value="glassy">üåÖ Glassy (sin viento)</option>
        <option value="offshore">üí® Off-shore (bueno)</option>
        <option value="onshore">üå¨Ô∏è On-shore (malo)</option>
        <option value="cross">‚ÜóÔ∏è Cross-shore (lateral)</option>
      </select>
    </div>

    <div class="field" style="margin-bottom:0">
      <label class="field-label">Crowd</label>
      <div class="sem-row">
        <button class="sem-btn selected" data-v="empty" onclick="semSelect(this)">üü¢<br><span style="font-size:11px">Vac√≠o</span></button>
        <button class="sem-btn" data-v="medium" onclick="semSelect(this)">üü°<br><span style="font-size:11px">Medio</span></button>
        <button class="sem-btn" data-v="crowded" onclick="semSelect(this)">üî¥<br><span style="font-size:11px">Lleno</span></button>
      </div>
    </div>
  </div>

  <!-- Objective -->
  <div class="field">
    <label class="field-label">üéØ Objetivo de la Sesi√≥n</label>
    <input class="field-input" id="ssFocus" placeholder="Ej: T√©cnica de Bottom Turn">
  </div>

  <!-- Athletes -->
  <div class="card">
    <div class="card-header flex-between" style="margin-bottom:8px">
      <span>üë• Atletas</span>
      <button class="text-sm" style="color:var(--accent);font-weight:700" onclick="openAddAthleteModal()">+ Agregar</button>
    </div>
    <div class="athlete-grid" id="ssAthletes"></div>
    <div id="ssAthCount" style="margin-top:10px;font-size:12px;color:var(--text-secondary);font-weight:600"></div>
  </div>

  <button class="btn btn-accent" onclick="launchSession()" id="ssLaunchBtn" style="font-size:17px;padding:18px">
    üèÑ Iniciar Sesi√≥n
  </button>
</div>

<!-- ==================== SESSION HUB ==================== -->
<div class="view" id="view-session-hub">
  <div style="text-align:center;margin:16px 0 20px">
    <img class="kss-logo" id="hubLogoImg" alt="KSS" style="margin:0 auto">
    <div style="font-size:11px;font-weight:700;color:var(--green);text-transform:uppercase;letter-spacing:.08em">‚óè Sesi√≥n Activa</div>
    <div style="font-size:22px;font-weight:800;margin-top:4px" id="hubSpot">‚Äî</div>
    <div style="font-size:13px;color:var(--text-secondary);margin-top:4px" id="hubConditions">‚Äî</div>
    <div style="font-size:28px;font-weight:800;font-variant-numeric:tabular-nums;color:var(--text-primary);margin-top:8px" id="hubTimer">00:00</div>
  </div>

  <!-- Session athletes -->
  <div class="card" style="margin-bottom:12px">
    <div class="card-header" style="margin-bottom:6px">üë• Atletas en Sesi√≥n</div>
    <div id="hubAthletes" style="display:flex;flex-wrap:wrap;gap:6px"></div>
  </div>

  <!-- Objective -->
  <div id="hubFocusCard" class="card" style="margin-bottom:16px;display:none">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px">üéØ Objetivo</div>
    <div id="hubFocus" style="font-size:14px;color:var(--text-primary)"></div>
  </div>

  <!-- Mode selection -->
  <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:16px">
    <button class="btn" onclick="showView('beginner')" style="padding:16px;font-size:15px;background:linear-gradient(135deg,#06b6d4,#0891b2);text-align:left;display:flex;align-items:center;gap:14px">
      <span style="font-size:28px">üåä</span>
      <div><div style="font-weight:800">Beginner Mode</div><div style="font-size:11px;font-weight:500;opacity:.85;margin-top:1px">Evaluaci√≥n de principiantes</div></div>
    </button>
    <button class="btn" onclick="showView('tactical')" style="padding:16px;font-size:15px;background:linear-gradient(135deg,var(--green),#059669);text-align:left;display:flex;align-items:center;gap:14px">
      <span style="font-size:28px">üèÑ</span>
      <div><div style="font-weight:800">Tactical IQ</div><div style="font-size:11px;font-weight:500;opacity:.85;margin-top:1px">Olas + Biomec√°nica</div></div>
    </button>
    <button class="btn" onclick="hubEnterJudge()" style="padding:16px;font-size:15px;background:linear-gradient(135deg,#6366f1,#4f46e5);text-align:left;display:flex;align-items:center;gap:14px">
      <span style="font-size:28px">‚öñÔ∏è</span>
      <div><div style="font-weight:800">Judge Heat</div><div style="font-size:11px;font-weight:500;opacity:.85;margin-top:1px">Scoring ISA 0-10</div></div>
    </button>
    <button class="btn" onclick="showView('workout')" style="padding:16px;font-size:15px;background:linear-gradient(135deg,#f59e0b,#d97706);text-align:left;display:flex;align-items:center;gap:14px">
      <span style="font-size:28px">üí™</span>
      <div><div style="font-weight:800">Workout</div><div style="font-size:11px;font-weight:500;opacity:.85;margin-top:1px">Ejercicios y condici√≥n f√≠sica</div></div>
    </button>
    <button class="btn" onclick="showView('lab')" style="padding:16px;font-size:15px;background:linear-gradient(135deg,#ec4899,#be185d);text-align:left;display:flex;align-items:center;gap:14px">
      <span style="font-size:28px">üé•</span>
      <div><div style="font-weight:800">Tech Lab</div><div style="font-size:11px;font-weight:500;opacity:.85;margin-top:1px">Video an√°lisis y correcci√≥n</div></div>
    </button>
  </div>

  <!-- Quick overview button -->
  <button class="btn btn-outline" onclick="showView('overview')" style="margin-bottom:10px">
    üìä Vista General (Quick Overview)
  </button>

  <!-- End session -->
  <button class="btn" onclick="endSessionFromHub()" style="background:var(--bg-card);border:1px solid var(--red);color:var(--red);font-size:14px;padding:14px">
    üèÅ Finalizar Sesi√≥n
  </button>
</div>

<!-- ==================== TACTICAL IQ ==================== -->
<div class="view" id="view-tactical" style="padding:0 0 24px">
  <!-- Sticky header -->
  <div class="tac-header">
    <button class="tac-nav-arrow" onclick="tacPrev()">‚Äπ</button>
    <div style="text-align:center">
      <div class="tac-athlete-name" id="tacName">‚Äî</div>
      <div style="font-size:11px;color:var(--text-secondary);font-weight:600" id="tacLevel"></div>
    </div>
    <button class="tac-nav-arrow" onclick="tacNext()">‚Ä∫</button>
    <img class="kss-logo-sm" id="tacLogoImg" alt="KSS" style="position:absolute;top:10px;right:12px;opacity:.35;width:22px;height:22px">
  </div>

  <div style="padding:12px 16px">
    <!-- MODE TOGGLE: Waves vs Biomechanics -->
    <div style="display:flex;gap:4px;margin-bottom:14px;background:var(--bg-input);border-radius:8px;padding:3px" id="tacModeToggle">
      <button class="seg-btn selected" data-v="waves" onclick="tacSwitchMode('waves',this)" style="flex:1;border-radius:6px;padding:8px;font-size:12px;font-weight:700">üåä Olas</button>
      <button class="seg-btn" data-v="biomech" onclick="tacSwitchMode('biomech',this)" style="flex:1;border-radius:6px;padding:8px;font-size:12px;font-weight:700">ü¶¥ Biomec√°nica</button>
    </div>

    <!-- ===== WAVE MODE (existing) ===== -->
    <div id="tacWaveMode">
      <!-- Catch Ratio -->
      <div class="tac-catch mid" id="tacCatch">
        <div id="tacCatchVal">‚Äî%</div>
        <div class="tac-catch-label">Catch Ratio</div>
      </div>

      <!-- Stats -->
      <div class="tac-stat-row">
        <div class="tac-stat"><div class="tac-stat-val" id="tacPaddled" style="color:var(--accent)">0</div><div class="tac-stat-label">Remadas</div></div>
        <div class="tac-stat"><div class="tac-stat-val" id="tacCaught" style="color:var(--green)">0</div><div class="tac-stat-label">Atrapadas</div></div>
      </div>

      <!-- BIG COUNTER BUTTONS -->
      <div class="counter-row">
        <button class="counter-btn c-paddle" onclick="tacCount('paddle')">
          <span class="cnt-icon">üèä</span>
          <span style="font-size:11px">REM√ì</span>
          <span class="cnt-val" id="tacPaddleBtn">+1</span>
        </button>
        <button class="counter-btn c-catch" onclick="tacCount('catch')">
          <span class="cnt-icon">‚úÖ</span>
          <span style="font-size:11px">ATRAP√ì</span>
          <span class="cnt-val" id="tacCatchBtn">+1</span>
        </button>
        <button class="counter-btn c-fall" onclick="tacCount('fall')">
          <span class="cnt-icon">üí•</span>
          <span style="font-size:11px">CA√çDA</span>
          <span class="cnt-val" id="tacFallBtn">+1</span>
        </button>
      </div>

      <!-- Quick Eval (only visible after catching a wave) -->
      <div id="tacEvalSection" style="display:none">
        <div style="font-size:12px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">Evaluaci√≥n R√°pida ‚Äî √öltima Ola</div>
      
      <!-- Set or Interset -->
      <div class="eval-section">
        <div class="eval-label">Tipo de Ola</div>
        <div class="eval-row" id="evalWaveType">
          <button class="eval-btn" data-v="set" onclick="evalSet('wave_type',this,'b')" style="flex:1">üåä Set</button>
          <button class="eval-btn" data-v="interset" onclick="evalSet('wave_type',this,'m')" style="flex:1">„Ä∞Ô∏è Interset</button>
        </div>
      </div>

      <!-- Wave Quality -->
      <div class="eval-section">
        <div class="eval-label">Calidad de la Ola</div>
        <div class="eval-row" id="evalWaveQuality">
          <button class="eval-btn" data-v="poor" onclick="evalSet('wave_quality',this,'r')">üí© Pobre</button>
          <button class="eval-btn" data-v="regular" onclick="evalSet('wave_quality',this,'y')">üëå Regular</button>
          <button class="eval-btn" data-v="good" onclick="evalSet('wave_quality',this,'g')">üî• Buena</button>
          <button class="eval-btn" data-v="excellent" onclick="evalSet('wave_quality',this,'a')">‚≠ê Excelente</button>
        </div>
      </div>

      <div class="eval-section">
        <div class="eval-label">Wave Selection</div>
        <div class="eval-row" id="evalSelection">
          <button class="eval-btn" data-v="poor" onclick="evalSet('selection',this,'r')">üî¥ Mala</button>
          <button class="eval-btn" data-v="normal" onclick="evalSet('selection',this,'y')">üü° Normal</button>
          <button class="eval-btn" data-v="excellent" onclick="evalSet('selection',this,'g')">üü¢ Excelente</button>
        </div>
      </div>

      <div class="eval-section">
        <div class="eval-label">Positioning</div>
        <div class="eval-row" id="evalPosition">
          <button class="eval-btn" data-v="poor" onclick="evalSet('position',this,'r')">üî¥ Fuera</button>
          <button class="eval-btn" data-v="normal" onclick="evalSet('position',this,'y')">üü° Ok</button>
          <button class="eval-btn" data-v="excellent" onclick="evalSet('position',this,'g')">üü¢ En el pico</button>
        </div>
      </div>

      <div class="eval-section">
        <div class="eval-label">Commitment</div>
        <div class="eval-row" id="evalCommit">
          <button class="eval-btn" data-v="poor" onclick="evalSet('commit',this,'r')">üî¥ Dud√≥</button>
          <button class="eval-btn" data-v="normal" onclick="evalSet('commit',this,'y')">üü° Normal</button>
          <button class="eval-btn" data-v="excellent" onclick="evalSet('commit',this,'g')">üü¢ Full Send</button>
        </div>
      </div>

      <!-- Maneuver Tags -->
      <div class="eval-label">Maniobras</div>
      <div class="tag-row" id="tacTags">
        <button class="tag-btn" data-m="takeoff" onclick="tagToggle(this)">Take Off</button>
        <button class="tag-btn" data-m="bt" onclick="tagToggle(this)">BT</button>
        <button class="tag-btn" data-m="carving" onclick="tagToggle(this)">Carving</button>
        <button class="tag-btn" data-m="cutback" onclick="tagToggle(this)">Cutback</button>
        <button class="tag-btn" data-m="snap" onclick="tagToggle(this)">Snap</button>
        <button class="tag-btn" data-m="floater" onclick="tagToggle(this)">Floater</button>
        <button class="tag-btn" data-m="aerial" onclick="tagToggle(this)">Aerial</button>
        <button class="tag-btn" data-m="tube" onclick="tagToggle(this)">Tube</button>
        <button class="tag-btn" data-m="reentry" onclick="tagToggle(this)">Re-entry</button>
      </div>

      <button class="btn btn-sm" onclick="confirmWave()" style="margin-top:12px;background:#f97316;color:#fff;font-weight:800;font-size:16px;padding:16px;box-shadow:0 0 20px rgba(249,115,22,.5);border:2px solid #fb923c;letter-spacing:.03em">‚úì CONFIRMAR OLA</button>
    </div>

    <!-- Falls counter visible -->
    <div class="tac-stat-row" style="margin-top:12px">
      <div class="tac-stat"><div class="tac-stat-val" id="tacFalls" style="color:var(--red)">0</div><div class="tac-stat-label">Ca√≠das</div></div>
      <div class="tac-stat"><div class="tac-stat-val" id="tacWaves" style="color:var(--text-primary)">0</div><div class="tac-stat-label">Total Olas</div></div>
    </div>
    </div><!-- end tacWaveMode -->

    <!-- ===== BIOMECHANICS MODE ===== -->
    <div id="tacBioMode" style="display:none">
      <div style="font-size:12px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.06em;margin-bottom:12px">ü¶¥ Evaluaci√≥n Biomec√°nica en Agua</div>

      <!-- Wave counter for biomech -->
      <div style="display:flex;gap:8px;margin-bottom:14px">
        <button class="btn btn-accent" onclick="bioNewWave()" style="flex:1;padding:14px;font-size:15px;font-weight:800">üèÑ Nueva Ola para Evaluar</button>
      </div>
      <div style="font-size:13px;font-weight:700;color:var(--accent);text-align:center;margin-bottom:14px" id="bioWaveCount">Ola #0</div>

      <div id="bioEvalForm" style="display:none">
        <!-- Shoulders -->
        <div class="eval-section">
          <div class="eval-label">Hombros Paralelos</div>
          <div class="eval-row" id="bioShoulders">
            <button class="eval-btn" data-v="poor" onclick="evalSet('bio_shoulders',this,'r')">üî¥ Desalineados</button>
            <button class="eval-btn" data-v="ok" onclick="evalSet('bio_shoulders',this,'y')">üü° Parcial</button>
            <button class="eval-btn" data-v="good" onclick="evalSet('bio_shoulders',this,'g')">üü¢ Paralelos</button>
          </div>
        </div>

        <!-- Knees -->
        <div class="eval-section">
          <div class="eval-label">Rodillas (direcci√≥n)</div>
          <div class="eval-row" id="bioKnees">
            <button class="eval-btn" data-v="poor" onclick="evalSet('bio_knees',this,'r')">üî¥ Cerradas/Abiertas</button>
            <button class="eval-btn" data-v="ok" onclick="evalSet('bio_knees',this,'y')">üü° Parcial</button>
            <button class="eval-btn" data-v="good" onclick="evalSet('bio_knees',this,'g')">üü¢ Hacia adelante</button>
          </div>
        </div>

        <!-- Arms -->
        <div class="eval-section">
          <div class="eval-label">Brazos (direcci√≥n y gu√≠a)</div>
          <div class="eval-row" id="bioArms">
            <button class="eval-btn" data-v="poor" onclick="evalSet('bio_arms',this,'r')">üî¥ Sin gu√≠a</button>
            <button class="eval-btn" data-v="ok" onclick="evalSet('bio_arms',this,'y')">üü° Parcial</button>
            <button class="eval-btn" data-v="good" onclick="evalSet('bio_arms',this,'g')">üü¢ Gu√≠an bien</button>
          </div>
        </div>

        <!-- Compression / Bottom Turn -->
        <div class="eval-section">
          <div class="eval-label">Compresi√≥n en Bottom Turn</div>
          <div class="eval-row" id="bioCompression">
            <button class="eval-btn" data-v="none" onclick="evalSet('bio_compression',this,'r')">üî¥ Sin compresi√≥n</button>
            <button class="eval-btn" data-v="partial" onclick="evalSet('bio_compression',this,'y')">üü° Parcial</button>
            <button class="eval-btn" data-v="full" onclick="evalSet('bio_compression',this,'g')">üü¢ Full compress</button>
          </div>
        </div>

        <!-- Head Position -->
        <div class="eval-section">
          <div class="eval-label">Cabeza / Mirada</div>
          <div class="eval-row" id="bioHead">
            <button class="eval-btn" data-v="poor" onclick="evalSet('bio_head',this,'r')">üî¥ Mirando abajo</button>
            <button class="eval-btn" data-v="ok" onclick="evalSet('bio_head',this,'y')">üü° Inconsistente</button>
            <button class="eval-btn" data-v="good" onclick="evalSet('bio_head',this,'g')">üü¢ Mira al destino</button>
          </div>
        </div>

        <!-- Back Foot -->
        <div class="eval-section">
          <div class="eval-label">Pie Trasero (posici√≥n en tail)</div>
          <div class="eval-row" id="bioBackFoot">
            <button class="eval-btn" data-v="poor" onclick="evalSet('bio_backfoot',this,'r')">üî¥ Centrado</button>
            <button class="eval-btn" data-v="ok" onclick="evalSet('bio_backfoot',this,'y')">üü° Cerca</button>
            <button class="eval-btn" data-v="good" onclick="evalSet('bio_backfoot',this,'g')">üü¢ Sobre el tail</button>
          </div>
        </div>

        <!-- Weight Transfer -->
        <div class="eval-section">
          <div class="eval-label">‚öñÔ∏è Transferencia de Peso</div>
          <div class="eval-row" id="bioWeight">
            <button class="eval-btn" data-v="poor" onclick="evalSet('bio_weight',this,'r')">üî¥ Est√°tico</button>
            <button class="eval-btn" data-v="ok" onclick="evalSet('bio_weight',this,'y')">üü° Parcial</button>
            <button class="eval-btn" data-v="good" onclick="evalSet('bio_weight',this,'g')">üü¢ Fluida</button>
          </div>
        </div>

        <!-- Overall Flow -->
        <div class="eval-section">
          <div class="eval-label">Fluidez General</div>
          <div class="eval-row" id="bioFlow">
            <button class="eval-btn" data-v="1" onclick="evalSet('bio_flow',this,'r')">1</button>
            <button class="eval-btn" data-v="2" onclick="evalSet('bio_flow',this,'r')">2</button>
            <button class="eval-btn" data-v="3" onclick="evalSet('bio_flow',this,'y')">3</button>
            <button class="eval-btn" data-v="4" onclick="evalSet('bio_flow',this,'y')">4</button>
            <button class="eval-btn" data-v="5" onclick="evalSet('bio_flow',this,'g')">5</button>
          </div>
        </div>

        <!-- Notes -->
        <div class="eval-section">
          <div class="eval-label">üìù Notas de Correcci√≥n</div>
          <textarea class="field-input" id="bioNotes" rows="3" placeholder="Ej: Hombro delantero cae en el cutback, necesita rotar m√°s las caderas..."></textarea>
        </div>

        <button class="btn btn-sm" onclick="bioConfirmWave()" style="margin-top:10px;background:#f97316;color:#fff;font-weight:800;font-size:16px;padding:16px;box-shadow:0 0 20px rgba(249,115,22,.5);border:2px solid #fb923c;letter-spacing:.03em;width:100%">‚úì CONFIRMAR EVALUACI√ìN</button>
      </div>

      <!-- Biomech History for current session -->
      <div id="bioHistory" style="margin-top:16px"></div>
    </div><!-- end tacBioMode -->

    <!-- ===== PADDLE RACE MODE ===== -->
    <div id="tacPaddleRaceMode" style="display:none">
      <div style="font-size:12px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.06em;margin-bottom:12px">üèÅ Paddle Race Tracking</div>
      
      <!-- Race Timer -->
      <div class="card" style="text-align:center;padding:16px;margin-bottom:12px">
        <div style="font-size:10px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.08em;margin-bottom:6px">Tiempo de Carrera</div>
        <div id="raceTimerDisplay" style="font-size:42px;font-weight:800;font-variant-numeric:tabular-nums;color:var(--accent)">00:00.0</div>
        <div style="display:flex;gap:8px;margin-top:12px;justify-content:center">
          <button class="btn btn-sm" onclick="raceTimerToggle()" id="raceTimerBtn" style="background:var(--green);color:#fff;padding:10px 24px;font-weight:800">‚ñ∂ Start</button>
          <button class="btn btn-sm btn-outline" onclick="raceTimerReset()" style="padding:10px 16px">‚Üª Reset</button>
        </div>
      </div>

      <!-- Lap Counter -->
      <div class="card" style="padding:14px;margin-bottom:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <div style="font-size:12px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.06em">Vueltas / Splits</div>
          <button class="btn btn-sm" onclick="raceAddLap()" id="raceLapBtn" style="background:var(--accent);color:#fff;padding:8px 20px;font-size:14px;font-weight:800">‚è± Lap</button>
        </div>
        <div id="raceLapList" style="font-size:13px"></div>
      </div>

      <!-- Race Stats -->
      <div class="tac-stat-row" style="margin-bottom:12px">
        <div class="tac-stat"><div class="tac-stat-val" id="raceLapCount" style="color:var(--accent)">0</div><div class="tac-stat-label">Vueltas</div></div>
        <div class="tac-stat"><div class="tac-stat-val" id="raceBestLap" style="color:var(--green)">‚Äî</div><div class="tac-stat-label">Mejor Vuelta</div></div>
        <div class="tac-stat"><div class="tac-stat-val" id="raceAvgLap" style="color:var(--text-primary)">‚Äî</div><div class="tac-stat-label">Promedio</div></div>
      </div>

      <!-- Race Eval -->
      <div class="card" style="padding:12px;margin-bottom:12px">
        <div class="eval-label">T√©cnica de Remada</div>
        <div class="eval-row" id="raceTechnique">
          <button class="eval-btn" data-v="poor" onclick="evalSet('race_technique',this,'r')">üî¥ D√©bil</button>
          <button class="eval-btn" data-v="ok" onclick="evalSet('race_technique',this,'y')">üü° Regular</button>
          <button class="eval-btn" data-v="good" onclick="evalSet('race_technique',this,'g')">üü¢ Fuerte</button>
        </div>
        
        <div class="eval-label" style="margin-top:10px">Estrategia / Pacing</div>
        <div class="eval-row" id="racePacing">
          <button class="eval-btn" data-v="poor" onclick="evalSet('race_pacing',this,'r')">üî¥ Inconsistente</button>
          <button class="eval-btn" data-v="ok" onclick="evalSet('race_pacing',this,'y')">üü° Regular</button>
          <button class="eval-btn" data-v="good" onclick="evalSet('race_pacing',this,'g')">üü¢ Bien</button>
        </div>

        <div class="eval-label" style="margin-top:10px">Posici√≥n en la Tabla</div>
        <div class="eval-row" id="racePosition">
          <button class="eval-btn" data-v="poor" onclick="evalSet('race_position',this,'r')">üî¥ Inestable</button>
          <button class="eval-btn" data-v="ok" onclick="evalSet('race_position',this,'y')">üü° Regular</button>
          <button class="eval-btn" data-v="good" onclick="evalSet('race_position',this,'g')">üü¢ S√≥lida</button>
        </div>
        
        <div class="eval-label" style="margin-top:10px">Notas de Carrera</div>
        <textarea class="field-input" id="raceNotes" rows="2" placeholder="Ej: Perdi√≥ ritmo en el segundo tramo..." style="font-size:13px"></textarea>
        <button class="btn btn-sm" onclick="raceSaveEval()" style="margin-top:8px;background:var(--accent);color:#fff;font-weight:700;width:100%;padding:10px">üíæ Guardar Evaluaci√≥n</button>
      </div>

      <!-- Race History -->
      <div id="raceHistory" style="margin-top:12px"></div>
    </div><!-- end tacPaddleRaceMode -->

    <div style="margin-top:20px;display:flex;gap:8px">
      <button class="btn btn-outline btn-sm" onclick="showView('overview')" style="flex:1">üë• Ver Todos</button>
      <button class="btn btn-sm" style="flex:1;background:var(--red);color:#fff" onclick="endSession()">‚ñ† Cerrar Sesi√≥n</button>
    </div>
  </div>
</div>

<!-- ==================== OVERVIEW ==================== -->
<div class="view" id="view-overview" style="padding-top:8px">
  <div class="flex-between mb-4" style="padding:0 4px">
    <div style="display:flex;align-items:center;gap:8px"><img class="kss-logo-sm" id="ovLogoImg" alt="KSS" style="opacity:.6"><span style="font-size:17px;font-weight:800">Sesi√≥n en Vivo</span></div>
    <button class="text-sm" style="color:var(--accent);font-weight:700" onclick="showView('tactical')">‚Üê Tracking</button>
  </div>
  <div id="ovInfo" style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;font-weight:600"></div>
  <div class="card" style="padding:0;overflow:hidden" id="ovList"></div>
  <div style="margin-top:16px;text-align:center">
    <div style="font-size:13px;color:var(--text-secondary);font-weight:600">Catch Ratio Promedio</div>
    <div id="ovAvg" style="font-size:32px;font-weight:800;color:var(--accent)">‚Äî%</div>
  </div>
  <button class="btn btn-sm" style="margin-top:16px;background:var(--red);color:#fff" onclick="endSession()">‚ñ† Cerrar Sesi√≥n</button>
</div>

<!-- ==================== BEGINNER MODE ==================== -->
<div class="view" id="view-beginner" style="padding:0 0 24px">
  <div class="beg-header">
    <button class="tac-nav-arrow" onclick="begPrev()">‚Äπ</button>
    <div style="text-align:center">
      <div style="font-size:16px;font-weight:800" id="begName">‚Äî</div>
      <div style="font-size:11px;color:var(--text-secondary);font-weight:600">üåä Beginner Mode</div>
    </div>
    <button class="tac-nav-arrow" onclick="begNext()">‚Ä∫</button>
  </div>

  <!-- Quick summary -->
  <div class="beg-summary" id="begSummary">
    <div class="beg-sum-row"><span class="beg-sum-label">Intentos</span><span class="beg-sum-val" id="begTotal">0</span></div>
    <div class="beg-sum-row"><span class="beg-sum-label">De pie</span><span class="beg-sum-val" id="begStanding">0</span></div>
    <div class="beg-sum-row"><span class="beg-sum-label">Solo</span><span class="beg-sum-val" id="begSolo">0</span></div>
    <div class="beg-sum-row"><span class="beg-sum-label">Trayecto completo</span><span class="beg-sum-val" id="begComplete">0</span></div>
  </div>

  <!-- New wave evaluation card -->
  <div class="beg-wave-card" id="begEvalCard">
    <div style="font-size:13px;font-weight:800;margin-bottom:12px">üìã Evaluar Intento</div>

    <div class="beg-eval-row">
      <div class="beg-eval-label">Entrada</div>
      <div class="beg-eval-opts" id="begCatching">
        <button class="beg-eval-btn red" data-v="assisted" onclick="begSel('begCatching','assisted',this)">ü§ù Asistido</button>
        <button class="beg-eval-btn yellow" data-v="timed" onclick="begSel('begCatching','timed',this)">‚è±Ô∏è Timing</button>
        <button class="beg-eval-btn green" data-v="solo" onclick="begSel('begCatching','solo',this)">üèÑ Solo</button>
      </div>
    </div>

    <div class="beg-eval-row">
      <div class="beg-eval-label">Pop-up</div>
      <div class="beg-eval-opts" id="begPopup">
        <button class="beg-eval-btn red" data-v="none" onclick="begSel('begPopup','none',this)">‚ùå No</button>
        <button class="beg-eval-btn yellow" data-v="knees" onclick="begSel('begPopup','knees',this)">ü¶µ Rodillas</button>
        <button class="beg-eval-btn green" data-v="standing" onclick="begSel('begPopup','standing',this)">‚úÖ De pie</button>
      </div>
    </div>

    <div class="beg-eval-row">
      <div class="beg-eval-label">Equilibrio</div>
      <div class="beg-eval-opts" id="begBalance">
        <button class="beg-eval-btn red" data-v="falls" onclick="begSel('begBalance','falls',this)">üí• Cae</button>
        <button class="beg-eval-btn yellow" data-v="partial" onclick="begSel('begBalance','partial',this)">‚öñÔ∏è Parcial</button>
        <button class="beg-eval-btn green" data-v="complete" onclick="begSel('begBalance','complete',this)">üèÜ Completo</button>
      </div>
    </div>

    <div class="beg-eval-row">
      <div class="beg-eval-label">Direcci√≥n</div>
      <div class="beg-eval-opts" id="begDirection">
        <button class="beg-eval-btn red" data-v="none" onclick="begSel('begDirection','none',this)">‚ùå Sin ctrl</button>
        <button class="beg-eval-btn yellow" data-v="some" onclick="begSel('begDirection','some',this)">„Ä∞Ô∏è Algo</button>
        <button class="beg-eval-btn green" data-v="controls" onclick="begSel('begDirection','controls',this)">‚úÖ Controla</button>
      </div>
    </div>

    <div class="beg-eval-row">
      <div class="beg-eval-label">Tipo ola</div>
      <div class="beg-eval-opts" id="begWaveType">
        <button class="beg-eval-btn" data-v="whitewash" onclick="begSel('begWaveType','whitewash',this)">ü´ß Espuma</button>
        <button class="beg-eval-btn" data-v="reform" onclick="begSel('begWaveType','reform',this)">üåä Reforma</button>
        <button class="beg-eval-btn" data-v="green" onclick="begSel('begWaveType','green',this)">üíö Verde</button>
      </div>
    </div>

    <div class="beg-eval-row" style="margin-bottom:0">
      <div class="beg-eval-label">Stance</div>
      <div class="beg-eval-opts" id="begStance">
        <button class="beg-eval-btn" data-v="undefined" onclick="begSel('begStance','undefined',this)">‚ùì No definido</button>
        <button class="beg-eval-btn" data-v="frontside" onclick="begSel('begStance','frontside',this)">üßç Frontside</button>
        <button class="beg-eval-btn" data-v="backside" onclick="begSel('begStance','backside',this)">üîÑ Backside</button>
      </div>
    </div>

    <textarea class="field-input" id="begNotes" placeholder="Notas r√°pidas..." style="margin-top:10px;height:40px;font-size:12px"></textarea>

    <button class="btn btn-accent" onclick="begLogWave()" style="margin-top:10px;padding:14px;font-size:15px;width:100%">
      ‚úÖ Registrar Intento
    </button>
  </div>

  <!-- Wave history -->
  <div style="padding:0 16px">
    <div style="font-size:13px;font-weight:700;margin-bottom:8px">üìã Historial de Intentos</div>
    <div id="begWaveList"></div>
  </div>

  <div style="padding:16px">
    <button class="btn btn-outline" onclick="showView('session-hub')" style="width:100%">‚Üê Volver al Hub</button>
  </div>
</div>

<!-- ==================== WORKOUT MODULE ==================== -->
<div class="view" id="view-workout">
  <div class="flex-between mb-4" style="padding:0 4px">
    <button class="text-sm text-muted" onclick="showView('session-hub')">‚Üê Hub</button>
    <div style="display:flex;align-items:center;gap:8px"><img class="kss-logo-sm" id="woLogoImg" alt="KSS" style="opacity:.6"><span style="font-size:17px;font-weight:800">üí™ Workout</span></div>
    <div style="width:60px"></div>
  </div>

  <!-- Assign drill to all or individual -->
  <div style="display:flex;gap:8px;margin-bottom:14px">
    <button class="btn btn-accent btn-sm" onclick="woAssignAll()" style="flex:1">üìã Asignar a Todos</button>
    <button class="btn btn-outline btn-sm" onclick="woAssignOne()" style="flex:1">üë§ Asignar Individual</button>
  </div>

  <!-- Athletes workout table -->
  <div id="woAthleteList"></div>

  <!-- Summary -->
  <div class="card" id="woSummary" style="display:none;margin-top:14px">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px">üìä Resumen Workout</div>
    <div id="woSummaryContent"></div>
  </div>
</div>

<!-- Workout Assign Modal -->
<div class="modal-overlay" id="modalWoAssign" onclick="if(event.target===this)this.classList.remove('active')">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <div style="font-size:18px;font-weight:800" id="woAssignTitle">Asignar Ejercicio</div>
      <button onclick="document.getElementById('modalWoAssign').classList.remove('active')" style="font-size:20px;padding:4px 8px;color:var(--text-muted)">‚úï</button>
    </div>
    <div id="woAssignTarget" style="font-size:12px;color:var(--text-secondary);margin-bottom:12px"></div>
    
    <!-- Pick from library or custom -->
    <div style="display:flex;gap:4px;margin-bottom:12px;background:var(--bg-input);border-radius:8px;padding:3px">
      <button class="seg-btn selected" onclick="woAssignTab('library',this)" style="flex:1;border-radius:6px;padding:8px;font-size:13px">üìö Biblioteca</button>
      <button class="seg-btn" onclick="woAssignTab('custom',this)" style="flex:1;border-radius:6px;padding:8px;font-size:13px">‚úèÔ∏è Personalizado</button>
    </div>
    
    <div id="woLibraryTab">
      <div class="drill-cat-filter" id="woCatFilter"></div>
      <div id="woLibraryList" style="max-height:50vh;overflow-y:auto;-webkit-overflow-scrolling:touch"></div>
    </div>
    
    <div id="woCustomTab" style="display:none">
      <div class="field"><label class="field-label">Nombre</label><input class="field-input" id="woCustomName" placeholder="Ej: Sprint en arena" autocomplete="off"></div>
      <div class="field"><label class="field-label">Descripci√≥n (opcional)</label><input class="field-input" id="woCustomDesc" placeholder="Descripci√≥n breve" autocomplete="off"></div>
      <div class="field"><label class="field-label">Duraci√≥n</label><input class="field-input" id="woCustomDur" placeholder="Ej: 3 series x 10" autocomplete="off"></div>
      <button class="btn btn-accent" onclick="woAssignCustom()" style="padding:14px;font-size:15px">‚úÖ Asignar</button>
    </div>
  </div>
</div>

<!-- ==================== DEBRIEF ==================== -->
<div class="view" id="view-debrief">
  <div style="display:flex;align-items:center;gap:10px;margin-bottom:4px">
    <img class="kss-logo" id="dbLogoImg" alt="KSS">
    <div style="font-size:20px;font-weight:800">üìã Session Debrief</div>
  </div>
  <div id="dbDate" style="font-size:13px;color:var(--text-secondary);margin-bottom:16px"></div>

  <div class="db-condition" id="dbConditions"></div>

  <div class="card" style="padding:12px">
    <div class="flex-between">
      <span style="font-size:13px;font-weight:700;color:var(--text-secondary)">EQUIPO</span>
      <span id="dbTeamRatio" style="font-size:15px;font-weight:800;color:var(--accent)"></span>
    </div>
    <div id="dbTeamStats" style="font-size:12px;color:var(--text-secondary);margin-top:4px"></div>
  </div>

  <div id="dbAthletes"></div>

  <!-- Visual Chart -->
  <div class="db-chart" id="dbChart" style="display:none">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px">üìä Catch Ratio Comparado</div>
    <div id="dbChartBars"></div>
  </div>

  <div class="field" style="margin-top:16px">
    <label class="field-label">üìù Nota General</label>
    <textarea class="field-input" id="dbNotes" rows="3" placeholder="Notas sobre la sesi√≥n..."></textarea>
  </div>

  <div class="field">
    <label class="field-label">‚≠ê Rating de la Sesi√≥n</label>
    <div class="stars" id="dbRating">
      <span class="star" onclick="starSelect('dbRating',1)">‚òÖ</span>
      <span class="star" onclick="starSelect('dbRating',2)">‚òÖ</span>
      <span class="star" onclick="starSelect('dbRating',3)">‚òÖ</span>
      <span class="star" onclick="starSelect('dbRating',4)">‚òÖ</span>
      <span class="star" onclick="starSelect('dbRating',5)">‚òÖ</span>
    </div>
  </div>

  <button class="btn btn-accent" onclick="saveAndExport()" style="margin-bottom:10px">üíæ Guardar y Exportar CSV</button>
  <button class="btn btn-outline" onclick="saveDebrief(); showView('home')">Guardar sin Exportar</button>
  <div style="display:flex;gap:8px;margin-top:10px">
    <button class="btn btn-outline" onclick="saveTemplate()" style="flex:1;border-color:var(--accent);color:var(--accent)">üìã Template</button>
    <button class="share-btn" onclick="shareSession('debrief')" style="flex:1">üì§ Compartir</button>
  </div>
</div>

<!-- ==================== ATHLETES ==================== -->
<div class="view" id="view-athletes">
  <div class="flex-between mb-4" style="align-items:center">
    <div class="kss-header" style="margin-bottom:0"><img class="kss-logo-sm" id="athLogoImg" alt="KSS"><div class="kss-title">üë• Mis Atletas</div></div>
    <button style="color:var(--accent);font-weight:700;font-size:14px" onclick="openAddAthleteModal()">+ Nuevo</button>
  </div>
  <div id="athList"></div>
  <div id="athEmpty" class="empty-state">
    <p>No tienes atletas registrados.</p>
    <button class="btn btn-accent btn-sm" onclick="openAddAthleteModal()" style="width:auto;display:inline-block">Agregar Atleta</button>
  </div>
</div>

<!-- ==================== PLAYER CARD (Phase 2) ==================== -->
<div class="view" id="view-player-card">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <button class="text-sm text-muted" onclick="showView('athletes')">‚Üê Mis Atletas</button>
    <img class="kss-logo-sm" id="pcLogoImg" alt="KSS" style="opacity:.6">
  </div>
  
  <div class="pc-header">
    <div class="pc-avi" id="pcAvi">‚Äî</div>
    <div class="pc-name" id="pcName">‚Äî</div>
    <div class="pc-sub" id="pcSub">‚Äî</div>
    <div class="pc-level-tag" id="pcLevel">‚Äî</div>
    <div class="pc-xp-bar"><div class="pc-xp-fill" id="pcXpFill" style="width:0%"></div></div>
    <div class="pc-xp-text" id="pcXpText">0 / 100 XP</div>
  </div>

  <!-- Discipline Filter Tabs -->
  <div id="pcDiscFilter" style="display:none;padding:0 12px 4px;overflow-x:auto"></div>

  <!-- Quick Stats -->
  <div class="pc-stats" id="pcStats"></div>

  <!-- Per-Discipline Breakdown -->
  <div id="pcDiscBreakdown" style="display:none"></div>

  <!-- Badges -->
  <div class="card" style="padding:12px">
    <div class="card-header" style="font-size:13px;margin-bottom:8px">üèÜ Badges</div>
    <div class="pc-badges" id="pcBadges"></div>
  </div>

  <!-- Catch Ratio Trend (Sessions) -->
  <div class="pc-chart" id="pcCatchChart" style="display:none">
    <div class="pc-chart-title">üìà Catch Ratio por Sesi√≥n</div>
    <div id="pcCatchBars"></div>
  </div>

  <!-- Wave Score Distribution (Judge) -->
  <div class="pc-chart" id="pcScoreChart" style="display:none">
    <div class="pc-chart-title">‚öñÔ∏è Distribuci√≥n de Scores</div>
    <div id="pcScoreBars"></div>
  </div>

  <!-- Active Drills -->
  <div class="card" id="pcDrillsCard" style="padding:12px;display:none">
    <div class="card-header flex-between" style="font-size:13px;margin-bottom:8px">
      <span>üèãÔ∏è Drills Asignados</span>
      <button class="text-sm" style="color:var(--accent);font-weight:700" onclick="openDrillPicker()">+ Asignar</button>
    </div>
    <div id="pcDrills"></div>
  </div>

  <!-- Heat History -->
  <div class="card" id="pcHeatCard" style="padding:0;overflow:hidden;display:none">
    <div class="card-header" style="font-size:13px;padding:12px 12px 8px">‚öñÔ∏è Heat History</div>
    <div id="pcHeats"></div>
  </div>

  <!-- Judge Training Sessions -->
  <div class="card" id="pcJudgeTrainCard" style="padding:12px;display:none">
    <div class="card-header" style="font-size:13px;margin-bottom:8px">‚öñÔ∏è Judging en Entrenamiento</div>
    <div id="pcJudgeTrainContent"></div>
  </div>

  <!-- Session History -->
  <div class="card" id="pcSessionCard" style="padding:0;overflow:hidden;display:none">
    <div class="card-header" style="font-size:13px;padding:12px 12px 8px">üèÑ Session History</div>
    <div id="pcSessions"></div>
  </div>

  <!-- Biomechanics Summary -->
  <div class="card" id="pcBioCard" style="padding:12px;display:none">
    <div class="card-header" style="font-size:13px;margin-bottom:8px">ü¶¥ Biomec√°nica</div>
    <div id="pcBioContent"></div>
  </div>

  <!-- Biometrics -->
  <div class="card" style="padding:12px">
    <div class="card-header flex-between" style="font-size:13px;margin-bottom:8px">
      <span>üìä Biometrics</span>
      <button class="text-sm" style="color:var(--accent);font-weight:700" onclick="openBioModal()">+ Registro</button>
    </div>
    <div class="bio-grid" id="pcBioGrid"></div>
    <div id="pcBioHistory" style="display:none">
      <div style="font-size:11px;color:var(--text-muted);font-weight:600;margin-bottom:4px">√öltimos 7 d√≠as</div>
      <div id="pcBioRows"></div>
    </div>
  </div>

  <!-- Tech Lab Frames for this athlete -->
  <div class="card" id="pcLabCard" style="padding:12px;display:none">
    <div class="card-header flex-between" style="font-size:13px;margin-bottom:8px">
      <span>üé• Tech Lab Frames</span>
      <button class="text-sm" style="color:var(--accent);font-weight:700" onclick="showView('lab')">Ir al Lab</button>
    </div>
    <div class="lab-frames" id="pcLabFrames"></div>
  </div>

  <!-- Actions -->
  <div style="margin-top:16px;display:flex;gap:8px">
    <button class="btn btn-accent" onclick="openProgression(_pcAthleteId, 'player-card')" style="flex:1">üìà Progresi√≥n</button>
    <button class="btn btn-outline" onclick="editAthlete()" style="flex:1">‚úèÔ∏è Editar</button>
    <button class="btn" onclick="deleteAthleteFromCard()" style="flex:1;background:var(--bg-card);border:1px solid var(--red);color:var(--red)">üóëÔ∏è</button>
  </div>
</div>

<!-- ==================== DRILL BANK (Phase 2) ==================== -->
<div class="view" id="view-drills">
  <div class="flex-between mb-4">
    <button class="text-sm text-muted" onclick="showView(window._drillReturnView||'athletes')">‚Üê Volver</button>
    <div style="display:flex;align-items:center;gap:6px"><img class="kss-logo-sm" id="drillsLogoImg" alt="KSS"><span style="font-size:17px;font-weight:800">üèãÔ∏è Drill Bank</span></div>
    <div style="width:50px"></div>
  </div>
  
  <!-- Category filter -->
  <div class="drill-cat-filter" id="drillCatFilter"></div>
  
  <!-- Drill list -->
  <div id="drillList"></div>
</div>

<!-- ==================== DRILL PICKER MODAL ==================== -->
<div class="modal-overlay" id="modalDrillPicker">
  <div class="modal-sheet" style="max-height:80vh;overflow-y:auto">
    <div class="modal-handle"></div>
    <div class="modal-title">Asignar Drill</div>
    <div class="drill-cat-filter" id="dpCatFilter" style="margin-bottom:8px"></div>
    <div id="dpDrillList"></div>
    <button class="btn btn-outline" onclick="closeModal('modalDrillPicker')" style="margin-top:12px">Cerrar</button>
  </div>
</div>

<!-- ==================== BIOMETRICS MODAL ==================== -->
<div class="modal-overlay" id="modalBio">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">üìä Registro Biom√©trico</div>
    <div class="field">
      <label class="field-label">Peso (kg)</label>
      <input class="field-input" id="bioWeight" type="number" step="0.1" placeholder="70.5">
    </div>
    <div class="field">
      <label class="field-label">Horas de Sue√±o</label>
      <input class="field-input" id="bioSleep" type="number" step="0.5" min="0" max="14" placeholder="8">
    </div>
    <div class="field">
      <label class="field-label">Nivel de Energ√≠a (1-10)</label>
      <div class="seg-row" id="bioEnergy" style="flex-wrap:wrap;gap:4px">
        <button class="seg-btn" data-v="1" onclick="segSelect('bioEnergy',this)" style="min-width:32px;padding:8px 4px">1</button>
        <button class="seg-btn" data-v="2" onclick="segSelect('bioEnergy',this)" style="min-width:32px;padding:8px 4px">2</button>
        <button class="seg-btn" data-v="3" onclick="segSelect('bioEnergy',this)" style="min-width:32px;padding:8px 4px">3</button>
        <button class="seg-btn" data-v="4" onclick="segSelect('bioEnergy',this)" style="min-width:32px;padding:8px 4px">4</button>
        <button class="seg-btn" data-v="5" onclick="segSelect('bioEnergy',this)" style="min-width:32px;padding:8px 4px">5</button>
        <button class="seg-btn" data-v="6" onclick="segSelect('bioEnergy',this)" style="min-width:32px;padding:8px 4px">6</button>
        <button class="seg-btn" data-v="7" onclick="segSelect('bioEnergy',this)" style="min-width:32px;padding:8px 4px">7</button>
        <button class="seg-btn selected" data-v="8" onclick="segSelect('bioEnergy',this)" style="min-width:32px;padding:8px 4px">8</button>
        <button class="seg-btn" data-v="9" onclick="segSelect('bioEnergy',this)" style="min-width:32px;padding:8px 4px">9</button>
        <button class="seg-btn" data-v="10" onclick="segSelect('bioEnergy',this)" style="min-width:32px;padding:8px 4px">10</button>
      </div>
    </div>
    <div class="field">
      <label class="field-label">Dolor / Lesi√≥n</label>
      <div class="seg-row" id="bioPain">
        <button class="seg-btn selected" data-v="none" onclick="segSelect('bioPain',this)">Sin dolor</button>
        <button class="seg-btn" data-v="mild" onclick="segSelect('bioPain',this)">Leve</button>
        <button class="seg-btn" data-v="moderate" onclick="segSelect('bioPain',this)">Moderado</button>
        <button class="seg-btn" data-v="severe" onclick="segSelect('bioPain',this)">Severo</button>
      </div>
    </div>
    <div class="field">
      <label class="field-label">Zona de dolor (opcional)</label>
      <input class="field-input" id="bioPainZone" placeholder="Hombro derecho, espalda baja...">
    </div>
    <div class="field">
      <label class="field-label">Notas</label>
      <input class="field-input" id="bioNotes" placeholder="C√≥mo me siento hoy...">
    </div>
    <button class="btn btn-accent" onclick="saveBio()">Guardar Registro</button>
    <button class="btn btn-outline" onclick="closeModal('modalBio')" style="margin-top:8px">Cancelar</button>
  </div>
</div>

<!-- ==================== TECH LAB (Phase 3) ==================== -->
<div class="view" id="view-lab">
  <div class="kss-header"><img class="kss-logo-sm" id="labLogoImg" alt="KSS"><div><div class="kss-title">üé• Tech Lab</div></div></div>

  <!-- Upload / Record -->
  <div class="card" id="labUploadCard">
    <div class="card-header" style="margin-bottom:10px">Cargar Video</div>
    <div style="display:flex;gap:8px">
      <label class="btn btn-accent" style="flex:1;text-align:center;cursor:pointer;padding:14px">
        üì∑ Grabar
        <input type="file" accept="video/*" capture="environment" onchange="labLoadVideo(this)" style="display:none">
      </label>
      <label class="btn btn-outline" style="flex:1;text-align:center;cursor:pointer;padding:14px">
        üìÅ Galer√≠a
        <input type="file" accept="video/*" onchange="labLoadVideo(this)" style="display:none">
      </label>
    </div>
    <!-- Athlete selector -->
    <div class="field" style="margin-top:10px;margin-bottom:0">
      <label class="field-label">Vincular a Atleta</label>
      <select class="field-input" id="labAthlete" onchange="labAthleteChanged()"><option value="">‚Äî Sin vincular ‚Äî</option></select>
    </div>
    <div class="field" id="labDiscField" style="margin-top:6px;margin-bottom:0;display:none">
      <label class="field-label">Disciplina</label>
      <select class="field-input" id="labDisc"></select>
    </div>
  </div>

  <!-- Video Player + Canvas -->
  <div id="labPlayerSection" style="display:none">
    <div id="labFsContainer">
      <button class="lab-fs-close" id="labFsClose" onclick="labExitFullscreen()" style="display:none">‚úï</button>
      <div class="lab-video-wrap" id="labVideoWrap">
        <div class="lab-video-inner" id="labVideoInner">
          <video class="lab-video" id="labVideo" playsinline></video>
          <canvas class="lab-canvas" id="labCanvas"></canvas>
        </div>
        <img class="kss-watermark" id="labWatermark" alt="KSS">
        <button class="lab-fs-expand" onclick="labEnterFullscreen()" id="labFsExpand" title="Pantalla completa">‚õ∂</button>
        <!-- Gesture layer -->
        <div class="lab-gesture" id="labGesture">
          <div class="lab-gest-skip left" id="labGestL"><div class="lab-gest-skip-inner">‚è™</div></div>
          <div class="lab-gest-skip right" id="labGestR"><div class="lab-gest-skip-inner">‚è©</div></div>
          <div class="lab-gest-indicator" id="labGestPlay">‚ñ∂Ô∏è</div>
          <div class="lab-gest-scrub" id="labGestScrub"><div class="lab-gest-scrub-time" id="labGestScrubTime">0:00</div><div class="lab-gest-scrub-delta" id="labGestScrubDelta"></div></div>
          <div class="lab-gest-speed" id="labGestSpeed">2.0x ‚è©</div>
        </div>
      </div>

      <!-- Sticker mini-bar (shown when sticker mode active) -->
      <div class="lab-stk-bar" id="labStkBar">
        <div class="lab-stk-bar-preview" id="labStkBarImg"></div>
        <div class="lab-stk-bar-name" id="labStkBarName">‚Äî</div>
        <button class="lab-stk-bar-btn" onclick="labStickerShrink()">‚àí</button>
        <button class="lab-stk-bar-btn" onclick="labStickerGrow()">+</button>
        <button class="lab-stk-bar-btn" onclick="labStickerDelete()">üóë</button>
        <button class="lab-stk-bar-btn accent" onclick="labOpenStickerModal()">üìÇ</button>
      </div>

      <!-- Controls (auto-hide on mobile) -->
      <div class="lab-controls-wrap" id="labControlsWrap">
        <div class="lab-controls">
          <button class="lab-ctrl-btn" onclick="labStep(-1)" title="Frame atr√°s">‚è™</button>
          <button class="lab-ctrl-btn" id="labPlayBtn" onclick="labTogglePlay()">‚ñ∂Ô∏è</button>
          <button class="lab-ctrl-btn" onclick="labStep(1)" title="Frame adelante">‚è©</button>
          <input type="range" class="lab-timeline" id="labTimeline" min="0" max="100" value="0" step="0.1" oninput="labSeek(this.value)">
          <div class="lab-time" id="labTime">0:00</div>
        </div>

        <div class="lab-szrow">
          <span class="lab-sz-label">Speed</span>
          <button class="lab-ctrl-btn lab-spd-btn" onclick="labSpeed(0.25)">0.25x</button>
          <button class="lab-ctrl-btn lab-spd-btn" onclick="labSpeed(0.5)">0.5x</button>
          <button class="lab-ctrl-btn lab-spd-btn active" onclick="labSpeed(1)" id="labSpeedNormal">1x</button>
          <button class="lab-ctrl-btn lab-spd-btn" onclick="labSpeed(2)">2x</button>
          <div class="lab-sz-sep"></div>
          <span class="lab-sz-label">Zoom</span>
          <button class="lab-ctrl-btn" onclick="labZoomOut()" style="font-size:16px;font-weight:700">‚àí</button>
          <div class="lab-zoom-level" id="labZoomLevel">1.0x</div>
          <button class="lab-ctrl-btn" onclick="labZoomIn()" style="font-size:16px;font-weight:700">+</button>
        </div>

        <div class="lab-tools" id="labTools">
          <button class="lab-tool" onclick="labSetTool('none',this)">üëÜ Mover</button>
          <button class="lab-tool" onclick="labSetTool('pen',this)">‚úèÔ∏è Dibujar</button>
          <button class="lab-tool" onclick="labSetTool('arrow',this)">‚û°Ô∏è Flecha</button>
          <button class="lab-tool" onclick="labSetTool('angle',this)">üìê √Ångulo</button>
          <button class="lab-tool" onclick="labClearDraw()">üóëÔ∏è Borrar</button>
          <button class="lab-tool" onclick="labOpenStickerModal()">üèÑ Stickers</button>
          <button class="lab-tool" onclick="labCapture()" style="background:var(--green);border-color:var(--green);color:#fff">üì∏ Capturar</button>
        </div>

        <div class="lab-color-row" style="display:flex;gap:8px;margin-bottom:16px;align-items:center">
          <span style="font-size:11px;color:var(--text-muted)">Color:</span>
          <div class="lab-color-dot active" style="background:#ef4444" onclick="labSetColor('#ef4444',this)"></div>
          <div class="lab-color-dot" style="background:#f59e0b" onclick="labSetColor('#f59e0b',this)"></div>
          <div class="lab-color-dot" style="background:#22c55e" onclick="labSetColor('#22c55e',this)"></div>
          <div class="lab-color-dot" style="background:#3b82f6" onclick="labSetColor('#3b82f6',this)"></div>
          <div class="lab-color-dot" style="background:#ffffff" onclick="labSetColor('#ffffff',this)"></div>
          <span style="font-size:11px;color:var(--text-muted);margin-left:auto">Grosor:</span>
          <button class="lab-ctrl-btn" onclick="labStrokeWidth=2;this.style.borderColor='var(--accent)'" style="font-size:9px;width:28px;height:28px">S</button>
          <button class="lab-ctrl-btn" onclick="labStrokeWidth=4;this.style.borderColor='var(--accent)'" style="font-size:11px;width:28px;height:28px;border-color:var(--accent)">M</button>
          <button class="lab-ctrl-btn" onclick="labStrokeWidth=7;this.style.borderColor='var(--accent)'" style="font-size:14px;width:28px;height:28px">L</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Sticker modal (full screen bottom sheet) -->
  <div class="lab-stk-modal" id="labStkModal">
    <div class="lab-stk-modal-title">
      <span>üèÑ Sticker Library</span>
      <button class="lab-stk-modal-close" onclick="labCloseStickerModal()">‚úï</button>
    </div>
    <div class="lab-stk-grid" id="labStkGrid"></div>
  </div>

  <!-- Captured Frames -->
  <div id="labFramesSection" style="display:none">
    <div class="flex-between" style="margin-bottom:8px">
      <div style="font-size:13px;font-weight:700">üì∏ Frames Capturados</div>
      <button class="text-sm" style="color:var(--accent);font-weight:700" onclick="labCompareMode()">Comparar</button>
    </div>
    <div class="lab-frames" id="labFrames"></div>
  </div>

  <!-- Compare View -->
  <div id="labCompareSection" style="display:none">
    <div class="flex-between" style="margin-bottom:8px">
      <div style="font-size:13px;font-weight:700">üîç Comparar</div>
      <button class="text-sm" style="color:var(--text-muted)" onclick="document.getElementById('labCompareSection').style.display='none'">‚úï Cerrar</button>
    </div>
    <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px">Selecciona 2 frames para comparar side-by-side</div>
    <div class="lab-compare" id="labCompare"></div>
    <div class="lab-frames" id="labCompareSelect"></div>
  </div>

  <!-- Saved clips list -->
  <div id="labClipSection">
    <div style="font-size:13px;font-weight:700;margin-bottom:8px">üé¨ Clips Guardados</div>
    <div id="labClips"></div>
    <div id="labClipsEmpty" style="font-size:12px;color:var(--text-muted);text-align:center;padding:16px">No hay clips guardados a√∫n</div>
  </div>
</div>

<!-- ==================== SESSION HISTORY ==================== -->
<div class="view" id="view-history">
  <div class="kss-header" style="margin-bottom:4px"><img class="kss-logo-sm" id="histLogoImg" alt="KSS"><div class="kss-title">üìö Historial de Sesiones</div></div>
  <div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px" id="histCount"></div>
  
  <!-- Filters -->
  <div style="display:flex;gap:6px;margin-bottom:12px">
    <select class="field-input" id="histSpotFilter" onchange="renderHistory()" style="flex:1;font-size:13px;padding:8px">
      <option value="">Todos los spots</option>
    </select>
    <select class="field-input" id="histAthleteFilter" onchange="renderHistory()" style="flex:1;font-size:13px;padding:8px">
      <option value="">Todos los atletas</option>
    </select>
  </div>
  
  <div id="histList"></div>
  <div id="histEmpty" style="text-align:center;color:var(--text-muted);padding:40px 0;display:none">
    <div style="font-size:36px;margin-bottom:8px">üìã</div>
    <div>Sin sesiones guardadas a√∫n</div>
  </div>
</div>

<!-- ==================== SESSION DETAIL ==================== -->
<div class="view" id="view-session-detail">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <button class="text-sm text-muted" onclick="showView('history')">‚Üê Historial</button>
    <img class="kss-logo-sm" id="sdLogoImg" alt="KSS" style="opacity:.6">
  </div>
  <div style="font-size:18px;font-weight:800;margin-bottom:4px" id="sdTitle"></div>
  <div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px" id="sdMeta"></div>
  
  <div class="db-condition" id="sdConditions"></div>
  
  <!-- Team stats -->
  <div class="card" style="padding:12px;margin-bottom:12px">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px">EQUIPO</div>
    <div id="sdTeamStats"></div>
  </div>
  
  <!-- Athlete cards -->
  <div id="sdAthletes"></div>
  
  <!-- Charts -->
  <div id="sdCharts"></div>
  
  <!-- Notes -->
  <div class="card" id="sdNotesCard" style="padding:12px;display:none">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:6px">üìù Notas del Coach</div>
    <div id="sdNotes" style="font-size:13px;line-height:1.5"></div>
  </div>
  
  <div style="display:flex;gap:8px;margin-top:12px">
    <button class="btn btn-outline btn-sm" onclick="exportSessionCSVById(window._sdSessionIdx)" style="flex:1">üì• Exportar CSV</button>
    <button class="share-btn" onclick="shareSession('detail')" style="flex:1">üì§ Compartir</button>
  </div>
</div>

<!-- ==================== PROGRESSION ==================== -->
<div class="view" id="view-progress">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <button class="text-sm text-muted" onclick="showView(_progressReturn || 'athletes')">‚Üê Atr√°s</button>
    <img class="kss-logo-sm" id="progLogoImg" alt="KSS" style="opacity:.6">
  </div>
  <div style="font-size:20px;font-weight:800;margin-bottom:4px" id="progTitle"></div>
  <div style="font-size:12px;color:var(--text-secondary);margin-bottom:4px" id="progSubtitle"></div>
  <div id="progDiscFilter" style="display:none;margin-bottom:12px;overflow-x:auto"></div>
  
  <!-- Stat summaries -->
  <div class="dash-row" id="progKPIs" style="margin-bottom:16px"></div>
  
  <!-- Catch ratio trend -->
  <div class="card" style="padding:12px;margin-bottom:12px">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:8px">üìà Catch Ratio</div>
    <div id="progCatchChart" style="height:120px;position:relative"></div>
  </div>
  
  <!-- Bio trend -->
  <div class="card" id="progBioCard" style="padding:12px;margin-bottom:12px;display:none">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:8px">ü¶¥ Biomec√°nica Promedio</div>
    <div id="progBioBars"></div>
  </div>
  
  <!-- Maneuver frequency -->
  <div class="card" style="padding:12px;margin-bottom:12px">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:8px">üèÑ Maniobras Frecuentes</div>
    <div id="progManeuvers"></div>
  </div>
  
  <!-- XP timeline -->
  <div class="card" style="padding:12px;margin-bottom:12px">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:8px">‚ú® XP Acumulado</div>
    <div id="progXPChart" style="height:100px;position:relative"></div>
  </div>
  
  <!-- Session list for this athlete -->
  <div class="card" style="padding:12px">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:8px">üóìÔ∏è Sesiones</div>
    <div id="progSessions"></div>
  </div>
</div>

<!-- ==================== ANALYTICS ENGINE (Phase 7) ==================== -->
<div class="view" id="view-analytics">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
    <button class="text-sm text-muted" onclick="showView('home')">‚Üê Home</button>
    <img class="kss-logo-sm" id="anlLogoImg" alt="KSS" style="opacity:.6">
  </div>
  <div style="font-size:22px;font-weight:800;margin-bottom:2px">üìä Analytics</div>
  <div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px" id="anlSubtitle">Insights del equipo</div>

  <!-- Scope: Team / Athlete picker -->
  <div style="display:flex;gap:6px;margin-bottom:12px;overflow-x:auto;padding-bottom:4px" id="anlScopePills"></div>
  <!-- Discipline filter (when athlete selected) -->
  <div id="anlDiscFilter" style="display:none;margin-bottom:12px;overflow-x:auto"></div>
  <!-- Time range -->
  <div style="display:flex;gap:6px;margin-bottom:16px" id="anlTimeRange">
    <button class="anl-time-btn active" data-r="all" onclick="anlSetRange('all')">Todo</button>
    <button class="anl-time-btn" data-r="90" onclick="anlSetRange('90')">90d</button>
    <button class="anl-time-btn" data-r="30" onclick="anlSetRange('30')">30d</button>
    <button class="anl-time-btn" data-r="7" onclick="anlSetRange('7')">7d</button>
  </div>

  <!-- KPI Row -->
  <div class="dash-row" id="anlKPIs" style="margin-bottom:16px"></div>

  <!-- Session Frequency Chart -->
  <div class="card" style="padding:12px;margin-bottom:12px">
    <div class="anl-card-title">üìÖ Frecuencia de Sesiones</div>
    <div id="anlFreqChart" style="height:120px;position:relative;overflow:hidden"></div>
  </div>

  <!-- Catch Ratio Trend -->
  <div class="card" style="padding:12px;margin-bottom:12px">
    <div class="anl-card-title">üìà Tendencia Catch Ratio</div>
    <div id="anlCatchTrend" style="height:160px;position:relative;overflow:hidden"></div>
  </div>

  <!-- Wave Quality Distribution -->
  <div class="card" style="padding:12px;margin-bottom:12px">
    <div class="anl-card-title">üåä Calidad de Olas</div>
    <div style="display:flex;gap:16px;align-items:center">
      <div id="anlQualDonut" style="width:100px;height:100px;flex-shrink:0"></div>
      <div id="anlQualLegend" style="flex:1;font-size:12px"></div>
    </div>
  </div>

  <!-- Maneuver Distribution -->
  <div class="card" style="padding:12px;margin-bottom:12px">
    <div class="anl-card-title">üèÑ Maniobras Top</div>
    <div id="anlManeuvers"></div>
  </div>

  <!-- Wave Evaluation Breakdown -->
  <div class="card" style="padding:12px;margin-bottom:12px">
    <div class="anl-card-title">üéØ Evaluaci√≥n de Olas</div>
    <div id="anlEvalBars"></div>
  </div>

  <!-- Biomech Averages -->
  <div class="card" id="anlBioCard" style="padding:12px;margin-bottom:12px;display:none">
    <div class="anl-card-title">ü¶¥ Biomec√°nica</div>
    <div id="anlBioBars"></div>
  </div>

  <!-- Heat Performance -->
  <div class="card" id="anlHeatCard" style="padding:12px;margin-bottom:12px;display:none">
    <div class="anl-card-title">‚öñÔ∏è Performance en Heats</div>
    <div id="anlHeatChart" style="height:140px;position:relative;overflow:hidden"></div>
    <div id="anlHeatStats" style="margin-top:8px"></div>
  </div>

  <!-- Athlete Comparison -->
  <div class="card" id="anlCompareCard" style="padding:12px;margin-bottom:12px;display:none">
    <div class="anl-card-title">‚ö° Comparar Atletas</div>
    <div style="display:flex;gap:6px;margin-bottom:10px">
      <select class="field-input" id="anlCmpA" onchange="anlRenderCompare()" style="flex:1;font-size:12px"></select>
      <span style="align-self:center;font-weight:800;color:var(--text-muted)">vs</span>
      <select class="field-input" id="anlCmpB" onchange="anlRenderCompare()" style="flex:1;font-size:12px"></select>
    </div>
    <div id="anlCompare"></div>
  </div>

  <!-- Spot Analysis -->
  <div class="card" style="padding:12px;margin-bottom:12px">
    <div class="anl-card-title">üìç Spots Frecuentes</div>
    <div id="anlSpots"></div>
  </div>
</div>

<!-- ==================== SETTINGS ==================== -->
<div class="view" id="view-settings">
  <div class="kss-header"><img class="kss-logo-sm" id="settingsLogoImg" alt="KSS"><div><div class="kss-title">‚öôÔ∏è Configuraci√≥n</div><div class="kss-subtitle">KSS Coach ¬∑ Karibe Surf Score</div></div></div>

  <div class="card">
    <div class="card-header">üìç Spots</div>
    <div id="setSpotList"></div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <input class="field-input" id="setNewSpot" placeholder="Nuevo spot..." style="flex:1">
      <button class="btn btn-accent btn-sm" onclick="addSpot()" style="width:auto;padding:10px 20px">+</button>
    </div>
  </div>

  <div class="card">
    <div class="card-header">üìã Session Templates</div>
    <div id="setTplList"></div>
    <div id="setTplEmpty" style="font-size:12px;color:var(--text-muted);padding:4px 0">Sin templates guardados. Crea uno desde el debrief de una sesi√≥n.</div>
  </div>

  <div class="card">
    <div class="card-header">üèãÔ∏è Drill Bank</div>
    <button class="btn btn-outline btn-sm" onclick="window._drillReturnView='settings';showView('drills')" style="margin-bottom:8px">Explorar Ejercicios</button>
    <div id="setCustomDrills"></div>
    <div style="display:flex;gap:6px;margin-top:8px">
      <input class="field-input" id="setNewDrillName" placeholder="Nombre del ejercicio" style="flex:1">
      <button class="btn btn-accent btn-sm" onclick="addCustomDrill()" style="width:auto;padding:8px 12px">+ Agregar</button>
    </div>
  </div>

  <div class="card">
    <div class="card-header">üìä Datos</div>
    
    <!-- Storage health -->
    <div id="setStorageHealth" style="margin-bottom:10px;padding:8px 10px;border-radius:8px;background:var(--bg-input);font-size:12px"></div>
    
    <!-- Export -->
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:6px;margin-top:4px">Exportar</div>
    <div style="display:flex;gap:6px;margin-bottom:10px;flex-wrap:wrap">
      <button class="btn btn-outline btn-sm" onclick="exportFullBackup()" style="flex:1;min-width:120px">üíæ Backup Completo (JSON)</button>
      <button class="btn btn-outline btn-sm" onclick="exportAllSessionsCSV()" style="flex:1;min-width:120px">üìä Todas las Sesiones (CSV)</button>
    </div>
    <div style="display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap">
      <button class="btn btn-outline btn-sm" onclick="exportAthletesCSV()" style="flex:1;min-width:120px">üë• Atletas (CSV)</button>
      <button class="btn btn-outline btn-sm" onclick="exportHeatsCSV()" style="flex:1;min-width:120px">‚öñÔ∏è Heats (CSV)</button>
    </div>
    
    <!-- Import -->
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:6px">Importar / Restaurar</div>
    <div style="display:flex;gap:6px;margin-bottom:10px">
      <label class="btn btn-outline btn-sm" style="flex:1;text-align:center;cursor:pointer">
        üì• Restaurar Backup (JSON)
        <input type="file" accept=".json,application/json" onchange="importBackup(this)" style="display:none">
      </label>
    </div>
    <div id="setImportStatus" style="display:none;margin-bottom:10px;padding:8px 10px;border-radius:8px;font-size:12px"></div>
    
    <!-- Validation -->
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:6px">Integridad</div>
    <div style="display:flex;gap:6px;margin-bottom:12px">
      <button class="btn btn-outline btn-sm" onclick="validateData()" style="flex:1">üîç Validar Datos</button>
      <button class="btn btn-outline btn-sm" onclick="repairData()" style="flex:1">üîß Reparar</button>
    </div>
    <div id="setValidation" style="display:none;margin-bottom:10px;padding:8px 10px;border-radius:8px;font-size:12px"></div>

    <!-- Danger Zone -->
    <div style="font-size:11px;font-weight:700;color:var(--red);text-transform:uppercase;margin-bottom:6px;margin-top:8px">‚ö†Ô∏è Zona Peligrosa</div>
    <div style="display:flex;gap:6px">
      <button class="btn btn-sm" style="background:var(--red);color:#fff;flex:1" onclick="confirmClearData()">üóëÔ∏è Borrar Todo</button>
      <button class="btn btn-sm" style="background:#854d0e;color:#fef08a;flex:1" onclick="clearSessionsOnly()">üóÇÔ∏è Solo Sesiones</button>
    </div>
  </div>

  <div style="text-align:center;margin-top:24px;color:var(--text-muted);font-size:12px">
    <img id="footerLogoImg" alt="KSS" style="width:44px;height:44px;border-radius:50%;margin-bottom:6px;opacity:.6"><br>
    KSS Coach v7.0 ¬∑ Phase 8<br>Karibe Surf Score
  </div>
</div>

<!-- ==================== ADD ATHLETE MODAL ==================== -->
<div class="modal-overlay" id="modalAddAthlete">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">Nuevo Atleta</div>
    <div class="field">
      <label class="field-label">Nombre</label>
      <input class="field-input" id="maName" placeholder="Nombre completo">
    </div>
    <div class="field">
      <label class="field-label">Disciplinas <span style="font-weight:400;font-size:11px;color:var(--text-muted)">(selecciona 1 o m√°s)</span></label>
      <div class="disc-grid" id="maDisc">
        <button class="disc-btn selected" data-v="surfboard" onclick="discSelect(this)"><img src="surfboard.png" class="disc-icon-img"><span class="disc-label">Surfboard</span></button>
        <button class="disc-btn" data-v="bodyboard" onclick="discSelect(this)"><img src="bodyboard.png" class="disc-icon-img"><span class="disc-label">Bodyboard</span></button>
        <button class="disc-btn" data-v="longboard" onclick="discSelect(this)"><img src="longboard.png" class="disc-icon-img"><span class="disc-label">Longboard</span></button>
        <button class="disc-btn" data-v="kneeboard" onclick="discSelect(this)"><img src="kneeboard.png" class="disc-icon-img"><span class="disc-label">Kneeboard</span></button>
        <button class="disc-btn" data-v="paddlesurf" onclick="discSelect(this)"><img src="paddle_surf.png" class="disc-icon-img"><span class="disc-label">Paddle Surf</span></button>
        <button class="disc-btn" data-v="paddlerace" onclick="discSelect(this)"><img src="paddle_race.png" class="disc-icon-img"><span class="disc-label">Paddle Race</span></button>
      </div>
    </div>
    <div class="field">
      <label class="field-label">Stance</label>
      <div class="seg-row" id="maStance">
        <button class="seg-btn selected" data-v="regular" onclick="segSelect('maStance',this)">Regular</button>
        <button class="seg-btn" data-v="goofy" onclick="segSelect('maStance',this)">Goofy</button>
      </div>
    </div>
    <div class="field">
      <label class="field-label">Edad</label>
      <input class="field-input" id="maAge" type="number" placeholder="15" min="5" max="60">
    </div>
    <button class="btn btn-accent" onclick="saveNewAthlete()">Guardar Atleta</button>
    <button class="btn btn-outline" onclick="closeModal('modalAddAthlete')" style="margin-top:8px">Cancelar</button>
  </div>
</div>

<!-- UNDO TOAST -->
<div class="undo-toast" id="undoToast">
  <span id="undoText"></span>
  <button onclick="undoLastAction()">UNDO</button>
</div>

<!-- ==================== JUDGE MODE ==================== -->
<div class="view" id="view-judge" style="padding:8px 8px 24px">
  <img class="kss-logo-sm" id="judgeLogoImg" alt="KSS" style="position:absolute;top:12px;right:12px;opacity:.5">
  <!-- Collapsed metadata -->
  <div class="jm-meta-collapsed" id="jmMetaCollapsed"></div>
  
  <!-- Setup form -->
  <div class="jm-setup-form" id="jmSetupForm">
    <div style="font-size:17px;font-weight:800;margin-bottom:12px">‚öñÔ∏è Judge Mode</div>
    <div class="card">
      <div class="card-header">Heat Info</div>
      <div class="jm-meta-grid">
        <div class="field" style="margin-bottom:8px"><label class="field-label">Heat #</label><input class="field-input" id="jmHeatNum" placeholder="1"></div>
        <div class="field" style="margin-bottom:8px"><label class="field-label">Category</label><input class="field-input" id="jmCategory" placeholder="Open Men"></div>
        <div class="field" style="margin-bottom:8px"><label class="field-label">Round</label><input class="field-input" id="jmRound" placeholder="Quarter Final"></div>
        <div class="field" style="margin-bottom:8px"><label class="field-label">Location</label><input class="field-input" id="jmLocation" placeholder="Parguito"></div>
      </div>
      <div class="field" style="margin-bottom:0"><label class="field-label">Duration (min)</label><input class="field-input" id="jmDuration" type="number" value="20" min="5" max="60" style="width:100px"></div>
    </div>
    <div class="card">
      <div class="card-header">üë• Surfers</div>
      <div class="jm-surfer-grid" id="jmSurferSetup"></div>
    </div>
  </div>

  <!-- Timer bar -->
  <div class="jm-timer-bar" id="jmTimerBar" style="display:none">
    <div class="jm-timer" id="jmTimerDisplay">20:00</div>
    <div class="jm-timer-btns">
      <button class="jm-timer-btn" onclick="jmNotes()" title="Notes">üìù</button>
      <button class="jm-timer-btn" id="jmCloseBtn" onclick="jmCloseHeat()">üèÅ Close</button>
      <button class="jm-timer-btn" id="jmReopenBtn" onclick="jmReopenHeat()" style="display:none">üîì Reopen</button>
    </div>
  </div>

  <!-- Start / Reset buttons -->
  <div style="display:flex;gap:8px;margin-bottom:8px">
    <button class="btn btn-accent" id="jmStartBtn" onclick="jmStartTimer()" style="flex:1;padding:14px">‚ñ∂Ô∏è Start Heat</button>
    <button class="btn btn-outline" onclick="jmResetHeat()" style="width:auto;padding:14px 20px">üîÑ</button>
  </div>
  <div id="jmCloseRow" style="display:none;margin-bottom:12px">
    <button class="btn" id="jmCloseBtn2" onclick="jmCloseHeat()" style="width:100%;padding:14px;background:var(--red);font-size:15px;font-weight:800">üèÅ Cerrar Heat</button>
  </div>

  <!-- Score Grid -->
  <div class="card" style="padding:10px;overflow:hidden">
    <div class="jm-grid-wrap">
      <table class="jm-grid" id="jmGrid"></table>
    </div>
  </div>

  <!-- Priority -->
  <div class="card" style="padding:12px">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;text-align:center">üéØ Priority (tap surfer to send right ‚Üí)</div>
    <div class="jm-priority" id="jmPriority"></div>
  </div>

  <!-- Live Rankings -->
  <div class="card" style="padding:12px">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;text-align:center">üìä Live Rankings</div>
    <div class="jm-rankings" id="jmRankings"></div>
  </div>

  <!-- Results (after close) -->
  <div class="jm-results" id="jmResults" style="display:none">
    <div class="card">
      <div class="card-header">üèÜ Final Results</div>
      <div id="jmResultsContent"></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn btn-sm btn-outline" onclick="jmExportCSV()" style="flex:1">üìä CSV</button>
      </div>
    </div>
  </div>

  <!-- Session Tracker -->
  <div id="jmTracker" style="display:none;margin-top:12px">
    <div class="card">
      <div class="card-header">üìà Session Tracker</div>
      <div style="overflow-x:auto" id="jmTrackerContent"></div>
    </div>
  </div>
</div>

<!-- Judge Notes Modal -->
<div class="jm-notes-modal" id="jmNotesModal" onclick="if(event.target===this)this.classList.remove('active')">
  <div class="jm-notes-box">
    <div class="flex-between mb-4"><span style="font-weight:800">üìù Heat Notes</span><button onclick="document.getElementById('jmNotesModal').classList.remove('active')" style="font-size:18px">‚úï</button></div>
    <textarea class="field-input" id="jmNotesText" rows="6" placeholder="Notes..."></textarea>
  </div>
</div>

<!-- ==================== BOTTOM NAV ==================== -->
<nav class="bottom-nav">
  <button class="nav-btn active" data-view="home" onclick="showView('home')">
    <svg viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0a1 1 0 01-1-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 01-1 1"/></svg>
    Home
  </button>
  <button class="nav-btn" data-view="athletes" onclick="showView('athletes')">
    <svg viewBox="0 0 24 24"><path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
    Atletas
  </button>
  <button class="nav-btn" data-view="judge" onclick="showView('judge')">
    <svg viewBox="0 0 24 24"><path d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/></svg>
    Judge
  </button>
  <button class="nav-btn" data-view="lab" onclick="showView('lab')">
    <svg viewBox="0 0 24 24"><path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
    Lab
  </button>
  <button class="nav-btn" data-view="settings" onclick="showView('settings')">
    <svg viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><circle cx="12" cy="12" r="3"/></svg>
    Config
  </button>
</nav>

<!-- Global KSS watermark -->
<img class="kss-global-wm" id="globalWmLogoImg" alt="">

<!-- PWA Install Banner -->
<div class="pwa-banner" id="pwaBanner" style="display:none">
  <img class="pwa-banner-logo" id="pwaLogoImg" alt="KSS">
  <div class="pwa-banner-text">Instalar KSS Coach<small>Acceso r√°pido desde tu pantalla</small></div>
  <button class="pwa-banner-install" onclick="pwaInstall()">Instalar</button>
  <button class="pwa-banner-close" onclick="pwaDismiss()">√ó</button>
</div>

<script>
// ============================================================
// KSS BRANDING
// ============================================================
const KSS_LOGO = 'data:image/png;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/4gHYSUNDX1BST0ZJTEUAAQEAAAHIAAAAAAQwAABtbnRyUkdCIFhZWiAH4AABAAEAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAACRyWFlaAAABFAAAABRnWFlaAAABKAAAABRiWFlaAAABPAAAABR3dHB0AAABUAAAABRyVFJDAAABZAAAAChnVFJDAAABZAAAAChiVFJDAAABZAAAAChjcHJ0AAABjAAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJYWVogAAAAAAAAb6IAADj1AAADkFhZWiAAAAAAAABimQAAt4UAABjaWFlaIAAAAAAAACSgAAAPhAAAts9YWVogAAAAAAAA9tYAAQAAAADTLXBhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACAAAAAcAEcAbwBvAGcAbABlACAASQBuAGMALgAgADIAMAAxADb/2wBDAAUDBAQEAwUEBAQFBQUGBwwIBwcHBw8LCwkMEQ8SEhEPERETFhwXExQaFRERGCEYGh0dHx8fExciJCIeJBweHx7/2wBDAQUFBQcGBw4ICA4eFBEUHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh4eHh7/wAARCADAAMADASIAAhEBAxEB/8QAHQAAAAYDAQAAAAAAAAAAAAAAAAEFBgcIAgMJBP/EAFgQAAEDAwEEBQYICAoIAwkAAAECAwQABREGBxIhMQgTQVFhIkJxgZGhFCMyUmJysdEVGDOCkqLB0xckNENTVJOUs9IWJTZFVXWVsjWDhCdERmNlc3SFwv/EABsBAAEFAQEAAAAAAAAAAAAAAAQAAQIDBQYH/8QANhEAAQMCAwUECgICAwAAAAAAAQACAwQRBSExEhNBUWGBkbHBBhQVIiMyUnGh4dHwM0JD0vH/2gAMAwEAAhEDEQA/AK50BQFDNdcuSR8KIZoqPtpJXQxR0KFMn0RUBQxTk0HoPV+uZfUaVsMq4pCt1cgAIjtn6TisJ9QyfCk5waLuKTGOebNCbeKJakoGVqCR3k4q1OieiXhpMvXWqdxIG8uJbE7oHeFPLH2JHpp0KZ6L2zFfVvfgGTPbPHf3rjI3h3/KwfZQTq6O9mAuPRHtw99rvNlTOGxKmkiFElSsc+oZUv7BSxH0brOSneY0fqJxPeLa9/lq1M/pWaAtY6nT2k7vKQOGUstRUeGATn3UiSemAriYuz9WM8Otug/Y3TCeoOkf5TmnpxkZFW+Ro/WDH5bSOoW/rW14f/zSTNjS4RxOhyohzj49hSOPrFWjjdMF7rB8J2fp3O3q7px97dL1v6V2gbkAzqHSl4ipPe01KR7jn3UjPUN1j/KZtPTuyD1ThC0r4oUlQ8Dms6ucHOi7tMc6kCwRZ7p4eSq3SN49x8nJ9tNzWXRMjusqmaF1WrChvIjXMBxCvQ8gZHrSqnbXMvZ4Lfuk6gfa7DdVUI40XGnRtA2f6x0HK6rVVhkwWicNy0/GRnD4OJ4eo4PhTXzxoxjg4XBuEFJG5hs4WR0XbQzQqarRUKGaMUydAUdFmhTpkBQoUVMnQo6FAUkyMca9dmtdxvV2j2mzwZFwuElW6zGjo3lrPo7AO0ngO2lnZzonUOv9TM6f05FDj6sLffcBDMVvPFxwjs7hzJ4CreRo2zPozaJEiUtU6+zUY3wkGbcFjzUD+bbB/NHaSeYs9SIjstF3HgjqekMg2nZNTQ2WdGezWSCNR7V50Z0MJ61VuS/uRGAO15zhv+gYT9avTtB6TWmdNwzYNl9mjT+oHVolKb6mC1jh5CU4Lnq3R41Ae1jajq/aldkJuji2oHWfxSzxCotIPZvDm6v6R5dgArdprZ044hEi/OqYHAiK0Rv4+krkPQOPjVApi87dQbnlwVNfjVLhsetvE/YeeiSdZ7Q9f69klm+6guM9LhO7BjktsjwDSOBHpyfGvLZdn2oJa0lcZq2snmt9QBx9UcT7ql2226Ba2ept8NmMjt3E8T6TzNbJTzEZovyn2mGhzW6sJHvq8ODcmCy4Wr9L55XWgZ2nM9wy8Ug2DZRofCPw7rG/qWflCFam0IH5y1qJ9lP+w7HdgMwpZc1VqLriOcmSGB7erAHtpgytb6Yjq3Pwgp9Q7GWVKHt5VoTtB0yVbpXNSO8scPtqt7JH8SETTY1jTMzT7Q6tP6U5p6LGy2dFD1vu9/KFjyHWrg24n0/IINNu9dECEptarJrmW255iJsJDifWUFJ91M7S20GFBmpkWDUvwGQTxSVFvf8AApV5KvQan/Z7tcj3Jxq36mSxDfXgNTEHDDp+l8w+Oceig5PWosw4kLo8P9IqOoeIauIxPPPQ9uVu3vVY9Y9GfafZUuORIEDUUZPIwX8OY/8AtuYPsJplad1jtG2aXYQ7fdb1YX2zlVvmJV1agO9lwbpHiPbXSikbVuldOastqrdqSywrpGPmyGgop8Unmk+IINRZiJItK0ELpnUQGcZsVXnZ30nrBfogse1CzR4SXx1Tkxpsuw3c8PjGzlSP1h4isdqPRq0/qS3f6TbJ58SMp9PWogh7fhSAf6JYz1ZPdxT4JpM2vdFl6Kw9ddm8p2SlOVqtExzKiO5p08z9Ff6VQxsw2j612T6geZtvXNNId3Z9knBSW1KHMFJ4tr+kPXkVcxjXfEpnWPJUve5vuVDbjmmhe7Tc7HdpFovMCRb7jGVuvRpCN1ae4+IPYRkGvHxq8hRsz6TGiS4gGFfIaMb2EibbnD2H57ZP5qvA8qg7StD6g2fandsGoYwQ6AVx5DYPUy2s8HGz9qeaTzoynqRJ7rhZw4IKppDH77M2ps9lCgaHGikEio6FDFIJIDnRkUXbWQ40rqQCI8KWNE6YvOstUQtN2COHp8xWElWdxpA+U4s9iUjifYOJpFWcDkonkAkZJPYAO+rr7EtJ2jYXshn651iEs3iVHD848CtlH81FR3qJIz3qPcBQ1TPuW5anRF01PvnXOgXuu0/RfRm2VNQoTKZ96mZ6pskB64yQPKcWfNbT7EjAHE8agXm56o2jayeudzkKuN3lnylnyWmWweCUjzG09g+0mtut9U6j2n69dvFwQXJ01fVRYqVZRGaBO60k9wHEntOTUl6V0/F09bRGZIckLwqQ/ji4rw7kjsFVQxCAbTs3FZPpFjzKKMMZqdB5np4961aS01A06xlkB+apOHZKhxPgn5qfee2l0dpzy4k91Fio32p6nUpbmn7e6UoTwmuJPFR/owe4dvsqYBeV5vTU9Ri1VYuuTmSeA/ug7F6tXbQEMrXC08EPLB3VzFjKEn6A870nh6ajyZJmTnVSZkh6SvPFxxRVg/YPQKWdJ6bcupEqUVNQknAI4KcI5gdw7zWFwcF3vLVstjaGojay3HQkYSB5zh7ycE57sUQxoC7uhho6Fxhpxm0Xc48O3n0GQ+6SocORLLhZSA20nedcUcIbHeo9n2mtTLS5EgMRkLeWo4QlCTlXjinDrB9mE0zp+CN1hoB14j5Tizyz3nt9Yp6WCwWvSum3LpdipUjqw5JIPLPJpPj2eJpi6yepxYQQtlLbl5sxvE9T/HUfdR7M0zeo7IeVD61GMkNKCyn0isbDqa72RwCHJKmM+XGe8ppXq830ijv+oJ13fUVfxWNn4uMyohKR9I81HxNIpFS1GaNjikmh2atrTfh/eP271djot7XYuqGE6WnPLRMaRmK28rK0pA4t585IHFJ7BwPIVP58OdcsbNdrlYrxEvNokKjz4TqX47g7FpOQD3g4wR3V0y0BqKPq3RVn1NFTuNXKI3I3PmEjyk+o5HqrDr6cRuDhoVv4QDHEYdq4bpfUDl1twPLLhcpeltdRLnqCXpq5M/g+9RXVo6onKHwnzm1ejjg8cHhnjTJ6TGxqHtCsDt6s0dtjVcFomO4kAfDEDj1DnfnzVeafAmoe6UWo7norb+mbbXFKakQI0xbJPJ1KlJC0HzVYQnwOONWo2dali6w0PaNSw1hTU+Ml04GN1fJQx2YUCKg9hhDZmZXTUUk7nyU1V71tHcx15Edx4cVze0lqO+6Q1HHvthlvW66RFFOSk9hwppxPakkYKT9oBq5tguui+kxssfttzYTBvUMDrm0kF63yMeS80T8ptXHwIyk8RVculnptjTe3C6piNhuNdGm7ilAGAFrylzHpUkn10yNnmsLzoTV0PU1icxJjHDjJOESWj8tpfgfcQD2VpSRCoYJGZO4KEcvq8hjdm1a9d6UvWidVzdNX9gNzYiuC0g7j7Z+S6jvSoew5B4ikQVdvbFpezbetjsHWWkUpcvMZhT9vJwFrx+ViOeOQQO5QB5E5pIM8QpK0KSSFIUMKSQcEEdhB4Yq6lqN63PUaqirpt0640KOizRUeaKug0VGDRUYyASBk9g76YKV1NvQ/2ep1htG/D9xYDlp08UvkKTlLso/kkeO7xWfQnvpS6Zu0VWpNajRNuf8A9U2JeZRSeD0zHHPg2Dj6xV3CsNI7b7Ps02TRtJaFtjs++voU/cLpKR1bCJLg8opT8pzd8lIzgeSOJqELaqM9d2nbzIfWw48XJbu7vuOZO8onvKjz9NBMjc+cyvGQ0R007IafYbmdTbwCkzZbp9Nvtv4YkNj4XMT8VkcW2vvVz9GKeRNNP+EDTQOErmJSOAAjHAHYOdD+EHTWfys7+6n76mQ4m5C8mrKPEayd0z4nXPQ5DgOxLep7qLLp+ZchjrGkYZB7XDwT7zn1VC9hgu3i8tRluKPWKK33O3d5qPpP7adO0XVdsvdpjQbY5IJS/wBY71jRQMAHHp4mkfRFzt1pelvTVOhbiEob3G97hnJ9HZVjAQF0mD0c1Fh8jww7x3C2fIZd5T4vOIGlLhKYQGmo0fq2gkYwpXkpA9tNbZVb/hl1kOYx1TYTn5oJ4n3Y9dKWqtWWKfo2RaYbsr4U4UEb7BSkkKBPGk7ZrqO1WBNwFyL6TIKC2Wmt/lnOe7nSu6xKpggqmYZOAw7bjYC2ZGWfik65oS/tKdYUndbN0S3juSFJAHup27aZbibdb4YJCHn1ur8d0YA99MvU9wiyNVyrtaluFpx5MhsuI3CFgAkEeke+l7aFqSy6htcP4IuQmYw5vFC2SlOFDygFeBxTbJuCjX08rqmjkLTZrbHL5Tbjyz8Ex+znQo8eNER41cuhWKgOddBOidHkxuj/AKWRJzvLZccQD8xTqyn3EVz7cSVNqSDgkYzVr7d0odOWbZPb7baLDMTqOLAbiNxVNgRWloQEhzrM8UcM7oG92cOdAV8b5GNa0XzWhQSMYXOcVGHTBvLF427XJEdYWi2xWYSiDkb4BWoeorx6qsJ0IJqJOw9uKHApUK5yWikHigFQWB+tn11WOx7KNoOsdD3LaSw0xMiqW9KcU89iTMIJLriE4weIVwJGccBypr6L1vqvR7j8jSmoJdr+FpAeDWFIcHYSlQIyOw4zTyQCWERMObU7JjFMZHjIqWem3OiTttsKCH0NJh2xhmS6BvdVvuKVkgceCVA48aa23rQWiNE/gE6O1eb8Z7CnJKFOocKAAndcBR8kKyRunu9NRvPmS7hOkT58p6XMkuF1995ZUtxZ5kk8zXnShCAd1KU5OTgYyavjgLGtF9PyhpKhry47OqnnoabRVaX10rSFykbtov6wGd4+SzMAwkjuDgG6fpBPjWrpkbPUaT2go1NbWNy1ahKnFpSMJalp4uDw3x5Y8QuoLytK0ONOLacQoLQtBwpCgchQPeCAan3VW3W0bR9kk3R+u7W7CvTbSXoF0iI61lclvihSkfKb3uIOMjCjyqiSN0c4lYMjqiIpWywmN5seCgMCio0nKQSMHHEZodtHrNIRUFKCUKUeSQScUfqrCR/J3fqH7KV07RcqarB0atot8sMC8wZOn/gs6OiQyFy1hQStIUMjq+eDWvVHRw2h6b03cb/cpFh+B26OuS8Gpa1LKEjJ3QUAE+sVcjY7x2UaU/5RG/w015NvRxsW1if/AKPJ/wCw1iCvm3mz1W0aCHYv0XODOQCORGaBHCsWfySPqj7KfGxnZzddpms2rHAUuPBZw7cpoGRGZz2fTVghI9J5Ctl7w0Fx0WRHEXu2QvXss2Oa22kW+VctPR4bMCO71Pwia6ptDq/OSjCTvbvDJ5DOOeaeg6K21D+s6cH/AKxz93VztL2K1aZ0/CsNkhoiW+E0GmGk+aB395JySeZJJrPUN4tmn7JLvV5mNQrfDaLr77pwlCR+3sA7TWI7EpS73dFstw6IDNcytUWeXp3U1z0/cFNKmW2SuM+WlEoK08DukgEj1V4ozD8mS1FisPSJDyt1pllsrccV3JSOJpb2iXljVW0i/X20xpJZu9zW9EZWn41W+oBCcDziccPGrudHbY5a9nGn2Z8+OzK1VLaBmSyN7qM8epaPYkciRxUeJ7ANGeq3MYLtSgIaTeyG2gVYNOdHLaxeoyJK7LEtLa+IFwlhC/WhIUR68UsHorbUAeEjTh/9Y5+7q8NCs04lNfKy0fZ0Ko8OittQ/rGnP745+7o/xVtp/wDWdOf3xz93V4MUMU3tKbol7PhVH/xVdp/D+M6c/vjn7uoVvtukWi9z7RLLapMCS5GeLasoK0KKVbp7RkV0m2mawteg9FXHU12dSlqK0eqbz5T7pHkNJHapRwPaeQNc3bfHu+q9UNRI7Xwq8XmcQlAPBbzqyTx7gSST2AZo+iqJJruk0CCrKZkdgzUp4aH2j7TIulV7NtJyH5MSd1iGoseJ1slCV/LS2ocUpOTx7MnBFOKxdGfaxcYrbrlrttrQpI3UTJwCwO4hAVira7FNllg2ZacTEgNIk3V9INwuKk/GPr7gfNQOxI+3Jp/j0UHJX7LjugB5otlDtNG9N1R/8VXafj+U6c/vjn7ui/FW2of1jTn98c/d1eGhioe0p+il7OhVHT0VdqGP5Rpz++Ofu61yei3tMYjuyHZOnEttIUtX8ccPADP9HV5qjHpLa9h6G2XXJXwlKbtc2Vw7ayD5a3FjBXj5qASonwA7RUmV873Bo4qLqCBoJK56tqCkBQzg1lnwoJTuNIQOSQBmjrdCwzkcljWEj8g59RX2Vs7a1yP5O79Q/ZTEJ2nMLpdsaOdkukzn/c8b/DTXk2+HGxTWPb/qeR/2GvVsXGNkekhn/c8b/DTStrawMap0jddOSZDsdi5RXIzjrWN9AWMEjPDNcve0tzzXT2vHbouaOjdP3fVd/t+nrDEMq4zVBDSPNSMeUtZ7EJHEmuiex3Z9adm2i49gtuHnz8bOllOFyniPKWe4dgHYABSHsP2Lab2VCc/bZMq53CZhCpktKQtDQxhtO6MAZ4nvOM8hUnUTWVe+Oy3RD0tKIRc6rF1xtppbrq0toQCpSlHASBxJJ7BVEulFtgXtDv5sNjkKGlbc78WUnAnvDh1x70DzB+d2jD86Ym2EyHZOzTTMohpB3L5KbPM/1VJ96z6E99VcAA4Dl2CiqCkt8R/Yha6q/wCNnapF6M1pZvO3jS0aSgLZYfXLKT2qabUpP62D6q6I1zl6Pd+jaY206Yu05wNxTKMV5Z5IDyS2FHwCinNdG81TiYO9H2V2G23Xaoq6SG1lWyvTUJ+Fbm7hdrm8pmI26opaQEjK1rI4kAY4DmTVfPxsto3/AAXTH9k9+8qz+2bZlYtqGm2rReXZEV2M710OZHI6xheMHgeCkkcCDUJjofQAf9vp2P8Al6P81RpXUwZ8QZqdQ2oLvhnJM0dLHaL/AMF0x/ZPfvK1SelbtMcaUhq26ZYURgLEd1RHqLmKfQ6H9uHPXk7/AKej/NTY1l0TtUwIy5GmNQwbyU8RGktfBnFDwUCUk+nFFB9CT/6hi2tAUKa+1zqzXdyRO1XenrgtrPUNYCGWc89xtPAHx4nxqS+hJaWLhttMx9IUbZa3pDQIzha1JbB9SVK9tQ9frVdLFeJFovdvk264Rzh2PIRurT3HuIPYRkGpV6HOoY9h23w2Ja0oavERy3pUeQdJC2x6ygp9JFEztAgcGckNA4moG3qr6VCHSY23S9mEi22ax2uNOu85pUhS5SldSw0FboJCcFSlHOBkYwanCox247GdP7VG4T86ZJtlzghSGJkcBRLZOShaTwUnPEciD28awoDGJAZNFtyh5YdjVVy/Gy2kD/c+mP7B795WSelltGxxsumD/wCS9+8p6jofW7P+3s7H/L0f5qy/E/tmP9vLhn/8BH+atPeUPL8FZu7reaYU/pVbTZMZTUeHpyCs8nURXFqT6ApePbUO6p1FfdVXp29ajusm5z3BjrXlfIT81KRwSnwAAqbdc9FbWdniLmabusPUSEAkxij4O+R9HJKVHwJFQDMjyIct6HMjvRZTCy28w82UONqHNKkniDRVP6uc4rIWo9YAtJotaqxo6KiwgjmUKxf/ACDn1D9lZmtb/wCQc+ofspXTtGa6O7JZT6NlOkdxQSDZopxj/wCWKc3w2V88foimjso4bKNIA/8ABIv+GKco4muUk+YrqWfKF6RNlfPH6NGZsn54/RquPSV24TNLXyLpbRUlpVzhSG5F1kcFISEnIielXnnsGBzziZdner7TrvSEHU1nJDEoEOsqOVx3k8FtK8Un2jB7asdA9jA8jIqLZWucWg5hQT0xdmhdbVtKskYBaAG7402nmnkiTgdo4JV4bp7DVXxzrppIYYkx3Y0llt9h5Cm3WnBlLiFDCkkdoIOKoZt62cu7N9bLgMIdXZJ28/aX1cfi8+U0T89BOPEbprTw+o2hu3ajRZtfT2+I3tUfLSFIKVDIIwatv0dukJEmWiJpLXNybg3OOkMw7nIOGZiBwSlxR+Q6OWTwV3g1UfJoKAI4jIPA5oyenbM2zkFT1LoXXauoCZkpbaXErSpChlKkgFKh3gjgaP4XK+d+rXNrT2r9W6dZ6mwaovNsZ/oo8tQb/ROQPZSuNrO1EHhr/UH94H3VmnDH3yK0hiUdswuhpmS/nfq0Qmyf6QH82ueydre1JKgU6/v2Rx4vA/sq2vRq1veNe7MxdL+EuXKFNXCdkoQECSEpCgvA4BWFYOOGRVE9E+Fu0Tkr4Ktkxs1enpA7N4m0vSLwSy0jUUBtTlrlBICioDJZUe1C+XgcGqHNLfYeQ60t2NIZcCkqB3VtOJPAjuUkj2iumqDurSRkEEGufG22Czbdser4UdISyi7OqSkDAG9hRHtUaKw2Qm7ChcRjAAeNVafYR0gLdrG2xbJqWdGtWqG0hs9bhDE/HntqPALPag9vLIqavhMwcyR+ZXLxaUrSQpIUO4inHYdea6sbKWLPrK/QmE/JaRMUpCfQFZAqUuGhxuw2UYsSsLPC6P8AwuX879WgZcsef+rXPRW1vakf/j+/ep8fdW2Nti2rR3kOta+vJUg5AdUlxB9KSnBHhVXsuTmFd7SiXQMzpQ/nB+iKgvpYbNWNV6WkaztkZCdQWhkuPltODMip+UhXepA8pJ54BHbUhbI9TStZ7MrDqifFRFlz428+hAwgrSopKkjsSrdyB406wy3IC4zqQpt5Cm1pPIpUkgj30ExzoJLjUIx7RKyx0K5j8CAQcg8QaPFbZrSI06VGbz1bL7jaPQlRA+ytWa6cG65gtsbIY4Vrf/IOfUP2VnWL35Bz6h+ykk3VdFtlg/8AZbpLj/uWL/histp9znWXZlqe8Wx7qJ0K1vvR3cAltYTwUAe0UWylClbK9JHycfgWLzUP6MV5ttaCNjWsvk/+DSOSgfNrlxnLY8/NdPpH2Lnopa3cvOuLddcJW4taipS1HiVEnmSSTmpS6Nm03+DzWRjXV9SdN3dSWp+TwjOckSB6M4V9E+AqLG/ySfqj7KBAIwQCDwI766SSNsjS06LnY5THJtBdOc8ilSVJIBCknIIPIg91NHa3oS3bRdEytOzShmRnroEsjJjSAPJV9U/JUO0E1EnRD2pC525vZ3f5ebhDb/1O84rjIYHNjJ5rR5venh5tWKSCHEggg5HOuckY+CS3ELoWObMy40K5oXq3zbLdptpujQjzYD62JLZOQhaDhXHtHDnU57G+jnN1Pao2oNZTpNotslAcjQo6QJTyDxC1qUMNpI4gYKiOPCm01ZIepelxIslySlyHJ1O+qQhXJaG1KWUnwO6AavEpCion4sdwChge+tOsq3sa1rdSLrPpKRjnFzuCiBHRv2SobCVWi6OED5Srm5k+nFD8XHZJn/we5/8AU3Kl8tq70fpj76Lq1fQ/TH31m+sS/Ue9aG5j+kKIfxcdknbZ7of/ANm5Ul6aslo03Y4tksNvZt9uipKWWGhwGTkkk8SoniSeJpT6tXZu/pj76SNTaj07piAudqK+262R0DJU/ISFHwCR5Sj4AVF0kkmRJKdrGMzAsvbcZ8O1W6Vdbi+liFDZXIkOqOAhtAyT7BXOPVd5e1Jqu76gebWHbpOckhsDKhvq8lOO/G6Md9Sz0h9t69dsq0zplt+JppKwp911O47cFJOU5T5jQPEJPEnBOMYpG6KljiX3bbaUTW0utQGnrgEKxuqcbA6vOe5SgfSBWrSwmnjdI/VZlTKJ5GxNKkLZZ0ZBMtjN02hT5cNx5IWi1QlBLjYPEdc4QcK+inl2nNSR+Ljsjxj8DXL0/hN3NS2UKzklJJ55WPvrIIV9H9MffWc+rmeb7VloNpomiwaoh/Fx2Sdtnuf/AFJysmujnsjQ6lxVinvBJBLblydKFeBGeIqXOrV3o/TH30XVK+h+mPvqPrMv1HvUtzGP9QtEWPHhxGYkOO1GjMNpaZZaSEobQkYCUgcgBSNtE1NF0boS86lmLCUwoqi0kni48obraB4lRFY6y1rpHR8FcvUmobfBSkZDXWhby/BLacqUfVVN9vO12ftLubUWNHdt2nILhXEiLV8Y8vGOudxw3sckjgkHtJJqympnTOzGSrqKhsTeqi8FZG84d5xWVLPeonJ95o8GjoGuisucJubrGjAz2ZoqMcKcJl7JbN2iQokuUm4sQ5ScxX1laWnQDjyFfJOCCMDlXn+ESd0pMmSUngUl1RBHiM1Yrob6utsx64bKtUsRZ1suYXJtzMtAW31mPjWcK4eUPLA7wrvpg9JPZr/Btr9Ue3tOCwXNJkW1RJPV4PxjGTzKSQR9FQ7jQrZxvTE4WPDqjnQHdCRrslF/ooYoGjolBhBCltuIcbWttxtQWhaFFKkKHIgjiCO8U9om17anFZQyzr6+dWgYSFvBZA9KgSfXTJ7M0Kg5jXfMLqxsj2/KV6bpcJ9zusm7T5Tr8+U6p5+QTurWtRyVZGOJ8K0ddJ/rUn+2V99e+y2S7Xlzdt0F15OcF0jdbT6VHhT1tuzQlIVc7pg/0cZGcfnK+6kXtbqs6rxWmpMpZLHlqe4adqjz4RJx/K5P9sr76MSJX9bk/wBsr76lE6E0q15LsiapXhI4+wCmrqy2aTt6Vt265TlyxwDJSlaAfFXAj30zXtdwQ9LjkNVIGRhx7DbzTX+ESh/73J/tlffWlSQtzrF5Wv5yyVH2ms3MDysgDtNLNj0vfLuAuJBWhk/zz3kI9WeJ9VSyC1Jp2Qt2pXWHUpFPKsm3FtEqbdcaPIqQspOPSKkq1bM46QFXW4uPHtbjJ3U+tR4+wCnDE09pa1kFu3wwsec6esX781Ayt4Zrn5/SajjdaK7z0FvHP8KGWly3jhp6Y6foOLV9hr2N27UDgy1DvCx4JdxU1IucNkbjCFbo5BtvdFYqvjKexQ9LiR+2m2zyQbvSmoPyQ97v0FC7lt1C2MqhXhI+q5XifVPYOH3J7R+mpxP21Oib22s8ErP1XAaTdX6oZtdidW1lUx4FuO24jPE81egD9lNtm+isp/SSrkkbHuLk5ZOP8FQqEJ3yvGVHmo8SfXXojRZUliTIjRX3mIid+S6hslDKcgZWrkniQOPfUgdHfZyvaTtFYt0tDhssFIlXVxJIyjPktZHIrVw78BR7Kkfpials9qTbtk+kYcS3W2BuTLkzEQEILmPimiBzwPLOe0oqLp7SiJoufBdo2C8ZkeclXOixQFA0UgkKKgKFMnXqts2ZbLlFudukLizojyX4zyObbiTlJ9vuq7Tf4D6SmwfcUtqFe2CN7HEwJ6Bz7y2oH1oV38qOA099i+0a67M9ZtXyElciC8A1coST/KGc8x9NPEpPpHImhKqAyAOZ8w0R1JOGHZdoU073a7lZLzMs13iLiXGC8pmSyrzVju7weYPaCDTitehLhdIDM6Fc7a5HdGQcqBSe1JGOBHdVptuGzWybbNGwtf6BlRnryI+9HcB3UT2h/MufNcScgE8UnIPDlU2w3u8aSuUuK5GW24lZalQpKSkocTw4jmlQ99PT1BmblkRqEBjFLVRMvSkX4XtY9Oh5JwxNmL28DMvLQT2pZZJPtJpw2zRWmrZhx9gy3E8ly15HqSOH201l7SLgocYDQH0XCP2V4pGt7g6ctxI6D3qKlmrC151K5OSjxyp92R9h0IHgpNeuTLaQ1Fb3wOAAG6kegU3r7qeJDSUy5u+52R2eKvXjl66j2dfrtM+LdnOAK4dW15APhgcTXtsujL9cylYi/A2FcS9J8n1hPM+6n3bW5lNHgFPSDeVcgA8e0+QWm86mnzwptpXwSOeaGz5Sh4q+6t+nNH3i84dS0IcRX8++CN4fRTzPuFSFYNHWSzITIdQJslHEvyAN1J70p5D3mlOXdE8Uxhvq+erl6hTF/wBKhN6QNjaYcPjsPqI8v57kmWfSFgsqEvuNJlPp49fJwQD9FPIe80pP3VJOGEFePOVwApvX++RYCesnvqceIyhpPFavV2DxphXu/wA+5koUvqIyjgMtk8fSeaqbd7RzQtLhNViLt7M4kczp2f0BPe+axhxiptUlyU6OHVR/kg+J5fbTSnavuT5IjIZio8E76vaeHur06e0LeLolLskJt8ZQ4F1OXFDwR9+KdbentD6eSk3F+O8+OZmPBRJ8Gx91Tu1oyWiH4VQndsaZX8gL/rxKjZUu6XBzjJmSiexBUr3JrcmwX15O8mzT157epP7alNrWmlGEhpmcG0DgA1FUlPuFek6s02IrkoXhhSWxlSBnrD4BJ4k1HeHkk/HK2PKOkLR1B8gFD8y03e3M9fKt0yK2CB1i2ykZPIZrVCjXW+XWHa4DUi4T5TiWIjAUVKWpR4JGeQ7SeQAJpX1XqK56rubMZhh7qS4G4cFoFa1rJwOA+Us+7sq1OwXZlaNjekpe0XaG/Hi3j4MVOFZCk25k/wA0jHynVcASOZwkeNdROIm34nQLrcMhnqGB1Q0NPG3DpfnzSrBZsXRq2ErfkFmbfZJ3l4ODPnKTwQO0NoHsSknmapPdrhPu90l3W6SVSp815T8l5XNa1HJPo7AOwAU8dt20m57TtZrvMlC41tjhTNshKP5BrPFSuzrF4BV3cB2UxM0qSAxguf8AMdUTWVAedhnyhA0AKFGKLCCRYoYoc6GKSRQ4UATRUYpinCkrYXtbvWy6+KLSXLhYJSwZ1u3sEnl1rWeCXAOfYoDB7CLH7TNm2i9vWlmda6IucVi9qbw3MCSEv4H5GSgcQocs/KT4jhVJyac+zXX2p9nl+/C+mpxZKyBJiugqjykjzXE9/coYI76DnpiXbyM2d4o+CqAG7kF2pO1fpu/aRvj1j1HbHrdPaz5DgylxPzkK5LSe8UuaSOhJIS3dYz8aWMZL0hRZcPgRy9B9tWj03tG2T7erG1pfWNvYgXgjKIctYSoLxxXGf4ZPgMK7xUWbU+i5qmxF2fomT/pFbxk/BHSluY2O4cku/qnwNQZVg+5L7rkPX4UaiP4TyBzabH9pOhCwW1IVboEdokcFtMjJ/ONZvXZ1fBpoJz5yzk1Drc6+6bnrt74l2+Q2fjIctooIP1FDPsr1ydWXt3IElDAPY02B9uTRAjvnquJl9GJt5cu2urib+fmpGuMxDLRfnyktoHa4rA9Qpo3rV4ALNpSc8uvcT/2p/afZTQfkPSXeskOuOrPnOKJI9vKnTpyy6ZJS/etRwlDn8GYcIH5yyB7B7ancNGaObhdLQM3k93nkAbdw87BJFltF11FPWmIhb6ycvSHVHcR4qV+wcakWHatN6HtybhcXEyJp4IdWgFa1fNaR2en2mtN21rY7Lb0Q7C2xLWlPxbbI3WW/FR7T4DjUaXW4zLpOXNnyFPvr4bx4BI+akdg8KiLu6BMGVuLm0gMUPLRzv1+Oh1S/ftZ3q9vGPELkKOs7qWY5JcX9ZQ4n0DFa4Gjrk+jrpTjUIHirf8pfr7vWa89pvkWzRv8AV9v66YsYckvq5eCUjkPXxrySLletQzEQEfCZr7hwiJFbKio9wQnifXUwAFoRU08fwaRgjZztcns/7Z/ZbbvDtEJJbjXRydIB47jQDY9Ks8fVWGnLDedT3pmy6ftsi5XB75DDKckD5yjySkdqjgVMuy3ow6v1Ctmbq9w6ZthweoGFzXB3BPFLfpVk+FS7qLXOyfo/WF3T2lYLE6+EZVDjuBbzi+xUl453R4Hj3JoWStAOxENpy36age1l5nm3M2v+LLTsq2XaQ2G6cd11r+5w3b0235UhQy1EyPyUdJ4qWeW9jeVyAAqu+3va9edqN7Sncdt+nobhMGAVcVHl1zuOBXjkOSQeHHJpt7SNfao2hX43fU08vFBPwaI1lMeKk+a2jv71HKj302Sc0oKYh28kN3eCnUVQLd3FkER9NAYoUBx4Uas8IHnQFDkaHbSCSKj7KKj7KdMio88aGRQNJIIGgaFCoqSIpChhQzg5Hge+pb2Y9IDaDopLcN2ajUFrRwEW4qJWgdyHh5Q9e8PColHOgai+JkjbOF1KOZ8Zu0q5ULbdsQ2lQ27fr6zMW59Xk7l2jBxsH6D6Qcek7tY3Lo2bKNWRvh2idRSLelY3kmFLTLY/RUSR6lCqb863QJEm3v8AX26XIhP/ANJGdU0r2pIoP1Is/wATyEcK5r8pW3Vibv0R9WsKWq06rs01A+SJDLjCj7N8U3H+jFtZQvCItkdHzk3DA96RTNs+2DalaUpRD11eShAACH3EvjH/AJgNOVjpKbYGkbqr9Ae8XLa1n3YpbNY3iCkHUh4EL3MdGDaw4oJXHsbI7VLuBI9yTTjtXRI1e8pJumq7LDSflBhlx5Q9u6KaDnSW2vrGBfLc34otjf7c03bxtm2q3XeErXV1bSoEFEUoYGD9QA0tmsPEBPtUg0BKsPbOjJsy0zH+H611NLntoGVfCZKIUf1hJBP6VbpO2XYVsvhrgaFtUe4yUjBRZ44CVH6b6sA+1RqnV0mzrq/191ny7g78+W+p1X6xNaOQGKQoi/8AyvJSNc1g+G2ymDaZ0h9oOskOwoclGnLWvgWLes9ctPct4+V+iE1EHIqPHKiSok5JJ5kntPjQzkYojRccTIxZgsgpJnyG7jdHwoudFRirAqibodtDjR0VK6VkKFCjpwmIsv/Z';

// ============================================================
// STORAGE LAYER
// ============================================================
const DB = {
  _get(k, def) { try { return JSON.parse(localStorage.getItem('kss_' + k)) || def; } catch { return def; } },
  _set(k, v) { localStorage.setItem('kss_' + k, JSON.stringify(v)); },
  _cache: { activeSession: undefined },
  
  get athletes() { return this._get('athletes', []); },
  set athletes(v) { this._set('athletes', v); },
  
  get spots() { return this._get('spots', ['Parguito', 'El Tirano', 'Los Caracas', 'Playa El Agua']); },
  set spots(v) { this._set('spots', v); },
  
  get sessions() { return this._get('sessions', []); },
  set sessions(v) { this._set('sessions', v); },
  
  get activeSession() {
    if (this._cache.activeSession === undefined) {
      this._cache.activeSession = this._get('active_session', null);
    }
    return this._cache.activeSession;
  },
  set activeSession(v) {
    this._cache.activeSession = v;
    this._set('active_session', v);
  },
  
  // Flush in-memory activeSession to localStorage (call after mutations)
  saveActive() {
    if (this._cache.activeSession !== undefined) {
      this._set('active_session', this._cache.activeSession);
    }
  },
  
  get coach() { return this._get('coach', { name: 'Coach' }); },
  set coach(v) { this._set('coach', v); },
  
  get judgeHeat() { return this._get('judge_heat', null); },
  set judgeHeat(v) { this._set('judge_heat', v); },
  
  get judgeTracker() { return this._get('judge_tracker', {}); },
  set judgeTracker(v) { this._set('judge_tracker', v); },

  get labFrames() { return this._get('lab_frames', []); },
  set labFrames(v) { this._set('lab_frames', v); },

  get templates() { return this._get('templates', []); },
  set templates(v) { this._set('templates', v); },

  get customDrills() { return this._get('custom_drills', []); },
  set customDrills(v) { this._set('custom_drills', v); },

  genId() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 7); }
};

// ============================================================
// VIEW ROUTER
// ============================================================
let currentView = 'home';
let sessionTimer = null;
let sessionStartTime = null;

function showView(id) {
  // Session bar visible across all views during active session
  const s = DB.activeSession;
  
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  const el = document.getElementById('view-' + id);
  if (el) el.classList.add('active');
  
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  const nav = document.querySelector(`.nav-btn[data-view="${id}"]`);
  if (nav) nav.classList.add('active');
  
  currentView = id;
  
  // Close any open modals
  document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
  
  // Clean up hub timer when leaving hub
  if (id !== 'session-hub' && typeof hubTimerInterval !== 'undefined' && hubTimerInterval) {
    clearInterval(hubTimerInterval);
    hubTimerInterval = null;
  }
  
  // Lifecycle hooks
  if (id === 'home') renderHome();
  if (id === 'athletes') renderAthletes();
  if (id === 'player-card') renderPlayerCard();
  if (id === 'drills') renderDrillBank();
  if (id === 'lab') renderLab();
  if (id === 'settings') renderSettings();
  if (id === 'session-setup') renderSessionSetup();
  if (id === 'session-hub') renderSessionHub();
  if (id === 'tactical') renderTactical();
  if (id === 'overview') renderOverview();
  if (id === 'debrief') renderDebrief();
  if (id === 'judge') renderJudge();
  if (id === 'workout') renderWorkout();
  if (id === 'history') renderHistory();
  if (id === 'session-detail') renderSessionDetail();
  if (id === 'progress') renderProgress();
  if (id === 'analytics') renderAnalytics();
  if (id === 'beginner') renderBeginner();
  
  // Session bar
  updateSessionBar();
}

function updateSessionBar() {
  const bar = document.getElementById('sessionBar');
  const s = DB.activeSession;
  if (s) {
    const sizeNames = { 1: 'Flat', 2: '1-2ft', 3: '2-4ft', 4: '4-6ft', 5: '+6ft' };
    bar.querySelector('#sbInfo').textContent = `${s.spot} ¬∑ ${sizeNames[s.wave_size] || ''} ¬∑ ${s.wind_condition}`;
    bar.classList.add('active');
    if (!sessionTimer) startSessionTimer();
  } else {
    bar.classList.remove('active');
  }
  
  // Dynamic nav: swap Home/Athletes for Hub/Track during session
  updateNavBar(!!s);
}

function updateNavBar(hasSession) {
  const nav = document.querySelector('.bottom-nav');
  if (!nav) return;
  const btns = nav.querySelectorAll('.nav-btn');
  
  if (hasSession) {
    // Slot 0: Hub (was Home)
    btns[0].setAttribute('data-view', 'session-hub');
    btns[0].onclick = () => showView('session-hub');
    btns[0].querySelector('svg').innerHTML = '<path d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>';
    btns[0].lastChild.textContent = 'Hub';
    
    // Slot 1: Track (was Athletes)
    btns[1].setAttribute('data-view', 'tactical');
    btns[1].onclick = () => showView('tactical');
    btns[1].querySelector('svg').innerHTML = '<path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>';
    btns[1].lastChild.textContent = 'Track';
  } else {
    // Restore defaults
    btns[0].setAttribute('data-view', 'home');
    btns[0].onclick = () => showView('home');
    btns[0].querySelector('svg').innerHTML = '<path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0a1 1 0 01-1-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 01-1 1"/>';
    btns[0].lastChild.textContent = 'Home';
    
    btns[1].setAttribute('data-view', 'athletes');
    btns[1].onclick = () => showView('athletes');
    btns[1].querySelector('svg').innerHTML = '<path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>';
    btns[1].lastChild.textContent = 'Atletas';
  }
  
  // Highlight active
  nav.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  const active = nav.querySelector(`.nav-btn[data-view="${currentView}"]`);
  if (active) active.classList.add('active');
}

function startSessionTimer() {
  const s = DB.activeSession;
  if (!s) return;
  sessionStartTime = new Date(s.started_at);
  sessionTimer = setInterval(() => {
    const diff = Math.floor((Date.now() - sessionStartTime.getTime()) / 1000);
    const m = String(Math.floor(diff / 60)).padStart(2, '0');
    const sec = String(diff % 60).padStart(2, '0');
    document.getElementById('sbTime').textContent = `${m}:${sec}`;
  }, 1000);
}

function stopSessionTimer() {
  if (sessionTimer) { clearInterval(sessionTimer); sessionTimer = null; }
}

// ============================================================
// HOME
// ============================================================
function renderHome() {
  const sessions = DB.sessions;
  const athletes = DB.athletes;
  const s = DB.activeSession;
  const templates = DB.templates;
  
  // Greeting based on time
  const hour = new Date().getHours();
  const greeting = hour < 12 ? 'Buenos d√≠as' : hour < 18 ? 'Buenas tardes' : 'Buenas noches';
  const coach = DB.coach;
  document.getElementById('homeGreeting').textContent = `${greeting}${coach.name !== 'Coach' ? ', ' + coach.name : ''}`;
  
  // If active session, change button
  const btn = document.getElementById('homeStartBtn');
  if (s) {
    btn.textContent = 'üèÑ Volver a Sesi√≥n';
    btn.onclick = () => showView('session-hub');
  } else {
    btn.textContent = '‚ö° Nueva Sesi√≥n';
    btn.onclick = () => startNewSession();
  }
  
  // KPIs
  const kpiDiv = document.getElementById('homeKPIs');
  if (sessions.length > 0 || athletes.length > 0) {
    kpiDiv.style.display = 'grid';
    const totalWaves = sessions.reduce((sum, s) => sum + Object.values(s.athlete_data || {}).reduce((a, d) => a + (d.caught || 0), 0), 0);
    const totalHeats = athletes.reduce((sum, a) => sum + (a.heat_history || []).length, 0);
    
    kpiDiv.innerHTML = [
      { val: sessions.length, lbl: 'Sesiones', color: 'var(--accent)' },
      { val: totalWaves, lbl: 'Olas', color: 'var(--green)' },
      { val: totalHeats, lbl: 'Heats', color: '#a855f7' },
    ].map(k => `<div class="dash-kpi"><div class="dash-kpi-val" style="color:${k.color}">${k.val}</div><div class="dash-kpi-lbl">${k.lbl}</div></div>`).join('');
  } else { kpiDiv.style.display = 'none'; }
  
  // Analytics button
  const anlBtn = document.getElementById('homeAnalyticsBtn');
  if (anlBtn) anlBtn.style.display = (sessions.length > 0 || athletes.length > 0) ? 'block' : 'none';
  
  // Athletes strip
  const athSection = document.getElementById('homeAthSection');
  if (athletes.length > 0) {
    athSection.style.display = 'block';
    document.getElementById('homeAthStrip').innerHTML = athletes.map(a => {
      const initials = a.name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
      const lvl = calcLevel(a.xp_total || 0);
      return `<div class="dash-ath-chip" onclick="openPlayerCard('${a.id}')">
        <div class="dash-ath-avi">${initials}</div>
        <div class="dash-ath-name">${a.name.split(' ')[0]}</div>
        <div class="dash-ath-stat">${LEVEL_NAMES[lvl.level]}</div>
      </div>`;
    }).join('');
  } else { athSection.style.display = 'none'; }
  
  // Templates
  const tplSection = document.getElementById('homeTplSection');
  if (templates.length > 0) {
    tplSection.style.display = 'block';
    document.getElementById('homeTplList').innerHTML = templates.slice(0, 3).map(t => {
      const athNames = (t.athlete_ids || []).map(id => {
        const a = athletes.find(x => x.id === id);
        return a ? a.name.split(' ')[0] : '?';
      }).join(', ');
      return `<div class="tpl-card" onclick="loadTemplate('${t.id}')">
        <div class="tpl-card-name">üìã ${t.name}</div>
        <div class="tpl-card-meta">üìç ${t.spot} ¬∑ üåä ${t.wave_size || '?'}ft ¬∑ ${athNames || 'Sin atletas'}</div>
      </div>`;
    }).join('');
  } else { tplSection.style.display = 'none'; }
  
  // Needs Attention
  const attSection = document.getElementById('homeAttentionSection');
  if (athletes.length > 0 && sessions.length >= 2) {
    const alerts = [];
    athletes.forEach(a => {
      // Declining catch ratio
      const athSessions = sessions.filter(s => s.athlete_data && s.athlete_data[a.id]).slice(-3);
      if (athSessions.length >= 2) {
        const ratios = athSessions.map(s => {
          const d = s.athlete_data[a.id];
          return d.paddled > 0 ? d.caught / d.paddled * 100 : 0;
        });
        const trend = ratios[ratios.length - 1] - ratios[0];
        if (trend < -15) {
          alerts.push({ icon: 'üìâ', text: `${a.name.split(' ')[0]}: catch ratio cay√≥ ${Math.abs(Math.round(trend))}% en √∫ltimas sesiones`, color: 'var(--red)' });
        }
      }
      // Pain reported
      const bio = a.biometrics || [];
      if (bio.length > 0) {
        const last = bio[bio.length - 1];
        if (last.pain === 'moderate' || last.pain === 'severe') {
          alerts.push({ icon: 'ü©π', text: `${a.name.split(' ')[0]}: report√≥ dolor ${last.pain === 'severe' ? 'severo' : 'moderado'}${last.painZone ? ' en ' + last.painZone : ''}`, color: 'var(--yellow)' });
        }
      }
      // Low energy
      if ((a.biometrics || []).length > 0) {
        const last = a.biometrics[a.biometrics.length - 1];
        if (last.energy <= 4) {
          alerts.push({ icon: 'üîã', text: `${a.name.split(' ')[0]}: energ√≠a baja (${last.energy}/10)`, color: 'var(--yellow)' });
        }
      }
    });
    
    if (alerts.length > 0) {
      attSection.style.display = 'block';
      document.getElementById('homeAttention').innerHTML = '<div class="card" style="padding:10px 12px">' +
        alerts.slice(0, 4).map(a => `<div style="display:flex;gap:8px;align-items:center;padding:6px 0;font-size:13px;border-bottom:1px solid var(--border)"><span>${a.icon}</span><span style="color:${a.color}">${a.text}</span></div>`).join('') + '</div>';
    } else { attSection.style.display = 'none'; }
  } else { attSection.style.display = 'none'; }
  
  // Activity Feed
  const feedSection = document.getElementById('homeFeedSection');
  if (sessions.length > 0) {
    feedSection.style.display = 'block';
    const feed = [];
    
    // Last 5 sessions (module-aware)
    sessions.slice(-5).reverse().forEach(s => {
      const d = new Date(s.date || s.started_at);
      const dateStr = new Intl.DateTimeFormat('es', { day:'numeric', month:'short' }).format(d);
      const mods = s.modules_used || [];
      const hasTac = !s.modules_used || mods.includes('tactical');
      const athCount = Object.keys(s.athlete_data || {}).length;
      
      let detail;
      if (hasTac) {
        const totalCaught = Object.values(s.athlete_data || {}).reduce((a, d) => a + (d.caught || 0), 0);
        const totalPaddled = Object.values(s.athlete_data || {}).reduce((a, d) => a + (d.paddled || 0), 0);
        const ratio = totalPaddled > 0 ? Math.round(totalCaught / totalPaddled * 100) : 0;
        detail = `${athCount} atletas ¬∑ ${totalCaught} olas ¬∑ ${ratio}% catch`;
      } else {
        const modLabels = mods.map(m => m==='judge'?'‚öñÔ∏è Judge':m==='workout'?'üí™ Workout':m==='biomech'?'ü¶¥ Bio':m).join(', ');
        detail = `${athCount} atletas ¬∑ ${modLabels || 'sesi√≥n'}`;
      }
      feed.push({ icon: 'üèÑ', text: `<strong>${s.spot}</strong> ¬∑ ${detail}`, time: dateStr });
    });
    
    // Last 3 heats from athletes
    const allHeats = [];
    athletes.forEach(a => (a.heat_history || []).forEach(h => allHeats.push({ ...h, athlete: a.name })));
    allHeats.sort((a, b) => new Date(b.date) - new Date(a.date));
    allHeats.slice(0, 3).forEach(h => {
      const dateStr = new Intl.DateTimeFormat('es', { day:'numeric', month:'short' }).format(new Date(h.date));
      const pos = h.position === 1 ? 'ü•á' : h.position === 2 ? 'ü•à' : h.position === 3 ? 'ü•â' : `${h.position}th`;
      feed.push({ icon: '‚öñÔ∏è', text: `<strong>${h.athlete.split(' ')[0]}</strong> ¬∑ Heat ${h.heat_number || '?'} ¬∑ ${pos} ¬∑ ${h.total.toFixed(1)}pts`, time: dateStr });
    });
    
    document.getElementById('homeFeed').innerHTML = feed.slice(0, 6).map(f =>
      `<div class="dash-feed-item"><span class="dash-feed-icon">${f.icon}</span><div><div class="dash-feed-text">${f.text}</div><div class="dash-feed-time">${f.time}</div></div></div>`
    ).join('') || '<div style="font-size:12px;color:var(--text-muted);text-align:center;padding:8px">Sin actividad reciente</div>';
  } else { feedSection.style.display = 'none'; }
  
  // Empty state
  document.getElementById('homeEmpty').style.display = sessions.length === 0 && athletes.length === 0 ? 'block' : 'none';
}

// ============================================================
// SESSION CREATOR
// ============================================================
function startNewSession() {
  if (DB.athletes.length === 0) {
    openAddAthleteModal();
    return;
  }
  showView('session-setup');
}

function renderSessionSetup() {
  // Spots dropdown
  const spotSel = document.getElementById('ssSpot');
  const spots = DB.spots;
  spotSel.innerHTML = spots.map(s => `<option value="${s}">${s}</option>`).join('');
  
  // Pre-select last used spot
  const sessions = DB.sessions;
  if (sessions.length > 0) {
    spotSel.value = sessions[sessions.length - 1].spot;
  }
  
  // Athletes
  renderSSAthletes();
}

function renderSSAthletes() {
  const container = document.getElementById('ssAthletes');
  const athletes = DB.athletes;
  const sessions = DB.sessions;
  
  // Pre-select from last session
  const lastAthletes = sessions.length > 0 ? Object.keys(sessions[sessions.length - 1].athlete_data) : [];
  
  if (!window._ssSelected) {
    window._ssSelected = new Set(lastAthletes.length > 0 ? lastAthletes : athletes.map(a => a.id));
  }
  
  container.innerHTML = athletes.map(a => {
    const sel = window._ssSelected.has(a.id);
    const initials = a.name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
    const discIcons = getAthleteDisciplines(a).map(d => getDisciplineInfo(d).icon).join('');
    return `<button class="athlete-chip ${sel ? 'selected' : ''}" onclick="toggleSSAthlete('${a.id}',this)">
      <span class="avi">${initials}</span>${a.name.split(' ')[0]} <span style="font-size:11px">${discIcons}</span>
    </button>`;
  }).join('');
  
  const cnt = window._ssSelected.size;
  document.getElementById('ssAthCount').textContent = cnt > 0 ? `‚úì ${cnt} atleta${cnt > 1 ? 's' : ''} ¬∑ +${cnt * 10} XP` : 'Selecciona al menos 1 atleta';
}

function toggleSSAthlete(id, el) {
  if (window._ssSelected.has(id)) { window._ssSelected.delete(id); el.classList.remove('selected'); }
  else { window._ssSelected.add(id); el.classList.add('selected'); }
  const cnt = window._ssSelected.size;
  document.getElementById('ssAthCount').textContent = cnt > 0 ? `‚úì ${cnt} atleta${cnt > 1 ? 's' : ''} ¬∑ +${cnt * 10} XP` : 'Selecciona al menos 1 atleta';
}

function cancelSession() {
  window._ssSelected = null;
  showView('home');
}

function launchSession() {
  const spot = document.getElementById('ssSpot').value;
  const size = getSegValue('ssSize');
  const quality = getStarValue('ssQuality');
  const wind = document.getElementById('ssWind').value;
  const crowd = document.querySelector('.sem-btn.selected')?.dataset.v || 'empty';
  const focus = document.getElementById('ssFocus').value;
  const selectedIds = Array.from(window._ssSelected || []);
  
  if (selectedIds.length === 0) { alert('Selecciona al menos un atleta'); return; }
  
  // Build athlete data
  const athleteData = {};
  selectedIds.forEach(id => {
    const ath = DB.athletes.find(a => a.id === id);
    const athDiscs = ath ? getAthleteDisciplines(ath) : ['surfboard'];
    const hasRaceDisc = athDiscs.some(d => !isDiscWaveBased(d));
    athleteData[id] = {
      paddled: 0,
      caught: 0,
      falls: 0,
      waves: [], // Array of wave objects
      race: hasRaceDisc ? { sessions: [] } : undefined,
    };
  });
  
  const session = {
    id: DB.genId(),
    spot,
    wave_size: parseInt(size),
    wave_quality: parseInt(quality),
    wind_condition: wind,
    crowd_factor: crowd,
    focus_area: focus,
    started_at: new Date().toISOString(),
    athlete_data: athleteData,
    status: 'active',
    modules_used: [], // auto-detected on close
    judge_data: null   // captured from tracker on close
  };
  
  DB.activeSession = session;
  DB.judgeTracker = {}; // Reset tracker for new session
  window._ssSelected = null;
  window._tacIdx = 0;
  window._pendingWave = null;
  
  showView('session-hub');
}

// ============================================================
// SESSION HUB
// ============================================================
let hubTimerInterval = null;

function renderSessionHub() {
  const s = DB.activeSession;
  if (!s) { showView('home'); return; }
  
  const sizeNames = { 1:'Flat', 2:'1-2ft', 3:'2-4ft', 4:'4-6ft', 5:'+6ft' };
  const qualityStr = '‚òÖ'.repeat(s.wave_quality) + '‚òÜ'.repeat(5 - s.wave_quality);
  const windNames = { glassy:'Glassy', offshore:'Off-shore', onshore:'On-shore', cross:'Cross-shore' };
  const crowdNames = { empty:'üü¢ Vac√≠o', medium:'üü° Medio', crowded:'üî¥ Lleno' };
  
  document.getElementById('hubSpot').textContent = s.spot;
  document.getElementById('hubConditions').textContent = `${sizeNames[s.wave_size]} ¬∑ ${qualityStr} ¬∑ ${windNames[s.wind_condition]} ¬∑ ${crowdNames[s.crowd_factor]}`;
  
  // Focus
  const focusCard = document.getElementById('hubFocusCard');
  if (s.focus_area) {
    focusCard.style.display = 'block';
    document.getElementById('hubFocus').textContent = s.focus_area;
  } else {
    focusCard.style.display = 'none';
  }
  
  // Athletes
  const athletes = DB.athletes;
  const ids = Object.keys(s.athlete_data);
  document.getElementById('hubAthletes').innerHTML = ids.map(id => {
    const ath = athletes.find(a => a.id === id);
    if (!ath) return '';
    const data = s.athlete_data[id];
    const caught = data.caught || 0;
    const paddled = data.paddled || 0;
    const ratio = paddled > 0 ? Math.round(caught / paddled * 100) : 0;
    const hasWaveData = paddled > 0;
    const athDiscs = getAthleteDisciplines(ath);
    const discIcons = athDiscs.map(d => getDisciplineInfo(d).icon).join('');
    const raceCount = data.race ? data.race.sessions.length : 0;
    const hasRaceData = raceCount > 0;
    
    let infoHtml = '';
    if (hasWaveData) infoHtml += `${caught}/${paddled} ¬∑ ${ratio}%`;
    if (hasWaveData && hasRaceData) infoHtml += ' ¬∑ ';
    if (hasRaceData) infoHtml += `${raceCount} üèÅ`;
    
    return `<div style="background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:13px;display:flex;align-items:center;gap:8px">
      <span class="avi" style="width:28px;height:28px;font-size:11px">${ath.name.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase()}</span>
      <span style="font-weight:700">${ath.name.split(' ')[0]}</span>
      <span style="font-size:11px">${discIcons}</span>
      ${infoHtml ? `<span style="font-size:11px;color:var(--text-secondary);margin-left:auto">${infoHtml}</span>` : ''}
    </div>`;
  }).join('');
  
  // Hub timer
  if (!hubTimerInterval) {
    const startTime = new Date(s.started_at);
    hubTimerInterval = setInterval(() => {
      const diff = Math.floor((Date.now() - startTime.getTime()) / 1000);
      const m = String(Math.floor(diff / 60)).padStart(2, '0');
      const sec = String(diff % 60).padStart(2, '0');
      const el = document.getElementById('hubTimer');
      if (el) el.textContent = `${m}:${sec}`;
    }, 1000);
  }
}

function hubEnterJudge() {
  const s = DB.activeSession;
  if (!s) return;
  
  const athletes = DB.athletes;
  const ids = Object.keys(s.athlete_data);
  
  // Reset judge heat cache so it picks up fresh data
  window._jmHeatCache = null;
  
  // Pre-populate judge surfers from session athletes (max 5)
  const h = jmGetHeat();
  const surferAthletes = ids.slice(0, 5);
  
  surferAthletes.forEach((id, i) => {
    const ath = athletes.find(a => a.id === id);
    if (ath && h.surfers[i]) {
      h.surfers[i].name = ath.name;
      h.surfers[i].athlete_id = id;
      // Pre-fill discipline from active discipline in tactical IQ or default
      const athDiscs = getAthleteDisciplines(ath);
      h.surfers[i].discipline = athDiscs.length > 1 ? getActiveDisc(id) : athDiscs[0];
    }
  });
  
  // Pre-fill location from session
  h.metadata.location = s.spot;
  
  jmSave();
  
  // Clear surfer setup init flag so dropdowns refresh with pre-selected values
  const sg = document.getElementById('jmSurferSetup');
  if (sg) delete sg.dataset.init;
  
  showView('judge');
}

function endSessionFromHub() {
  if (!confirm('¬øFinalizar esta sesi√≥n? Podr√°s revisar el debrief.')) return;
  
  // Stop hub timer
  if (hubTimerInterval) { clearInterval(hubTimerInterval); hubTimerInterval = null; }
  
  // Auto-confirm any pending wave
  if (window._pendingWave) confirmWave();
  stopSessionTimer();
  
  showView('debrief');
}

// ============================================================
// TACTICAL IQ
// ============================================================
function renderTactical() {
  const s = DB.activeSession;
  if (!s) { showView('home'); return; }
  
  const ids = Object.keys(s.athlete_data);
  if (window._tacIdx === undefined || window._tacIdx >= ids.length) window._tacIdx = 0;
  
  const currentId = ids[window._tacIdx];
  const athlete = DB.athletes.find(a => a.id === currentId);
  const data = s.athlete_data[currentId];
  
  document.getElementById('tacName').textContent = athlete ? athlete.name : 'Atleta';
  
  // Discipline picker for multi-discipline athletes
  const discs = athlete ? getAthleteDisciplines(athlete) : ['surfboard'];
  const activeDisc = getActiveDisc(currentId);
  const discInfo = getDisciplineInfo(activeDisc);
  
  // Show discipline strip if athlete has multiple disciplines
  let discPickerEl = document.getElementById('tacDiscPicker');
  if (!discPickerEl) {
    // Create it dynamically if not in DOM yet
    const tacHeader = document.querySelector('#view-tactical .tac-header');
    if (tacHeader) {
      const dp = document.createElement('div');
      dp.id = 'tacDiscPicker';
      dp.style.cssText = 'display:flex;gap:4px;justify-content:center;padding:4px 12px 0;flex-wrap:wrap';
      tacHeader.after(dp);
      discPickerEl = dp;
    }
  }
  
  if (discPickerEl) {
    if (discs.length > 1) {
      discPickerEl.style.display = 'flex';
      discPickerEl.innerHTML = discs.map(d => {
        const di = getDisciplineInfo(d);
        const isActive = d === activeDisc;
        return `<button onclick="setActiveDisc('${currentId}','${d}')" style="display:flex;align-items:center;gap:3px;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;border:1.5px solid ${isActive ? di.color : 'var(--border)'};background:${isActive ? di.color + '20' : 'transparent'};color:${isActive ? di.color : 'var(--text-muted)'};transition:all .15s">${di.icon} ${di.label}</button>`;
      }).join('');
    } else {
      discPickerEl.style.display = 'none';
    }
  }
  
  document.getElementById('tacLevel').innerHTML = athlete ? `${discInfo.icon} ${discInfo.label} ¬∑ Nivel ${athlete.level || 1} ¬∑ ${athlete.stance || 'Regular'}` : '';
  
  // Dynamic maneuver tags based on ACTIVE discipline
  const isPaddleRace = !isDiscWaveBased(activeDisc);
  const maneuvers = getManeuversForDisc(activeDisc);
  const tagContainer = document.getElementById('tacTags');
  if (tagContainer) {
    tagContainer.innerHTML = maneuvers.map(m => 
      `<button class="tag-btn${window._pendingWave && window._pendingWave.maneuvers.includes(m.id) ? ' active' : ''}" data-m="${m.id}" onclick="tagToggle(this)">${m.label}</button>`
    ).join('');
  }
  
  // Toggle wave mode vs paddle race mode
  const waveMode = document.getElementById('tacWaveMode');
  const bioMode = document.getElementById('tacBioMode');
  const raceMode = document.getElementById('tacPaddleRaceMode');
  const modeToggle = document.getElementById('tacModeToggle');
  
  if (isPaddleRace) {
    // Show paddle race toggle options
    if (modeToggle) {
      modeToggle.innerHTML = `
        <button class="seg-btn${window._tacMode === 'race' || window._tacMode === 'waves' ? ' selected' : ''}" data-v="race" onclick="tacSwitchMode('race',this)" style="flex:1;border-radius:6px;padding:8px;font-size:12px;font-weight:700">üèÅ Carrera</button>
        <button class="seg-btn${window._tacMode === 'biomech' ? ' selected' : ''}" data-v="biomech" onclick="tacSwitchMode('biomech',this)" style="flex:1;border-radius:6px;padding:8px;font-size:12px;font-weight:700">ü¶¥ Biomec√°nica</button>
      `;
    }
    if (window._tacMode !== 'biomech') window._tacMode = 'race';
    if (waveMode) waveMode.style.display = 'none';
    if (raceMode) raceMode.style.display = window._tacMode === 'race' ? 'block' : 'none';
    if (bioMode) bioMode.style.display = window._tacMode === 'biomech' ? 'block' : 'none';
    // Render race data
    if (window._tacMode === 'race') renderPaddleRaceUI(currentId, data);
  } else {
    // Restore wave/bio toggle
    if (modeToggle) {
      modeToggle.innerHTML = `
        <button class="seg-btn${window._tacMode === 'waves' ? ' selected' : ''}" data-v="waves" onclick="tacSwitchMode('waves',this)" style="flex:1;border-radius:6px;padding:8px;font-size:12px;font-weight:700">üåä Olas</button>
        <button class="seg-btn${window._tacMode === 'biomech' ? ' selected' : ''}" data-v="biomech" onclick="tacSwitchMode('biomech',this)" style="flex:1;border-radius:6px;padding:8px;font-size:12px;font-weight:700">ü¶¥ Biomec√°nica</button>
      `;
    }
    if (waveMode) waveMode.style.display = window._tacMode === 'waves' ? 'block' : 'none';
    if (raceMode) raceMode.style.display = 'none';
    if (bioMode) bioMode.style.display = window._tacMode === 'biomech' ? 'block' : 'none';
  }
  
  // Stats
  document.getElementById('tacPaddled').textContent = data.paddled;
  document.getElementById('tacCaught').textContent = data.caught;
  document.getElementById('tacFalls').textContent = data.falls;
  document.getElementById('tacWaves').textContent = data.waves.length;
  
  // Catch ratio
  const ratio = data.paddled > 0 ? Math.round(data.caught / data.paddled * 100) : 0;
  const catchEl = document.getElementById('tacCatch');
  document.getElementById('tacCatchVal').textContent = data.paddled > 0 ? ratio + '%' : '‚Äî%';
  catchEl.className = 'tac-catch ' + (ratio >= 60 ? 'good' : ratio >= 40 ? 'mid' : data.paddled > 0 ? 'low' : 'mid');
  
  // Reset eval section
  document.getElementById('tacEvalSection').style.display = window._pendingWave ? 'block' : 'none';
  if (!window._pendingWave) resetEvalUI();
  
  updateSessionBar();
}

function tacPrev() {
  const s = DB.activeSession;
  if (!s) return;
  const ids = Object.keys(s.athlete_data);
  window._tacIdx = (window._tacIdx - 1 + ids.length) % ids.length;
  window._pendingWave = null;
  // Auto-switch mode based on active discipline for this athlete
  const nextId = ids[window._tacIdx];
  const activeDisc = getActiveDisc(nextId);
  if (!isDiscWaveBased(activeDisc)) {
    if (window._tacMode === 'waves') window._tacMode = 'race';
  } else {
    if (window._tacMode === 'race') window._tacMode = 'waves';
  }
  renderTactical();
}

function tacNext() {
  const s = DB.activeSession;
  if (!s) return;
  const ids = Object.keys(s.athlete_data);
  window._tacIdx = (window._tacIdx + 1) % ids.length;
  window._pendingWave = null;
  // Auto-switch mode based on active discipline for this athlete
  const nextId = ids[window._tacIdx];
  const activeDisc = getActiveDisc(nextId);
  if (!isDiscWaveBased(activeDisc)) {
    if (window._tacMode === 'waves') window._tacMode = 'race';
  } else {
    if (window._tacMode === 'race') window._tacMode = 'waves';
  }
  renderTactical();
}

function tacCount(type) {
  const s = DB.activeSession;
  if (!s) return;
  const ids = Object.keys(s.athlete_data);
  const currentId = ids[window._tacIdx];
  const data = s.athlete_data[currentId];
  
  if (type === 'paddle') {
    data.paddled++;
    showUndoToast('Remada +1', () => { data.paddled = Math.max(0, data.paddled - 1); saveSession(); renderTactical(); });
  } else if (type === 'catch') {
    data.caught++;
    if (data.paddled < data.caught) data.paddled = data.caught; // Auto-correct
    // Show eval section for this wave
    window._pendingWave = { type: 'caught', timestamp: new Date().toISOString(), discipline: getActiveDisc(currentId), wave_type: null, wave_quality: null, selection: null, position: null, commit: null, maneuvers: [] };
    document.getElementById('tacEvalSection').style.display = 'block';
    resetEvalUI();
    showUndoToast('Atrapada +1', () => { 
      data.caught = Math.max(0, data.caught - 1); 
      window._pendingWave = null;
      document.getElementById('tacEvalSection').style.display = 'none';
      saveSession(); renderTactical(); 
    });
  } else if (type === 'fall') {
    data.falls++;
    data.paddled++;
    if (data.paddled < data.caught + data.falls) data.paddled = data.caught + data.falls;
    // Record fall wave
    data.waves.push({ type: 'fall', timestamp: new Date().toISOString(), discipline: getActiveDisc(currentId) });
    showUndoToast('Ca√≠da +1', () => { 
      data.falls = Math.max(0, data.falls - 1); 
      data.paddled = Math.max(0, data.paddled - 1);
      data.waves.pop(); 
      saveSession(); renderTactical(); 
    });
  }
  
  // Haptic
  if (navigator.vibrate) navigator.vibrate(30);
  
  saveSession();
  renderTactical();
}

function evalSet(field, el, color) {
  const parent = el.parentElement;
  parent.querySelectorAll('.eval-btn').forEach(b => b.className = 'eval-btn');
  el.classList.add('sel-' + color);
  if (window._pendingWave) window._pendingWave[field] = el.dataset.v;
  if (window._pendingBio) window._pendingBio[field] = el.dataset.v;
}

function tagToggle(el) {
  el.classList.toggle('selected');
  if (window._pendingWave) {
    const m = el.dataset.m;
    const idx = window._pendingWave.maneuvers.indexOf(m);
    if (idx >= 0) window._pendingWave.maneuvers.splice(idx, 1);
    else window._pendingWave.maneuvers.push(m);
  }
}

function confirmWave() {
  if (!window._pendingWave) return;
  const s = DB.activeSession;
  const ids = Object.keys(s.athlete_data);
  const currentId = ids[window._tacIdx];
  s.athlete_data[currentId].waves.push({ ...window._pendingWave });
  window._pendingWave = null;
  document.getElementById('tacEvalSection').style.display = 'none';
  saveSession();
  renderTactical();
  if (navigator.vibrate) navigator.vibrate([30, 50, 30]);
}

function resetEvalUI() {
  document.querySelectorAll('#tacEvalSection .eval-btn').forEach(b => b.className = 'eval-btn');
  document.querySelectorAll('#tacTags .tag-btn').forEach(b => b.classList.remove('selected'));
}

// ============================================================
// TACTICAL IQ: MODE SWITCH & BIOMECHANICS
// ============================================================
window._tacMode = 'waves';
window._bioWaveCount = 0;
window._pendingBio = null;

function tacSwitchMode(mode, el) {
  window._tacMode = mode;
  // Toggle buttons
  document.querySelectorAll('#tacModeToggle .seg-btn').forEach(b => b.classList.remove('selected'));
  if (el) el.classList.add('selected');
  
  document.getElementById('tacWaveMode').style.display = mode === 'waves' ? 'block' : 'none';
  document.getElementById('tacBioMode').style.display = mode === 'biomech' ? 'block' : 'none';
  const raceEl = document.getElementById('tacPaddleRaceMode');
  if (raceEl) raceEl.style.display = mode === 'race' ? 'block' : 'none';
  
  if (mode === 'biomech') renderBioHistory();
  if (mode === 'race') {
    const s = DB.activeSession;
    if (s) {
      const ids = Object.keys(s.athlete_data);
      const currentId = ids[window._tacIdx];
      const data = s.athlete_data[currentId];
      renderPaddleRaceUI(currentId, data);
    }
  }
}

function bioNewWave() {
  window._bioWaveCount++;
  document.getElementById('bioWaveCount').textContent = `Ola #${window._bioWaveCount}`;
  document.getElementById('bioEvalForm').style.display = 'block';
  
  // Reset all bio eval buttons
  ['bioShoulders','bioKnees','bioArms','bioCompression','bioHead','bioBackFoot','bioWeight','bioFlow'].forEach(id => {
    document.querySelectorAll(`#${id} .eval-btn`).forEach(b => b.className = 'eval-btn');
  });
  document.getElementById('bioNotes').value = '';
  
  window._pendingBio = {
    wave_num: window._bioWaveCount,
    timestamp: new Date().toISOString(),
    discipline: (() => { const s = DB.activeSession; if (!s) return 'surfboard'; const ids = Object.keys(s.athlete_data); return getActiveDisc(ids[window._tacIdx]); })(),
    bio_shoulders: null,
    bio_knees: null,
    bio_arms: null,
    bio_compression: null,
    bio_head: null,
    bio_backfoot: null,
    bio_weight: null,
    bio_flow: null,
    notes: ''
  };
  
  if (navigator.vibrate) navigator.vibrate(50);
}

function bioConfirmWave() {
  if (!window._pendingBio) return;
  const s = DB.activeSession;
  if (!s) return;
  
  const ids = Object.keys(s.athlete_data);
  const currentId = ids[window._tacIdx];
  if (!currentId) return;
  
  // Save notes
  window._pendingBio.notes = document.getElementById('bioNotes').value.trim();
  
  // Ensure biomech array exists
  if (!s.athlete_data[currentId].biomech) s.athlete_data[currentId].biomech = [];
  s.athlete_data[currentId].biomech.push({ ...window._pendingBio });
  
  window._pendingBio = null;
  document.getElementById('bioEvalForm').style.display = 'none';
  saveSession();
  renderBioHistory();
  
  if (navigator.vibrate) navigator.vibrate([30, 50, 30]);
}

function renderBioHistory() {
  const s = DB.activeSession;
  if (!s) return;
  const ids = Object.keys(s.athlete_data);
  const currentId = ids[window._tacIdx];
  if (!currentId) return;
  
  const biomech = s.athlete_data[currentId].biomech || [];
  const div = document.getElementById('bioHistory');
  
  if (biomech.length === 0) {
    div.innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:13px;padding:12px">Sin evaluaciones a√∫n. Toca "Nueva Ola" para comenzar.</div>';
    return;
  }
  
  const colorMap = { poor: 'üî¥', ok: 'üü°', good: 'üü¢', none: 'üî¥', partial: 'üü°', full: 'üü¢' };
  const scoreLabel = v => `${colorMap[v] || '‚ö™'} ${bioScore(v)}`;
  const numColor = v => { const n = parseInt(v); return n >= 4 ? 'üü¢' : n >= 3 ? 'üü°' : 'üî¥'; };
  
  div.innerHTML = '<div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px">üìã Historial Biomec√°nica</div>' +
    biomech.slice().reverse().map(b => {
      const checks = [
        b.bio_shoulders ? `Hombros ${scoreLabel(b.bio_shoulders)}` : null,
        b.bio_knees ? `Rodillas ${scoreLabel(b.bio_knees)}` : null,
        b.bio_arms ? `Brazos ${scoreLabel(b.bio_arms)}` : null,
        b.bio_compression ? `Compresi√≥n ${scoreLabel(b.bio_compression)}` : null,
        b.bio_head ? `Cabeza ${scoreLabel(b.bio_head)}` : null,
        b.bio_backfoot ? `Pie trasero ${scoreLabel(b.bio_backfoot)}` : null,
        b.bio_weight ? `Peso ${scoreLabel(b.bio_weight)}` : null,
        b.bio_flow ? `Fluidez ${numColor(b.bio_flow)} ${b.bio_flow}/5` : null,
      ].filter(Boolean);
      
      return `<div class="card" style="padding:10px 12px;margin-bottom:8px">
        <div style="font-size:13px;font-weight:700;margin-bottom:6px">üèÑ Ola #${b.wave_num}</div>
        <div style="font-size:12px;color:var(--text-secondary);display:flex;flex-wrap:wrap;gap:6px">${checks.map(c => `<span style="background:var(--bg-input);padding:2px 6px;border-radius:4px">${c}</span>`).join('')}</div>
        ${b.notes ? `<div style="font-size:12px;color:var(--text-primary);margin-top:6px;padding:6px 8px;background:var(--bg-input);border-radius:6px;line-height:1.4">üìù ${b.notes}</div>` : ''}
      </div>`;
    }).join('');
}

// ============================================================
// PADDLE RACE MODE
// ============================================================
window._raceTimer = null;
window._raceStartTime = null;
window._raceElapsed = 0;
window._raceLaps = [];
window._raceRunning = false;

function formatRaceTime(ms) {
  const totalSec = ms / 1000;
  const mins = Math.floor(totalSec / 60);
  const secs = Math.floor(totalSec % 60);
  const tenths = Math.floor((totalSec * 10) % 10);
  return `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}.${tenths}`;
}

function raceTimerToggle() {
  if (window._raceRunning) {
    // Stop
    clearInterval(window._raceTimer);
    window._raceElapsed += Date.now() - window._raceStartTime;
    window._raceRunning = false;
    document.getElementById('raceTimerBtn').innerHTML = '‚ñ∂ Resume';
    document.getElementById('raceTimerBtn').style.background = 'var(--green)';
  } else {
    // Start
    window._raceStartTime = Date.now();
    window._raceRunning = true;
    document.getElementById('raceTimerBtn').innerHTML = '‚è∏ Pause';
    document.getElementById('raceTimerBtn').style.background = 'var(--red)';
    window._raceTimer = setInterval(() => {
      const total = window._raceElapsed + (Date.now() - window._raceStartTime);
      document.getElementById('raceTimerDisplay').textContent = formatRaceTime(total);
    }, 100);
  }
}

function raceTimerReset() {
  clearInterval(window._raceTimer);
  window._raceElapsed = 0;
  window._raceStartTime = null;
  window._raceRunning = false;
  window._raceLaps = [];
  document.getElementById('raceTimerDisplay').textContent = '00:00.0';
  document.getElementById('raceTimerBtn').innerHTML = '‚ñ∂ Start';
  document.getElementById('raceTimerBtn').style.background = 'var(--green)';
  document.getElementById('raceLapList').innerHTML = '';
  document.getElementById('raceLapCount').textContent = '0';
  document.getElementById('raceBestLap').textContent = '‚Äî';
  document.getElementById('raceAvgLap').textContent = '‚Äî';
}

function raceAddLap() {
  if (!window._raceRunning && window._raceElapsed === 0) return;
  const currentTotal = window._raceRunning ? window._raceElapsed + (Date.now() - window._raceStartTime) : window._raceElapsed;
  const prevTotal = window._raceLaps.length > 0 ? window._raceLaps[window._raceLaps.length - 1].totalMs : 0;
  const lapMs = currentTotal - prevTotal;
  
  window._raceLaps.push({ lapMs, totalMs: currentTotal, num: window._raceLaps.length + 1 });
  renderRaceLaps();
}

function renderRaceLaps() {
  const laps = window._raceLaps;
  const bestMs = laps.length > 0 ? Math.min(...laps.map(l => l.lapMs)) : 0;
  const avgMs = laps.length > 0 ? laps.reduce((s, l) => s + l.lapMs, 0) / laps.length : 0;
  
  document.getElementById('raceLapCount').textContent = laps.length;
  document.getElementById('raceBestLap').textContent = laps.length > 0 ? formatRaceTime(bestMs) : '‚Äî';
  document.getElementById('raceAvgLap').textContent = laps.length > 0 ? formatRaceTime(avgMs) : '‚Äî';
  
  document.getElementById('raceLapList').innerHTML = laps.slice().reverse().map(l => {
    const isBest = l.lapMs === bestMs && laps.length > 1;
    return `<div style="display:flex;justify-content:space-between;padding:6px 8px;border-bottom:1px solid var(--border);${isBest ? 'color:var(--green);font-weight:700' : ''}">
      <span>Vuelta ${l.num}</span>
      <span style="font-variant-numeric:tabular-nums">${formatRaceTime(l.lapMs)} ${isBest ? '‚ö°' : ''}</span>
      <span style="font-size:11px;color:var(--text-muted);font-variant-numeric:tabular-nums">${formatRaceTime(l.totalMs)}</span>
    </div>`;
  }).join('');
}

function renderPaddleRaceUI(athleteId, data) {
  // Initialize race data if needed
  if (!data.race) data.race = { sessions: [] };
  
  // Render past race evals for this session
  const histDiv = document.getElementById('raceHistory');
  if (histDiv && data.race.sessions.length > 0) {
    histDiv.innerHTML = '<div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px">üìã Evaluaciones de Carrera</div>' +
      data.race.sessions.slice().reverse().map((r, i) => {
        const evalTags = [
          r.technique ? `Remada ${r.technique === 'good' ? 'üü¢' : r.technique === 'ok' ? 'üü°' : 'üî¥'}` : null,
          r.pacing ? `Pacing ${r.pacing === 'good' ? 'üü¢' : r.pacing === 'ok' ? 'üü°' : 'üî¥'}` : null,
          r.position ? `Posici√≥n ${r.position === 'good' ? 'üü¢' : r.position === 'ok' ? 'üü°' : 'üî¥'}` : null,
        ].filter(Boolean);
        return `<div class="card" style="padding:10px 12px;margin-bottom:8px">
          <div style="font-size:13px;font-weight:700;margin-bottom:4px">üèÅ Carrera #${data.race.sessions.length - i}</div>
          <div style="font-size:12px;color:var(--text-secondary);display:flex;flex-wrap:wrap;gap:4px">${
            r.laps ? `<span style="background:var(--bg-input);padding:2px 6px;border-radius:4px">${r.laps} vueltas</span>` : ''
          }${r.total_time ? `<span style="background:var(--bg-input);padding:2px 6px;border-radius:4px">Total: ${r.total_time}</span>` : ''}${
            r.best_lap ? `<span style="background:var(--bg-input);padding:2px 6px;border-radius:4px">Mejor: ${r.best_lap}</span>` : ''
          }${evalTags.map(t => `<span style="background:var(--bg-input);padding:2px 6px;border-radius:4px">${t}</span>`).join('')}</div>
          ${r.notes ? `<div style="font-size:12px;color:var(--text-primary);margin-top:6px;padding:6px 8px;background:var(--bg-input);border-radius:6px;line-height:1.4">üìù ${r.notes}</div>` : ''}
        </div>`;
      }).join('');
  } else if (histDiv) {
    histDiv.innerHTML = '';
  }
}

function raceSaveEval() {
  const s = DB.activeSession;
  if (!s) return;
  const ids = Object.keys(s.athlete_data);
  const currentId = ids[window._tacIdx];
  const data = s.athlete_data[currentId];
  
  if (!data.race) data.race = { sessions: [] };
  
  const totalMs = window._raceRunning ? window._raceElapsed + (Date.now() - window._raceStartTime) : window._raceElapsed;
  
  const raceEntry = {
    timestamp: new Date().toISOString(),
    discipline: getActiveDisc(currentId),
    laps: window._raceLaps.length,
    total_time: formatRaceTime(totalMs),
    total_ms: totalMs,
    best_lap: window._raceLaps.length > 0 ? formatRaceTime(Math.min(...window._raceLaps.map(l => l.lapMs))) : null,
    best_lap_ms: window._raceLaps.length > 0 ? Math.min(...window._raceLaps.map(l => l.lapMs)) : null,
    avg_lap: window._raceLaps.length > 0 ? formatRaceTime(window._raceLaps.reduce((s, l) => s + l.lapMs, 0) / window._raceLaps.length) : null,
    lap_splits: window._raceLaps.map(l => ({ num: l.num, ms: l.lapMs, total_ms: l.totalMs })),
    technique: getEvalValue('race_technique'),
    pacing: getEvalValue('race_pacing'),
    position: getEvalValue('race_position'),
    notes: document.getElementById('raceNotes')?.value?.trim() || '',
  };
  
  data.race.sessions.push(raceEntry);
  
  // Track modules used
  if (!s.modules_used) s.modules_used = [];
  if (!s.modules_used.includes('race')) s.modules_used.push('race');
  
  saveSession();
  
  // Reset timer & UI for next race
  raceTimerReset();
  document.getElementById('raceNotes').value = '';
  // Reset eval buttons
  document.querySelectorAll('#raceTechnique .eval-btn, #racePacing .eval-btn, #racePosition .eval-btn').forEach(b => {
    b.className = 'eval-btn';
  });
  
  renderPaddleRaceUI(currentId, data);
  
  // Visual confirmation
  const btn = document.querySelector('#tacPaddleRaceMode .btn[onclick="raceSaveEval()"]');
  if (btn) {
    btn.textContent = '‚úÖ Guardado!';
    setTimeout(() => { btn.textContent = 'üíæ Guardar Evaluaci√≥n'; }, 1500);
  }
}

function getEvalValue(name) {
  const containerMap = { race_technique: 'raceTechnique', race_pacing: 'racePacing', race_position: 'racePosition' };
  const containerId = containerMap[name];
  if (!containerId) return null;
  const sel = document.querySelector(`#${containerId} .eval-btn[class*="sel-"]`);
  return sel ? sel.dataset.v : null;
}

// ============================================================
// DEBRIEF SUMMARY HELPERS
// ============================================================
// Universal bio scoring: poor/none=1, ok/partial=50, good/full=100, empty=0
function bioScore(v) {
  if (!v) return 0;
  if (v === 'good' || v === 'full') return 100;
  if (v === 'ok' || v === 'partial') return 50;
  return 1; // poor, none, or any other value
}

function bioAvgScore(bio, field) {
  const vals = bio.map(b => b[field]).filter(Boolean);
  if (vals.length === 0) return 0;
  return Math.round(vals.reduce((sum, v) => sum + bioScore(v), 0) / vals.length);
}

function renderBioSummaryHTML(ad) {
  const bio = ad.biomech || [];
  if (bio.length === 0) return '';
  
  const fields = ['bio_shoulders','bio_knees','bio_arms','bio_compression','bio_head','bio_backfoot','bio_weight'];
  const labels = ['Hombros','Rodillas','Brazos','Compresi√≥n','Cabeza','Pie','Peso'];
  
  let summary = fields.map((f, i) => {
    const avg = bioAvgScore(bio, f);
    return `<span style="font-size:11px">${labels[i]} ${avg >= 60 ? 'üü¢' : avg >= 30 ? 'üü°' : avg > 0 ? 'üî¥' : '‚ö™'}${avg}</span>`;
  }).join(' ¬∑ ');
  
  // Average flow
  const flows = bio.map(b => parseInt(b.bio_flow)).filter(n => !isNaN(n));
  const avgFlow = flows.length > 0 ? (flows.reduce((a,b)=>a+b,0)/flows.length).toFixed(1) : '‚Äî';
  
  // Collect all notes
  const notes = bio.map(b => b.notes).filter(Boolean);
  
  return `<div style="margin-top:8px;padding:8px;background:var(--bg-input);border-radius:8px">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:4px">ü¶¥ Biomec√°nica (${bio.length} olas)</div>
    <div style="display:flex;flex-wrap:wrap;gap:4px">${summary}</div>
    <div style="font-size:12px;margin-top:4px">Fluidez promedio: <strong>${avgFlow}/5</strong></div>
    ${notes.length > 0 ? `<div style="font-size:11px;color:var(--text-secondary);margin-top:4px">${notes.map(n => `üìù ${n}`).join('<br>')}</div>` : ''}
  </div>`;
}

function renderWorkoutSummaryHTML(ad) {
  const wo = ad.workouts || [];
  if (wo.length === 0) return '';
  
  const done = wo.filter(w => w.completed).length;
  const total = wo.length;
  const goodQ = wo.filter(w => w.quality === 'good').length;
  
  return `<div style="margin-top:8px;padding:8px;background:var(--bg-input);border-radius:8px">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:4px">üí™ Workout</div>
    <div style="font-size:12px">${done}/${total} completados ${goodQ > 0 ? `¬∑ ${goodQ} buenos` : ''}</div>
    <div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:4px">${wo.map(w => {
      const icon = w.completed ? (w.quality === 'good' ? 'üü¢' : w.quality === 'regular' ? 'üü°' : 'üî¥') : '‚¨ú';
      return `<span style="font-size:11px;background:var(--bg-card);padding:2px 6px;border-radius:4px">${icon} ${w.name}</span>`;
    }).join('')}</div>
  </div>`;
}

// ============================================================
// WORKOUT MODULE
// ============================================================
window._woAssignTarget = 'all'; // 'all' or athlete id
window._woActiveCat = 'Todos';

function renderWorkout() {
  const s = DB.activeSession;
  if (!s) { showView('home'); return; }
  
  const athletes = DB.athletes;
  const ids = Object.keys(s.athlete_data);
  const container = document.getElementById('woAthleteList');
  
  let html = '';
  ids.forEach(id => {
    const a = athletes.find(x => x.id === id);
    const ad = s.athlete_data[id];
    if (!ad.workouts) ad.workouts = [];
    
    html += `<div class="wo-ath-card">
      <div class="wo-ath-name">${a ? a.name : 'Atleta'} 
        <button style="float:right;font-size:11px;color:var(--accent);font-weight:700" onclick="woAssignOne('${id}')">+ Ejercicio</button>
      </div>`;
    
    if (ad.workouts.length === 0) {
      html += `<div style="font-size:12px;color:var(--text-muted);text-align:center;padding:8px">Sin ejercicios asignados</div>`;
    } else {
      ad.workouts.forEach((w, wi) => {
        const checkClass = w.completed ? (w.quality === 'poor' ? 'fail' : 'done') : '';
        html += `<div class="wo-drill-row">
          <div class="wo-check ${checkClass}" onclick="woToggleComplete('${id}',${wi})">${w.completed ? '‚úì' : ''}</div>
          <div class="wo-drill-name">${w.name}${w.duration ? `<br><span style="font-size:10px;color:var(--text-muted)">${w.duration}</span>` : ''}</div>
          <div class="wo-quality">
            <div class="wo-q-btn ${w.quality === 'good' ? 'active' : ''}" onclick="woSetQuality('${id}',${wi},'good')" style="${w.quality === 'good' ? 'background:var(--green);color:#fff;border-color:var(--green)' : ''}">üëç</div>
            <div class="wo-q-btn ${w.quality === 'regular' ? 'active' : ''}" onclick="woSetQuality('${id}',${wi},'regular')" style="${w.quality === 'regular' ? 'background:var(--yellow);color:#fff;border-color:var(--yellow)' : ''}">üëå</div>
            <div class="wo-q-btn ${w.quality === 'poor' ? 'active' : ''}" onclick="woSetQuality('${id}',${wi},'poor')" style="${w.quality === 'poor' ? 'background:var(--red);color:#fff;border-color:var(--red)' : ''}">üëé</div>
          </div>
        </div>`;
      });
    }
    html += `</div>`;
  });
  
  container.innerHTML = html || '<div style="text-align:center;color:var(--text-muted);padding:20px">No hay atletas en sesi√≥n</div>';
  
  // Summary
  const allWorkouts = ids.flatMap(id => (s.athlete_data[id].workouts || []));
  const sumDiv = document.getElementById('woSummary');
  if (allWorkouts.length > 0) {
    sumDiv.style.display = 'block';
    const done = allWorkouts.filter(w => w.completed).length;
    document.getElementById('woSummaryContent').innerHTML = `
      <div style="font-size:14px;font-weight:700">${done}/${allWorkouts.length} ejercicios completados</div>
      <div style="height:8px;background:var(--bg-input);border-radius:4px;margin-top:8px;overflow:hidden">
        <div style="height:100%;width:${allWorkouts.length > 0 ? Math.round(done/allWorkouts.length*100) : 0}%;background:var(--green);border-radius:4px;transition:width .3s"></div>
      </div>
    `;
  } else { sumDiv.style.display = 'none'; }
}

function woAssignAll() {
  window._woAssignTarget = 'all';
  document.getElementById('woAssignTitle').textContent = 'Asignar a Todos';
  document.getElementById('woAssignTarget').textContent = 'Se asignar√° a todos los atletas de la sesi√≥n';
  woRenderLibrary();
  document.getElementById('modalWoAssign').classList.add('active');
}

function woAssignOne(athleteId) {
  const s = DB.activeSession;
  if (!s) return;
  
  if (!athleteId) {
    // Prompt to pick athlete
    const ids = Object.keys(s.athlete_data);
    const athletes = DB.athletes;
    if (ids.length === 1) { athleteId = ids[0]; }
    else {
      const names = ids.map(id => { const a = athletes.find(x => x.id === id); return a ? a.name : id; });
      const choice = prompt('Atleta:\n' + ids.map((id, i) => `${i+1}. ${names[i]}`).join('\n') + '\n\nEscribe el n√∫mero:');
      if (!choice) return;
      athleteId = ids[parseInt(choice) - 1];
      if (!athleteId) return;
    }
  }
  
  window._woAssignTarget = athleteId;
  const a = DB.athletes.find(x => x.id === athleteId);
  document.getElementById('woAssignTitle').textContent = 'Asignar Ejercicio';
  document.getElementById('woAssignTarget').textContent = `Para: ${a ? a.name : 'Atleta'}`;
  woRenderLibrary();
  document.getElementById('modalWoAssign').classList.add('active');
}

function woAssignTab(tab, el) {
  document.querySelectorAll('#modalWoAssign .seg-btn').forEach(b => b.classList.remove('selected'));
  if (el) el.classList.add('selected');
  document.getElementById('woLibraryTab').style.display = tab === 'library' ? 'block' : 'none';
  document.getElementById('woCustomTab').style.display = tab === 'custom' ? 'block' : 'none';
}

function woRenderLibrary() {
  const allDrills = [...DRILL_LIBRARY, ...DB.customDrills];
  const cats = ['Todos', ...new Set(allDrills.map(d => d.cat))];
  
  document.getElementById('woCatFilter').innerHTML = cats.map(c =>
    `<button class="drill-cat-btn ${c === window._woActiveCat ? 'active' : ''}" onclick="woFilterCat('${c}')">${c}</button>`
  ).join('');
  
  const filtered = window._woActiveCat === 'Todos' ? allDrills : allDrills.filter(d => d.cat === window._woActiveCat);
  document.getElementById('woLibraryList').innerHTML = filtered.map(d => {
    const safeName = (d.name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
    const safeDur = (d.duration || '').replace(/'/g, "\\'");
    return `<div style="padding:14px 12px;border-bottom:1px solid var(--border);cursor:pointer;-webkit-tap-highlight-color:transparent" onclick="woSelectDrill('${d.id}','${safeName}','${safeDur}')" ontouchstart="this.style.background='var(--bg-input)'" ontouchend="this.style.background=''">
      <div style="font-weight:700;font-size:14px">${d.icon || 'üèãÔ∏è'} ${d.name}</div>
      <div style="font-size:12px;color:var(--text-muted);margin-top:2px">${d.duration || ''} ¬∑ ${d.cat}</div>
    </div>`;
  }).join('');
}

function woFilterCat(cat) {
  window._woActiveCat = cat;
  woRenderLibrary();
}

function woSelectDrill(drillId, name, duration) {
  const s = DB.activeSession;
  if (!s) return;
  
  const workout = { id: DB.genId(), drill_id: drillId, name, duration, completed: false, quality: null, notes: '' };
  
  if (window._woAssignTarget === 'all') {
    Object.keys(s.athlete_data).forEach(id => {
      if (!s.athlete_data[id].workouts) s.athlete_data[id].workouts = [];
      s.athlete_data[id].workouts.push({ ...workout, id: DB.genId() });
    });
  } else {
    if (!s.athlete_data[window._woAssignTarget].workouts) s.athlete_data[window._woAssignTarget].workouts = [];
    s.athlete_data[window._woAssignTarget].workouts.push(workout);
  }
  
  saveSession();
  document.getElementById('modalWoAssign').classList.remove('active');
  renderWorkout();
}

function woAssignCustom() {
  const name = document.getElementById('woCustomName').value.trim();
  if (!name) { alert('Nombre requerido'); return; }
  const desc = document.getElementById('woCustomDesc').value.trim();
  const dur = document.getElementById('woCustomDur').value.trim();
  
  // Save to custom drills library
  const custom = DB.customDrills;
  const newDrill = { id: 'custom_' + DB.genId(), name, desc, duration: dur, cat: 'Custom', icon: '‚≠ê', level: 'Todos' };
  custom.push(newDrill);
  DB.customDrills = custom;
  
  // Assign to session
  woSelectDrill(newDrill.id, name, dur);
  
  // Reset form
  document.getElementById('woCustomName').value = '';
  document.getElementById('woCustomDesc').value = '';
  document.getElementById('woCustomDur').value = '';
}

function woToggleComplete(athId, woIdx) {
  const s = DB.activeSession;
  if (!s) return;
  const w = s.athlete_data[athId].workouts[woIdx];
  w.completed = !w.completed;
  if (!w.completed) w.quality = null;
  saveSession();
  renderWorkout();
  if (navigator.vibrate) navigator.vibrate(30);
}

function woSetQuality(athId, woIdx, quality) {
  const s = DB.activeSession;
  if (!s) return;
  const w = s.athlete_data[athId].workouts[woIdx];
  w.quality = quality;
  w.completed = true;
  saveSession();
  renderWorkout();
}

function saveSession() {
  DB.saveActive();
}

// ============================================================
// OVERVIEW
// ============================================================
function renderOverview() {
  const s = DB.activeSession;
  if (!s) { showView('home'); return; }
  
  const sizeNames = { 1: 'Flat', 2: '1-2ft', 3: '2-4ft', 4: '4-6ft', 5: '+6ft' };
  document.getElementById('ovInfo').textContent = `${s.spot} ¬∑ ${sizeNames[s.wave_size]} ¬∑ ${s.focus_area || ''}`;
  
  const athletes = DB.athletes;
  const ids = Object.keys(s.athlete_data);
  let totalPaddled = 0, totalCaught = 0;
  
  let html = '';
  ids.forEach((id, i) => {
    const a = athletes.find(x => x.id === id);
    const d = s.athlete_data[id];
    const athDiscs = a ? getAthleteDisciplines(a) : ['surfboard'];
    const discIcons = athDiscs.map(dc => getDisciplineInfo(dc).icon).join('');
    const raceCount = d.race ? d.race.sessions.length : 0;
    const hasWaveData = d.paddled > 0;
    const hasRaceData = raceCount > 0;
    
    if (hasWaveData) {
      const ratio = d.paddled > 0 ? Math.round(d.caught / d.paddled * 100) : 0;
      const color = ratio >= 60 ? 'var(--green)' : ratio >= 40 ? 'var(--yellow)' : d.paddled > 0 ? 'var(--red)' : 'var(--text-muted)';
      totalPaddled += d.paddled;
      totalCaught += d.caught;
      
      html += `<div class="ov-row" onclick="window._tacIdx=${i};showView('tactical')" style="cursor:pointer">
        <div class="ov-name">${discIcons} ${a ? a.name.split(' ')[0] : 'Atleta'}</div>
        <div class="ov-stats">${d.paddled}/${d.caught}${hasRaceData ? ` ¬∑ ${raceCount}üèÅ` : ''}</div>
        <div class="ov-ratio" style="color:${color}">${d.paddled > 0 ? ratio + '%' : '‚Äî'}</div>
      </div>`;
    } else if (hasRaceData) {
      const lastRace = d.race.sessions[raceCount - 1];
      html += `<div class="ov-row" onclick="window._tacIdx=${i};showView('tactical')" style="cursor:pointer">
        <div class="ov-name">${discIcons} ${a ? a.name.split(' ')[0] : 'Atleta'}</div>
        <div class="ov-stats">${raceCount} carrera${raceCount>1?'s':''}</div>
        <div class="ov-ratio" style="color:var(--accent)">${lastRace ? lastRace.total_time : '‚Äî'}</div>
      </div>`;
    } else {
      html += `<div class="ov-row" onclick="window._tacIdx=${i};showView('tactical')" style="cursor:pointer">
        <div class="ov-name">${discIcons} ${a ? a.name.split(' ')[0] : 'Atleta'}</div>
        <div class="ov-stats">‚Äî</div>
        <div class="ov-ratio" style="color:var(--text-muted)">‚Äî</div>
      </div>`;
    }
  });
  
  document.getElementById('ovList').innerHTML = html;
  const avgRatio = totalPaddled > 0 ? Math.round(totalCaught / totalPaddled * 100) : 0;
  document.getElementById('ovAvg').textContent = totalPaddled > 0 ? avgRatio + '%' : '‚Äî%';
  
  updateSessionBar();
}

// ============================================================
// END SESSION ‚Üí DEBRIEF
// ============================================================
function endSession() {
  if (!confirm('¬øCerrar la sesi√≥n actual?')) return;
  // Auto-confirm any pending wave
  if (window._pendingWave) confirmWave();
  stopSessionTimer();
  showView('debrief');
}

function renderDebrief() {
  const s = DB.activeSession;
  if (!s) { showView('home'); return; }
  
  const d = new Date(s.started_at);
  document.getElementById('dbDate').textContent = new Intl.DateTimeFormat('es', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }).format(d);
  
  // Conditions tags
  const sizeNames = { 1: 'Flat', 2: '1-2ft', 3: '2-4ft', 4: '4-6ft', 5: '+6ft' };
  const windNames = { glassy: 'üåÖ Glassy', offshore: 'üí® Off-shore', onshore: 'üå¨Ô∏è On-shore', cross: '‚ÜóÔ∏è Cross-shore' };
  const crowdNames = { empty: 'üü¢ Vac√≠o', medium: 'üü° Medio', crowded: 'üî¥ Lleno' };
  
  let tags = `<span class="db-tag">üìç ${s.spot}</span>`;
  tags += `<span class="db-tag">üåä ${sizeNames[s.wave_size]}</span>`;
  tags += `<span class="db-tag">${'‚≠ê'.repeat(s.wave_quality)}</span>`;
  tags += `<span class="db-tag">${windNames[s.wind_condition]}</span>`;
  tags += `<span class="db-tag">${crowdNames[s.crowd_factor]}</span>`;
  if (s.focus_area) tags += `<span class="db-tag">üéØ ${s.focus_area}</span>`;
  document.getElementById('dbConditions').innerHTML = tags;
  
  // Detect modules
  const mods = detectModulesUsed(s);
  const hasTactical = mods.includes('tactical');
  const hasJudge = mods.includes('judge');
  const hasBiomech = mods.includes('biomech');
  const hasWorkout = mods.includes('workout');
  
  // Modules used badge
  const modLabels = { tactical: 'üèÑ Tactical', biomech: 'ü¶¥ Bio', judge: '‚öñÔ∏è Judge', workout: 'üí™ Workout', lab: 'üé• Lab' };
  const modBadges = mods.map(m => `<span class="hist-badge">${modLabels[m] || m}</span>`).join(' ');
  
  // Team stats
  const ids = Object.keys(s.athlete_data);
  let totalP = 0, totalC = 0, totalF = 0;
  let raceAthletes = 0;
  if (hasTactical) {
    ids.forEach(id => { 
      const d = s.athlete_data[id]; 
      totalP += d.paddled; totalC += d.caught; totalF += d.falls;
      if (d.race && d.race.sessions.length > 0) raceAthletes++;
    });
  }
  const teamRatio = totalP > 0 ? Math.round(totalC / totalP * 100) : 0;
  
  if (hasTactical && (totalP > 0 || raceAthletes > 0)) {
    const waveInfo = totalP > 0 ? `Catch Ratio: ${teamRatio}%` : '';
    const raceInfo = raceAthletes > 0 ? `${raceAthletes} paddle race` : '';
    document.getElementById('dbTeamRatio').textContent = [waveInfo, raceInfo].filter(Boolean).join(' ¬∑ ');
    document.getElementById('dbTeamStats').textContent = `${ids.length} atletas ¬∑ ${totalP} remadas ¬∑ ${totalC} atrapadas ¬∑ ${totalF} ca√≠das`;
  } else {
    document.getElementById('dbTeamRatio').textContent = '';
    document.getElementById('dbTeamStats').innerHTML = `${ids.length} atletas ¬∑ ${modBadges}`;
  }
  
  // Per athlete
  const athletes = DB.athletes;
  let athHtml = '';
  ids.forEach(id => {
    const a = athletes.find(x => x.id === id);
    const ad = s.athlete_data[id];
    
    athHtml += `<div class="db-athlete-card">
      <div class="db-athlete-name">${a ? a.name : 'Atleta'} ${a ? getAthleteDisciplines(a).map(d => { const di = getDisciplineInfo(d); return `<span style="font-size:11px" title="${di.label}">${di.icon}</span>`; }).join(' ') : ''}</div>`;
    
    const athDiscs = a ? getAthleteDisciplines(a) : ['surfboard'];
    const hasRaceDisc = athDiscs.some(d => !isDiscWaveBased(d));
    const hasWaveDisc = athDiscs.some(d => isDiscWaveBased(d));
    
    // Paddle Race section (if they have race data)
    if (ad.race && ad.race.sessions.length > 0) {
      const races = ad.race.sessions;
      const bestTime = races.reduce((best, r) => !best || r.total_ms < best.total_ms ? r : best, null);
      const avgLaps = races.length > 0 ? Math.round(races.reduce((s, r) => s + (r.laps || 0), 0) / races.length) : 0;
      
      athHtml += `<div style="margin-top:6px;padding:8px;background:var(--bg-input);border-radius:8px">
        <div style="font-size:11px;font-weight:700;color:${getDisciplineInfo('paddlerace').color};text-transform:uppercase;margin-bottom:4px">üèÅ Paddle Race</div>
        <div class="db-stat-grid">
        <div class="db-stat"><div class="db-stat-v" style="color:var(--accent)">${races.length}</div><div class="db-stat-l">Carreras</div></div>
        <div class="db-stat"><div class="db-stat-v" style="color:var(--green)">${bestTime ? bestTime.total_time : '‚Äî'}</div><div class="db-stat-l">Mejor Tiempo</div></div>
        <div class="db-stat"><div class="db-stat-v">${avgLaps}</div><div class="db-stat-l">Avg Vueltas</div></div>
      </div>
      ${bestTime && bestTime.best_lap ? `<div style="font-size:12px;color:var(--text-secondary);margin-top:4px">‚ö° Mejor vuelta: ${bestTime.best_lap}</div>` : ''}
      </div>`;
    }
    
    // Wave-based discipline section (with per-discipline breakdown if multiple)
    if (hasTactical && ad.waves && ad.waves.length > 0) {
      // Detect which wave disciplines were used in this session
      const waveDiscsUsed = [...new Set(ad.waves.map(w => w.discipline || getAthleteDiscipline(a)).filter(d => isDiscWaveBased(d)))];
      
      if (waveDiscsUsed.length > 1) {
        // Multi-discipline breakdown
        waveDiscsUsed.forEach(disc => {
          const di = getDisciplineInfo(disc);
          const discWaves = ad.waves.filter(w => (w.discipline || getAthleteDiscipline(a)) === disc);
          const discCaught = discWaves.filter(w => w.type === 'caught').length;
          const discFalls = discWaves.filter(w => w.type === 'fall').length;
          const discPaddled = discCaught + discFalls;
          const ratio = discPaddled > 0 ? Math.round(discCaught / discPaddled * 100) : 0;
          const ratioColor = ratio >= 60 ? 'var(--green)' : ratio >= 40 ? 'var(--yellow)' : 'var(--red)';
          const maneuvers = {};
          discWaves.forEach(w => { if (w.maneuvers) w.maneuvers.forEach(m => { maneuvers[m] = (maneuvers[m] || 0) + 1; }); });
          const manStr = Object.entries(maneuvers).map(([m, c]) => `${m.toUpperCase()}√ó${c}`).join(' ');
          
          athHtml += `<div style="margin-top:6px;padding:8px;background:var(--bg-input);border-radius:8px">
            <div style="font-size:11px;font-weight:700;color:${di.color};text-transform:uppercase;margin-bottom:4px">${di.icon} ${di.label}</div>
            <div class="db-stat-grid">
              <div class="db-stat"><div class="db-stat-v">${discPaddled}</div><div class="db-stat-l">Rem√≥</div></div>
              <div class="db-stat"><div class="db-stat-v">${discCaught}</div><div class="db-stat-l">Atrap√≥</div></div>
              <div class="db-stat"><div class="db-stat-v" style="color:${ratioColor}">${ratio}%</div><div class="db-stat-l">Catch</div></div>
            </div>
            ${discFalls > 0 ? `<div style="font-size:12px;color:var(--red);font-weight:600">üí• ${discFalls} ca√≠da${discFalls > 1 ? 's' : ''}</div>` : ''}
            ${manStr ? `<div style="font-size:12px;color:var(--text-secondary);margin-top:4px">üèÑ ${manStr}</div>` : ''}
          </div>`;
        });
      } else {
        // Single discipline - show classic view
        const ratio = ad.paddled > 0 ? Math.round(ad.caught / ad.paddled * 100) : 0;
        const ratioColor = ratio >= 60 ? 'var(--green)' : ratio >= 40 ? 'var(--yellow)' : 'var(--red)';
        const maneuvers = {};
        ad.waves.forEach(w => { if (w.maneuvers) w.maneuvers.forEach(m => { maneuvers[m] = (maneuvers[m] || 0) + 1; }); });
        const manStr = Object.entries(maneuvers).map(([m, c]) => `${m.toUpperCase()}√ó${c}`).join(' ');
      
      athHtml += `<div class="db-stat-grid">
        <div class="db-stat"><div class="db-stat-v">${ad.paddled}</div><div class="db-stat-l">Rem√≥</div></div>
        <div class="db-stat"><div class="db-stat-v">${ad.caught}</div><div class="db-stat-l">Atrap√≥</div></div>
        <div class="db-stat"><div class="db-stat-v" style="color:${ratioColor}">${ratio}%</div><div class="db-stat-l">Catch</div></div>
      </div>
      ${ad.falls > 0 ? `<div style="font-size:12px;color:var(--red);font-weight:600">üí• ${ad.falls} ca√≠da${ad.falls > 1 ? 's' : ''}</div>` : ''}
      ${manStr ? `<div style="font-size:12px;color:var(--text-secondary);margin-top:4px">üèÑ ${manStr}</div>` : ''}`;
      }
    }
    
    // Judge section
    if (hasJudge) {
      const js = getJudgeSummaryForAthlete(id);
      if (js) {
        const scoreColor = js.avg_wave >= 6 ? 'var(--green)' : js.avg_wave >= 4 ? 'var(--yellow)' : js.avg_wave > 0 ? 'var(--red)' : 'var(--text-muted)';
        athHtml += `<div style="margin-top:8px;padding:8px;background:var(--bg-input);border-radius:8px">
          <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:4px">‚öñÔ∏è Judging (${js.heat_count} heat${js.heat_count > 1 ? 's' : ''})</div>
          <div class="db-stat-grid">
            <div class="db-stat"><div class="db-stat-v" style="color:var(--accent)">${js.avg_total.toFixed(2)}</div><div class="db-stat-l">Avg Heat</div></div>
            <div class="db-stat"><div class="db-stat-v" style="color:${scoreColor}">${js.avg_wave.toFixed(2)}</div><div class="db-stat-l">Avg/Ola</div></div>
            ${js.goal > 0 ? `<div class="db-stat"><div class="db-stat-v" style="color:var(--yellow)">${js.goal.toFixed(1)}</div><div class="db-stat-l">Goal</div></div>` : ''}
          </div>
          <div style="font-size:11px;color:var(--text-secondary);margin-top:4px">${js.heats.map((h, i) => `H${i+1}: ${h.toFixed(2)}`).join(' ¬∑ ')}</div>
        </div>`;
      }
    }
    
    athHtml += renderBioSummaryHTML(ad);
    athHtml += renderWorkoutSummaryHTML(ad);
    
    // XP (calculated now)
    let xp = ad.xp_earned || 10;
    athHtml += `<div class="db-xp">‚ú® +${xp} XP</div>`;
    athHtml += `</div>`;
  });
  document.getElementById('dbAthletes').innerHTML = athHtml;
  
  // Visual catch ratio chart (only athletes with wave data)
  const waveIds = ids.filter(id => { const d = s.athlete_data[id]; return d.paddled > 0; });
  if (hasTactical && waveIds.length > 0) {
    const chart = document.getElementById('dbChart');
    chart.style.display = 'block';
    document.getElementById('dbChartBars').innerHTML = waveIds.map(id => {
      const a = athletes.find(x => x.id === id);
      const ad = s.athlete_data[id];
      const ratio = ad.paddled > 0 ? Math.round(ad.caught / ad.paddled * 100) : 0;
      const color = ratio >= 60 ? 'var(--green)' : ratio >= 40 ? 'var(--yellow)' : 'var(--red)';
      return `<div class="pc-bar-row"><div class="pc-bar-label">${(a ? a.name.split(' ')[0] : '?').slice(0,6)}</div><div class="pc-bar-track"><div class="pc-bar-fill" style="width:${ratio}%;background:${color}"></div></div><div class="pc-bar-val">${ratio}%</div></div>`;
    }).join('');
  } else {
    document.getElementById('dbChart').style.display = 'none';
  }
}

// Helper: get judge summary for an athlete from the tracker
function getJudgeSummaryForAthlete(athId) {
  const tracker = DB.judgeTracker;
  for (const [name, info] of Object.entries(tracker)) {
    if (info.athlete_id === athId) {
      const valid = (info.heats || []).filter(h => h != null);
      const avg = valid.length > 0 ? valid.reduce((a, b) => a + b, 0) / valid.length : 0;
      const wAvgs = (info.all_wave_avgs || []).filter(a => a > 0);
      const allWaveAvg = wAvgs.length > 0 ? wAvgs.reduce((a, b) => a + b, 0) / wAvgs.length : 0;
      return { heats: info.heats || [], heat_count: valid.length, avg_total: avg, avg_wave: allWaveAvg, goal: info.goal || 0 };
    }
  }
  return null;
}

function detectModulesUsed(s) {
  const mods = [];
  const ids = Object.keys(s.athlete_data || {});
  
  // Tactical: any paddled/caught/waves
  if (ids.some(id => { const d = s.athlete_data[id]; return (d.paddled || 0) > 0 || (d.caught || 0) > 0 || (d.waves || []).length > 0; })) {
    mods.push('tactical');
  }
  
  // Biomech: any biomech evaluations
  if (ids.some(id => (s.athlete_data[id].biomech || []).length > 0)) {
    mods.push('biomech');
  }
  
  // Judge: tracker has data
  const tracker = DB.judgeTracker;
  if (Object.keys(tracker).length > 0) {
    mods.push('judge');
  }
  
  // Workout: any workouts assigned
  if (ids.some(id => (s.athlete_data[id].workouts || []).length > 0)) {
    mods.push('workout');
  }
  
  // Lab: check if any frames captured during session
  if (ids.some(id => (s.athlete_data[id].lab_frames || []).length > 0)) {
    mods.push('lab');
  }
  
  return mods;
}

function saveDebrief() {
  const s = DB.activeSession;
  if (!s) return;
  
  s.status = 'completed';
  s.ended_at = new Date().toISOString();
  s.date = s.started_at;
  s.coach_notes = document.getElementById('dbNotes').value;
  s.coach_rating = getStarValue('dbRating');
  
  // Calculate duration
  const start = new Date(s.started_at);
  const end = new Date(s.ended_at);
  s.duration_min = Math.round((end - start) / 60000);
  
  // Detect which modules were actually used
  s.modules_used = detectModulesUsed(s);
  
  // Capture judge tracker data into session
  const tracker = DB.judgeTracker;
  if (Object.keys(tracker).length > 0) {
    s.judge_data = JSON.parse(JSON.stringify(tracker));
    
    // Also save per-athlete judge summaries
    for (const [name, info] of Object.entries(tracker)) {
      const athId = info.athlete_id;
      if (athId && s.athlete_data[athId]) {
        const valid = (info.heats || []).filter(h => h != null);
        const avg = valid.length > 0 ? valid.reduce((a, b) => a + b, 0) / valid.length : 0;
        const wAvgs = (info.all_wave_avgs || []).filter(a => a > 0);
        const allWaveAvg = wAvgs.length > 0 ? wAvgs.reduce((a, b) => a + b, 0) / wAvgs.length : 0;
        
        s.athlete_data[athId].judge_summary = {
          heats: info.heats || [],
          heat_count: valid.length,
          avg_heat_total: parseFloat(avg.toFixed(2)),
          avg_wave_score: parseFloat(allWaveAvg.toFixed(2)),
          all_wave_avgs: info.all_wave_avgs || [],
          goal: info.goal || 0
        };
      }
    }
  }
  
  // Add XP to athletes (module-aware)
  const athletes = DB.athletes;
  const usedTactical = s.modules_used.includes('tactical');
  const usedJudge = s.modules_used.includes('judge');
  const usedWorkout = s.modules_used.includes('workout');
  const usedBiomech = s.modules_used.includes('biomech');
  
  Object.keys(s.athlete_data).forEach(id => {
    const a = athletes.find(x => x.id === id);
    if (!a) return;
    const ad = s.athlete_data[id];
    
    let xp = 10; // Base attendance XP
    
    if (usedTactical) {
      const ratio = ad.paddled > 0 ? ad.caught / ad.paddled : 0;
      if (ratio >= 0.7) xp += 25;
      if (ad.falls === 0 && ad.caught > 0) xp += 40;
      const goodWaves = ad.waves.filter(w => w.selection === 'excellent').length;
      xp += goodWaves * 15;
    }
    
    if (usedJudge && ad.judge_summary) {
      xp += ad.judge_summary.heat_count * 10;
      if (ad.judge_summary.avg_wave_score >= 6) xp += 30;
      else if (ad.judge_summary.avg_wave_score >= 4) xp += 15;
    }
    
    if (usedWorkout) {
      const wo = ad.workouts || [];
      const done = wo.filter(w => w.completed).length;
      xp += done * 5;
      xp += wo.filter(w => w.quality === 'good').length * 5;
    }
    
    if (usedBiomech) {
      const bio = ad.biomech || [];
      xp += bio.length * 5;
    }
    
    ad.xp_earned = xp; // Store for display
    a.xp_total = (a.xp_total || 0) + xp;
    a.sessions_count = (a.sessions_count || 0) + 1;
  });
  DB.athletes = athletes;
  
  // Save session
  const sessions = DB.sessions;
  sessions.push(s);
  DB.sessions = sessions;
  
  // Clear active
  DB.activeSession = null;
  stopSessionTimer();
}

function saveAndExport() {
  saveDebrief();
  exportSessionCSV();
  showView('home');
}

function saveTemplate() {
  const s = DB.activeSession || DB.sessions[DB.sessions.length - 1];
  if (!s) { alert('No hay sesi√≥n activa'); return; }
  
  const name = prompt('Nombre del template:', `${s.spot} - ${s.focus_area || 'Sesi√≥n'}`);
  if (!name) return;
  
  const tpl = {
    id: DB.genId(),
    name,
    spot: s.spot,
    wave_size: s.wave_size,
    wave_quality: s.wave_quality,
    wind_condition: s.wind_condition,
    crowd_factor: s.crowd_factor,
    focus_area: s.focus_area,
    athlete_ids: Object.keys(s.athlete_data || {}),
    created_at: new Date().toISOString()
  };
  
  const templates = DB.templates;
  templates.push(tpl);
  DB.templates = templates;
  alert('‚úÖ Template guardado');
}

function loadTemplate(id) {
  const tpl = DB.templates.find(t => t.id === id);
  if (!tpl) return;
  
  // Start session setup
  if (DB.athletes.length === 0) { openAddAthleteModal(); return; }
  showView('session-setup');
  
  // Auto-fill fields after render
  setTimeout(() => {
    // Spot
    const spotSel = document.getElementById('ssSpot');
    for (let i = 0; i < spotSel.options.length; i++) {
      if (spotSel.options[i].value === tpl.spot) { spotSel.selectedIndex = i; break; }
    }
    // Size
    const sizeBtn = document.querySelector(`#ssSize .seg-btn[data-v="${tpl.wave_size}"]`);
    if (sizeBtn) segSelect('ssSize', sizeBtn);
    // Quality
    if (tpl.wave_quality) starSelect('ssQuality', tpl.wave_quality);
    // Wind
    const windBtn = document.querySelector(`#ssWind .seg-btn[data-v="${tpl.wind_condition}"]`);
    if (windBtn) segSelect('ssWind', windBtn);
    // Crowd
    const crowdBtn = document.querySelector(`#ssCrowd .seg-btn[data-v="${tpl.crowd_factor}"]`);
    if (crowdBtn) segSelect('ssCrowd', crowdBtn);
    // Focus
    if (tpl.focus_area) document.getElementById('ssFocus').value = tpl.focus_area;
    // Athletes
    if (tpl.athlete_ids && tpl.athlete_ids.length > 0) {
      const checks = document.querySelectorAll('#ssAthList input[type="checkbox"]');
      checks.forEach(cb => {
        cb.checked = tpl.athlete_ids.includes(cb.value);
      });
    }
  }, 100);
}

function deleteTemplate(id) {
  if (!confirm('¬øEliminar este template?')) return;
  DB.templates = DB.templates.filter(t => t.id !== id);
  renderSettings();
}

// ============================================================
// EXPORT CSV
// ============================================================
function exportSessionCSV() {
  const sessions = DB.sessions;
  if (sessions.length === 0) return;
  const s = sessions[sessions.length - 1];
  const athletes = DB.athletes;
  
  // Flat BI-ready format: one row per athlete, all data as columns
  const headers = [
    'timestamp','spot','wave_size','wave_quality','wind','crowd','focus','duration_min','coach_rating',
    'modules_used',
    'athlete','discipline',
    'paddled','caught','falls','catch_ratio',
    'waves_total','maneuvers',
    'selection_poor','selection_normal','selection_excellent',
    'position_poor','position_normal','position_excellent',
    'commit_poor','commit_normal','commit_excellent',
    'xp',
    'bio_evals','bio_shoulders_score','bio_knees_score','bio_arms_score',
    'bio_compression_score','bio_head_score','bio_backfoot_score','bio_weight_score',
    'bio_avg_flow','bio_notes',
    'judge_heats','judge_h1','judge_h2','judge_h3','judge_h4','judge_h5','judge_h6',
    'judge_avg_heat','judge_avg_wave','judge_goal',
    'workout_total','workout_completed','workout_good','workout_regular','workout_poor',
    'race_count','race_best_time_ms','race_best_lap_ms','race_avg_laps',
    'coach_notes'
  ];
  
  const modsStr = (s.modules_used || []).join(';');
  let csv = headers.join(',') + '\n';
  
  Object.keys(s.athlete_data).forEach(id => {
    const a = athletes.find(x => x.id === id);
    const d = s.athlete_data[id];
    const usedTactical = (s.modules_used || []).includes('tactical');
    const ratio = usedTactical && d.paddled > 0 ? Math.round(d.caught / d.paddled * 100) : '';
    
    // Tactical aggregates (only if module used)
    const maneuvers = {};
    let sel = { poor: 0, normal: 0, excellent: 0 };
    let pos = { poor: 0, normal: 0, excellent: 0 };
    let com = { poor: 0, normal: 0, excellent: 0 };
    if (usedTactical) {
      d.waves.forEach(w => {
        if (w.maneuvers) w.maneuvers.forEach(m => maneuvers[m] = (maneuvers[m] || 0) + 1);
        if (w.selection) sel[w.selection] = (sel[w.selection] || 0) + 1;
        if (w.position) pos[w.position] = (pos[w.position] || 0) + 1;
        if (w.commit) com[w.commit] = (com[w.commit] || 0) + 1;
      });
    }
    const xp = d.xp_earned || 10;
    const manStr = Object.entries(maneuvers).map(([m, c]) => `${m}:${c}`).join(';');
    
    // Biomechanics aggregates
    const bio = d.biomech || [];
    const flows = bio.map(b => parseInt(b.bio_flow)).filter(n => !isNaN(n));
    const avgFlow = flows.length > 0 ? (flows.reduce((a,b)=>a+b,0)/flows.length).toFixed(1) : '';
    const bioNotes = bio.map(b => b.notes).filter(Boolean).join(' | ');
    
    // Workout aggregates
    const wo = d.workouts || [];
    const woDone = wo.filter(w => w.completed).length;
    const woGood = wo.filter(w => w.quality === 'good').length;
    const woReg = wo.filter(w => w.quality === 'regular').length;
    const woPoor = wo.filter(w => w.quality === 'poor').length;
    
    const esc = (v) => `"${String(v || '').replace(/"/g, '""')}"`;
    
    // Judge data
    const js = d.judge_summary || {};
    const jHeats = js.heats || [];
    
    const row = [
      s.date || s.started_at,
      esc(s.spot),
      s.wave_size,
      s.wave_quality,
      s.wind_condition,
      s.crowd_factor,
      esc(s.focus_area || ''),
      s.duration_min || '',
      s.coach_rating || '',
      esc(modsStr),
      esc(a ? a.name : id),
      esc(a ? getAthleteDisciplines(a).join('+') : 'surfboard'),
      usedTactical ? d.paddled : '',
      usedTactical ? d.caught : '',
      usedTactical ? d.falls : '',
      ratio,
      usedTactical ? d.waves.length : '',
      esc(manStr),
      usedTactical ? sel.poor : '', usedTactical ? sel.normal : '', usedTactical ? sel.excellent : '',
      usedTactical ? pos.poor : '', usedTactical ? pos.normal : '', usedTactical ? pos.excellent : '',
      usedTactical ? com.poor : '', usedTactical ? com.normal : '', usedTactical ? com.excellent : '',
      xp,
      bio.length || '',
      bio.length > 0 ? bioAvgScore(bio, 'bio_shoulders') : '',
      bio.length > 0 ? bioAvgScore(bio, 'bio_knees') : '',
      bio.length > 0 ? bioAvgScore(bio, 'bio_arms') : '',
      bio.length > 0 ? bioAvgScore(bio, 'bio_compression') : '',
      bio.length > 0 ? bioAvgScore(bio, 'bio_head') : '',
      bio.length > 0 ? bioAvgScore(bio, 'bio_backfoot') : '',
      bio.length > 0 ? bioAvgScore(bio, 'bio_weight') : '',
      avgFlow,
      esc(bioNotes),
      jHeats.length || '',
      jHeats[0] != null ? jHeats[0].toFixed(2) : '',
      jHeats[1] != null ? jHeats[1].toFixed(2) : '',
      jHeats[2] != null ? jHeats[2].toFixed(2) : '',
      jHeats[3] != null ? jHeats[3].toFixed(2) : '',
      jHeats[4] != null ? jHeats[4].toFixed(2) : '',
      jHeats[5] != null ? jHeats[5].toFixed(2) : '',
      js.avg_heat_total != null ? js.avg_heat_total : '',
      js.avg_wave_score != null ? js.avg_wave_score : '',
      js.goal || '',
      wo.length || '',
      woDone || '',
      woGood || '',
      woReg || '',
      woPoor || '',
      // Race data
      d.race && d.race.sessions.length > 0 ? d.race.sessions.length : '',
      d.race && d.race.sessions.length > 0 ? Math.min(...d.race.sessions.map(r => r.total_ms || Infinity)) : '',
      d.race && d.race.sessions.length > 0 ? Math.min(...d.race.sessions.filter(r => r.best_lap_ms).map(r => r.best_lap_ms)) || '' : '',
      d.race && d.race.sessions.length > 0 ? Math.round(d.race.sessions.reduce((s, r) => s + (r.laps || 0), 0) / d.race.sessions.length) : '',
      esc(s.coach_notes || '')
    ];
    
    csv += row.join(',') + '\n';
  });
  
  // Download
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `KSS_Session_${s.spot.replace(/\s/g, '')}_${new Date(s.date).toISOString().slice(0, 10)}.csv`;
  link.click();
  URL.revokeObjectURL(url);
}

function exportAllData() { exportFullBackup(); }

// ============================================================
// DATA LAYER HARDENING (Phase 8)
// ============================================================

// --- STORAGE HEALTH ---
function getStorageHealth() {
  let used = 0;
  for (let i = 0; i < localStorage.length; i++) {
    const k = localStorage.key(i);
    if (k.startsWith('kss_')) used += localStorage.getItem(k).length * 2; // UTF-16
  }
  const usedMB = (used / 1024 / 1024).toFixed(2);
  const maxMB = 5; // typical localStorage limit
  const pct = Math.min(100, Math.round((used / (maxMB * 1024 * 1024)) * 100));
  return { used, usedMB, maxMB, pct };
}

function renderStorageHealth() {
  const h = getStorageHealth();
  const el = document.getElementById('setStorageHealth');
  if (!el) return;
  const color = h.pct >= 80 ? 'var(--red)' : h.pct >= 60 ? 'var(--yellow)' : 'var(--green)';
  const athletes = DB.athletes.length;
  const sessions = DB.sessions.length;
  const frames = DB.labFrames.length;
  el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
    <span style="font-weight:700">üíæ Almacenamiento</span>
    <span style="font-weight:800;color:${color}">${h.usedMB} MB / ~${h.maxMB} MB</span>
  </div>
  <div style="height:6px;background:var(--border);border-radius:3px;overflow:hidden;margin-bottom:6px"><div style="width:${h.pct}%;height:100%;background:${color};border-radius:3px;transition:width .3s"></div></div>
  <div style="color:var(--text-muted);display:flex;gap:12px;flex-wrap:wrap">
    <span>üë• ${athletes} atletas</span>
    <span>üìã ${sessions} sesiones</span>
    <span>üñºÔ∏è ${frames} frames</span>
    ${h.pct >= 70 ? '<span style="color:var(--red);font-weight:700">‚ö†Ô∏è Espacio bajo ‚Äî elimina frames de Lab o exporta backup</span>' : ''}
  </div>`;
}

// --- FULL BACKUP EXPORT (JSON) ---
function exportFullBackup() {
  const data = {
    _kss_version: '7.0',
    _export_date: new Date().toISOString(),
    athletes: DB.athletes,
    sessions: DB.sessions,
    spots: DB.spots,
    templates: DB._get('templates', []),
    judgeTracker: DB.judgeTracker,
    labFrames: DB.labFrames,
    customDrills: DB._get('custom_drills', []),
    settings: {
      theme: localStorage.getItem('kss_theme') || 'dark',
    }
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `KSS_Coach_Backup_${new Date().toISOString().slice(0, 10)}.json`;
  link.click();
  URL.revokeObjectURL(url);
  showImportStatus('‚úÖ Backup exportado correctamente', 'var(--green)');
}

// --- IMPORT/RESTORE BACKUP ---
function importBackup(input) {
  const file = input.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result);
      
      // Validate structure
      const issues = [];
      if (!data.athletes || !Array.isArray(data.athletes)) issues.push('athletes missing/invalid');
      if (!data.sessions || !Array.isArray(data.sessions)) issues.push('sessions missing/invalid');
      
      if (issues.length > 0) {
        showImportStatus('‚ùå Archivo inv√°lido: ' + issues.join(', '), 'var(--red)');
        return;
      }
      
      // Validate athletes have required fields
      let repairedAthletes = 0;
      data.athletes.forEach(a => {
        if (!a.id) { a.id = 'ath_' + Date.now() + '_' + Math.random().toString(36).slice(2, 6); repairedAthletes++; }
        if (!a.name) { a.name = 'Atleta ' + a.id.slice(-4); repairedAthletes++; }
        if (!a.disciplines && !a.discipline) { a.disciplines = ['surfboard']; repairedAthletes++; }
        if (a.discipline && !a.disciplines) { a.disciplines = [a.discipline]; delete a.discipline; }
        if (!Array.isArray(a.disciplines)) a.disciplines = ['surfboard'];
      });
      
      // Validate sessions
      let repairedSessions = 0;
      data.sessions.forEach(s => {
        if (!s.date && s.started_at) { s.date = s.started_at; repairedSessions++; }
        if (!s.date) { s.date = new Date().toISOString(); repairedSessions++; }
        if (!s.athlete_data || typeof s.athlete_data !== 'object') { s.athlete_data = {}; repairedSessions++; }
        if (!s.spot) s.spot = 'Desconocido';
        Object.values(s.athlete_data).forEach(d => {
          if (!d.waves) d.waves = [];
          if (typeof d.paddled !== 'number') d.paddled = d.waves.length;
          if (typeof d.caught !== 'number') d.caught = d.waves.filter(w => w.type === 'caught').length;
          if (typeof d.falls !== 'number') d.falls = d.waves.filter(w => w.type === 'fall').length;
        });
      });
      
      // Confirm with user
      const summary = `üì¶ Backup encontrado:\n‚Ä¢ ${data.athletes.length} atletas\n‚Ä¢ ${data.sessions.length} sesiones\n‚Ä¢ ${(data.labFrames || []).length} frames de Lab\n${repairedAthletes + repairedSessions > 0 ? `‚Ä¢ ${repairedAthletes + repairedSessions} campos reparados autom√°ticamente\n` : ''}${data._export_date ? '‚Ä¢ Exportado: ' + new Date(data._export_date).toLocaleDateString('es') : ''}\n\n‚ö†Ô∏è Esto REEMPLAZAR√Å todos los datos actuales.\n¬øContinuar?`;
      
      if (!confirm(summary)) {
        showImportStatus('üö´ Importaci√≥n cancelada', 'var(--yellow)');
        return;
      }
      
      // Apply data
      DB.athletes = data.athletes;
      DB.sessions = data.sessions;
      if (data.spots) DB.spots = data.spots;
      if (data.templates) DB._set('templates', data.templates);
      if (data.judgeTracker) DB.judgeTracker = data.judgeTracker;
      if (data.labFrames) DB.labFrames = data.labFrames;
      if (data.customDrills) DB._set('custom_drills', data.customDrills);
      
      showImportStatus(`‚úÖ Restauraci√≥n exitosa: ${data.athletes.length} atletas, ${data.sessions.length} sesiones`, 'var(--green)');
      renderSettings();
      
    } catch (err) {
      showImportStatus('‚ùå Error leyendo archivo: ' + err.message, 'var(--red)');
    }
  };
  reader.readAsText(file);
  input.value = ''; // Reset so same file can be re-imported
}

function showImportStatus(msg, color) {
  const el = document.getElementById('setImportStatus');
  if (!el) return;
  el.style.display = 'block';
  el.style.borderLeft = `3px solid ${color}`;
  el.innerHTML = msg;
  setTimeout(() => { el.style.display = 'none'; }, 8000);
}

// --- MULTI-SESSION CSV EXPORT ---
function exportAllSessionsCSV() {
  const sessions = DB.sessions;
  const athletes = DB.athletes;
  if (sessions.length === 0) return alert('No hay sesiones para exportar');
  
  const headers = [
    'session_date','spot','wave_size','wind','crowd','duration_min','modules',
    'athlete','discipline',
    'paddled','caught','falls','catch_ratio',
    'maneuvers',
    'selection_excellent','selection_normal','selection_poor',
    'position_excellent','position_normal','position_poor',
    'commit_excellent','commit_normal','commit_poor',
    'bio_evals','bio_shoulders','bio_hips','bio_knees','bio_arms','bio_balance',
    'race_count','race_best_time_ms',
    'xp_earned','coach_notes'
  ];
  
  let csv = headers.join(',') + '\n';
  
  sessions.forEach(s => {
    const dateStr = s.date || s.started_at || '';
    const modsStr = (s.modules_used || []).join(';');
    const dur = s.duration ? Math.round(s.duration / 60) : '';
    
    Object.entries(s.athlete_data || {}).forEach(([id, d]) => {
      const a = athletes.find(x => x.id === id);
      const discStr = a ? getAthleteDisciplines(a).join('+') : '';
      
      // Wave stats
      const sel = { excellent: 0, normal: 0, poor: 0 };
      const pos = { excellent: 0, normal: 0, poor: 0 };
      const com = { excellent: 0, normal: 0, poor: 0 };
      const maneuvers = {};
      (d.waves || []).forEach(w => {
        if (w.selection) sel[w.selection] = (sel[w.selection] || 0) + 1;
        if (w.position) pos[w.position] = (pos[w.position] || 0) + 1;
        if (w.commit) com[w.commit] = (com[w.commit] || 0) + 1;
        if (w.maneuvers) w.maneuvers.forEach(m => maneuvers[m] = (maneuvers[m] || 0) + 1);
      });
      const manStr = Object.entries(maneuvers).map(([m,c]) => `${m}:${c}`).join(';');
      const ratio = d.paddled > 0 ? Math.round((d.caught || 0) / d.paddled * 100) : '';
      
      // Bio
      const bio = d.biomech || [];
      const bioAvg = (field) => {
        const vals = bio.map(b => b[field] === 'good' ? 3 : b[field] === 'ok' ? 2 : b[field] === 'poor' ? 1 : 0).filter(v => v > 0);
        return vals.length > 0 ? (vals.reduce((a,b) => a+b, 0) / vals.length).toFixed(1) : '';
      };
      
      // Race
      const raceCount = d.race ? (d.race.sessions || []).length : 0;
      const raceBest = raceCount > 0 ? Math.min(...d.race.sessions.map(r => r.total_ms || Infinity)) : '';
      
      const row = [
        dateStr, csvSafe(s.spot || ''), csvSafe(s.swell || ''), csvSafe(s.wind || ''), csvSafe(s.crowd || ''), dur, modsStr,
        csvSafe(a ? a.name : id), discStr,
        d.paddled || 0, d.caught || 0, d.falls || 0, ratio,
        csvSafe(manStr),
        sel.excellent, sel.normal, sel.poor,
        pos.excellent, pos.normal, pos.poor,
        com.excellent, com.normal, com.poor,
        bio.length, bioAvg('bio_shoulders'), bioAvg('bio_hips'), bioAvg('bio_knees'), bioAvg('bio_arms'), bioAvg('bio_balance'),
        raceCount, raceBest || '',
        d.xp_earned || '', csvSafe(d.notes || s.coach_notes || '')
      ];
      csv += row.join(',') + '\n';
    });
  });
  
  downloadCSV(csv, `KSS_AllSessions_${new Date().toISOString().slice(0,10)}.csv`);
}

// --- ATHLETES CSV EXPORT ---
function exportAthletesCSV() {
  const athletes = DB.athletes;
  const sessions = DB.sessions;
  if (athletes.length === 0) return alert('No hay atletas');
  
  const headers = ['name','disciplines','stance','age','level','xp_total','sessions_count','total_caught','total_paddled','catch_ratio','heats','wins','podiums','avg_heat_total','badges_count','created_at'];
  let csv = headers.join(',') + '\n';
  
  athletes.forEach(a => {
    const discs = getAthleteDisciplines(a).join('+');
    let totalC = 0, totalP = 0;
    sessions.forEach(s => {
      const d = s.athlete_data?.[a.id];
      if (d) { totalC += d.caught || 0; totalP += d.paddled || 0; }
    });
    const heats = a.heat_history || [];
    const wins = heats.filter(h => h.position === 1).length;
    const podiums = heats.filter(h => h.position <= 3).length;
    const avgHeat = heats.length > 0 ? (heats.reduce((s,h) => s + (h.total||0), 0) / heats.length).toFixed(1) : '';
    const badges = (typeof BADGE_DEFS !== 'undefined' ? BADGE_DEFS : []).filter(b => { try { return b.check(a); } catch { return false; } }).length;
    const ratio = totalP > 0 ? Math.round(totalC / totalP * 100) : '';
    
    csv += [
      csvSafe(a.name), discs, a.stance || '', a.age || '', a.level || '', a.xp_total || 0,
      a.sessions_count || 0, totalC, totalP, ratio,
      heats.length, wins, podiums, avgHeat, badges, a.created_at || ''
    ].join(',') + '\n';
  });
  
  downloadCSV(csv, `KSS_Athletes_${new Date().toISOString().slice(0,10)}.csv`);
}

// --- HEATS CSV EXPORT ---
function exportHeatsCSV() {
  const athletes = DB.athletes;
  let allHeats = [];
  athletes.forEach(a => {
    (a.heat_history || []).forEach(h => {
      allHeats.push({ ...h, athlete_name: a.name, athlete_id: a.id });
    });
  });
  if (allHeats.length === 0) return alert('No hay heats registrados');
  
  const headers = ['date','athlete','discipline','heat_number','category','round','location','position','total','avg_wave','wave_count','interference'];
  let csv = headers.join(',') + '\n';
  
  allHeats.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(h => {
    csv += [
      h.date || '', csvSafe(h.athlete_name), h.discipline || '',
      csvSafe(h.heat_number || ''), csvSafe(h.category || ''), csvSafe(h.round || ''),
      csvSafe(h.location || ''), h.position || '', (h.total || 0).toFixed(2),
      (h.all_wave_avg || 0).toFixed(2), h.wave_count || 0, h.interference || 0
    ].join(',') + '\n';
  });
  
  downloadCSV(csv, `KSS_Heats_${new Date().toISOString().slice(0,10)}.csv`);
}

function csvSafe(str) {
  if (str === null || str === undefined) return '';
  str = String(str);
  if (str.includes(',') || str.includes('"') || str.includes('\n')) {
    return '"' + str.replace(/"/g, '""') + '"';
  }
  return str;
}

function downloadCSV(csv, filename) {
  const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  link.click();
  URL.revokeObjectURL(url);
}

// --- DATA VALIDATION ---
function validateData() {
  const athletes = DB.athletes;
  const sessions = DB.sessions;
  const issues = [];
  const warnings = [];
  
  // Validate athletes
  const ids = new Set();
  athletes.forEach((a, i) => {
    if (!a.id) issues.push(`Atleta #${i+1}: sin ID`);
    else if (ids.has(a.id)) issues.push(`Atleta "${a.name}": ID duplicado (${a.id})`);
    else ids.add(a.id);
    if (!a.name) issues.push(`Atleta #${i+1}: sin nombre`);
    const discs = getAthleteDisciplines(a);
    if (discs.length === 0) warnings.push(`${a.name}: sin disciplina asignada`);
    if (typeof a.xp_total !== 'number') warnings.push(`${a.name}: XP inv√°lido`);
    if (a.heat_history && !Array.isArray(a.heat_history)) issues.push(`${a.name}: heat_history corrupto`);
  });
  
  // Validate sessions
  sessions.forEach((s, i) => {
    if (!s.date && !s.started_at) warnings.push(`Sesi√≥n #${i+1}: sin fecha`);
    if (!s.athlete_data || typeof s.athlete_data !== 'object') {
      issues.push(`Sesi√≥n #${i+1}: athlete_data corrupto`);
      return;
    }
    Object.entries(s.athlete_data).forEach(([id, d]) => {
      if (!ids.has(id) && id !== '__custom') warnings.push(`Sesi√≥n #${i+1}: atleta ${id} no encontrado (datos hu√©rfanos)`);
      if (!Array.isArray(d.waves)) warnings.push(`Sesi√≥n #${i+1}, atleta ${id}: waves no es array`);
      if (d.caught > d.paddled) warnings.push(`Sesi√≥n #${i+1}, atleta ${id}: caught(${d.caught}) > paddled(${d.paddled})`);
    });
  });
  
  // Check for orphaned session references
  const sessionAthletes = new Set();
  sessions.forEach(s => Object.keys(s.athlete_data || {}).forEach(id => sessionAthletes.add(id)));
  athletes.forEach(a => {
    if (!sessionAthletes.has(a.id) && (a.sessions_count || 0) > 0) {
      warnings.push(`${a.name}: sessions_count=${a.sessions_count} pero sin datos de sesi√≥n`);
    }
  });
  
  // Storage check
  const health = getStorageHealth();
  if (health.pct >= 80) warnings.push(`Almacenamiento al ${health.pct}% ‚Äî considera exportar y limpiar frames de Lab`);
  
  const el = document.getElementById('setValidation');
  el.style.display = 'block';
  if (issues.length === 0 && warnings.length === 0) {
    el.style.borderLeft = '3px solid var(--green)';
    el.innerHTML = `‚úÖ <strong>Datos saludables</strong><br><span style="color:var(--text-muted)">${athletes.length} atletas, ${sessions.length} sesiones ‚Äî sin problemas detectados</span>`;
  } else {
    el.style.borderLeft = `3px solid ${issues.length > 0 ? 'var(--red)' : 'var(--yellow)'}`;
    let html = issues.length > 0 ? `‚ùå <strong>${issues.length} error(es)</strong><br>` : '';
    html += warnings.length > 0 ? `‚ö†Ô∏è <strong>${warnings.length} advertencia(s)</strong><br>` : '';
    html += '<div style="max-height:120px;overflow-y:auto;margin-top:4px;font-size:11px">';
    issues.forEach(i => html += `<div style="color:var(--red);margin-bottom:2px">‚ùå ${i}</div>`);
    warnings.forEach(w => html += `<div style="color:var(--yellow);margin-bottom:2px">‚ö†Ô∏è ${w}</div>`);
    html += '</div>';
    el.innerHTML = html;
  }
}

// --- DATA REPAIR ---
function repairData() {
  let fixes = 0;
  const athletes = DB.athletes;
  const sessions = DB.sessions;
  
  // Fix athletes
  athletes.forEach(a => {
    if (!a.id) { a.id = 'ath_' + Date.now() + '_' + Math.random().toString(36).slice(2,6); fixes++; }
    if (!a.name) { a.name = 'Atleta ' + a.id.slice(-4); fixes++; }
    if (a.discipline && !a.disciplines) { a.disciplines = [a.discipline]; delete a.discipline; fixes++; }
    if (!a.disciplines || !Array.isArray(a.disciplines) || a.disciplines.length === 0) { a.disciplines = ['surfboard']; fixes++; }
    if (typeof a.xp_total !== 'number') { a.xp_total = 0; fixes++; }
    if (!Array.isArray(a.heat_history)) { a.heat_history = []; fixes++; }
    if (typeof a.sessions_count !== 'number') { a.sessions_count = 0; fixes++; }
  });
  
  // Fix sessions
  sessions.forEach(s => {
    if (!s.date && s.started_at) { s.date = s.started_at; fixes++; }
    if (!s.date) { s.date = new Date().toISOString(); fixes++; }
    if (!s.athlete_data || typeof s.athlete_data !== 'object') { s.athlete_data = {}; fixes++; }
    if (!s.spot) { s.spot = 'Desconocido'; fixes++; }
    
    Object.values(s.athlete_data).forEach(d => {
      if (!Array.isArray(d.waves)) { d.waves = []; fixes++; }
      if (typeof d.paddled !== 'number') { d.paddled = d.waves.length; fixes++; }
      if (typeof d.caught !== 'number') { d.caught = d.waves.filter(w => w.type === 'caught').length; fixes++; }
      if (typeof d.falls !== 'number') { d.falls = d.waves.filter(w => w.type === 'fall').length; fixes++; }
      if (d.caught > d.paddled) { d.paddled = d.caught + d.falls; fixes++; }
      if (!Array.isArray(d.biomech)) d.biomech = [];
    });
  });
  
  // Recalculate sessions_count for each athlete
  athletes.forEach(a => {
    const actual = sessions.filter(s => s.athlete_data && s.athlete_data[a.id]).length;
    if (a.sessions_count !== actual) { a.sessions_count = actual; fixes++; }
  });
  
  // Save repaired data
  DB.athletes = athletes;
  DB.sessions = sessions;
  
  const el = document.getElementById('setValidation');
  el.style.display = 'block';
  if (fixes > 0) {
    el.style.borderLeft = '3px solid var(--green)';
    el.innerHTML = `üîß <strong>${fixes} campos reparados</strong><br><span style="color:var(--text-muted)">Los datos han sido corregidos y guardados</span>`;
  } else {
    el.style.borderLeft = '3px solid var(--green)';
    el.innerHTML = `‚úÖ <strong>Nada que reparar</strong> ‚Äî datos ya est√°n saludables`;
  }
  renderStorageHealth();
}

// --- CLEAR SESSIONS ONLY ---
function clearSessionsOnly() {
  const count = DB.sessions.length;
  if (count === 0) return alert('No hay sesiones para borrar');
  if (!confirm(`¬øBorrar ${count} sesiones? Los atletas se mantendr√°n.\n\nEsta acci√≥n NO se puede deshacer.`)) return;
  if (!confirm('‚ö†Ô∏è CONFIRMAR: ¬øEst√°s seguro? Se perder√°n todos los datos de sesiones.')) return;
  
  DB.sessions = [];
  // Reset session counts on athletes
  const athletes = DB.athletes;
  athletes.forEach(a => { a.sessions_count = 0; });
  DB.athletes = athletes;
  
  alert(`‚úÖ ${count} sesiones eliminadas. Los atletas se mantienen.`);
  renderSettings();
}

// ============================================================
// SHARE SESSION SUMMARY
// ============================================================
function shareSession(source) {
  let s, idx;
  if (source === 'debrief') {
    // Current session just ended ‚Äî it's the last one in DB
    idx = DB.sessions.length - 1;
    s = DB.sessions[idx];
    if (!s) { // Session not yet saved, save it first
      saveDebrief();
      idx = DB.sessions.length - 1;
      s = DB.sessions[idx];
    }
  } else {
    idx = window._sdSessionIdx;
    s = DB.sessions[idx];
  }
  if (!s) return alert('No hay sesi√≥n para compartir');

  const athletes = DB.athletes;
  const date = new Date(s.date).toLocaleDateString('es', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
  const duration = s.duration ? Math.round(s.duration / 60) + ' min' : '‚Äî';
  const modules = s.modules_used || [];

  let text = `üèÑ KSS Coach ‚Äî Resumen de Sesi√≥n\n`;
  text += `üìÖ ${date}\n`;
  text += `üìç ${s.spot || '‚Äî'}\n`;
  text += `‚è±Ô∏è ${duration}\n`;
  if (s.swell) text += `üåä ${s.swell} ¬∑ ${s.wind || ''}\n`;
  if (modules.length) text += `üì¶ M√≥dulos: ${modules.join(', ')}\n`;
  text += `\n`;

  // Per-athlete summary
  const athData = s.athletes || [];
  athData.forEach(ad => {
    const a = athletes.find(x => x.id === ad.id);
    const name = a ? a.name : ad.id;
    let line = `üë§ ${name}`;
    if (modules.includes('tactical') && ad.paddled > 0) {
      const ratio = Math.round((ad.caught / ad.paddled) * 100);
      line += ` ‚Äî ${ad.caught}/${ad.paddled} olas (${ratio}%)`;
    }
    if (ad.judge_summary) {
      const js = ad.judge_summary;
      line += ` ‚Äî Judge avg: ${js.avg_wave?.toFixed(1) || '‚Äî'}`;
    }
    if (ad.xp_earned) line += ` ¬∑ +${ad.xp_earned} XP`;
    text += line + `\n`;
  });

  if (s.notes) text += `\nüìù ${s.notes}\n`;
  if (s.rating) text += `‚≠ê ${s.rating}/5\n`;
  text += `\n‚Äî Powered by KSS Coach üåä`;

  if (navigator.share) {
    navigator.share({ title: 'KSS Coach - Sesi√≥n', text }).catch(() => {});
  } else {
    // Fallback: copy to clipboard + offer WhatsApp
    navigator.clipboard.writeText(text).then(() => {
      const wa = confirm('üìã Resumen copiado al clipboard!\n\n¬øAbrir WhatsApp para enviar?');
      if (wa) {
        window.open('https://wa.me/?text=' + encodeURIComponent(text), '_blank');
      }
    }).catch(() => {
      // Last resort: prompt with text
      prompt('Copia este resumen:', text);
    });
  }
}

// ============================================================
// PWA INSTALL PROMPT
// ============================================================
let _pwaPrompt = null;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  _pwaPrompt = e;
  // Show banner if not dismissed before
  if (!localStorage.getItem('kss_pwa_dismissed')) {
    setTimeout(() => {
      const banner = document.getElementById('pwaBanner');
      if (banner) banner.style.display = 'flex';
    }, 3000); // Show after 3 seconds
  }
});

function pwaInstall() {
  if (_pwaPrompt) {
    _pwaPrompt.prompt();
    _pwaPrompt.userChoice.then(choice => {
      if (choice.outcome === 'accepted') {
        document.getElementById('pwaBanner').style.display = 'none';
      }
      _pwaPrompt = null;
    });
  } else {
    // Fallback: show instructions
    alert('Para instalar:\n\nüì± iOS: Safari ‚Üí Compartir ‚Üí Agregar a Inicio\nü§ñ Android: Men√∫ ‚ãÆ ‚Üí Instalar app\nüíª Desktop: Barra de direcci√≥n ‚Üí Instalar');
    document.getElementById('pwaBanner').style.display = 'none';
  }
}

function pwaDismiss() {
  document.getElementById('pwaBanner').style.display = 'none';
  localStorage.setItem('kss_pwa_dismissed', '1');
}

// ============================================================
// SESSION HISTORY
// ============================================================
function renderHistory() {
  const sessions = DB.sessions.slice().reverse();
  const athletes = DB.athletes;
  const spotFilter = document.getElementById('histSpotFilter').value;
  const athFilter = document.getElementById('histAthleteFilter').value;
  
  // Populate filter options
  const spots = [...new Set(sessions.map(s => s.spot))];
  const spotSel = document.getElementById('histSpotFilter');
  if (spotSel.options.length <= 1) {
    spots.forEach(sp => { const o = document.createElement('option'); o.value = sp; o.textContent = sp; spotSel.appendChild(o); });
  }
  const athSel = document.getElementById('histAthleteFilter');
  if (athSel.options.length <= 1) {
    athletes.forEach(a => { const o = document.createElement('option'); o.value = a.id; o.textContent = a.name; athSel.appendChild(o); });
  }
  
  let filtered = sessions;
  if (spotFilter) filtered = filtered.filter(s => s.spot === spotFilter);
  if (athFilter) filtered = filtered.filter(s => s.athlete_data && s.athlete_data[athFilter]);
  
  document.getElementById('histCount').textContent = `${filtered.length} sesi√≥n${filtered.length !== 1 ? 'es' : ''}`;
  
  if (filtered.length === 0) {
    document.getElementById('histList').innerHTML = '';
    document.getElementById('histEmpty').style.display = 'block';
    return;
  }
  document.getElementById('histEmpty').style.display = 'none';
  
  const allSessions = DB.sessions;
  document.getElementById('histList').innerHTML = filtered.map(s => {
    const idx = allSessions.indexOf(s);
    const ids = Object.keys(s.athlete_data || {});
    const athCount = ids.length;
    const date = new Date(s.date || s.started_at);
    const dateStr = new Intl.DateTimeFormat('es', { weekday:'short', day:'numeric', month:'short', year:'numeric' }).format(date);
    const sizeNames = { 1:'Flat', 2:'1-2ft', 3:'2-4ft', 4:'4-6ft', 5:'+6ft' };
    const mods = s.modules_used || [];
    const hasTactical = !s.modules_used || mods.includes('tactical');
    const hasJudge = mods.includes('judge');
    
    // Aggregate stats (only from tactical)
    let totalP = 0, totalC = 0, totalF = 0;
    if (hasTactical) {
      ids.forEach(id => { const d = s.athlete_data[id]; totalP += d.paddled || 0; totalC += d.caught || 0; totalF += d.falls || 0; });
    }
    const bioCount = ids.reduce((sum, id) => sum + (s.athlete_data[id].biomech || []).length, 0);
    const woCount = ids.reduce((sum, id) => sum + (s.athlete_data[id].workouts || []).length, 0);
    const judgeHeats = ids.reduce((sum, id) => sum + ((s.athlete_data[id].judge_summary || {}).heat_count || 0), 0);
    
    let badges = '';
    if (hasJudge && judgeHeats > 0) badges += `<span class="hist-badge">‚öñÔ∏è ${judgeHeats}h</span>`;
    if (bioCount > 0) badges += `<span class="hist-badge">ü¶¥ ${bioCount}</span>`;
    if (woCount > 0) badges += `<span class="hist-badge">üí™ ${woCount}</span>`;
    if (s.duration_min) badges += `<span class="hist-badge">‚è±Ô∏è ${s.duration_min}m</span>`;
    
    // Right side metric
    let rightHtml = '';
    if (hasTactical && totalP > 0) {
      const ratio = Math.round(totalC / totalP * 100);
      const ratioColor = ratio >= 60 ? 'var(--green)' : ratio >= 40 ? 'var(--yellow)' : 'var(--red)';
      rightHtml = `<div style="font-size:22px;font-weight:800;color:${ratioColor}">${ratio}%</div><div style="font-size:10px;color:var(--text-muted)">catch</div>`;
    } else if (hasJudge) {
      const avgScores = ids.map(id => (s.athlete_data[id].judge_summary||{}).avg_wave_score||0).filter(v=>v>0);
      const teamAvg = avgScores.length > 0 ? (avgScores.reduce((a,b)=>a+b,0)/avgScores.length).toFixed(1) : '‚Äî';
      rightHtml = `<div style="font-size:22px;font-weight:800;color:var(--accent)">${teamAvg}</div><div style="font-size:10px;color:var(--text-muted)">avg/ola</div>`;
    } else {
      rightHtml = `<div style="font-size:18px">‚úì</div>`;
    }
    
    // Bottom stats
    let statsHtml = `<span>üë• ${athCount}</span>`;
    if (hasTactical && totalP > 0) statsHtml += `<span>üèÑ ${totalC}/${totalP} olas</span>`;
    if (totalF > 0) statsHtml += `<span>üí• ${totalF}</span>`;
    statsHtml += badges;
    
    return `<div class="hist-card" onclick="openSessionDetail(${idx})">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div class="hist-spot">${s.spot}</div>
          <div class="hist-date">${dateStr} ¬∑ ${sizeNames[s.wave_size] || ''} ¬∑ ${s.wind_condition || ''}</div>
        </div>
        <div style="text-align:right">${rightHtml}</div>
      </div>
      <div class="hist-stats">${statsHtml}</div>
    </div>`;
  }).join('');
}

function openSessionDetail(idx) {
  window._sdSessionIdx = idx;
  showView('session-detail');
}

function exportSessionCSVById(idx) {
  // Temporarily swap sessions array to export specific session
  const sessions = DB.sessions;
  if (idx === undefined || !sessions[idx]) return;
  const orig = sessions.length;
  const s = sessions[idx];
  // Push to end temporarily for exportSessionCSV which grabs last
  sessions.push(s);
  DB.sessions = sessions;
  exportSessionCSV();
  sessions.pop();
  DB.sessions = sessions;
}

// ============================================================
// SESSION DETAIL
// ============================================================
function renderSessionDetail() {
  const s = DB.sessions[window._sdSessionIdx];
  if (!s) { showView('history'); return; }
  const athletes = DB.athletes;
  const mods = s.modules_used || [];
  const hasTactical = !s.modules_used || mods.includes('tactical');
  const hasJudge = mods.includes('judge');
  
  const date = new Date(s.date || s.started_at);
  const dateStr = new Intl.DateTimeFormat('es', { weekday:'long', day:'numeric', month:'long', year:'numeric' }).format(date);
  const sizeNames = { 1:'Flat', 2:'1-2ft', 3:'2-4ft', 4:'4-6ft', 5:'+6ft' };
  
  document.getElementById('sdTitle').textContent = s.spot;
  const modLabels = { tactical:'üèÑ Tactical', biomech:'ü¶¥ Bio', judge:'‚öñÔ∏è Judge', workout:'üí™ Workout', lab:'üé• Lab' };
  const modBadges = mods.length > 0 ? mods.map(m => modLabels[m]||m).join(' ¬∑ ') : '';
  document.getElementById('sdMeta').textContent = `${dateStr} ¬∑ ${s.duration_min ? s.duration_min + ' min' : ''}${modBadges ? ' ¬∑ ' + modBadges : ''}`;
  
  // Conditions
  document.getElementById('sdConditions').innerHTML = `
    <span class="db-cond-tag">${sizeNames[s.wave_size] || ''}</span>
    <span class="db-cond-tag">${'‚≠ê'.repeat(s.wave_quality || 0)}</span>
    <span class="db-cond-tag">${s.wind_condition || ''}</span>
    <span class="db-cond-tag">${s.crowd_factor || ''}</span>
    ${s.focus_area ? `<span class="db-cond-tag">üéØ ${s.focus_area}</span>` : ''}
  `;
  
  const ids = Object.keys(s.athlete_data || {});
  let totalP = 0, totalC = 0;
  
  // Athlete cards
  let athHtml = '';
  ids.forEach(id => {
    const a = athletes.find(x => x.id === id);
    const d = s.athlete_data[id];
    
    athHtml += `<div class="sd-ath-card">
      <div style="font-weight:800;font-size:14px;margin-bottom:8px">${a ? a.name : 'Atleta'}</div>`;
    
    if (hasTactical && d.paddled > 0) {
      const ratio = Math.round(d.caught / d.paddled * 100);
      const ratioColor = ratio >= 60 ? 'var(--green)' : ratio >= 40 ? 'var(--yellow)' : 'var(--red)';
      totalP += d.paddled || 0;
      totalC += d.caught || 0;
      
      const maneuvers = {};
      d.waves.forEach(w => { if (w.maneuvers) w.maneuvers.forEach(m => maneuvers[m] = (maneuvers[m] || 0) + 1); });
      const manStr = Object.entries(maneuvers).map(([m, c]) => `${m.toUpperCase()}√ó${c}`).join(' ');
      
      athHtml += `<div class="db-stat-grid">
        <div class="db-stat"><div class="db-stat-v">${d.paddled}</div><div class="db-stat-l">Rem√≥</div></div>
        <div class="db-stat"><div class="db-stat-v">${d.caught}</div><div class="db-stat-l">Atrap√≥</div></div>
        <div class="db-stat"><div class="db-stat-v" style="color:${ratioColor}">${ratio}%</div><div class="db-stat-l">Catch</div></div>
      </div>
      ${d.falls > 0 ? `<div style="font-size:12px;color:var(--red);font-weight:600">üí• ${d.falls} ca√≠da${d.falls > 1 ? 's' : ''}</div>` : ''}
      ${manStr ? `<div style="font-size:12px;color:var(--text-secondary);margin-top:6px">üèÑ ${manStr}</div>` : ''}`;
    }
    
    // Judge summary
    if (d.judge_summary) {
      const js = d.judge_summary;
      const scoreColor = js.avg_wave_score >= 6 ? 'var(--green)' : js.avg_wave_score >= 4 ? 'var(--yellow)' : 'var(--red)';
      athHtml += `<div style="margin-top:8px;padding:8px;background:var(--bg-input);border-radius:8px">
        <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:4px">‚öñÔ∏è Judging (${js.heat_count} heat${js.heat_count>1?'s':''})</div>
        <div class="db-stat-grid">
          <div class="db-stat"><div class="db-stat-v" style="color:var(--accent)">${js.avg_heat_total.toFixed(2)}</div><div class="db-stat-l">Avg Heat</div></div>
          <div class="db-stat"><div class="db-stat-v" style="color:${scoreColor}">${js.avg_wave_score.toFixed(2)}</div><div class="db-stat-l">Avg/Ola</div></div>
        </div>
        <div style="font-size:11px;color:var(--text-secondary);margin-top:4px">${js.heats.map((h,i)=>`H${i+1}: ${h.toFixed(2)}`).join(' ¬∑ ')}</div>
      </div>`;
    }
    
    athHtml += renderBioSummaryHTML(d);
    athHtml += renderWorkoutSummaryHTML(d);
    athHtml += `</div>`;
  });
  document.getElementById('sdAthletes').innerHTML = athHtml;
  
  // Team stats (adapted to modules)
  if (hasTactical && totalP > 0) {
    const teamRatio = Math.round(totalC / totalP * 100);
    document.getElementById('sdTeamStats').innerHTML = `
      <div class="db-stat-grid">
        <div class="db-stat"><div class="db-stat-v">${ids.length}</div><div class="db-stat-l">Atletas</div></div>
        <div class="db-stat"><div class="db-stat-v">${totalC}/${totalP}</div><div class="db-stat-l">Olas</div></div>
        <div class="db-stat"><div class="db-stat-v" style="color:${teamRatio>=60?'var(--green)':teamRatio>=40?'var(--yellow)':'var(--red)'}">${teamRatio}%</div><div class="db-stat-l">Catch</div></div>
      </div>`;
  } else {
    document.getElementById('sdTeamStats').innerHTML = `<div class="db-stat-grid">
      <div class="db-stat"><div class="db-stat-v">${ids.length}</div><div class="db-stat-l">Atletas</div></div>
    </div>`;
  }
  
  // Catch ratio chart (only if tactical)
  if (hasTactical && ids.length > 1 && totalP > 0) {
    document.getElementById('sdCharts').innerHTML = `<div class="card" style="padding:12px;margin-bottom:12px">
      <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:8px">üìä Catch Ratio Comparado</div>
      ${ids.map(id => {
        const a = athletes.find(x => x.id === id);
        const d = s.athlete_data[id];
        const r = d.paddled > 0 ? Math.round(d.caught / d.paddled * 100) : 0;
        const c = r >= 60 ? 'var(--green)' : r >= 40 ? 'var(--yellow)' : 'var(--red)';
        return `<div class="pc-bar-row"><div class="pc-bar-label">${(a?a.name.split(' ')[0]:'?').slice(0,8)}</div><div class="pc-bar-track"><div class="pc-bar-fill" style="width:${r}%;background:${c}"></div></div><div class="pc-bar-val">${r}%</div></div>`;
      }).join('')}
    </div>`;
  } else { document.getElementById('sdCharts').innerHTML = ''; }
  
  // Notes
  if (s.coach_notes) {
    document.getElementById('sdNotesCard').style.display = 'block';
    document.getElementById('sdNotes').textContent = s.coach_notes;
  } else { document.getElementById('sdNotesCard').style.display = 'none'; }
}

// ============================================================
// ANALYTICS ENGINE (Phase 7)
// ============================================================
let _anlScope = 'team'; // 'team' or athlete id
let _anlRange = 'all'; // 'all', '7', '30', '90'
let _anlDisc = 'all';

function anlSetRange(r) {
  _anlRange = r;
  document.querySelectorAll('.anl-time-btn').forEach(b => b.classList.toggle('active', b.dataset.r === r));
  renderAnalytics();
}

function anlSetScope(scope) {
  _anlScope = scope;
  _anlDisc = 'all';
  renderAnalytics();
}

function anlSetDisc(d) {
  _anlDisc = d;
  renderAnalytics();
}

// Get filtered sessions based on time range
function anlGetSessions() {
  let sessions = DB.sessions.slice();
  if (_anlRange !== 'all') {
    const days = parseInt(_anlRange);
    const cutoff = new Date();
    cutoff.setDate(cutoff.getDate() - days);
    sessions = sessions.filter(s => new Date(s.date || s.started_at) >= cutoff);
  }
  return sessions;
}

// Get all waves across sessions for scope
function anlGetWaves(sessions) {
  const athletes = DB.athletes;
  let waves = [];
  sessions.forEach(s => {
    Object.entries(s.athlete_data || {}).forEach(([id, d]) => {
      if (_anlScope !== 'team' && _anlScope !== id) return;
      const ath = athletes.find(a => a.id === id);
      const primaryDisc = ath ? getAthleteDiscipline(ath) : 'surfboard';
      (d.waves || []).forEach(w => {
        const disc = w.discipline || primaryDisc;
        if (_anlDisc !== 'all' && disc !== _anlDisc) return;
        waves.push({ ...w, athlete_id: id, session_date: s.date || s.started_at, spot: s.spot, discipline: disc });
      });
    });
  });
  return waves;
}

// Get biomech evals
function anlGetBio(sessions) {
  const athletes = DB.athletes;
  let bio = [];
  sessions.forEach(s => {
    Object.entries(s.athlete_data || {}).forEach(([id, d]) => {
      if (_anlScope !== 'team' && _anlScope !== id) return;
      const ath = athletes.find(a => a.id === id);
      const primaryDisc = ath ? getAthleteDiscipline(ath) : 'surfboard';
      (d.biomech || []).forEach(b => {
        const disc = b.discipline || primaryDisc;
        if (_anlDisc !== 'all' && disc !== _anlDisc) return;
        bio.push({ ...b, athlete_id: id, discipline: disc });
      });
    });
  });
  return bio;
}

// Get heats for scope
function anlGetHeats() {
  const athletes = DB.athletes;
  let heats = [];
  athletes.forEach(a => {
    if (_anlScope !== 'team' && _anlScope !== a.id) return;
    (a.heat_history || []).forEach(h => {
      if (_anlRange !== 'all') {
        const days = parseInt(_anlRange);
        const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - days);
        if (new Date(h.date) < cutoff) return;
      }
      const disc = h.discipline || getAthleteDiscipline(a);
      if (_anlDisc !== 'all' && disc !== _anlDisc) return;
      heats.push({ ...h, athlete_id: a.id, athlete_name: a.name, discipline: disc });
    });
  });
  return heats;
}

// SVG line chart builder
function anlSvgLine(data, w, h, color, fill) {
  if (data.length < 2) return '';
  const maxV = Math.max(...data.map(d => d.v), 1);
  const minV = Math.min(...data.map(d => d.v), 0);
  const range = maxV - minV || 1;
  const pad = 4;
  const pts = data.map((d, i) => {
    const x = pad + (i / (data.length - 1)) * (w - pad * 2);
    const y = h - pad - ((d.v - minV) / range) * (h - pad * 2);
    return { x, y };
  });
  const line = pts.map((p, i) => `${i === 0 ? 'M' : 'L'}${p.x.toFixed(1)},${p.y.toFixed(1)}`).join(' ');
  const fillPath = fill ? `<path d="${line} L${pts[pts.length-1].x},${h} L${pts[0].x},${h} Z" fill="${color}" opacity="0.12"/>` : '';
  const dots = pts.map((p, i) => `<circle cx="${p.x.toFixed(1)}" cy="${p.y.toFixed(1)}" r="3" fill="${color}"><title>${data[i].label}: ${data[i].v}${data[i].unit || ''}</title></circle>`).join('');
  // Grid lines
  const gridY = [0.25, 0.5, 0.75].map(f => {
    const y = h - pad - f * (h - pad * 2);
    const val = Math.round(minV + f * range);
    return `<line x1="${pad}" y1="${y}" x2="${w-pad}" y2="${y}" stroke="var(--border)" stroke-width="0.5" stroke-dasharray="3"/><text x="${pad+2}" y="${y-3}" font-size="8" fill="var(--text-muted)">${val}</text>`;
  }).join('');
  return `<svg width="100%" height="100%" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">${gridY}${fillPath}<path d="${line}" fill="none" stroke="${color}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>${dots}</svg>`;
}

// Bar chart builder (vertical)
function anlSvgBars(data, w, h, defaultColor) {
  if (data.length === 0) return '<div style="text-align:center;color:var(--text-muted);font-size:12px;padding:20px">Sin datos</div>';
  const maxV = Math.max(...data.map(d => d.v), 1);
  const pad = 4;
  const barW = Math.min(24, (w - pad * 2) / data.length - 4);
  const gap = (w - pad * 2 - barW * data.length) / (data.length + 1);
  let svg = `<svg width="100%" height="100%" viewBox="0 0 ${w} ${h}">`;
  data.forEach((d, i) => {
    const x = pad + gap + i * (barW + gap);
    const barH = Math.max(2, (d.v / maxV) * (h - 30));
    const y = h - 16 - barH;
    const color = d.color || defaultColor || 'var(--accent)';
    svg += `<rect x="${x}" y="${y}" width="${barW}" height="${barH}" rx="3" fill="${color}" opacity="0.8"><title>${d.label}: ${d.v}</title></rect>`;
    svg += `<text x="${x + barW/2}" y="${h - 4}" text-anchor="middle" font-size="8" fill="var(--text-muted)" font-weight="600">${d.label}</text>`;
    svg += `<text x="${x + barW/2}" y="${y - 3}" text-anchor="middle" font-size="8" fill="var(--text-secondary)" font-weight="700">${d.v}</text>`;
  });
  svg += '</svg>';
  return svg;
}

// Donut chart builder (CSS conic-gradient)
function anlDonut(segments, size, centerText) {
  let total = segments.reduce((s, seg) => s + seg.v, 0);
  if (total === 0) return '';
  let gradParts = [];
  let cumPct = 0;
  segments.forEach(seg => {
    const pct = (seg.v / total) * 100;
    gradParts.push(`${seg.color} ${cumPct.toFixed(1)}% ${(cumPct + pct).toFixed(1)}%`);
    cumPct += pct;
  });
  return `<div class="anl-donut" style="width:${size}px;height:${size}px;background:conic-gradient(${gradParts.join(',')})">
    <div class="anl-donut-center">${centerText}</div></div>`;
}

function renderAnalytics() {
  const athletes = DB.athletes;
  const sessions = anlGetSessions();
  const waves = anlGetWaves(sessions);
  const bio = anlGetBio(sessions);
  const heats = anlGetHeats();

  // Scope pills
  const pillsDiv = document.getElementById('anlScopePills');
  pillsDiv.innerHTML = `<button onclick="anlSetScope('team')" style="padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;border:1.5px solid ${_anlScope === 'team' ? 'var(--accent)' : 'var(--border)'};background:${_anlScope === 'team' ? 'rgba(56,189,248,.08)' : 'transparent'};color:${_anlScope === 'team' ? 'var(--accent)' : 'var(--text-muted)'};white-space:nowrap">üë• Equipo</button>` +
    athletes.map(a => {
      const isActive = _anlScope === a.id;
      return `<button onclick="anlSetScope('${a.id}')" style="padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;border:1.5px solid ${isActive ? 'var(--accent)' : 'var(--border)'};background:${isActive ? 'rgba(56,189,248,.08)' : 'transparent'};color:${isActive ? 'var(--accent)' : 'var(--text-muted)'};white-space:nowrap">${a.name.split(' ')[0]}</button>`;
    }).join('');

  // Discipline filter (when single athlete selected)
  const discFilterDiv = document.getElementById('anlDiscFilter');
  if (_anlScope !== 'team') {
    const ath = athletes.find(a => a.id === _anlScope);
    if (ath) {
      const discs = getAthleteDisciplines(ath);
      if (discs.length > 1) {
        discFilterDiv.style.display = 'flex';
        discFilterDiv.innerHTML = `<div style="display:flex;gap:4px;flex-wrap:wrap">` +
          `<button onclick="anlSetDisc('all')" style="padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;border:1.5px solid ${_anlDisc === 'all' ? 'var(--accent)' : 'var(--border)'};background:${_anlDisc === 'all' ? 'rgba(56,189,248,.08)' : 'transparent'};color:${_anlDisc === 'all' ? 'var(--accent)' : 'var(--text-muted)'}">Todos</button>` +
          discs.map(d => {
            const di = getDisciplineInfo(d);
            const isA = _anlDisc === d;
            return `<button onclick="anlSetDisc('${d}')" style="padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;border:1.5px solid ${isA ? di.color : 'var(--border)'};background:${isA ? di.color + '20' : 'transparent'};color:${isA ? di.color : 'var(--text-muted)'}">${di.icon} ${di.label}</button>`;
          }).join('') + '</div>';
      } else { discFilterDiv.style.display = 'none'; }
    }
  } else { discFilterDiv.style.display = 'none'; }

  // Subtitle
  const scopeLabel = _anlScope === 'team' ? 'Equipo completo' : (athletes.find(a => a.id === _anlScope)?.name || '');
  document.getElementById('anlSubtitle').innerHTML = `${scopeLabel} ¬∑ ${sessions.length} sesiones${_anlDisc !== 'all' ? ' ¬∑ ' + getDisciplineInfo(_anlDisc).icon + ' ' + getDisciplineInfo(_anlDisc).label : ''}`;

  // === KPIs ===
  const caught = waves.filter(w => w.type === 'caught').length;
  const paddled = waves.length;
  const falls = waves.filter(w => w.type === 'fall').length;
  const catchPct = paddled > 0 ? Math.round(caught / paddled * 100) : 0;
  const avgHeatScore = heats.length > 0 ? (heats.reduce((s, h) => s + (h.total || 0), 0) / heats.length).toFixed(1) : '‚Äî';

  document.getElementById('anlKPIs').innerHTML = [
    { val: sessions.length, lbl: 'Sesiones', color: 'var(--accent)' },
    { val: caught, lbl: 'Olas', color: 'var(--green)' },
    { val: catchPct + '%', lbl: 'Catch %', color: catchPct >= 60 ? 'var(--green)' : catchPct >= 40 ? 'var(--yellow)' : 'var(--red)' },
    { val: heats.length > 0 ? avgHeatScore : bio.length, lbl: heats.length > 0 ? 'Avg Heat' : 'Evals Bio', color: 'var(--accent)' },
  ].map(k => `<div class="dash-kpi"><div class="dash-kpi-val" style="color:${k.color}">${k.val}</div><div class="dash-kpi-lbl">${k.lbl}</div></div>`).join('');

  // === Session Frequency ===
  const freqData = {};
  sessions.forEach(s => {
    const d = new Date(s.date || s.started_at);
    const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    const label = new Intl.DateTimeFormat('es', { month: 'short' }).format(d);
    if (!freqData[key]) freqData[key] = { label: label.slice(0,3), v: 0 };
    freqData[key].v++;
  });
  const freqArr = Object.entries(freqData).sort((a,b) => a[0].localeCompare(b[0])).slice(-8).map(([,d]) => d);
  document.getElementById('anlFreqChart').innerHTML = freqArr.length > 0 ?
    anlSvgBars(freqArr, 320, 120, 'var(--accent)') :
    '<div style="text-align:center;color:var(--text-muted);font-size:12px;padding:30px">Sin datos</div>';

  // === Catch Ratio Trend ===
  const catchBySession = [];
  sessions.forEach(s => {
    let p = 0, c = 0;
    Object.entries(s.athlete_data || {}).forEach(([id, d]) => {
      if (_anlScope !== 'team' && _anlScope !== id) return;
      const ath = athletes.find(a => a.id === id);
      const primaryDisc = ath ? getAthleteDiscipline(ath) : 'surfboard';
      (d.waves || []).forEach(w => {
        const disc = w.discipline || primaryDisc;
        if (_anlDisc !== 'all' && disc !== _anlDisc) return;
        p++;
        if (w.type === 'caught') c++;
      });
    });
    if (p > 0) {
      const dt = new Date(s.date || s.started_at);
      catchBySession.push({ v: Math.round(c / p * 100), label: new Intl.DateTimeFormat('es', { day:'numeric', month:'short' }).format(dt), unit: '%' });
    }
  });
  document.getElementById('anlCatchTrend').innerHTML = catchBySession.length >= 2 ?
    anlSvgLine(catchBySession.slice(-12), 320, 160, '#22c55e', true) :
    '<div style="text-align:center;color:var(--text-muted);font-size:12px;padding:40px">Necesita 2+ sesiones con datos</div>';

  // === Wave Quality Distribution ===
  const qualCounts = { excellent: 0, good: 0, regular: 0, poor: 0 };
  waves.filter(w => w.type === 'caught' && w.wave_quality).forEach(w => { if (qualCounts[w.wave_quality] !== undefined) qualCounts[w.wave_quality]++; });
  const qualTotal = Object.values(qualCounts).reduce((a,b) => a+b, 0);
  const qualColors = { excellent: '#22c55e', good: '#3b82f6', regular: '#f59e0b', poor: '#ef4444' };
  const qualLabels = { excellent: '‚≠ê Excelente', good: 'üî• Buena', regular: 'üëå Regular', poor: 'üí© Pobre' };
  const qualSegs = Object.entries(qualCounts).filter(([,v]) => v > 0).map(([k,v]) => ({ v, color: qualColors[k], label: qualLabels[k] }));

  if (qualTotal > 0) {
    document.getElementById('anlQualDonut').innerHTML = anlDonut(qualSegs, 100, qualTotal.toString());
    document.getElementById('anlQualLegend').innerHTML = qualSegs.map(seg =>
      `<div class="anl-legend-item"><div class="anl-legend-dot" style="background:${seg.color}"></div><span>${seg.label}: <strong>${seg.v}</strong> (${Math.round(seg.v/qualTotal*100)}%)</span></div>`
    ).join('');
  } else {
    document.getElementById('anlQualDonut').innerHTML = '<div style="width:100px;height:100px;border-radius:50%;background:var(--bg-input);display:flex;align-items:center;justify-content:center;font-size:11px;color:var(--text-muted)">Sin datos</div>';
    document.getElementById('anlQualLegend').innerHTML = '';
  }

  // === Top Maneuvers ===
  const maneuvers = {};
  waves.filter(w => w.type === 'caught').forEach(w => {
    if (w.maneuvers) w.maneuvers.forEach(m => { maneuvers[m] = (maneuvers[m] || 0) + 1; });
  });
  const sortedM = Object.entries(maneuvers).sort((a,b) => b[1] - a[1]).slice(0, 8);
  const maxM = sortedM.length > 0 ? sortedM[0][1] : 1;
  document.getElementById('anlManeuvers').innerHTML = sortedM.length > 0 ?
    sortedM.map(([m, c]) => {
      const pct = Math.round(c / maxM * 100);
      return `<div class="anl-bar-row"><div class="anl-bar-label">${m.toUpperCase()}</div><div class="anl-bar-track"><div class="anl-bar-fill" style="width:${pct}%;background:var(--accent)"></div></div><div class="anl-bar-val">${c}</div></div>`;
    }).join('') :
    '<div style="text-align:center;color:var(--text-muted);font-size:12px;padding:12px">Sin datos de maniobras</div>';

  // === Wave Eval Breakdown ===
  const evalFields = [
    { key: 'selection', label: 'üéØ Selecci√≥n', vals: { excellent: { lbl: 'Excelente', color: '#22c55e' }, normal: { lbl: 'Normal', color: '#f59e0b' }, poor: { lbl: 'Mala', color: '#ef4444' } } },
    { key: 'position', label: 'üìç Posici√≥n', vals: { excellent: { lbl: 'En pico', color: '#22c55e' }, normal: { lbl: 'Ok', color: '#f59e0b' }, poor: { lbl: 'Fuera', color: '#ef4444' } } },
    { key: 'commit', label: 'üí™ Compromiso', vals: { excellent: { lbl: 'Full Send', color: '#22c55e' }, normal: { lbl: 'Normal', color: '#f59e0b' }, poor: { lbl: 'Dud√≥', color: '#ef4444' } } },
  ];
  const caughtWaves = waves.filter(w => w.type === 'caught');
  let evalHtml = '';
  evalFields.forEach(ef => {
    const counts = {};
    let total = 0;
    caughtWaves.forEach(w => { if (w[ef.key]) { counts[w[ef.key]] = (counts[w[ef.key]] || 0) + 1; total++; } });
    if (total === 0) return;
    evalHtml += `<div style="margin-bottom:10px"><div style="font-size:11px;font-weight:700;color:var(--text-secondary);margin-bottom:4px">${ef.label}</div>`;
    evalHtml += '<div style="display:flex;height:18px;border-radius:4px;overflow:hidden;gap:1px">';
    Object.entries(ef.vals).forEach(([k, info]) => {
      const c = counts[k] || 0;
      const pct = (c / total * 100);
      if (pct > 0) evalHtml += `<div style="width:${pct}%;background:${info.color};display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:#fff;min-width:${pct > 10 ? '0' : '20px'}" title="${info.lbl}: ${c}">${pct >= 12 ? Math.round(pct) + '%' : ''}</div>`;
    });
    evalHtml += '</div></div>';
  });
  document.getElementById('anlEvalBars').innerHTML = evalHtml || '<div style="text-align:center;color:var(--text-muted);font-size:12px;padding:12px">Sin evaluaciones</div>';

  // === Biomech ===
  const bioCard = document.getElementById('anlBioCard');
  if (bio.length > 0) {
    bioCard.style.display = 'block';
    const bioFields = [
      { key: 'bio_shoulders', label: 'Hombros', icon: 'ü¶¥' },
      { key: 'bio_hips', label: 'Caderas', icon: 'ü¶¥' },
      { key: 'bio_knees', label: 'Rodillas', icon: 'ü¶µ' },
      { key: 'bio_arms', label: 'Brazos', icon: 'üí™' },
      { key: 'bio_balance', label: 'Balance', icon: '‚öñÔ∏è' },
    ];
    const valScore = { good: 3, ok: 2, poor: 1 };
    const bioBars = bioFields.map(bf => {
      const vals = bio.map(b => valScore[b[bf.key]] || 0).filter(v => v > 0);
      if (vals.length === 0) return null;
      const avg = vals.reduce((a,b) => a+b, 0) / vals.length;
      const pct = Math.round((avg / 3) * 100);
      const color = avg >= 2.5 ? 'var(--green)' : avg >= 1.8 ? 'var(--yellow)' : 'var(--red)';
      const label = avg >= 2.5 ? 'Bien' : avg >= 1.8 ? 'Regular' : 'Mejorar';
      return `<div class="anl-bar-row"><div class="anl-bar-label">${bf.icon} ${bf.label}</div><div class="anl-bar-track"><div class="anl-bar-fill" style="width:${pct}%;background:${color}"></div></div><div class="anl-bar-val" style="color:${color}">${label}</div></div>`;
    }).filter(Boolean);
    document.getElementById('anlBioBars').innerHTML = bioBars.join('') || '<div style="color:var(--text-muted);font-size:12px">Sin datos</div>';
  } else { bioCard.style.display = 'none'; }

  // === Heat Performance ===
  const heatCard = document.getElementById('anlHeatCard');
  if (heats.length > 0) {
    heatCard.style.display = 'block';
    const sorted = heats.sort((a,b) => new Date(a.date) - new Date(b.date));
    const heatLine = sorted.slice(-12).map(h => ({
      v: parseFloat(h.total.toFixed(1)),
      label: `H${h.heat_number || '?'}`,
      unit: 'pts'
    }));
    document.getElementById('anlHeatChart').innerHTML = heatLine.length >= 2 ?
      anlSvgLine(heatLine, 320, 140, '#a855f7', true) :
      anlSvgBars(heatLine, 320, 140, '#a855f7');

    // Heat stats
    const avgTotal = heats.reduce((s,h) => s + h.total, 0) / heats.length;
    const bestTotal = Math.max(...heats.map(h => h.total));
    const wins = heats.filter(h => h.position === 1).length;
    const podiums = heats.filter(h => h.position <= 3).length;
    document.getElementById('anlHeatStats').innerHTML = `<div style="display:flex;gap:8px;flex-wrap:wrap">
      <div style="flex:1;min-width:70px;text-align:center;padding:8px;background:var(--bg-input);border-radius:8px"><div style="font-size:16px;font-weight:800;color:var(--accent)">${avgTotal.toFixed(1)}</div><div style="font-size:10px;color:var(--text-muted)">Avg Total</div></div>
      <div style="flex:1;min-width:70px;text-align:center;padding:8px;background:var(--bg-input);border-radius:8px"><div style="font-size:16px;font-weight:800;color:var(--green)">${bestTotal.toFixed(1)}</div><div style="font-size:10px;color:var(--text-muted)">Mejor</div></div>
      <div style="flex:1;min-width:70px;text-align:center;padding:8px;background:var(--bg-input);border-radius:8px"><div style="font-size:16px;font-weight:800;color:#f59e0b">ü•á${wins}</div><div style="font-size:10px;color:var(--text-muted)">Victorias</div></div>
      <div style="flex:1;min-width:70px;text-align:center;padding:8px;background:var(--bg-input);border-radius:8px"><div style="font-size:16px;font-weight:800;color:#a855f7">üèÖ${podiums}</div><div style="font-size:10px;color:var(--text-muted)">Podios</div></div>
    </div>`;
  } else { heatCard.style.display = 'none'; }

  // === Athlete Comparison ===
  const compareCard = document.getElementById('anlCompareCard');
  if (_anlScope === 'team' && athletes.length >= 2) {
    compareCard.style.display = 'block';
    const selA = document.getElementById('anlCmpA');
    const selB = document.getElementById('anlCmpB');
    // Only rebuild options if empty
    if (selA.options.length <= 1) {
      selA.innerHTML = athletes.map((a, i) => `<option value="${a.id}" ${i === 0 ? 'selected' : ''}>${a.name}</option>`).join('');
      selB.innerHTML = athletes.map((a, i) => `<option value="${a.id}" ${i === 1 ? 'selected' : ''}>${a.name}</option>`).join('');
    }
    anlRenderCompare();
  } else { compareCard.style.display = 'none'; }

  // === Spot Analysis ===
  const spots = {};
  sessions.forEach(s => {
    const spot = s.spot || 'Desconocido';
    if (!spots[spot]) spots[spot] = { count: 0, caught: 0, paddled: 0 };
    spots[spot].count++;
    Object.entries(s.athlete_data || {}).forEach(([id, d]) => {
      if (_anlScope !== 'team' && _anlScope !== id) return;
      spots[spot].caught += d.caught || 0;
      spots[spot].paddled += d.paddled || 0;
    });
  });
  const sortedSpots = Object.entries(spots).sort((a,b) => b[1].count - a[1].count).slice(0, 6);
  document.getElementById('anlSpots').innerHTML = sortedSpots.length > 0 ?
    sortedSpots.map(([name, data]) => {
      const ratio = data.paddled > 0 ? Math.round(data.caught / data.paddled * 100) : 0;
      const ratioColor = ratio >= 60 ? 'var(--green)' : ratio >= 40 ? 'var(--yellow)' : data.paddled > 0 ? 'var(--red)' : 'var(--text-muted)';
      return `<div class="anl-spot-row">
        <div style="flex:1"><div style="font-size:13px;font-weight:700">${name}</div><div style="font-size:11px;color:var(--text-muted)">${data.count} sesiones ¬∑ ${data.caught} olas</div></div>
        <div style="font-size:16px;font-weight:800;color:${ratioColor}">${data.paddled > 0 ? ratio + '%' : '‚Äî'}</div>
      </div>`;
    }).join('') :
    '<div style="text-align:center;color:var(--text-muted);font-size:12px;padding:12px">Sin datos</div>';
}

function anlRenderCompare() {
  const idA = document.getElementById('anlCmpA').value;
  const idB = document.getElementById('anlCmpB').value;
  if (!idA || !idB || idA === idB) {
    document.getElementById('anlCompare').innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:12px;padding:12px">Selecciona 2 atletas diferentes</div>';
    return;
  }
  const sessions = anlGetSessions();
  const athletes = DB.athletes;
  const athA = athletes.find(a => a.id === idA);
  const athB = athletes.find(a => a.id === idB);
  if (!athA || !athB) return;

  // Gather stats for each
  function getStats(id) {
    let caught = 0, paddled = 0, falls = 0, bioScores = [];
    const ath = athletes.find(a => a.id === id);
    const primaryDisc = ath ? getAthleteDiscipline(ath) : 'surfboard';
    sessions.forEach(s => {
      const d = s.athlete_data?.[id];
      if (!d) return;
      (d.waves || []).forEach(w => {
        const disc = w.discipline || primaryDisc;
        if (_anlDisc !== 'all' && disc !== _anlDisc) return;
        paddled++;
        if (w.type === 'caught') caught++;
        else if (w.type === 'fall') falls++;
      });
      (d.biomech || []).forEach(b => {
        const disc = b.discipline || primaryDisc;
        if (_anlDisc !== 'all' && disc !== _anlDisc) return;
        const vals = [b.bio_shoulders, b.bio_hips, b.bio_knees, b.bio_arms, b.bio_balance].map(v => v === 'good' ? 3 : v === 'ok' ? 2 : v === 'poor' ? 1 : 0).filter(v => v > 0);
        if (vals.length > 0) bioScores.push(vals.reduce((a,b)=>a+b,0)/vals.length);
      });
    });
    const heatHistory = (ath?.heat_history || []).filter(h => {
      if (_anlRange !== 'all') { const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - parseInt(_anlRange)); if (new Date(h.date) < cutoff) return false; }
      if (_anlDisc !== 'all' && (h.discipline || primaryDisc) !== _anlDisc) return false;
      return true;
    });
    const avgHeat = heatHistory.length > 0 ? heatHistory.reduce((s,h) => s + h.total, 0) / heatHistory.length : 0;
    const catchPct = paddled > 0 ? Math.round(caught / paddled * 100) : 0;
    const avgBio = bioScores.length > 0 ? bioScores.reduce((a,b)=>a+b,0)/bioScores.length : 0;
    return { caught, paddled, falls, catchPct, avgHeat, avgBio: Math.round(avgBio * 33.3), heats: heatHistory.length };
  }

  const sA = getStats(idA);
  const sB = getStats(idB);

  const metrics = [
    { label: 'Catch %', a: sA.catchPct, b: sB.catchPct, max: 100, unit: '%' },
    { label: 'Olas', a: sA.caught, b: sB.caught, max: Math.max(sA.caught, sB.caught, 1) },
    { label: 'Avg Heat', a: parseFloat(sA.avgHeat.toFixed(1)), b: parseFloat(sB.avgHeat.toFixed(1)), max: 20 },
    { label: 'Bio Score', a: sA.avgBio, b: sB.avgBio, max: 100, unit: '%' },
  ];

  const nameA = athA.name.split(' ')[0];
  const nameB = athB.name.split(' ')[0];

  document.getElementById('anlCompare').innerHTML =
    `<div style="display:flex;justify-content:space-between;font-size:11px;font-weight:700;color:var(--text-secondary);margin-bottom:6px"><span style="color:var(--accent)">${nameA}</span><span style="color:var(--green)">${nameB}</span></div>` +
    metrics.map(m => {
      const pctA = m.max > 0 ? Math.round((m.a / m.max) * 50) : 0;
      const pctB = m.max > 0 ? Math.round((m.b / m.max) * 50) : 0;
      return `<div class="anl-cmp-row">
        <div style="width:30px;font-size:11px;font-weight:800;color:var(--accent);text-align:right">${m.a}${m.unit||''}</div>
        <div class="anl-cmp-bar"><div class="anl-cmp-fill-a" style="width:${pctA}%"></div><div class="anl-cmp-fill-b" style="width:${pctB}%"></div></div>
        <div style="width:30px;font-size:11px;font-weight:800;color:var(--green);text-align:left">${m.b}${m.unit||''}</div>
      </div>
      <div style="text-align:center;font-size:9px;color:var(--text-muted);margin-top:-6px;margin-bottom:6px">${m.label}</div>`;
    }).join('');
}

// ============================================================
// ATHLETE PROGRESSION
// ============================================================
let _progressAthleteId = null;
let _progressReturn = 'athletes';

function openProgression(athleteId, returnView) {
  _progressAthleteId = athleteId;
  _progressReturn = returnView || 'athletes';
  showView('progress');
}

function renderProgress() {
  const a = DB.athletes.find(x => x.id === _progressAthleteId);
  if (!a) { showView('athletes'); return; }
  
  const allSessions = DB.sessions.filter(s => s.athlete_data && s.athlete_data[a.id]);
  const athDiscs = getAthleteDisciplines(a);
  document.getElementById('progTitle').textContent = a.name;
  
  // Discipline filter
  const progDiscFilter = document.getElementById('progDiscFilter');
  const pfd = window._progDiscFilter || 'all';
  const fd = pfd !== 'all' ? pfd : null;
  
  if (athDiscs.length > 1) {
    progDiscFilter.style.display = 'flex';
    progDiscFilter.innerHTML = `<div style="display:flex;gap:4px;flex-wrap:wrap">` +
      `<button onclick="window._progDiscFilter='all';renderProgress()" style="padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;border:1.5px solid ${pfd === 'all' ? 'var(--accent)' : 'var(--border)'};background:${pfd === 'all' ? 'var(--accent)10' : 'transparent'};color:${pfd === 'all' ? 'var(--accent)' : 'var(--text-muted)'}">üìä Todos</button>` +
      athDiscs.map(d => {
        const di = getDisciplineInfo(d);
        const isActive = pfd === d;
        return `<button onclick="window._progDiscFilter='${d}';renderProgress()" style="padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;border:1.5px solid ${isActive ? di.color : 'var(--border)'};background:${isActive ? di.color + '20' : 'transparent'};color:${isActive ? di.color : 'var(--text-muted)'}">${di.icon} ${di.label}</button>`;
      }).join('') + `</div>`;
  } else {
    progDiscFilter.style.display = 'none';
  }
  
  const sessions = allSessions;
  document.getElementById('progSubtitle').innerHTML = `${sessions.length} sesiones ¬∑ Nivel ${a.level || 'Intermedio'}${fd ? ' ¬∑ ' + getDisciplineInfo(fd).icon + ' ' + getDisciplineInfo(fd).label : ''}`;
  
  if (sessions.length === 0) {
    document.getElementById('progKPIs').innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;width:100%">Sin datos de sesiones a√∫n</div>';
    return;
  }
  
  // Aggregate stats (module-aware, discipline-filtered)
  let totalP = 0, totalC = 0, totalF = 0, totalXP = 0;
  const catchRatios = [];
  const allManeuvers = {};
  const allBio = [];
  
  sessions.forEach(s => {
    const d = s.athlete_data[a.id];
    const mods = s.modules_used || [];
    const hasTactical = !s.modules_used || mods.includes('tactical');
    
    if (hasTactical) {
      if (fd) {
        // Filter waves by discipline
        (d.waves || []).forEach(w => {
          const wd = w.discipline || getAthleteDiscipline(a);
          if (wd === fd) {
            if (w.type === 'caught') { totalC++; totalP++; }
            else if (w.type === 'fall') { totalF++; totalP++; }
            if (w.maneuvers) w.maneuvers.forEach(m => allManeuvers[m] = (allManeuvers[m] || 0) + 1);
          }
        });
        if (totalP > 0) {
          const ratio = Math.round(totalC / totalP * 100);
          catchRatios.push({ date: s.date || s.started_at, ratio, spot: s.spot });
        }
      } else {
        totalP += d.paddled || 0;
        totalC += d.caught || 0;
        totalF += d.falls || 0;
        
        const ratio = d.paddled > 0 ? Math.round(d.caught / d.paddled * 100) : null;
        if (ratio !== null) catchRatios.push({ date: s.date || s.started_at, ratio, spot: s.spot });
        
        (d.waves || []).forEach(w => {
          if (w.maneuvers) w.maneuvers.forEach(m => allManeuvers[m] = (allManeuvers[m] || 0) + 1);
        });
      }
    }
    
    totalXP += d.xp_earned || 10;
    // Filter bio by discipline
    (d.biomech || []).forEach(b => {
      if (!fd || (b.discipline || getAthleteDiscipline(a)) === fd) allBio.push(b);
    });
  });
  
  const avgRatio = catchRatios.length > 0 ? Math.round(catchRatios.reduce((s, r) => s + r.ratio, 0) / catchRatios.length) : 0;
  const avgColor = avgRatio >= 60 ? 'var(--green)' : avgRatio >= 40 ? 'var(--yellow)' : 'var(--red)';
  
  // Trend arrow
  let trend = '';
  if (catchRatios.length >= 3) {
    const recent = catchRatios.slice(-3).reduce((s, r) => s + r.ratio, 0) / 3;
    const older = catchRatios.slice(0, 3).reduce((s, r) => s + r.ratio, 0) / Math.min(3, catchRatios.length);
    trend = recent > older + 5 ? 'üìà' : recent < older - 5 ? 'üìâ' : '‚û°Ô∏è';
  }
  
  // KPIs
  document.getElementById('progKPIs').innerHTML = `
    <div class="dash-kpi"><div class="dash-kpi-val" style="color:${avgColor}">${avgRatio}% ${trend}</div><div class="dash-kpi-lbl">Catch Prom.</div></div>
    <div class="dash-kpi"><div class="dash-kpi-val">${totalC}/${totalP}</div><div class="dash-kpi-lbl">Olas Total</div></div>
    <div class="dash-kpi"><div class="dash-kpi-val" style="color:var(--accent)">${totalXP}</div><div class="dash-kpi-lbl">XP Total</div></div>
  `;
  
  // Catch ratio sparkline
  if (catchRatios.length >= 2) {
    const w = 300, h = 100, pad = 8;
    const pts = catchRatios.map((r, i) => {
      const x = pad + (i / (catchRatios.length - 1)) * (w - pad * 2);
      const y = h - pad - (r.ratio / 100) * (h - pad * 2);
      return `${x},${y}`;
    });
    const line = pts.join(' ');
    const areaPath = `M${pts[0]} ${pts.map(p => `L${p}`).join(' ')} L${pad + ((catchRatios.length - 1) / (catchRatios.length - 1)) * (w - pad * 2)},${h - pad} L${pad},${h - pad} Z`;
    
    document.getElementById('progCatchChart').innerHTML = `
      <svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none" style="width:100%;height:100%">
        <defs><linearGradient id="cg" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="var(--accent)" stop-opacity=".3"/>
          <stop offset="100%" stop-color="var(--accent)" stop-opacity=".02"/>
        </linearGradient></defs>
        <line x1="${pad}" y1="${h - pad - 60 / 100 * (h - pad * 2)}" x2="${w - pad}" y2="${h - pad - 60 / 100 * (h - pad * 2)}" stroke="var(--text-muted)" stroke-width=".5" stroke-dasharray="4,4"/>
        <path d="${areaPath}" fill="url(#cg)"/>
        <polyline points="${line}" fill="none" stroke="var(--accent)" stroke-width="2.5" stroke-linejoin="round" stroke-linecap="round"/>
        ${catchRatios.map((r, i) => {
          const x = pad + (i / (catchRatios.length - 1)) * (w - pad * 2);
          const y = h - pad - (r.ratio / 100) * (h - pad * 2);
          return `<circle cx="${x}" cy="${y}" r="3.5" fill="var(--accent)"/>`;
        }).join('')}
      </svg>
      <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-muted);margin-top:2px">
        ${catchRatios.map(r => `<span>${new Intl.DateTimeFormat('es', {day:'numeric', month:'short'}).format(new Date(r.date))}</span>`).join('')}
      </div>
    `;
  } else {
    document.getElementById('progCatchChart').innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:12px;padding:20px">Necesita al menos 2 sesiones para ver tendencia</div>';
  }
  
  // Biomechanics bars
  if (allBio.length > 0) {
    document.getElementById('progBioCard').style.display = 'block';
    const fields = ['bio_shoulders','bio_knees','bio_arms','bio_compression','bio_head','bio_backfoot','bio_weight'];
    const labels = ['Hombros','Rodillas','Brazos','Compresi√≥n','Cabeza','Pie Trasero','Trans. Peso'];
    
    document.getElementById('progBioBars').innerHTML = fields.map((f, i) => {
      const avg = bioAvgScore(allBio, f);
      const color = avg >= 60 ? 'var(--green)' : avg >= 30 ? 'var(--yellow)' : avg > 0 ? 'var(--red)' : 'var(--text-muted)';
      return `<div class="pc-bar-row"><div class="pc-bar-label">${labels[i]}</div><div class="pc-bar-track"><div class="pc-bar-fill" style="width:${avg}%;background:${color}"></div></div><div class="pc-bar-val">${avg}</div></div>`;
    }).join('');
  } else { document.getElementById('progBioCard').style.display = 'none'; }
  
  // Maneuvers frequency
  const sorted = Object.entries(allManeuvers).sort((a, b) => b[1] - a[1]);
  if (sorted.length > 0) {
    const maxCount = sorted[0][1];
    document.getElementById('progManeuvers').innerHTML = sorted.slice(0, 10).map(([m, c]) => {
      const pct = Math.round(c / maxCount * 100);
      return `<div class="pc-bar-row"><div class="pc-bar-label">${m.toUpperCase()}</div><div class="pc-bar-track"><div class="pc-bar-fill" style="width:${pct}%;background:var(--accent)"></div></div><div class="pc-bar-val">${c}</div></div>`;
    }).join('');
  } else {
    document.getElementById('progManeuvers').innerHTML = '<div style="color:var(--text-muted);font-size:12px">Sin datos</div>';
  }
  
  // XP timeline (uses xp_earned from session data)
  if (sessions.length >= 2) {
    let cumXP = 0;
    const xpPts = sessions.map(s => {
      const d = s.athlete_data[a.id];
      cumXP += d.xp_earned || 10;
      return { date: s.date || s.started_at, xp: cumXP };
    });
    
    const w = 300, h = 80, pad = 8;
    const maxXP = xpPts[xpPts.length - 1].xp;
    const pts = xpPts.map((p, i) => {
      const x = pad + (i / (xpPts.length - 1)) * (w - pad * 2);
      const y = h - pad - (p.xp / maxXP) * (h - pad * 2);
      return `${x},${y}`;
    });
    
    document.getElementById('progXPChart').innerHTML = `
      <svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none" style="width:100%;height:100%">
        <polyline points="${pts.join(' ')}" fill="none" stroke="var(--accent)" stroke-width="2.5" stroke-linejoin="round"/>
        <circle cx="${pts[pts.length-1].split(',')[0]}" cy="${pts[pts.length-1].split(',')[1]}" r="4" fill="var(--accent)"/>
      </svg>
      <div style="text-align:right;font-size:11px;font-weight:700;color:var(--accent)">${totalXP} XP</div>
    `;
  } else {
    document.getElementById('progXPChart').innerHTML = `<div style="text-align:center;font-size:20px;font-weight:800;color:var(--accent);padding:20px">${totalXP} XP</div>`;
  }
  
  // Session list (module-aware)
  document.getElementById('progSessions').innerHTML = sessions.slice().reverse().map(s => {
    const d = s.athlete_data[a.id];
    const mods = s.modules_used || [];
    const hasTac = !s.modules_used || mods.includes('tactical');
    const dateStr = new Intl.DateTimeFormat('es', { day:'numeric', month:'short' }).format(new Date(s.date || s.started_at));
    const idx = DB.sessions.indexOf(s);
    
    let detail, rightSide;
    if (hasTac && d.paddled > 0) {
      const ratio = Math.round(d.caught / d.paddled * 100);
      const color = ratio >= 60 ? 'var(--green)' : ratio >= 40 ? 'var(--yellow)' : 'var(--red)';
      detail = `${d.caught}/${d.paddled} olas`;
      rightSide = `<div style="font-weight:800;font-size:16px;color:${color}">${ratio}%</div>`;
    } else if (d.judge_summary) {
      detail = `${d.judge_summary.heat_count} heats`;
      rightSide = `<div style="font-weight:800;font-size:16px;color:var(--accent)">${d.judge_summary.avg_heat_total.toFixed(1)}</div>`;
    } else {
      const modIcons = mods.map(m => m==='workout'?'üí™':m==='biomech'?'ü¶¥':m==='lab'?'üé•':'').join('');
      detail = modIcons || 'sesi√≥n';
      rightSide = `<div style="font-size:12px;color:var(--text-muted)">‚úì</div>`;
    }
    
    return `<div class="pc-hist-item" onclick="openSessionDetail(${idx})" style="cursor:pointer">
      <div><strong>${s.spot}</strong><div style="font-size:11px;color:var(--text-muted)">${dateStr} ¬∑ ${detail}</div></div>
      ${rightSide}
    </div>`;
  }).join('');
}

// ============================================================
// ATHLETES
// ============================================================
function renderAthletes() {
  const athletes = DB.athletes;
  const container = document.getElementById('athList');
  const empty = document.getElementById('athEmpty');
  
  if (athletes.length === 0) {
    container.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';
  
  container.innerHTML = '<div class="card" style="padding:0;overflow:hidden">' + athletes.map(a => {
    const initials = a.name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
    const xp = a.xp_total || 0;
    const lvl = calcLevel(xp);
    const sessCount = a.sessions_count || 0;
    const heatCount = (a.heat_history || []).length;
    
    return `<div class="ath-item" onclick="openPlayerCard('${a.id}')" style="cursor:pointer">
      <div class="ath-avi">${initials}</div>
      <div class="ath-info">
        <div class="ath-name">${a.name} ${getAthleteDisciplines(a).map(d => { const di = getDisciplineInfo(d); return `<span class="disc-badge" style="background:${di.color}20;color:${di.color}">${di.icon}</span>`; }).join('')}</div>
        <div class="ath-sub">${LEVEL_NAMES[lvl.level]} (Lv${lvl.level}) ¬∑ ${a.stance || 'Regular'} ¬∑ ${sessCount}s ${heatCount}h ¬∑ ${xp} XP</div>
      </div>
      <span style="color:var(--text-muted);font-size:14px">‚Ä∫</span>
    </div>`;
  }).join('') + '</div>';
}

function discSelect(btn) {
  const grid = btn.closest('.disc-grid');
  const isSelected = btn.classList.contains('selected');
  const selectedCount = grid.querySelectorAll('.disc-btn.selected').length;
  
  // Must keep at least 1 selected
  if (isSelected && selectedCount <= 1) return;
  
  btn.classList.toggle('selected');
  
  // Show/hide stance based on whether ANY wave discipline is selected
  const selectedDiscs = Array.from(grid.querySelectorAll('.disc-btn.selected')).map(b => b.dataset.v);
  const hasWaveDisc = selectedDiscs.some(d => isDiscWaveBased(d));
  const stanceField = document.getElementById('maStance')?.closest('.field');
  if (stanceField) stanceField.style.display = hasWaveDisc ? '' : 'none';
}

function getDiscValues() {
  return Array.from(document.querySelectorAll('#maDisc .disc-btn.selected')).map(b => b.dataset.v);
}

function getDiscValue() {
  return getDiscValues()[0] || 'surfboard';
}

function openAddAthleteModal() {
  document.getElementById('maName').value = '';
  document.getElementById('maAge').value = '';
  window._editAthleteId = null;
  segSelect('maStance', document.querySelector('#maStance .seg-btn[data-v="regular"]'));
  // Reset discipline to surfboard
  document.querySelectorAll('#maDisc .disc-btn').forEach(b => b.classList.remove('selected'));
  document.querySelector('#maDisc .disc-btn[data-v="surfboard"]').classList.add('selected');
  document.getElementById('maStance').closest('.field').style.display = '';
  document.getElementById('modalAddAthlete').classList.add('active');
  document.querySelector('#modalAddAthlete .modal-title').textContent = 'Nuevo Atleta';
  setTimeout(() => document.getElementById('maName').focus(), 300);
}

function closeModal(id) {
  document.getElementById(id).classList.remove('active');
}

function saveNewAthlete() {
  const name = document.getElementById('maName').value.trim();
  if (!name) { alert('Ingresa el nombre del atleta'); return; }
  
  const stance = getSegValue('maStance');
  const age = parseInt(document.getElementById('maAge').value) || null;
  const discipline = getDiscValue();
  const disciplines = getDiscValues();
  
  const athletes = DB.athletes;
  
  if (window._editAthleteId) {
    // Edit mode
    const a = athletes.find(x => x.id === window._editAthleteId);
    if (a) { a.name = name; a.stance = stance; a.age = age; a.discipline = discipline; a.disciplines = disciplines; }
    window._editAthleteId = null;
  } else {
    // New athlete
    athletes.push({
      id: DB.genId(),
      name,
      stance,
      age,
      discipline,
      disciplines,
      level: 1,
      xp_total: 0,
      sessions_count: 0,
      drills_completed: 0,
      assigned_drills: [],
      heat_history: [],
      created_at: new Date().toISOString()
    });
  }
  DB.athletes = athletes;
  
  closeModal('modalAddAthlete');
  
  if (currentView === 'athletes') renderAthletes();
  if (currentView === 'session-setup') renderSSAthletes();
  if (currentView === 'player-card') renderPlayerCard();
}

function deleteAthlete(id) {
  if (!confirm('¬øEliminar este atleta?')) return;
  DB.athletes = DB.athletes.filter(a => a.id !== id);
  renderAthletes();
}

// ============================================================
// PHASE 2: GAMIFICATION ENGINE
// ============================================================
const XP_THRESHOLDS = [0, 100, 400, 1000, 2000, 3500, 5700, 8700, 12700, 18200];
const LEVEL_NAMES = { 1:'Kook', 2:'Grom', 3:'Grom+', 4:'Ripper', 5:'Ripper+', 6:'Charger', 7:'Charger+', 8:'Pro', 9:'Pro+', 10:'Legend' };
const LEVEL_COLORS = { 1:'#94a3b8', 2:'#38bdf8', 3:'#38bdf8', 4:'#22c55e', 5:'#22c55e', 6:'#f59e0b', 7:'#f59e0b', 8:'#a855f7', 9:'#a855f7', 10:'#ef4444' };

// ============================================================
// DISCIPLINE SYSTEM
// ============================================================
const DISC_IMG = (src, sz=18) => `<img src="${src}" alt="" style="width:${sz}px;height:${sz}px;vertical-align:middle;object-fit:contain">`;
const DISCIPLINES = {
  surfboard:    { label: 'Surfboard', icon: DISC_IMG('surfboard.png'), color: '#22c55e', hasWaves: true, img: 'surfboard.png' },
  bodyboard:    { label: 'Bodyboard', icon: DISC_IMG('bodyboard.png'), color: '#3b82f6', hasWaves: true, img: 'bodyboard.png' },
  longboard:    { label: 'Longboard', icon: DISC_IMG('longboard.png'), color: '#f59e0b', hasWaves: true, img: 'longboard.png' },
  kneeboard:    { label: 'Kneeboard', icon: DISC_IMG('kneeboard.png'), color: '#a855f7', hasWaves: true, img: 'kneeboard.png' },
  paddlesurf:   { label: 'Paddle Surf', icon: DISC_IMG('paddle_surf.png'), color: '#06b6d4', hasWaves: true, img: 'paddle_surf.png' },
  paddlerace:   { label: 'Paddle Race', icon: DISC_IMG('paddle_race.png'), color: '#ef4444', hasWaves: false, img: 'paddle_race.png' },
};

const SURFBOARD_MANEUVERS = [
  { id: 'takeoff',  label: 'Take Off' },
  { id: 'bt',       label: 'BT' },
  { id: 'carving',  label: 'Carving' },
  { id: 'cutback',  label: 'Cutback' },
  { id: 'snap',     label: 'Snap' },
  { id: 'floater',  label: 'Floater' },
  { id: 'aerial',   label: 'Aerial' },
  { id: 'tube',     label: 'Tube' },
  { id: 'reentry',  label: 'Re-entry' },
];

const BODYBOARD_MANEUVERS = [
  { id: 'takeoff',      label: 'Take Off' },
  { id: 'bt',           label: 'BT' },
  { id: '360',          label: '360' },
  { id: 'reverse360',   label: 'Reverse 360' },
  { id: 'reentry',      label: 'Re-entry' },
  { id: 'rollup',       label: 'Roll Up' },
  { id: 'rollup360',    label: 'Roll Up 360' },
  { id: 'backflip',     label: 'Backflip' },
  { id: 'backflip360',  label: 'Backflip 360' },
  { id: 'frontflip',    label: 'Frontflip' },
  { id: 'air',          label: 'Air' },
  { id: 'invert',       label: 'Invert' },
  { id: 'air360',       label: 'Air 360' },
  { id: 'airrev360',    label: 'Air Rev 360' },
  { id: 'airrollup',    label: 'Air Roll Up' },
  { id: 'tube',         label: 'Tube' },
];

const LONGBOARD_MANEUVERS = [
  ...SURFBOARD_MANEUVERS,
  { id: 'hangfive',     label: 'Hang Five' },
  { id: 'hangten',      label: 'Hang Ten' },
  { id: 'crosscutback', label: 'Cross Cut Back' },
  { id: 'nose360',      label: 'Nose 360' },
];

const DISCIPLINE_MANEUVERS = {
  surfboard:   SURFBOARD_MANEUVERS,
  bodyboard:   BODYBOARD_MANEUVERS,
  longboard:   LONGBOARD_MANEUVERS,
  kneeboard:   SURFBOARD_MANEUVERS,
  paddlesurf:  SURFBOARD_MANEUVERS,
  paddlerace:  [], // No maneuvers ‚Äî time-based
};

function getAthleteDisciplines(athlete) {
  if (athlete?.disciplines && athlete.disciplines.length > 0) return athlete.disciplines;
  if (athlete?.discipline) return [athlete.discipline]; // backward compat
  return ['surfboard'];
}

function getAthleteDiscipline(athlete) {
  return getAthleteDisciplines(athlete)[0];
}

function getDisciplineInfo(disc) {
  return DISCIPLINES[disc] || DISCIPLINES.surfboard;
}

// Active discipline tracking per athlete in session
window._tacActiveDisc = {};

function getActiveDisc(athleteId) {
  if (window._tacActiveDisc[athleteId]) return window._tacActiveDisc[athleteId];
  const ath = DB.athletes.find(a => a.id === athleteId);
  return getAthleteDiscipline(ath);
}

function setActiveDisc(athleteId, disc) {
  window._tacActiveDisc[athleteId] = disc;
  renderTactical();
}

function getManeuversForDisc(disc) {
  return DISCIPLINE_MANEUVERS[disc] || SURFBOARD_MANEUVERS;
}

function getManeuversForAthlete(athlete) {
  const disc = getActiveDisc(athlete?.id);
  return DISCIPLINE_MANEUVERS[disc] || SURFBOARD_MANEUVERS;
}

function isDiscWaveBased(disc) {
  return (DISCIPLINES[disc] || DISCIPLINES.surfboard).hasWaves;
}

function isWaveDiscipline(athlete) {
  const disc = getActiveDisc(athlete?.id);
  return isDiscWaveBased(disc);
}

function calcLevel(xp) {
  let level = 1;
  for (let i = 1; i < XP_THRESHOLDS.length; i++) {
    if (xp >= XP_THRESHOLDS[i]) level = i + 1;
  }
  const curr = XP_THRESHOLDS[level - 1] || 0;
  const next = XP_THRESHOLDS[level] || XP_THRESHOLDS[XP_THRESHOLDS.length - 1] + 5000;
  const pct = Math.min(100, ((xp - curr) / (next - curr)) * 100);
  return { level, name: LEVEL_NAMES[level], xp, curr, next, pct };
}

const BADGE_DEFS = [
  { id:'first_session', icon:'üåä', name:'Primera Sesi√≥n', desc:'Completa tu primera sesi√≥n', check: a => (a.sessions_count||0) >= 1 },
  { id:'ten_sessions', icon:'üîü', name:'10 Sesiones', desc:'Completa 10 sesiones', check: a => (a.sessions_count||0) >= 10 },
  { id:'wave_hunter', icon:'üèÑ', name:'Cazador de Olas', desc:'Atrapa 50 olas', check: a => getTotalCaught(a) >= 50 },
  { id:'wave_machine', icon:'üåä', name:'M√°quina de Olas', desc:'Atrapa 200 olas', check: a => getTotalCaught(a) >= 200 },
  { id:'sharp_eye', icon:'üëÅÔ∏è', name:'Ojo Agudo', desc:'Catch ratio > 60%', check: a => getOverallCatchRatio(a) > 60 },
  { id:'sniper', icon:'üéØ', name:'Sniper', desc:'Catch ratio > 80%', check: a => getOverallCatchRatio(a) > 80 },
  { id:'competitor', icon:'‚öñÔ∏è', name:'Competidor', desc:'Completa tu primer heat', check: a => (a.heat_history||[]).length >= 1 },
  { id:'heat_veteran', icon:'üèÖ', name:'Veterano', desc:'Completa 10 heats', check: a => (a.heat_history||[]).length >= 10 },
  { id:'podium', icon:'ü•á', name:'Podio', desc:'Termina 1ro en un heat', check: a => (a.heat_history||[]).some(h => h.position === 1) },
  { id:'high_scorer', icon:'üíé', name:'High Scorer', desc:'Avg por ola > 6.0', check: a => getAvgWaveScore(a) > 6 },
  { id:'drill_starter', icon:'üèãÔ∏è', name:'Entrenador', desc:'Completa tu primer drill', check: a => (a.drills_completed||0) >= 1 },
  { id:'drill_master', icon:'üí™', name:'Drill Master', desc:'Completa 20 drills', check: a => (a.drills_completed||0) >= 20 },
];

function getTotalCaught(a) {
  const sessions = DB.sessions;
  let total = 0;
  sessions.forEach(s => {
    if (s.athlete_data && s.athlete_data[a.id] && (!s.modules_used || s.modules_used.includes('tactical')))
      total += s.athlete_data[a.id].caught || 0;
  });
  return total;
}

function getTotalPaddled(a) {
  const sessions = DB.sessions;
  let total = 0;
  sessions.forEach(s => {
    if (s.athlete_data && s.athlete_data[a.id] && (!s.modules_used || s.modules_used.includes('tactical')))
      total += s.athlete_data[a.id].paddled || 0;
  });
  return total;
}

function getOverallCatchRatio(a) {
  const p = getTotalPaddled(a);
  return p > 0 ? Math.round(getTotalCaught(a) / p * 100) : 0;
}

function getAvgWaveScore(a) {
  const heats = a.heat_history || [];
  const avgs = heats.filter(h => h.all_wave_avg > 0).map(h => h.all_wave_avg);
  return avgs.length > 0 ? avgs.reduce((s, v) => s + v, 0) / avgs.length : 0;
}

function getEarnedBadges(a) {
  return BADGE_DEFS.map(b => ({ ...b, earned: b.check(a) }));
}

// ============================================================
// PHASE 2: PLAYER CARD
// ============================================================
let _pcAthleteId = null;

function openPlayerCard(id) {
  _pcAthleteId = id;
  showView('player-card');
}

function renderPlayerCard() {
  const a = DB.athletes.find(x => x.id === _pcAthleteId);
  if (!a) { showView('athletes'); return; }
  
  const initials = a.name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
  const lvl = calcLevel(a.xp_total || 0);
  
  // Header
  document.getElementById('pcAvi').textContent = initials;
  document.getElementById('pcName').textContent = a.name;
  const discs = getAthleteDisciplines(a);
  const discBadges = discs.map(d => { const di = getDisciplineInfo(d); return `<span class="disc-badge" style="background:${di.color}20;color:${di.color}">${di.icon} ${di.label}</span>`; }).join(' ');
  document.getElementById('pcSub').innerHTML = `${discBadges} ¬∑ ${a.stance || 'Regular'} ¬∑ ${a.age ? a.age + ' a√±os' : ''}`;
  document.getElementById('pcLevel').textContent = `${lvl.name} ¬∑ Nivel ${lvl.level}`;
  document.getElementById('pcLevel').style.background = `linear-gradient(135deg,${LEVEL_COLORS[lvl.level]},${LEVEL_COLORS[Math.min(10,lvl.level+1)]})`;
  document.getElementById('pcXpFill').style.width = lvl.pct + '%';
  document.getElementById('pcXpText').textContent = `${lvl.xp} / ${lvl.next} XP`;
  
  // Discipline filter tabs
  const pcDiscFilter = document.getElementById('pcDiscFilter');
  const filterDisc = window._pcDiscFilter || 'all'; // 'all' or specific discipline
  if (discs.length > 1) {
    pcDiscFilter.style.display = 'flex';
    pcDiscFilter.innerHTML = `<div style="display:flex;gap:4px;flex-wrap:wrap;justify-content:center;width:100%">` +
      `<button onclick="window._pcDiscFilter='all';renderPlayerCard()" style="padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;border:1.5px solid ${filterDisc === 'all' ? 'var(--accent)' : 'var(--border)'};background:${filterDisc === 'all' ? 'var(--accent)10' : 'transparent'};color:${filterDisc === 'all' ? 'var(--accent)' : 'var(--text-muted)'}">üìä Todos</button>` +
      discs.map(d => {
        const di = getDisciplineInfo(d);
        const isActive = filterDisc === d;
        return `<button onclick="window._pcDiscFilter='${d}';renderPlayerCard()" style="padding:4px 10px;border-radius:20px;font-size:11px;font-weight:700;border:1.5px solid ${isActive ? di.color : 'var(--border)'};background:${isActive ? di.color + '20' : 'transparent'};color:${isActive ? di.color : 'var(--text-muted)'}">${di.icon} ${di.label}</button>`;
      }).join('') + `</div>`;
  } else {
    pcDiscFilter.style.display = 'none';
    window._pcDiscFilter = 'all';
  }
  
  // Filtered stats based on discipline
  const fd = filterDisc !== 'all' ? filterDisc : null; // null = all
  
  const sessCount = a.sessions_count || 0;
  const heats = (a.heat_history || []).filter(h => !fd || (h.discipline || getAthleteDiscipline(a)) === fd);
  const heatCount = heats.length;
  
  // Filtered caught/paddled from session waves
  let totalCaughtF = 0, totalPaddledF = 0;
  DB.sessions.forEach(s => {
    if (!s.athlete_data || !s.athlete_data[a.id]) return;
    const ad = s.athlete_data[a.id];
    if (fd) {
      // Count only waves tagged with this discipline
      (ad.waves || []).forEach(w => {
        const wd = w.discipline || getAthleteDiscipline(a);
        if (wd === fd) {
          if (w.type === 'caught') { totalCaughtF++; totalPaddledF++; }
          else if (w.type === 'fall') { totalPaddledF++; }
        }
      });
    } else {
      totalCaughtF += ad.caught || 0;
      totalPaddledF += ad.paddled || 0;
    }
  });
  const catchRatioF = totalPaddledF > 0 ? Math.round(totalCaughtF / totalPaddledF * 100) : 0;
  
  // Filtered avg heat score
  const heatAvgs = heats.filter(h => h.all_wave_avg > 0).map(h => h.all_wave_avg);
  const avgScoreF = heatAvgs.length > 0 ? heatAvgs.reduce((s, v) => s + v, 0) / heatAvgs.length : 0;
  
  document.getElementById('pcStats').innerHTML = [
    { val: fd ? heatCount : sessCount, lbl: fd ? 'Heats' : 'Sesiones', color: 'var(--accent)' },
    { val: totalCaughtF, lbl: 'Olas', color: 'var(--green)' },
    { val: catchRatioF + '%', lbl: 'Catch %', color: catchRatioF >= 60 ? 'var(--green)' : catchRatioF >= 40 ? 'var(--yellow)' : 'var(--red)' },
    { val: avgScoreF > 0 ? avgScoreF.toFixed(1) : '‚Äî', lbl: 'Avg Score', color: avgScoreF >= 6 ? 'var(--green)' : avgScoreF >= 4 ? 'var(--yellow)' : 'var(--text-primary)' },
  ].map(s => `<div class="pc-stat"><div class="pc-stat-val" style="color:${s.color}">${s.val}</div><div class="pc-stat-lbl">${s.lbl}</div></div>`).join('');
  
  // Per-discipline breakdown (only show in "All" mode)
  const pcDiscEl = document.getElementById('pcDiscBreakdown');
  if (discs.length > 1 && !fd) {
    const sessions = DB.sessions;
    const discStats = discs.map(d => {
      const di = getDisciplineInfo(d);
      let waves = 0, caught = 0, paddled = 0, falls = 0;
      sessions.forEach(s => {
        if (!s.athlete_data || !s.athlete_data[a.id]) return;
        const ad = s.athlete_data[a.id];
        // Count waves tagged with this discipline
        (ad.waves || []).forEach(w => {
          if ((w.discipline || 'surfboard') === d) {
            if (w.type === 'caught') { caught++; paddled++; }
            else if (w.type === 'fall') { falls++; paddled++; }
            waves++;
          }
        });
        // Untagged waves (old data) ‚Äî only attribute to primary discipline
        (ad.waves || []).filter(w => !w.discipline).forEach(w => {
          if (d === getAthleteDiscipline(a)) {
            if (w.type === 'caught') { caught++; paddled++; }
            else if (w.type === 'fall') { falls++; paddled++; }
            waves++;
          }
        });
      });
      const ratio = paddled > 0 ? Math.round(caught / paddled * 100) : 0;
      return { disc: d, di, waves, caught, paddled, falls, ratio };
    }).filter(ds => ds.waves > 0 || ds.disc === discs[0]); // Show all with data + primary always
    
    pcDiscEl.style.display = 'block';
    pcDiscEl.innerHTML = `<div class="card" style="padding:12px">
      <div class="card-header" style="font-size:13px;margin-bottom:10px">üìä Stats por Disciplina</div>
      ${discStats.map(ds => {
        const ratioColor = ds.ratio >= 60 ? 'var(--green)' : ds.ratio >= 40 ? 'var(--yellow)' : ds.paddled > 0 ? 'var(--red)' : 'var(--text-muted)';
        return `<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border)">
          <span class="disc-badge" style="background:${ds.di.color}20;color:${ds.di.color};min-width:80px;justify-content:center">${ds.di.icon} ${ds.di.label}</span>
          <div style="flex:1;display:flex;gap:12px;font-size:12px">
            <span style="color:var(--text-secondary)"><b style="color:var(--green)">${ds.caught}</b> olas</span>
            <span style="color:var(--text-secondary)"><b style="color:${ratioColor}">${ds.paddled > 0 ? ds.ratio + '%' : '‚Äî'}</b> catch</span>
            ${ds.falls > 0 ? `<span style="color:var(--text-secondary)"><b style="color:var(--red)">${ds.falls}</b> üí•</span>` : ''}
          </div>
        </div>`;
      }).join('')}
    </div>`;
  } else {
    pcDiscEl.style.display = 'none';
  }
  
  // Badges
  const badges = getEarnedBadges(a);
  const earned = badges.filter(b => b.earned);
  const locked = badges.filter(b => !b.earned);
  document.getElementById('pcBadges').innerHTML = 
    earned.map(b => `<div class="pc-badge earned"><span class="pc-badge-icon">${b.icon}</span><div class="pc-badge-info"><div class="pc-badge-name">${b.name}</div><div class="pc-badge-desc">${b.desc}</div></div></div>`).join('') +
    locked.slice(0, 4).map(b => `<div class="pc-badge locked"><span class="pc-badge-icon">üîí</span><div class="pc-badge-info"><div class="pc-badge-name">${b.name}</div><div class="pc-badge-desc">${b.desc}</div></div></div>`).join('');
  
  // Catch Ratio Chart (filtered by discipline)
  const sessions = DB.sessions;
  const athSessions = sessions.filter(s => s.athlete_data && s.athlete_data[a.id] && (!s.modules_used || s.modules_used.includes('tactical'))).slice(-8);
  const catchChart = document.getElementById('pcCatchChart');
  if (athSessions.length > 0) {
    catchChart.style.display = 'block';
    document.getElementById('pcCatchBars').innerHTML = athSessions.map((s, i) => {
      const d = s.athlete_data[a.id];
      let ratio;
      if (fd) {
        // Filter waves by discipline
        let fCaught = 0, fPaddled = 0;
        (d.waves || []).forEach(w => {
          const wd = w.discipline || getAthleteDiscipline(a);
          if (wd === fd) { if (w.type === 'caught') { fCaught++; fPaddled++; } else if (w.type === 'fall') { fPaddled++; } }
        });
        ratio = fPaddled > 0 ? Math.round(fCaught / fPaddled * 100) : -1; // -1 = no data for this disc
      } else {
        ratio = d.paddled > 0 ? Math.round(d.caught / d.paddled * 100) : 0;
      }
      if (ratio === -1) return ''; // Skip sessions with no data for this discipline
      const color = ratio >= 60 ? 'var(--green)' : ratio >= 40 ? 'var(--yellow)' : 'var(--red)';
      const label = s.spot.split(' ')[0].slice(0, 6);
      return `<div class="pc-bar-row"><div class="pc-bar-label">${label}</div><div class="pc-bar-track"><div class="pc-bar-fill" style="width:${ratio}%;background:${color}"></div></div><div class="pc-bar-val">${ratio}%</div></div>`;
    }).join('');
  } else { catchChart.style.display = 'none'; }
  
  // Score Distribution Chart (from filtered heats)
  const scoreChart = document.getElementById('pcScoreChart');
  if (heats.length > 0) {
    scoreChart.style.display = 'block';
    const recent = heats.slice(-8);
    document.getElementById('pcScoreBars').innerHTML = recent.map(h => {
      const pct = Math.min(100, (h.total / 20) * 100);
      const avgPct = h.all_wave_avg > 0 ? Math.min(100, (h.all_wave_avg / 10) * 100) : 0;
      const color = h.all_wave_avg >= 6 ? 'var(--green)' : h.all_wave_avg >= 4 ? 'var(--yellow)' : 'var(--red)';
      const label = `${h.discipline ? getDisciplineInfo(h.discipline).icon : ''}H${h.heat_number||'?'}`;
      return `<div class="pc-bar-row"><div class="pc-bar-label">${label}</div><div class="pc-bar-track"><div class="pc-bar-fill" style="width:${pct}%;background:var(--accent)"></div></div><div class="pc-bar-val">${h.total.toFixed(1)}</div></div>
      <div class="pc-bar-row" style="margin-top:-2px"><div class="pc-bar-label" style="font-size:9px">avg/w</div><div class="pc-bar-track" style="height:8px"><div class="pc-bar-fill" style="width:${avgPct}%;background:${color};height:100%"></div></div><div class="pc-bar-val" style="font-size:10px">${h.all_wave_avg.toFixed(1)}</div></div>`;
    }).join('');
  } else { scoreChart.style.display = 'none'; }
  
  // Active Drills
  const drills = a.assigned_drills || [];
  const drillsCard = document.getElementById('pcDrillsCard');
  drillsCard.style.display = 'block';
  if (drills.length > 0) {
    document.getElementById('pcDrills').innerHTML = drills.map(d => {
      const def = DRILL_LIBRARY.find(x => x.id === d.drill_id);
      if (!def) return '';
      return `<div class="drill-card" style="margin-bottom:6px;padding:10px">
        <div class="drill-header"><span class="drill-name">${def.icon} ${def.name}</span>
        <div style="display:flex;gap:4px">
          <button class="btn btn-sm" onclick="completeDrill('${a.id}','${d.drill_id}')" style="width:auto;padding:4px 10px;font-size:11px;background:var(--green)">‚úì</button>
          <button class="btn btn-sm" onclick="unassignDrill('${a.id}','${d.drill_id}')" style="width:auto;padding:4px 8px;font-size:11px;background:var(--bg-input)">√ó</button>
        </div></div>
        <div class="drill-desc">${def.desc}</div>
      </div>`;
    }).join('');
  } else {
    document.getElementById('pcDrills').innerHTML = '<div style="font-size:12px;color:var(--text-muted);padding:4px 0">Sin drills asignados</div>';
  }
  
  // Heat History
  const heatCard = document.getElementById('pcHeatCard');
  if (heats.length > 0) {
    heatCard.style.display = 'block';
    document.getElementById('pcHeats').innerHTML = heats.slice().reverse().slice(0, 10).map(h => {
      const posEmoji = h.position === 1 ? 'ü•á' : h.position === 2 ? 'ü•à' : h.position === 3 ? 'ü•â' : h.position + 'th';
      const d = new Date(h.date);
      const dateStr = new Intl.DateTimeFormat('es', { day:'numeric', month:'short' }).format(d);
      const discBdg = h.discipline ? getDisciplineInfo(h.discipline).icon + ' ' : '';
      return `<div class="pc-hist-item"><div><strong>${posEmoji}</strong> ${discBdg}H${h.heat_number||'?'} ¬∑ ${h.category||'?'} ¬∑ ${h.round||'?'}<div style="font-size:11px;color:var(--text-muted)">${dateStr} ¬∑ ${h.location||'?'} ¬∑ avg ${h.all_wave_avg?.toFixed(1)||'?'}/wave</div></div><div style="font-weight:800;font-size:16px">${h.total.toFixed(2)}</div></div>`;
    }).join('');
  } else { heatCard.style.display = 'none'; }
  
  // Session History (module-aware display)
  const athSess = sessions.filter(s => s.athlete_data && s.athlete_data[a.id]);
  const sessCard = document.getElementById('pcSessionCard');
  if (athSess.length > 0) {
    sessCard.style.display = 'block';
    document.getElementById('pcSessions').innerHTML = athSess.slice().reverse().slice(0, 10).map(s => {
      const d = s.athlete_data[a.id];
      const mods = s.modules_used || [];
      const hasTac = !s.modules_used || mods.includes('tactical');
      const dateStr = new Intl.DateTimeFormat('es', { day:'numeric', month:'short' }).format(new Date(s.date || s.started_at));
      
      let detail = '';
      let rightSide = '';
      
      if (hasTac && d.paddled > 0) {
        const ratio = Math.round(d.caught / d.paddled * 100);
        detail = `${d.caught}/${d.paddled} olas`;
        rightSide = `<div style="font-weight:800;font-size:16px;color:${ratio>=60?'var(--green)':ratio>=40?'var(--yellow)':'var(--red)'}">${ratio}%</div>`;
      } else if (d.judge_summary) {
        detail = `${d.judge_summary.heat_count} heats ¬∑ avg ${d.judge_summary.avg_wave_score.toFixed(1)}/ola`;
        rightSide = `<div style="font-weight:800;font-size:16px;color:var(--accent)">${d.judge_summary.avg_heat_total.toFixed(1)}</div>`;
      } else {
        const modLabels = mods.map(m => m === 'workout' ? 'üí™' : m === 'biomech' ? 'ü¶¥' : m === 'lab' ? 'üé•' : '').join('');
        detail = modLabels || 'sesi√≥n';
        rightSide = `<div style="font-size:12px;color:var(--text-muted)">‚úì</div>`;
      }
      
      return `<div class="pc-hist-item"><div><strong>${s.spot}</strong><div style="font-size:11px;color:var(--text-muted)">${dateStr} ¬∑ ${detail}</div></div>${rightSide}</div>`;
    }).join('');
  } else { sessCard.style.display = 'none'; }
  
  // Judge Training Sessions (from session judge_summary)
  const judgeSessions = athSess.filter(s => s.athlete_data[a.id].judge_summary);
  const judgeTrainCard = document.getElementById('pcJudgeTrainCard');
  if (judgeTrainCard) {
    if (judgeSessions.length > 0) {
      judgeTrainCard.style.display = 'block';
      let totalHeats = 0, allAvgWaves = [], allAvgTotals = [];
      judgeSessions.forEach(s => {
        const js = s.athlete_data[a.id].judge_summary;
        totalHeats += js.heat_count || 0;
        if (js.avg_wave_score > 0) allAvgWaves.push(js.avg_wave_score);
        if (js.avg_heat_total > 0) allAvgTotals.push(js.avg_heat_total);
      });
      const overallWaveAvg = allAvgWaves.length > 0 ? allAvgWaves.reduce((a,b)=>a+b,0)/allAvgWaves.length : 0;
      const overallHeatAvg = allAvgTotals.length > 0 ? allAvgTotals.reduce((a,b)=>a+b,0)/allAvgTotals.length : 0;
      const wColor = overallWaveAvg >= 6 ? 'var(--green)' : overallWaveAvg >= 4 ? 'var(--yellow)' : 'var(--red)';
      
      let html = `<div class="db-stat-grid" style="margin-bottom:8px">
        <div class="db-stat"><div class="db-stat-v">${judgeSessions.length}</div><div class="db-stat-l">Sesiones</div></div>
        <div class="db-stat"><div class="db-stat-v">${totalHeats}</div><div class="db-stat-l">Heats</div></div>
        <div class="db-stat"><div class="db-stat-v" style="color:${wColor}">${overallWaveAvg.toFixed(1)}</div><div class="db-stat-l">Avg/Ola</div></div>
        <div class="db-stat"><div class="db-stat-v" style="color:var(--accent)">${overallHeatAvg.toFixed(1)}</div><div class="db-stat-l">Avg Heat</div></div>
      </div>`;
      
      // Recent sessions
      html += judgeSessions.slice(-5).reverse().map(s => {
        const js = s.athlete_data[a.id].judge_summary;
        const dateStr = new Intl.DateTimeFormat('es', { day:'numeric', month:'short' }).format(new Date(s.date || s.started_at));
        return `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px">
          <div>${s.spot} ¬∑ ${dateStr} ¬∑ ${js.heat_count} heat${js.heat_count>1?'s':''}</div>
          <div style="font-weight:700;color:var(--accent)">${js.avg_heat_total.toFixed(1)}</div>
        </div>`;
      }).join('');
      
      document.getElementById('pcJudgeTrainContent').innerHTML = html;
    } else { judgeTrainCard.style.display = 'none'; }
  }
  
  // Biomechanics history across sessions
  const allBio = athSess.flatMap(s => (s.athlete_data[a.id].biomech || []).map(b => ({ ...b, spot: s.spot, date: s.date || s.started_at })));
  const bioCard = document.getElementById('pcBioCard');
  if (bioCard) {
    if (allBio.length > 0) {
      bioCard.style.display = 'block';
      const fields = ['bio_shoulders','bio_knees','bio_arms','bio_compression','bio_head','bio_backfoot','bio_weight'];
      const labels = ['Hombros','Rodillas','Brazos','Compresi√≥n','Cabeza','Pie Trasero','Trans. Peso'];
      
      let barsHtml = fields.map((f, i) => {
        const avg = bioAvgScore(allBio, f);
        const color = avg >= 60 ? 'var(--green)' : avg >= 30 ? 'var(--yellow)' : avg > 0 ? 'var(--red)' : 'var(--text-muted)';
        return `<div class="pc-bar-row"><div class="pc-bar-label">${labels[i]}</div><div class="pc-bar-track"><div class="pc-bar-fill" style="width:${avg}%;background:${color}"></div></div><div class="pc-bar-val">${avg}</div></div>`;
      }).join('');
      
      const flows = allBio.map(b => parseInt(b.bio_flow)).filter(n => !isNaN(n));
      const avgFlow = flows.length > 0 ? (flows.reduce((a,b)=>a+b,0)/flows.length).toFixed(1) : '‚Äî';
      
      document.getElementById('pcBioContent').innerHTML = `
        <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px">${allBio.length} evaluaciones biomec√°nicas</div>
        ${barsHtml}
        <div style="font-size:13px;margin-top:8px">Fluidez promedio: <strong>${avgFlow}/5</strong></div>
      `;
    } else { bioCard.style.display = 'none'; }
  }
  
  // Biometrics
  renderBiometrics(a);
  
  // Lab frames for this athlete
  renderLabFramesForAthlete(a);
}

function deleteAthleteFromCard() {
  if (!confirm('¬øEliminar este atleta y todo su historial?')) return;
  DB.athletes = DB.athletes.filter(a => a.id !== _pcAthleteId);
  showView('athletes');
}

function editAthlete() {
  const a = DB.athletes.find(x => x.id === _pcAthleteId);
  if (!a) return;
  document.getElementById('maName').value = a.name;
  document.getElementById('maAge').value = a.age || '';
  segSelect('maStance', document.querySelector(`#maStance .seg-btn[data-v="${a.stance||'regular'}"]`));
  // Set disciplines (multi-select)
  const discs = getAthleteDisciplines(a);
  document.querySelectorAll('#maDisc .disc-btn').forEach(b => {
    b.classList.toggle('selected', discs.includes(b.dataset.v));
  });
  // Hide stance if no wave discipline
  const hasWaveDisc = discs.some(d => isDiscWaveBased(d));
  document.getElementById('maStance').closest('.field').style.display = hasWaveDisc ? '' : 'none';
  window._editAthleteId = _pcAthleteId;
  document.querySelector('#modalAddAthlete .modal-title').textContent = 'Editar Atleta';
  document.getElementById('modalAddAthlete').classList.add('active');
}

// ============================================================
// PHASE 2: DRILL BANK
// ============================================================
const DRILL_LIBRARY = [
  // PADDLING
  { id:'d01', cat:'Paddling', icon:'üèä', name:'Sprint Paddle', desc:'5 sprints de 20 seg con 10 seg descanso. Enf√≥cate en la cadencia y mantener la cabeza baja.', duration:'5 min', level:'Todos' },
  { id:'d02', cat:'Paddling', icon:'üèä', name:'Duck Dive Drill', desc:'Practica duck dive en espuma con tabla grande. Repite 10 veces sin perder ritmo de remada.', duration:'10 min', level:'Grom+' },
  { id:'d03', cat:'Paddling', icon:'üèä', name:'Endurance Paddle', desc:'Rema continuo por 15 min manteniendo postura. Ideal como calentamiento.', duration:'15 min', level:'Todos' },
  
  // POP-UP
  { id:'d04', cat:'Pop-up', icon:'ü§∏', name:'Pop-up en Arena', desc:'20 repeticiones de pop-up en la arena. Tiempo objetivo: < 1 segundo. Enf√≥cate en un movimiento fluido.', duration:'10 min', level:'Kook' },
  { id:'d05', cat:'Pop-up', icon:'ü§∏', name:'Pop-up con Giro', desc:'Pop-up + giro inmediato 45¬∞. Simula el take-off en olas con √°ngulo. 15 reps por lado.', duration:'10 min', level:'Grom+' },
  
  // BOTTOM TURN
  { id:'d06', cat:'Bottom Turn', icon:'üí™', name:'BT Compression', desc:'En espuma: enf√≥cate en flexionar las rodillas y comprimir al fondo de la ola antes de subir. 10 olas.', duration:'20 min', level:'Grom+' },
  { id:'d07', cat:'Bottom Turn', icon:'üí™', name:'BT Rail Engage', desc:'Toma 5 olas concentr√°ndote solo en hundir el rail durante el bottom turn. Mano trasera toca el agua.', duration:'20 min', level:'Ripper' },
  
  // MANEUVERS
  { id:'d08', cat:'Maniobras', icon:'üî•', name:'Cutback Drill', desc:'Toma 5 olas y enf√≥cate en hacer cutback completo volviendo a la espuma. Prioriza el arco.', duration:'25 min', level:'Ripper' },
  { id:'d09', cat:'Maniobras', icon:'üî•', name:'Snap Practice', desc:'En secci√≥n vertical, practica snaps con m√°xima rotaci√≥n. 5 olas enfocado solo en el snap.', duration:'20 min', level:'Ripper+' },
  { id:'d10', cat:'Maniobras', icon:'üî•', name:'Floater Line', desc:'Busca secciones cerrando para practicar floaters. Enf√≥cate en timing y aterrizaje. 5 intentos.', duration:'20 min', level:'Ripper' },
  { id:'d11', cat:'Maniobras', icon:'üî•', name:'Re-entry Drill', desc:'En olas con labio definido, practica re-entries. Enf√≥cate en el timing del lip.', duration:'20 min', level:'Charger' },
  
  // WAVE READING
  { id:'d12', cat:'Lectura', icon:'üëÅÔ∏è', name:'Set Prediction', desc:'Desde la orilla, predice cu√°l ola del set ser√° la mejor. Cuenta sets por 15 min. Anota aciertos.', duration:'15 min', level:'Todos' },
  { id:'d13', cat:'Lectura', icon:'üëÅÔ∏è', name:'Lineup Study', desc:'Observa el lineup 10 min antes de entrar. Identifica: pico, corriente, secci√≥n m√°s larga, frecuencia de sets.', duration:'10 min', level:'Todos' },
  { id:'d14', cat:'Lectura', icon:'üëÅÔ∏è', name:'Priority Game', desc:'En sesi√≥n con amigos, practica reglas de prioridad ISA. Trabaja posicionamiento sin interferir.', duration:'30 min', level:'Grom+' },
  
  // FITNESS
  { id:'d15', cat:'Fitness', icon:'üèãÔ∏è', name:'Indo Board 5min', desc:'5 minutos de balance en Indo Board o similar. Trabaja front/backside shifts.', duration:'5 min', level:'Todos' },
  { id:'d16', cat:'Fitness', icon:'üèãÔ∏è', name:'Core Circuit', desc:'30s plank + 15 V-ups + 20 russian twists + 10 superman. 3 rondas.', duration:'15 min', level:'Todos' },
  { id:'d17', cat:'Fitness', icon:'üèãÔ∏è', name:'Squat Series', desc:'20 squats + 10 jump squats + 10 pistol squats (por pierna). Potencia para bottom turns.', duration:'10 min', level:'Grom+' },
  
  // MENTAL
  { id:'d18', cat:'Mental', icon:'üß†', name:'Visualizaci√≥n', desc:'Cierra los ojos y visualiza tu sesi√≥n ideal: el take-off perfecto, la maniobra, la salida. 5 minutos.', duration:'5 min', level:'Todos' },
  { id:'d19', cat:'Mental', icon:'üß†', name:'Heat Simulation', desc:'Antes de competir: visualiza tu heat. Prioridad, selecci√≥n de olas, combinaci√≥n de scores.', duration:'10 min', level:'Ripper+' },
];

const DRILL_CATS = ['Todos', 'Paddling', 'Pop-up', 'Bottom Turn', 'Maniobras', 'Lectura', 'Fitness', 'Mental'];

function renderDrillBank() {
  let activeCat = window._drillCat || 'Todos';
  
  // Category filters
  document.getElementById('drillCatFilter').innerHTML = DRILL_CATS.map(c =>
    `<button class="drill-cat-btn ${c === activeCat ? 'active' : ''}" onclick="filterDrills('${c}')">${c}</button>`
  ).join('');
  
  // Filtered drills
  const filtered = activeCat === 'Todos' ? DRILL_LIBRARY : DRILL_LIBRARY.filter(d => d.cat === activeCat);
  
  document.getElementById('drillList').innerHTML = filtered.map(d => {
    return `<div class="drill-card">
      <div class="drill-header"><span class="drill-name">${d.icon} ${d.name}</span><span class="drill-cat">${d.cat}</span></div>
      <div class="drill-desc">${d.desc}</div>
      <div class="drill-meta"><span>‚è±Ô∏è ${d.duration}</span><span>üìä ${d.level}</span></div>
    </div>`;
  }).join('');
}

function filterDrills(cat) {
  window._drillCat = cat;
  renderDrillBank();
}

function openDrillPicker() {
  const a = DB.athletes.find(x => x.id === _pcAthleteId);
  if (!a) return;
  const assigned = (a.assigned_drills || []).map(d => d.drill_id);
  let activeCat = 'Todos';
  
  function render(cat) {
    activeCat = cat;
    document.getElementById('dpCatFilter').innerHTML = DRILL_CATS.map(c =>
      `<button class="drill-cat-btn ${c === activeCat ? 'active' : ''}" onclick="dpFilter('${c}')">${c}</button>`
    ).join('');
    
    const filtered = activeCat === 'Todos' ? DRILL_LIBRARY : DRILL_LIBRARY.filter(d => d.cat === activeCat);
    document.getElementById('dpDrillList').innerHTML = filtered.map(d => {
      const isAssigned = assigned.includes(d.id);
      return `<div class="drill-card ${isAssigned ? 'assigned' : ''}" style="padding:10px">
        <div class="drill-header">
          <span class="drill-name" style="font-size:13px">${d.icon} ${d.name}</span>
          ${isAssigned ? '<span style="color:var(--green);font-size:12px;font-weight:700">‚úì Asignado</span>' : 
            `<button class="btn btn-sm" onclick="assignDrill('${a.id}','${d.id}')" style="width:auto;padding:4px 10px;font-size:11px;background:var(--accent)">+ Asignar</button>`}
        </div>
        <div class="drill-desc" style="font-size:11px">${d.desc}</div>
      </div>`;
    }).join('');
  }
  
  window.dpFilter = (cat) => render(cat);
  render('Todos');
  document.getElementById('modalDrillPicker').classList.add('active');
}

function assignDrill(athId, drillId) {
  const athletes = DB.athletes;
  const a = athletes.find(x => x.id === athId);
  if (!a) return;
  if (!a.assigned_drills) a.assigned_drills = [];
  if (a.assigned_drills.some(d => d.drill_id === drillId)) return;
  a.assigned_drills.push({ drill_id: drillId, assigned_at: new Date().toISOString() });
  DB.athletes = athletes;
  openDrillPicker(); // Refresh picker
  renderPlayerCard(); // Refresh card
}

function unassignDrill(athId, drillId) {
  const athletes = DB.athletes;
  const a = athletes.find(x => x.id === athId);
  if (!a) return;
  a.assigned_drills = (a.assigned_drills || []).filter(d => d.drill_id !== drillId);
  DB.athletes = athletes;
  renderPlayerCard();
}

function completeDrill(athId, drillId) {
  const athletes = DB.athletes;
  const a = athletes.find(x => x.id === athId);
  if (!a) return;
  
  // Remove from assigned
  a.assigned_drills = (a.assigned_drills || []).filter(d => d.drill_id !== drillId);
  
  // Track completion
  a.drills_completed = (a.drills_completed || 0) + 1;
  
  // Award XP
  a.xp_total = (a.xp_total || 0) + 25;
  
  DB.athletes = athletes;
  renderPlayerCard();
  
  if (navigator.vibrate) navigator.vibrate([30, 50, 30]);
}

// ============================================================
// PHASE 3: TECH LAB - VIDEO ANALYSIS
// ============================================================
let labVideoFile = null;
let labDrawTool = 'none';
let labDrawColor = '#ef4444';
let labStrokeWidth = 4;
let labDrawing = false;
let labDrawPoints = [];
let labAnnotations = [];
let labAnglePoints = [];
let labIsFullscreen = false;

function labEnterFullscreen() {
  const container = document.getElementById('labFsContainer');
  const nav = document.querySelector('.bottom-nav');
  
  container.classList.add('lab-fullscreen');
  if (nav) nav.style.display = 'none';
  document.getElementById('labFsClose').style.display = 'flex';
  document.getElementById('labFsExpand').style.display = 'none';
  document.body.style.overflow = 'hidden';
  labIsFullscreen = true;
  
  // Try native fullscreen API (works on some mobile browsers)
  try {
    if (container.requestFullscreen) container.requestFullscreen();
    else if (container.webkitRequestFullscreen) container.webkitRequestFullscreen();
  } catch(e) { /* CSS fullscreen fallback is fine */ }
  
  // Force screen to stay on if possible
  try { if (navigator.wakeLock) navigator.wakeLock.request('screen'); } catch(e) {}
  
  // Resize canvas after layout settles
  setTimeout(labResizeCanvas, 100);
}

function labExitFullscreen() {
  const container = document.getElementById('labFsContainer');
  const nav = document.querySelector('.bottom-nav');
  
  container.classList.remove('lab-fullscreen');
  if (nav) nav.style.display = '';
  document.getElementById('labFsClose').style.display = 'none';
  document.getElementById('labFsExpand').style.display = 'flex';
  document.body.style.overflow = '';
  labIsFullscreen = false;
  
  // Exit native fullscreen
  try {
    if (document.exitFullscreen) document.exitFullscreen();
    else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
  } catch(e) {}
  
  setTimeout(labResizeCanvas, 100);
}

// Listen for ESC / native fullscreen exit
document.addEventListener('fullscreenchange', () => {
  if (!document.fullscreenElement && labIsFullscreen) labExitFullscreen();
});
document.addEventListener('webkitfullscreenchange', () => {
  if (!document.webkitFullscreenElement && labIsFullscreen) labExitFullscreen();
});

function renderLab() {
  // Populate athlete dropdown
  const sel = document.getElementById('labAthlete');
  const athletes = DB.athletes;
  sel.innerHTML = '<option value="">‚Äî Sin vincular ‚Äî</option>' +
    athletes.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
  
  // Hide discipline dropdown initially
  document.getElementById('labDiscField').style.display = 'none';
  
  // Preload stickers
  labPreloadStickers();
  
  // Reset sticker/zoom state
  labPlacedStickers = [];
  labSelectedSticker = null;
  labActiveSticker = null;
  labZoom = 1; labPanX = 0; labPanY = 0;
  labApplyZoom();
  
  // Render saved frames
  renderLabFrames();
  renderLabClips();
}

function labAthleteChanged() {
  const athId = document.getElementById('labAthlete').value;
  const discField = document.getElementById('labDiscField');
  const discSel = document.getElementById('labDisc');
  
  if (athId) {
    const ath = DB.athletes.find(a => a.id === athId);
    if (ath) {
      const discs = getAthleteDisciplines(ath);
      if (discs.length > 1) {
        discSel.innerHTML = discs.map(d => { const di = getDisciplineInfo(d); return `<option value="${d}">${di.label}</option>`; }).join('');
        discField.style.display = 'block';
        return;
      }
    }
  }
  discField.style.display = 'none';
}

function labLoadVideo(input) {
  const file = input.files[0];
  if (!file) return;
  labVideoFile = file;
  
  const video = document.getElementById('labVideo');
  const url = URL.createObjectURL(file);
  video.src = url;
  video.load();
  
  video.onloadedmetadata = () => {
    document.getElementById('labPlayerSection').style.display = 'block';
    document.getElementById('labTimeline').max = video.duration;
    labResizeCanvas();
    labAnnotations = [];
    labPlacedStickers = [];
    labActiveSticker = null;
    labZoom = 1; labPanX = 0; labPanY = 0;
    labApplyZoom();
    labInitZoomGestures();
    labInitGestures();
  };
  
  video.ontimeupdate = () => {
    if (!video.paused) {
      document.getElementById('labTimeline').value = video.currentTime;
      labUpdateTime();
    }
  };
  
  video.onended = () => {
    document.getElementById('labPlayBtn').textContent = '‚ñ∂Ô∏è';
  };
}

function labResizeCanvas() {
  const video = document.getElementById('labVideo');
  const canvas = document.getElementById('labCanvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.style.width = '100%';
  canvas.style.height = '100%';
}

function labTogglePlay() {
  const video = document.getElementById('labVideo');
  const btn = document.getElementById('labPlayBtn');
  if (video.paused) {
    video.play();
    btn.textContent = '‚è∏Ô∏è';
  } else {
    video.pause();
    btn.textContent = '‚ñ∂Ô∏è';
  }
}

function labStep(dir) {
  const video = document.getElementById('labVideo');
  video.pause();
  document.getElementById('labPlayBtn').textContent = '‚ñ∂Ô∏è';
  // ~30fps = 0.033s per frame
  video.currentTime = Math.max(0, Math.min(video.duration, video.currentTime + dir * 0.033));
  document.getElementById('labTimeline').value = video.currentTime;
  labUpdateTime();
}

function labSeek(val) {
  const video = document.getElementById('labVideo');
  video.currentTime = parseFloat(val);
  labUpdateTime();
}

function labSpeed(rate) {
  const video = document.getElementById('labVideo');
  video.playbackRate = rate;
  document.querySelectorAll('.lab-szrow .lab-spd-btn').forEach(b => b.classList.remove('active'));
  if (event && event.target) event.target.classList.add('active');
}

function labUpdateTime() {
  const video = document.getElementById('labVideo');
  const t = video.currentTime;
  const m = Math.floor(t / 60);
  const s = Math.floor(t % 60);
  const ms = Math.floor((t % 1) * 10);
  document.getElementById('labTime').textContent = `${m}:${s.toString().padStart(2,'0')}.${ms}`;
}

function labSetTool(tool, el) {
  labDrawTool = tool;
  const canvas = document.getElementById('labCanvas');
  const gest = document.getElementById('labGesture');
  
  document.querySelectorAll('.lab-tool').forEach(b => b.classList.remove('active'));
  if (el) el.classList.add('active');
  
  // Remove all listeners
  canvas.onmousedown = canvas.onmousemove = canvas.onmouseup = null;
  canvas.ontouchstart = canvas.ontouchmove = canvas.ontouchend = canvas.ontouchcancel = null;
  
  if (tool === 'none') {
    canvas.classList.remove('drawing');
    canvas.style.cursor = '';
    if (gest) gest.classList.remove('disabled');
    // Hide sticker bar if no placed stickers
    if (labPlacedStickers.length === 0) labHideStickerBar();
  } else {
    canvas.classList.add('drawing');
    if (gest) gest.classList.add('disabled');
    // Mouse events
    canvas.onmousedown = labPointerDown;
    canvas.onmousemove = labPointerMove;
    canvas.onmouseup = labPointerUp;
    // Touch events (iOS/tablet)
    canvas.ontouchstart = (e) => { e.preventDefault(); labPointerDown(labTouchToMouse(e)); };
    canvas.ontouchmove = (e) => { e.preventDefault(); labPointerMove(labTouchToMouse(e)); };
    canvas.ontouchend = (e) => { e.preventDefault(); labPointerUp(labTouchToMouse(e)); };
    canvas.ontouchcancel = (e) => { labDrawing = false; };
  }
}

function labTouchToMouse(te) {
  const t = te.touches[0] || te.changedTouches[0];
  return { clientX: t.clientX, clientY: t.clientY, preventDefault: () => {} };
}

function labGetPos(e) {
  const canvas = document.getElementById('labCanvas');
  const rect = canvas.getBoundingClientRect();
  return {
    x: (e.clientX - rect.left) / rect.width * canvas.width,
    y: (e.clientY - rect.top) / rect.height * canvas.height
  };
}

function labPointerDown(e) {
  e.preventDefault();
  labDrawing = true;
  const pos = labGetPos(e);
  
  if (labDrawTool === 'pen') {
    labDrawPoints = [pos];
  } else if (labDrawTool === 'arrow') {
    labDrawPoints = [pos];
  } else if (labDrawTool === 'angle') {
    labAnglePoints.push(pos);
    if (labAnglePoints.length === 3) {
      labAnnotations.push({ type: 'angle', points: [...labAnglePoints], color: labDrawColor, width: labStrokeWidth });
      labAnglePoints = [];
      labRedraw();
    } else {
      labRedraw();
    }
    labDrawing = false;
    return;
  }
}

function labPointerMove(e) {
  if (!labDrawing) return;
  e.preventDefault();
  const pos = labGetPos(e);
  
  if (labDrawTool === 'pen') {
    labDrawPoints.push(pos);
    labRedraw();
    // Draw current stroke
    const ctx = document.getElementById('labCanvas').getContext('2d');
    ctx.beginPath();
    ctx.strokeStyle = labDrawColor;
    ctx.lineWidth = labStrokeWidth;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    labDrawPoints.forEach((p, i) => {
      if (i === 0) ctx.moveTo(p.x, p.y);
      else ctx.lineTo(p.x, p.y);
    });
    ctx.stroke();
  } else if (labDrawTool === 'arrow') {
    labRedraw();
    const ctx = document.getElementById('labCanvas').getContext('2d');
    labDrawArrow(ctx, labDrawPoints[0], pos, labDrawColor, labStrokeWidth);
  }
}

function labPointerUp(e) {
  if (!labDrawing) return;
  labDrawing = false;
  const pos = labGetPos(e);
  
  if (labDrawTool === 'pen' && labDrawPoints.length > 1) {
    labAnnotations.push({ type: 'pen', points: [...labDrawPoints], color: labDrawColor, width: labStrokeWidth });
  } else if (labDrawTool === 'arrow') {
    labAnnotations.push({ type: 'arrow', from: labDrawPoints[0], to: pos, color: labDrawColor, width: labStrokeWidth });
  }
  labDrawPoints = [];
  labRedraw();
}

function labDrawArrow(ctx, from, to, color, width) {
  ctx.beginPath();
  ctx.strokeStyle = color;
  ctx.fillStyle = color;
  ctx.lineWidth = width;
  ctx.moveTo(from.x, from.y);
  ctx.lineTo(to.x, to.y);
  ctx.stroke();
  
  // Arrowhead
  const angle = Math.atan2(to.y - from.y, to.x - from.x);
  const headLen = 15 + width * 2;
  ctx.beginPath();
  ctx.moveTo(to.x, to.y);
  ctx.lineTo(to.x - headLen * Math.cos(angle - Math.PI / 6), to.y - headLen * Math.sin(angle - Math.PI / 6));
  ctx.lineTo(to.x - headLen * Math.cos(angle + Math.PI / 6), to.y - headLen * Math.sin(angle + Math.PI / 6));
  ctx.closePath();
  ctx.fill();
}

function labRedraw() {
  const canvas = document.getElementById('labCanvas');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  labAnnotations.forEach(a => {
    if (a.type === 'pen') {
      ctx.beginPath();
      ctx.strokeStyle = a.color;
      ctx.lineWidth = a.width;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      a.points.forEach((p, i) => { if (i === 0) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y); });
      ctx.stroke();
    } else if (a.type === 'arrow') {
      labDrawArrow(ctx, a.from, a.to, a.color, a.width);
    } else if (a.type === 'angle') {
      const [p1, p2, p3] = a.points;
      ctx.beginPath();
      ctx.strokeStyle = a.color;
      ctx.lineWidth = a.width;
      ctx.moveTo(p1.x, p1.y);
      ctx.lineTo(p2.x, p2.y);
      ctx.lineTo(p3.x, p3.y);
      ctx.stroke();
      
      // Calculate and display angle
      const a1 = Math.atan2(p1.y - p2.y, p1.x - p2.x);
      const a2 = Math.atan2(p3.y - p2.y, p3.x - p2.x);
      let deg = Math.abs((a2 - a1) * 180 / Math.PI);
      if (deg > 180) deg = 360 - deg;
      
      // Arc
      ctx.beginPath();
      ctx.arc(p2.x, p2.y, 30, Math.min(a1, a2), Math.max(a1, a2));
      ctx.stroke();
      
      // Label
      ctx.font = 'bold 16px sans-serif';
      ctx.fillStyle = a.color;
      ctx.fillText(Math.round(deg) + '¬∞', p2.x + 35, p2.y - 10);
      
      // Dots on vertices
      [p1, p2, p3].forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
        ctx.fillStyle = a.color;
        ctx.fill();
      });
    }
  });
  
  // Draw angle points in progress
  if (labAnglePoints.length > 0) {
    ctx.fillStyle = labDrawColor;
    labAnglePoints.forEach(p => {
      ctx.beginPath();
      ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
      ctx.fill();
    });
    if (labAnglePoints.length === 2) {
      ctx.beginPath();
      ctx.strokeStyle = labDrawColor;
      ctx.lineWidth = labStrokeWidth;
      ctx.setLineDash([5, 5]);
      ctx.moveTo(labAnglePoints[0].x, labAnglePoints[0].y);
      ctx.lineTo(labAnglePoints[1].x, labAnglePoints[1].y);
      ctx.stroke();
      ctx.setLineDash([]);
    }
  }
  
  // Draw placed stickers
  labPlacedStickers.forEach(st => {
    const img = labStickerImages[st.stkId];
    if (img) {
      ctx.drawImage(img, st.x, st.y, st.w, st.h);
      // Selection highlight
      if (labActiveSticker && labActiveSticker.id === st.id) {
        ctx.strokeStyle = '#6366f1';
        ctx.lineWidth = 3;
        ctx.setLineDash([6, 4]);
        ctx.strokeRect(st.x - 4, st.y - 4, st.w + 8, st.h + 8);
        ctx.setLineDash([]);
        // Corner dots
        const corners = [[st.x-4,st.y-4],[st.x+st.w+4,st.y-4],[st.x-4,st.y+st.h+4],[st.x+st.w+4,st.y+st.h+4]];
        corners.forEach(c => {
          ctx.beginPath(); ctx.arc(c[0],c[1],5,0,Math.PI*2);
          ctx.fillStyle='#6366f1'; ctx.fill();
          ctx.strokeStyle='#fff'; ctx.lineWidth=1.5; ctx.stroke();
        });
      }
    }
  });
}

function labClearDraw() {
  labAnnotations = [];
  labAnglePoints = [];
  labPlacedStickers = [];
  labActiveSticker = null;
  const canvas = document.getElementById('labCanvas');
  canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
}

function labSetColor(color, el) {
  labDrawColor = color;
  document.querySelectorAll('.lab-color-dot').forEach(d => d.classList.remove('active'));
  if (el) el.classList.add('active');
}

function labCapture() {
  const video = document.getElementById('labVideo');
  const canvas = document.getElementById('labCanvas');
  
  // Create composite: video frame + annotations + stickers
  const tmpCanvas = document.createElement('canvas');
  tmpCanvas.width = video.videoWidth;
  tmpCanvas.height = video.videoHeight;
  const ctx = tmpCanvas.getContext('2d');
  
  // Draw video frame
  ctx.drawImage(video, 0, 0);
  
  // Temporarily hide selection UI for clean capture
  const prevTool = labDrawTool;
  const prevActive = labActiveSticker;
  labDrawTool = 'none';
  labActiveSticker = null;
  labRedraw();
  
  // Draw annotations + stickers on top
  ctx.drawImage(canvas, 0, 0);
  
  // Restore tool + selection
  labDrawTool = prevTool;
  labActiveSticker = prevActive;
  labRedraw();
  
  // Convert to data URL (compressed)
  const dataUrl = tmpCanvas.toDataURL('image/jpeg', 0.7);
  
  const athId = document.getElementById('labAthlete').value;
  const labDiscSel = document.getElementById('labDisc');
  const labDiscField = document.getElementById('labDiscField');
  const labDisc = (athId && labDiscField.style.display !== 'none' && labDiscSel.value) ? labDiscSel.value : null;
  const frame = {
    id: DB.genId(),
    athlete_id: athId || null,
    discipline: labDisc || (athId ? (() => { const a = DB.athletes.find(x => x.id === athId); return a ? getAthleteDiscipline(a) : null; })() : null),
    timestamp: video.currentTime,
    image: dataUrl,
    created_at: new Date().toISOString()
  };
  
  try {
    const frames = DB.labFrames;
    frames.push(frame);
    DB.labFrames = frames;
  } catch(e) {
    // localStorage might be full
    alert('Error guardando frame. Storage puede estar lleno. Intenta eliminar frames antiguos.');
    console.error(e);
    return;
  }
  
  renderLabFrames();
  if (navigator.vibrate) navigator.vibrate(30);
}

function renderLabFrames() {
  const frames = DB.labFrames;
  const section = document.getElementById('labFramesSection');
  
  if (frames.length === 0) {
    section.style.display = 'none';
    return;
  }
  section.style.display = 'block';
  
  document.getElementById('labFrames').innerHTML = frames.slice().reverse().map(f => {
    const t = f.timestamp || 0;
    const m = Math.floor(t / 60);
    const s = Math.floor(t % 60);
    const timeStr = `${m}:${s.toString().padStart(2,'0')}`;
    const ath = f.athlete_id ? (DB.athletes.find(a => a.id === f.athlete_id)?.name?.split(' ')[0] || '') : '';
    const discIcon = f.discipline ? getDisciplineInfo(f.discipline).icon : '';
    return `<div class="lab-frame" onclick="labFrameActions('${f.id}')">
      <img src="${f.image}" loading="lazy">
      <div class="lab-frame-time">${timeStr} ${ath ? '¬∑ '+ath : ''} ${discIcon}</div>
    </div>`;
  }).join('');
}

function labFrameActions(id) {
  const action = confirm('¬øEliminar este frame?\n\nOK = Eliminar\nCancel = Mantener');
  if (action) {
    DB.labFrames = DB.labFrames.filter(f => f.id !== id);
    renderLabFrames();
  }
}

function labCompareMode() {
  const frames = DB.labFrames;
  if (frames.length < 2) { alert('Necesitas al menos 2 frames para comparar'); return; }
  
  const section = document.getElementById('labCompareSection');
  section.style.display = 'block';
  
  window._labCompare = [];
  
  document.getElementById('labCompare').innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:12px;padding:20px;grid-column:span 2">Selecciona 2 frames abajo</div>';
  
  document.getElementById('labCompareSelect').innerHTML = frames.slice().reverse().map(f => {
    const t = f.timestamp || 0;
    const timeStr = `${Math.floor(t/60)}:${Math.floor(t%60).toString().padStart(2,'0')}`;
    return `<div class="lab-frame" onclick="labSelectCompare('${f.id}')" style="border-color:var(--border)">
      <img src="${f.image}" loading="lazy">
      <div class="lab-frame-time">${timeStr}</div>
    </div>`;
  }).join('');
}

function labSelectCompare(id) {
  const frames = DB.labFrames;
  const f = frames.find(x => x.id === id);
  if (!f) return;
  
  if (!window._labCompare) window._labCompare = [];
  if (window._labCompare.length >= 2) window._labCompare = [];
  window._labCompare.push(f);
  
  if (window._labCompare.length === 2) {
    document.getElementById('labCompare').innerHTML = window._labCompare.map(f => 
      `<img src="${f.image}">`
    ).join('');
  }
}

function renderLabClips() {
  const frames = DB.labFrames;
  const empty = document.getElementById('labClipsEmpty');
  const container = document.getElementById('labClips');
  
  if (frames.length === 0) {
    empty.style.display = 'block';
    container.innerHTML = '';
    return;
  }
  empty.style.display = 'none';
  
  // Group by athlete
  const byAth = {};
  frames.forEach(f => {
    const key = f.athlete_id || '_unlinked';
    if (!byAth[key]) byAth[key] = [];
    byAth[key].push(f);
  });
  
  container.innerHTML = Object.entries(byAth).map(([athId, aFrames]) => {
    const name = athId === '_unlinked' ? 'Sin vincular' : (DB.athletes.find(a => a.id === athId)?.name || 'Atleta');
    return `<div class="lab-clip">
      <div class="lab-clip-header"><span class="lab-clip-name">${name}</span><span class="lab-clip-meta">${aFrames.length} frames</span></div>
    </div>`;
  }).join('');
}

// ============================================================
// LAB STICKER LIBRARY
// ============================================================
const LAB_STICKERS = [
  { id:'stk01', name:'Aerial', file:'stickers_0000s_0000_Screenshot-2026-02-16-143059.png', cat:'SB' },
  { id:'stk02', name:'Cutback', file:'stickers_0000s_0001_Screenshot-2026-02-16-143050.png', cat:'SB' },
  { id:'stk03', name:'Reentry', file:'stickers_0000s_0002_Screenshot-2026-02-16-142954.png', cat:'SB' },
  { id:'stk04', name:'Tube', file:'stickers_0000s_0003_Screenshot-2026-02-16-142945.png', cat:'SB' },
  { id:'stk05', name:'Snap', file:'stickers_0000s_0004_Screenshot-2026-02-16-142928.png', cat:'SB' },
  { id:'stk06', name:'Air Grab', file:'stickers_0000s_0005_Screenshot-2026-02-16-142920.png', cat:'SB' },
  { id:'stk07', name:'Bottom Turn', file:'stickers_0000s_0006_Screenshot-2026-02-16-142911.png', cat:'SB' },
  { id:'stk08', name:'BS Off The Top', file:'stickers_0000s_0007_bs-ooff-the-top.png', cat:'BS' },
  { id:'stk09', name:'BS Carving', file:'stickers_0000s_0008_bs-carving.png', cat:'BS' },
  { id:'stk10', name:'Finishing OTT', file:'stickers_0000s_0009_finishing-off-the-top.png', cat:'SB' },
  { id:'stk11', name:'Off The Top', file:'stickers_0000s_0010_off-the-top.png', cat:'SB' }
];

// Preloaded sticker Image objects
const labStickerImages = {};
let labSelectedSticker = null;
let labPlacedStickers = []; // { id, stkId, x, y, w, h }
let labDraggingSticker = null;
let labDragOffset = { x: 0, y: 0 };
let labActiveSticker = null; // currently selected placed sticker for resize
let labDragMoved = false;

function labPreloadStickers() {
  LAB_STICKERS.forEach(s => {
    const img = new Image();
    img.src = './' + s.file;
    img.onload = () => { labStickerImages[s.id] = img; };
    img.onerror = () => { console.warn('Sticker load failed:', s.file); };
  });
}

function labOpenStickerModal() {
  const grid = document.getElementById('labStkGrid');
  grid.innerHTML = LAB_STICKERS.map(s => `
    <div class="lab-stk-item" onclick="labPickSticker('${s.id}')">
      <div class="lab-stk-item-img${labSelectedSticker===s.id?' selected':''}"><img src="./${s.file}" alt="${s.name}"></div>
      <div class="lab-stk-item-name">${s.name}</div>
    </div>
  `).join('');
  document.getElementById('labStkModal').classList.add('active');
}

function labCloseStickerModal() {
  document.getElementById('labStkModal').classList.remove('active');
}

function labPickSticker(stkId) {
  labSelectedSticker = stkId;
  labCloseStickerModal();
  
  // Show mini-bar
  const stk = LAB_STICKERS.find(s => s.id === stkId);
  const bar = document.getElementById('labStkBar');
  bar.classList.add('active');
  document.getElementById('labStkBarName').textContent = stk ? stk.name : '‚Äî';
  document.getElementById('labStkBarImg').innerHTML = stk ? `<img src="./${stk.file}">` : '';
  
  // Activate sticker tool
  labDrawTool = 'sticker';
  const canvas = document.getElementById('labCanvas');
  canvas.classList.add('drawing');
  canvas.style.cursor = 'copy';
  
  // Disable gesture layer when drawing
  const gest = document.getElementById('labGesture');
  if (gest) gest.classList.add('disabled');
  
  canvas.onmousedown = labStickerPointerDown;
  canvas.onmousemove = labStickerPointerMove;
  canvas.onmouseup = labStickerPointerUp;
  canvas.ontouchstart = (e) => { e.preventDefault(); labStickerPointerDown(labTouchToMouse(e)); };
  canvas.ontouchmove = (e) => { e.preventDefault(); labStickerPointerMove(labTouchToMouse(e)); };
  canvas.ontouchend = (e) => { e.preventDefault(); labStickerPointerUp(labTouchToMouse(e)); };
  canvas.ontouchcancel = () => { labDraggingSticker = null; };
  
  document.querySelectorAll('.lab-tool').forEach(b => b.classList.remove('active'));
}

function labHideStickerBar() {
  document.getElementById('labStkBar').classList.remove('active');
  labSelectedSticker = null;
  labActiveSticker = null;
  if (labDrawTool === 'sticker') labSetTool('none', document.querySelector('.lab-tool'));
}

// Update mini-bar when active sticker changes
function labUpdateStkBar() {
  const bar = document.getElementById('labStkBar');
  if (!bar.classList.contains('active')) return;
  if (labActiveSticker) {
    const stk = LAB_STICKERS.find(s => s.id === labActiveSticker.stkId);
    document.getElementById('labStkBarName').textContent = (stk ? stk.name : 'Sticker') + ' (seleccionado)';
  } else if (labSelectedSticker) {
    const stk = LAB_STICKERS.find(s => s.id === labSelectedSticker);
    document.getElementById('labStkBarName').textContent = stk ? stk.name : '‚Äî';
  }
}

// Keep old toggle as alias
function labToggleStickers() { labOpenStickerModal(); }

function labStickerHitTest(pos) {
  for (let i = labPlacedStickers.length - 1; i >= 0; i--) {
    const st = labPlacedStickers[i];
    if (pos.x >= st.x && pos.x <= st.x + st.w && pos.y >= st.y && pos.y <= st.y + st.h) return st;
  }
  return null;
}

function labStickerPointerDown(e) {
  e.preventDefault();
  const pos = labGetPos(e);
  labDragMoved = false;
  
  // Check if tapping an existing placed sticker
  const hit = labStickerHitTest(pos);
  if (hit) {
    labDraggingSticker = hit;
    labDragOffset = { x: pos.x - hit.x, y: pos.y - hit.y };
    return;
  }
  
  // Place new sticker if one is selected from library
  if (labSelectedSticker && labStickerImages[labSelectedSticker]) {
    const img = labStickerImages[labSelectedSticker];
    const maxDim = 150;
    const scale = maxDim / Math.max(img.width, img.height);
    const w = img.width * scale;
    const h = img.height * scale;
    
    const sticker = {
      id: 'pstk_' + Date.now().toString(36),
      stkId: labSelectedSticker,
      x: pos.x - w / 2,
      y: pos.y - h / 2,
      w: w,
      h: h
    };
    labPlacedStickers.push(sticker);
    labActiveSticker = sticker;
    labRedraw();
    labUpdateStkBar();
    if (navigator.vibrate) navigator.vibrate(20);
    return;
  }
  
  // Tap on empty area = deselect
  labActiveSticker = null;
  labRedraw();
  labUpdateStkBar();
}

function labStickerPointerMove(e) {
  if (!labDraggingSticker) return;
  e.preventDefault();
  labDragMoved = true;
  const pos = labGetPos(e);
  labDraggingSticker.x = pos.x - labDragOffset.x;
  labDraggingSticker.y = pos.y - labDragOffset.y;
  labRedraw();
}

function labStickerPointerUp(e) {
  if (labDraggingSticker && !labDragMoved) {
    // It was a tap, not a drag ‚Üí select/deselect this sticker
    labActiveSticker = (labActiveSticker === labDraggingSticker) ? null : labDraggingSticker;
    labRedraw();
    labUpdateStkBar();
  }
  labDraggingSticker = null;
  labDragMoved = false;
}

function labStickerGrow() {
  if (!labActiveSticker) return;
  const st = labActiveSticker;
  const img = labStickerImages[st.stkId];
  if (!img) return;
  const aspect = img.width / img.height;
  const cx = st.x + st.w / 2;
  const cy = st.y + st.h / 2;
  st.w = Math.min(st.w * 1.2, 600);
  st.h = st.w / aspect;
  st.x = cx - st.w / 2;
  st.y = cy - st.h / 2;
  labRedraw();
  if (navigator.vibrate) navigator.vibrate(10);
}

function labStickerShrink() {
  if (!labActiveSticker) return;
  const st = labActiveSticker;
  const img = labStickerImages[st.stkId];
  if (!img) return;
  const aspect = img.width / img.height;
  const cx = st.x + st.w / 2;
  const cy = st.y + st.h / 2;
  st.w = Math.max(st.w / 1.2, 30);
  st.h = st.w / aspect;
  st.x = cx - st.w / 2;
  st.y = cy - st.h / 2;
  labRedraw();
  if (navigator.vibrate) navigator.vibrate(10);
}

function labStickerDelete() {
  if (!labActiveSticker) return;
  labPlacedStickers = labPlacedStickers.filter(s => s.id !== labActiveSticker.id);
  labActiveSticker = null;
  labRedraw();
  labUpdateStkBar();
}

function labDeleteLastSticker() {
  if (labPlacedStickers.length > 0) {
    if (labActiveSticker === labPlacedStickers[labPlacedStickers.length - 1]) labActiveSticker = null;
    labPlacedStickers.pop();
    labRedraw();
  }
}

// ============================================================
// LAB ZOOM & PAN
// ============================================================
let labZoom = 1;
let labPanX = 0;
let labPanY = 0;
let labPinchStartDist = 0;
let labPinchStartZoom = 1;
let labIsPanning = false;
let labPanStart = { x: 0, y: 0 };
let labPanStartOffset = { x: 0, y: 0 };

function labApplyZoom() {
  const inner = document.getElementById('labVideoInner');
  if (!inner) return;
  inner.style.transform = `translate(${labPanX}px,${labPanY}px) scale(${labZoom})`;
  const lvl = document.getElementById('labZoomLevel');
  if (lvl) lvl.textContent = labZoom.toFixed(1) + 'x';
}

function labZoomIn() {
  labZoom = Math.min(5, labZoom + 0.5);
  labClampPan();
  labApplyZoom();
}

function labZoomOut() {
  labZoom = Math.max(1, labZoom - 0.5);
  if (labZoom === 1) { labPanX = 0; labPanY = 0; }
  labClampPan();
  labApplyZoom();
}

function labZoomReset() {
  labZoom = 1; labPanX = 0; labPanY = 0;
  labApplyZoom();
}

function labClampPan() {
  if (labZoom <= 1) { labPanX = 0; labPanY = 0; return; }
  const wrap = document.getElementById('labVideoWrap');
  if (!wrap) return;
  const w = wrap.clientWidth;
  const h = wrap.clientHeight;
  const maxX = w * (labZoom - 1) / 2;
  const maxY = h * (labZoom - 1) / 2;
  labPanX = Math.max(-maxX, Math.min(maxX, labPanX));
  labPanY = Math.max(-maxY, Math.min(maxY, labPanY));
}

function labInitZoomGestures() {
  const wrap = document.getElementById('labVideoWrap');
  if (!wrap) return;
  
  // Pinch-to-zoom (on video wrap, always works)
  wrap.addEventListener('touchstart', function(e) {
    if (e.touches.length === 2) {
      e.preventDefault();
      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      labPinchStartDist = Math.hypot(dx, dy);
      labPinchStartZoom = labZoom;
    }
  }, { passive: false });
  
  wrap.addEventListener('touchmove', function(e) {
    if (e.touches.length === 2) {
      e.preventDefault();
      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      const dist = Math.hypot(dx, dy);
      if (labPinchStartDist > 0) {
        labZoom = Math.max(1, Math.min(5, labPinchStartZoom * (dist / labPinchStartDist)));
        if (labZoom === 1) { labPanX = 0; labPanY = 0; }
        labClampPan();
        labApplyZoom();
      }
    }
  }, { passive: false });
  
  wrap.addEventListener('touchend', function(e) {
    if (e.touches.length < 2) labPinchStartDist = 0;
  });
  
  // Mouse wheel zoom (desktop)
  wrap.addEventListener('wheel', function(e) {
    e.preventDefault();
    const delta = e.deltaY > 0 ? -0.25 : 0.25;
    labZoom = Math.max(1, Math.min(5, labZoom + delta));
    if (labZoom === 1) { labPanX = 0; labPanY = 0; }
    labClampPan();
    labApplyZoom();
  }, { passive: false });
}

// ============ VLC-STYLE GESTURE SYSTEM ============
let labGestState = {};
function labInitGestures() {
  const el = document.getElementById('labGesture');
  if (!el) return;
  const video = document.getElementById('labVideo');
  
  let startX, startY, startTime, isScrubbing = false, isSpeedSwipe = false;
  let tapCount = 0, tapTimer = null, tapSide = null;
  let scrubStartTime = 0;
  
  function fmt(t) {
    const m = Math.floor(t / 60), s = Math.floor(t % 60);
    return m + ':' + s.toString().padStart(2,'0');
  }
  
  function showEl(id, ms) {
    const e = document.getElementById(id);
    e.classList.add('show');
    setTimeout(() => e.classList.remove('show'), ms || 600);
  }
  
  // Touch
  el.addEventListener('touchstart', function(e) {
    if (e.touches.length !== 1) return;
    const t = e.touches[0];
    startX = t.clientX; startY = t.clientY;
    startTime = Date.now();
    isScrubbing = false; isSpeedSwipe = false;
    scrubStartTime = video.currentTime;
  }, { passive: true });
  
  el.addEventListener('touchmove', function(e) {
    if (e.touches.length !== 1) return;
    const t = e.touches[0];
    const dx = t.clientX - startX;
    const dy = t.clientY - startY;
    const elapsed = Date.now() - startTime;
    
    if (elapsed < 100) return; // debounce
    
    const rect = el.getBoundingClientRect();
    const relX = (startX - rect.left) / rect.width; // 0-1
    
    // Horizontal scrub if dx > threshold
    if (!isSpeedSwipe && (isScrubbing || Math.abs(dx) > 25)) {
      e.preventDefault();
      isScrubbing = true;
      const sensitivity = video.duration / rect.width * 0.5;
      const newTime = Math.max(0, Math.min(video.duration, scrubStartTime + dx * sensitivity));
      video.currentTime = newTime;
      document.getElementById('labTimeline').value = newTime;
      labUpdateTime();
      
      const scrubEl = document.getElementById('labGestScrub');
      scrubEl.classList.add('show');
      document.getElementById('labGestScrubTime').textContent = fmt(newTime);
      const delta = newTime - scrubStartTime;
      document.getElementById('labGestScrubDelta').textContent = (delta >= 0 ? '+' : '') + delta.toFixed(1) + 's';
      return;
    }
    
    // Vertical right side = speed
    if (!isScrubbing && relX > 0.6 && (isSpeedSwipe || Math.abs(dy) > 30)) {
      e.preventDefault();
      isSpeedSwipe = true;
      // Map dy to speed: up = faster, down = slower
      const speeds = [0.25, 0.5, 1, 1.5, 2, 3];
      const curIdx = speeds.indexOf(video.playbackRate);
      const idx = Math.max(0, Math.min(speeds.length - 1, 2 + Math.round(-dy / 40)));
      video.playbackRate = speeds[idx];
      const spdEl = document.getElementById('labGestSpeed');
      spdEl.textContent = speeds[idx] + 'x';
      spdEl.classList.add('show');
    }
  }, { passive: false });
  
  el.addEventListener('touchend', function(e) {
    const elapsed = Date.now() - startTime;
    
    // Hide overlays
    document.getElementById('labGestScrub').classList.remove('show');
    document.getElementById('labGestSpeed').classList.remove('show');
    
    // Update speed buttons
    if (isSpeedSwipe) {
      document.querySelectorAll('.lab-szrow .lab-spd-btn').forEach(b => {
        b.classList.toggle('active', b.textContent === video.playbackRate + 'x');
      });
    }
    
    if (isScrubbing || isSpeedSwipe) return;
    
    // Tap detection
    if (elapsed < 300) {
      const rect = el.getBoundingClientRect();
      const relX = (startX - rect.left) / rect.width;
      const side = relX < 0.35 ? 'left' : relX > 0.65 ? 'right' : 'center';
      
      tapCount++;
      if (tapCount === 1) {
        tapSide = side;
        tapTimer = setTimeout(() => {
          // Single tap
          if (tapSide === 'center') {
            labTogglePlay();
            showEl('labGestPlay', 400);
            document.getElementById('labGestPlay').textContent = video.paused ? '‚ñ∂Ô∏è' : '‚è∏Ô∏è';
          }
          tapCount = 0;
        }, 250);
      } else if (tapCount === 2) {
        clearTimeout(tapTimer);
        tapCount = 0;
        // Double tap
        if (side === 'left') {
          video.currentTime = Math.max(0, video.currentTime - 2);
          document.getElementById('labTimeline').value = video.currentTime;
          labUpdateTime();
          showEl('labGestL', 400);
        } else if (side === 'right') {
          video.currentTime = Math.min(video.duration, video.currentTime + 2);
          document.getElementById('labTimeline').value = video.currentTime;
          labUpdateTime();
          showEl('labGestR', 400);
        }
      }
    }
  }, { passive: true });
  
  // Desktop click = play/pause
  el.addEventListener('click', function(e) {
    if ('ontouchstart' in window) return; // skip on touch devices
    labTogglePlay();
  });
}

// ============================================================
// PHASE 3: BIOMETRICS
// ============================================================
function openBioModal() {
  document.getElementById('bioWeight').value = '';
  document.getElementById('bioSleep').value = '';
  document.getElementById('bioPainZone').value = '';
  document.getElementById('bioNotes').value = '';
  segSelect('bioEnergy', document.querySelector('#bioEnergy .seg-btn[data-v="8"]'));
  segSelect('bioPain', document.querySelector('#bioPain .seg-btn[data-v="none"]'));
  document.getElementById('modalBio').classList.add('active');
}

function saveBio() {
  const weight = parseFloat(document.getElementById('bioWeight').value) || null;
  const sleep = parseFloat(document.getElementById('bioSleep').value) || null;
  const energy = parseInt(getSegValue('bioEnergy')) || 8;
  const pain = getSegValue('bioPain') || 'none';
  const painZone = document.getElementById('bioPainZone').value.trim();
  const notes = document.getElementById('bioNotes').value.trim();
  
  if (!weight && !sleep) { alert('Ingresa al menos peso o horas de sue√±o'); return; }
  
  const entry = {
    id: DB.genId(),
    date: new Date().toISOString(),
    weight, sleep, energy, pain, painZone, notes
  };
  
  const a = DB.athletes.find(x => x.id === _pcAthleteId);
  if (!a) { alert('No se encontr√≥ el atleta'); return; }
  
  const athletes = DB.athletes;
  const ath = athletes.find(x => x.id === _pcAthleteId);
  if (!ath.biometrics) ath.biometrics = [];
  ath.biometrics.push(entry);
  
  // XP for tracking biometrics
  ath.xp_total = (ath.xp_total || 0) + 10;
  
  DB.athletes = athletes;
  closeModal('modalBio');
  renderPlayerCard();
  
  if (navigator.vibrate) navigator.vibrate(30);
}

function renderBiometrics(a) {
  const bio = a.biometrics || [];
  const grid = document.getElementById('pcBioGrid');
  const histSection = document.getElementById('pcBioHistory');
  
  if (bio.length === 0) {
    grid.innerHTML = '<div style="grid-column:span 2;font-size:12px;color:var(--text-muted);text-align:center;padding:8px">Sin registros. Toca "+ Registro" para empezar.</div>';
    histSection.style.display = 'none';
    return;
  }
  
  const latest = bio[bio.length - 1];
  const last7 = bio.slice(-7);
  
  const painEmoji = { none: '‚úÖ', mild: 'üü°', moderate: 'üü†', severe: 'üî¥' };
  const painLabel = { none: 'Sin dolor', mild: 'Leve', moderate: 'Moderado', severe: 'Severo' };
  
  // Grid cards with mini trends
  const avgEnergy = last7.reduce((s, b) => s + (b.energy || 0), 0) / last7.length;
  const avgSleep = last7.filter(b => b.sleep).reduce((s, b) => s + b.sleep, 0) / (last7.filter(b => b.sleep).length || 1);
  
  grid.innerHTML = `
    <div class="bio-card">
      <div class="bio-val">${latest.weight ? latest.weight + '<span style="font-size:12px">kg</span>' : '‚Äî'}</div>
      <div class="bio-lbl">Peso</div>
      <div class="bio-trend">${last7.map(b => {
        const h = b.weight ? Math.max(5, (b.weight / 120) * 40) : 3;
        return `<div class="bio-bar" style="height:${h}px;background:var(--accent)"></div>`;
      }).join('')}</div>
    </div>
    <div class="bio-card">
      <div class="bio-val">${latest.sleep ? latest.sleep + '<span style="font-size:12px">h</span>' : '‚Äî'}</div>
      <div class="bio-lbl">Sue√±o</div>
      <div class="bio-trend">${last7.map(b => {
        const h = b.sleep ? Math.max(5, (b.sleep / 10) * 40) : 3;
        const c = b.sleep >= 7 ? 'var(--green)' : b.sleep >= 5 ? 'var(--yellow)' : 'var(--red)';
        return `<div class="bio-bar" style="height:${h}px;background:${c}"></div>`;
      }).join('')}</div>
    </div>
    <div class="bio-card">
      <div class="bio-val" style="color:${avgEnergy>=7?'var(--green)':avgEnergy>=5?'var(--yellow)':'var(--red)'}">${latest.energy}/10</div>
      <div class="bio-lbl">Energ√≠a</div>
      <div class="bio-trend">${last7.map(b => {
        const h = Math.max(5, (b.energy / 10) * 40);
        const c = b.energy >= 7 ? 'var(--green)' : b.energy >= 5 ? 'var(--yellow)' : 'var(--red)';
        return `<div class="bio-bar" style="height:${h}px;background:${c}"></div>`;
      }).join('')}</div>
    </div>
    <div class="bio-card">
      <div class="bio-val">${painEmoji[latest.pain] || '‚úÖ'}</div>
      <div class="bio-lbl">${painLabel[latest.pain] || 'Sin dolor'}</div>
      ${latest.painZone ? `<div style="font-size:10px;color:var(--text-muted);margin-top:4px">${latest.painZone}</div>` : ''}
    </div>
  `;
  
  // History rows
  if (bio.length > 1) {
    histSection.style.display = 'block';
    document.getElementById('pcBioRows').innerHTML = bio.slice().reverse().slice(0, 7).map(b => {
      const d = new Intl.DateTimeFormat('es', { day:'numeric', month:'short' }).format(new Date(b.date));
      return `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px">
        <span style="color:var(--text-muted);width:50px">${d}</span>
        <span>${b.weight ? b.weight+'kg' : '‚Äî'}</span>
        <span>${b.sleep ? b.sleep+'h' : '‚Äî'}</span>
        <span>‚ö°${b.energy}</span>
        <span>${painEmoji[b.pain]||'‚úÖ'}</span>
      </div>`;
    }).join('');
  } else { histSection.style.display = 'none'; }
}

function renderLabFramesForAthlete(a) {
  const frames = DB.labFrames.filter(f => f.athlete_id === a.id);
  const card = document.getElementById('pcLabCard');
  
  if (frames.length === 0) { card.style.display = 'none'; return; }
  card.style.display = 'block';
  
  document.getElementById('pcLabFrames').innerHTML = frames.slice(-6).reverse().map(f => {
    const t = f.timestamp || 0;
    const timeStr = `${Math.floor(t/60)}:${Math.floor(t%60).toString().padStart(2,'0')}`;
    return `<div class="lab-frame"><img src="${f.image}" loading="lazy"><div class="lab-frame-time">${timeStr}</div></div>`;
  }).join('');
}

// ============================================================
// SETTINGS
// ============================================================
function renderSettings() {
  const spots = DB.spots;
  document.getElementById('setSpotList').innerHTML = spots.map((s, i) => 
    `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
      <span style="font-size:14px">${s}</span>
      <button onclick="removeSpot(${i})" style="color:var(--text-muted);font-size:16px;padding:4px 8px">√ó</button>
    </div>`
  ).join('');
  
  // Templates
  const templates = DB.templates;
  const tplList = document.getElementById('setTplList');
  const tplEmpty = document.getElementById('setTplEmpty');
  if (templates.length > 0) {
    tplEmpty.style.display = 'none';
    tplList.innerHTML = templates.map(t => 
      `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
        <div><div style="font-size:14px;font-weight:600">${t.name}</div><div style="font-size:11px;color:var(--text-muted)">${t.spot} ¬∑ ${(t.athlete_ids||[]).length} atletas</div></div>
        <button onclick="deleteTemplate('${t.id}')" style="color:var(--text-muted);font-size:16px;padding:4px 8px">√ó</button>
      </div>`
    ).join('');
  } else {
    tplEmpty.style.display = 'block';
    tplList.innerHTML = '';
  }
  
  // Custom drills
  const customs = DB.customDrills;
  document.getElementById('setCustomDrills').innerHTML = customs.length > 0 ? 
    customs.map((d, i) => 
      `<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)">
        <span style="font-size:13px">‚≠ê ${d.name}</span>
        <button onclick="removeCustomDrill(${i})" style="color:var(--text-muted);font-size:16px;padding:4px 8px">√ó</button>
      </div>`
    ).join('') : '<div style="font-size:12px;color:var(--text-muted);padding:4px 0">Sin ejercicios personalizados</div>';
  
  // Storage health
  renderStorageHealth();
}

function addSpot() {
  const input = document.getElementById('setNewSpot');
  const name = input.value.trim();
  if (!name) return;
  const spots = DB.spots;
  if (!spots.includes(name)) { spots.push(name); DB.spots = spots; }
  input.value = '';
  renderSettings();
}

function removeSpot(i) {
  const spots = DB.spots;
  if (spots.length <= 1) { alert('Necesitas al menos un spot'); return; }
  spots.splice(i, 1);
  DB.spots = spots;
  renderSettings();
}

function addCustomDrill() {
  const input = document.getElementById('setNewDrillName');
  const name = input.value.trim();
  if (!name) return;
  const customs = DB.customDrills;
  customs.push({ id: 'custom_' + DB.genId(), name, desc: '', duration: '', cat: 'Custom', icon: '‚≠ê', level: 'Todos' });
  DB.customDrills = customs;
  input.value = '';
  renderSettings();
}

function removeCustomDrill(i) {
  const customs = DB.customDrills;
  customs.splice(i, 1);
  DB.customDrills = customs;
  renderSettings();
}

function confirmClearData() {
  const athletes = DB.athletes.length;
  const sessions = DB.sessions.length;
  if (athletes === 0 && sessions === 0) return alert('No hay datos para borrar');
  
  if (!confirm(`‚ö†Ô∏è ¬øBorrar TODOS los datos?\n\n‚Ä¢ ${athletes} atletas\n‚Ä¢ ${sessions} sesiones\n\nEsta acci√≥n NO se puede deshacer.`)) return;
  
  // Offer backup before clearing
  const doBackup = confirm('¬øDeseas exportar un backup antes de borrar?\n\n‚úÖ S√≠ = Exportar backup primero\n‚ùå No = Borrar sin backup');
  if (doBackup) exportFullBackup();
  
  if (!confirm('üî¥ √öLTIMA CONFIRMACI√ìN: ¬øBorrar todo permanentemente?')) return;
  
  localStorage.clear();
  location.reload();
}

// ============================================================
// UI HELPERS
// ============================================================
function segSelect(groupId, el) {
  document.querySelectorAll(`#${groupId} .seg-btn`).forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
}

function getSegValue(groupId) {
  return document.querySelector(`#${groupId} .seg-btn.selected`)?.dataset.v || '3';
}

function starSelect(groupId, n) {
  document.querySelectorAll(`#${groupId} .star`).forEach((s, i) => {
    s.classList.toggle('active', i < n);
  });
  document.getElementById(groupId).dataset.value = n;
}

function getStarValue(groupId) {
  return parseInt(document.getElementById(groupId).dataset?.value) || 3;
}

function semSelect(el) {
  document.querySelectorAll('.sem-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
}

let _undoTimer = null;
function showUndoToast(text, undoFn) {
  const toast = document.getElementById('undoToast');
  document.getElementById('undoText').textContent = text;
  window._undoFn = undoFn;
  toast.classList.add('show');
  clearTimeout(_undoTimer);
  _undoTimer = setTimeout(() => { toast.classList.remove('show'); window._undoFn = null; }, 3000);
}

function undoLastAction() {
  if (window._undoFn) { window._undoFn(); window._undoFn = null; }
  document.getElementById('undoToast').classList.remove('show');
  clearTimeout(_undoTimer);
}

// ============================================================
// JUDGE MODE
// ============================================================
const JM_COLORS = ['Red', 'Yellow', 'Black', 'White', 'Blue'];
const JM_COLOR_CSS = { Red:'jm-color-red', Yellow:'jm-color-yellow', Black:'jm-color-black', White:'jm-color-white', Blue:'jm-color-blue' };
const JM_INT_LABELS = { 0:'‚Äî', 1:'INT-1', 2:'INT-2', 3:'INT-3', 4:'2√óINT', 5:'2√óINT', 6:'DQ' };
const JM_INT_DESC = { 0:'', 1:'¬Ω 2nd (Non-Pri)', 2:'0 2nd (Priority)', 3:'0 1st (Last 5min)', 4:'¬Ω 1st + 0 2nd', 5:'0 both', 6:'DISQUALIFIED' };
let jmTimer = null;
let jmStartTime = null;
let jmScoreTimestamps = {};
const JM_LOCK_DELAY = 30000;

function jmGetHeat() {
  if (!window._jmHeatCache) {
    let h = DB.judgeHeat;
    if (!h) {
      h = {
        metadata: { heat_number:'', category:'', round:'', location:'', duration:20, is_closed:false, notes:'' },
        surfers: JM_COLORS.map(c => ({ color:c, name:'', athlete_id:'', discipline:'', goal:0, waves:new Array(20).fill(null), interference:0, interference_waves:[] })),
        priority_order: [],
        started: false
      };
      DB.judgeHeat = h;
    }
    window._jmHeatCache = h;
  }
  return window._jmHeatCache;
}
function jmSave() { DB.judgeHeat = window._jmHeatCache; }

function renderJudge() {
  const h = jmGetHeat();
  const athletes = DB.athletes;
  // Surfer setup fields
  const sg = document.getElementById('jmSurferSetup');
  if (sg && !sg.dataset.init) {
    sg.dataset.init = '1';
    sg.innerHTML = JM_COLORS.map((c, i) => {
      const lbl = c === 'Red' ? 'color:#fecaca;background:#991b1b' : c === 'Yellow' ? 'color:#fef08a;background:#854d0e' : c === 'Black' ? 'color:#e2e8f0;background:#0f172a' : c === 'White' ? 'color:#0f172a;background:#f0f0f0' : 'color:#bfdbfe;background:#1e3a8a';
      const curId = h.surfers[i].athlete_id || '';
      const curName = h.surfers[i].name || '';
      const curDisc = h.surfers[i].discipline || '';
      let opts = '<option value="">‚Äî Vac√≠o ‚Äî</option>';
      athletes.forEach(a => {
        const sel = a.id === curId ? 'selected' : '';
        opts += `<option value="${a.id}" ${sel}>${a.name}</option>`;
      });
      opts += `<option value="__custom" ${curId === '__custom' ? 'selected' : ''}>‚úèÔ∏è Otro...</option>`;
      // Discipline dropdown (populated dynamically by jmSelectSurfer)
      const ath = curId && curId !== '__custom' ? athletes.find(a => a.id === curId) : null;
      const athDiscs = ath ? getAthleteDisciplines(ath) : [];
      const showDisc = athDiscs.length > 1;
      let discOpts = athDiscs.map(d => { const di = getDisciplineInfo(d); return `<option value="${d}" ${d === curDisc ? 'selected' : ''}>${di.label}</option>`; }).join('');
      return `<div class="jm-surfer-item"><label style="${lbl}">${c}</label><select id="jmSN${i}" onchange="jmSelectSurfer(${i})">
        ${opts}</select><select id="jmSD${i}" onchange="jmSurferDiscChange(${i})" style="display:${showDisc ? 'block' : 'none'};font-size:12px;padding:4px 8px;border-radius:6px;border:1px solid var(--border);background:var(--bg-input);color:var(--text-primary)">${discOpts}</select><input placeholder="Nombre manual" id="jmSNcustom${i}" value="${curId === '__custom' ? curName : ''}" onchange="jmUpdateSurfer()" style="display:${curId === '__custom' ? 'block' : 'none'}"><input type="number" placeholder="Goal" step="0.1" min="0" max="20" id="jmSG${i}" value="${h.surfers[i].goal||''}" onchange="jmUpdateSurfer()"></div>`;
    }).join('');
  }
  // Duration
  document.getElementById('jmDuration').value = h.metadata.duration;
  document.getElementById('jmHeatNum').value = h.metadata.heat_number;
  document.getElementById('jmCategory').value = h.metadata.category;
  document.getElementById('jmRound').value = h.metadata.round;
  document.getElementById('jmLocation').value = h.metadata.location;
  
  // Build score grid
  jmBuildGrid(h);
  
  // Rankings + priority
  jmUpdateRankings();
  jmUpdatePriority();
  
  // Timer state
  if (h.started) {
    document.getElementById('jmSetupForm').querySelector('.card:first-of-type .card-header').parentElement.parentElement.querySelector('.jm-setup-form') || null;
    jmCollapseSetup();
    document.getElementById('jmTimerBar').style.display = 'flex';
    document.getElementById('jmCloseRow').style.display = 'block';
    document.getElementById('jmStartBtn').disabled = true;
    document.getElementById('jmStartBtn').style.opacity = '.4';
  }
  
  // Closed state
  if (h.metadata.is_closed) {
    document.getElementById('jmCloseBtn').style.display = 'none';
    document.getElementById('jmCloseRow').style.display = 'none';
    document.getElementById('jmReopenBtn').style.display = 'inline-block';
    document.getElementById('jmResults').style.display = 'block';
    jmDisplayResults();
  } else {
    document.getElementById('jmResults').style.display = 'none';
  }
  
  // Sequential + lock states
  jmUpdateSequential();
}

function jmBuildGrid(h) {
  const grid = document.getElementById('jmGrid');
  let html = '<thead><tr><th>Surfer</th>';
  for (let w = 1; w <= 20; w++) html += `<th>W${w}</th>`;
  html += '</tr></thead><tbody>';
  
  h.surfers.forEach((s, si) => {
    const intLvl = s.interference > 0 ? ` l${s.interference}` : '';
    const intText = s.interference > 0 ? JM_INT_LABELS[s.interference] : 'INT';
    const discIcon = s.discipline ? getDisciplineInfo(s.discipline).icon + ' ' : '';
    html += `<tr><td class="jm-color-cell ${JM_COLOR_CSS[s.color]}" onclick="jmSendPriority(${si})">
      ${s.color}${s.name ? '<br><span style="font-size:10px;font-weight:500;opacity:.8">'+discIcon+s.name.split(' ')[0]+'</span>':''}
      <span class="jm-int-badge${intLvl}" onclick="event.stopPropagation();jmToggleInt(${si})" title="Tap to cycle interference">${intText}</span>
    </td>`;
    for (let wi = 0; wi < 20; wi++) {
      const val = s.waves[wi] !== null ? s.waves[wi] : '';
      const intMarked = s.interference_waves.includes(wi);
      const cls = [intMarked ? 'int-marked' : ''].filter(Boolean).join(' ');
      html += `<td><input type="number" class="jm-score-input ${cls}" min="0" max="10" step="0.1" inputmode="decimal"
        id="jm-s${si}-w${wi}" data-si="${si}" data-wi="${wi}" value="${val}"
        onchange="jmScoreChange(this)" onfocus="jmScoreFocus(${si},${wi})"
        onkeydown="jmScoreKey(event,${si},${wi})"
        ondblclick="jmMarkInt(${si},${wi})">
        <span class="jm-tri" id="jm-tri-${si}-${wi}" ${intMarked?'style="display:block"':''}>‚ñ≤</span></td>`;
    }
    html += '</tr>';
  });
  html += '</tbody>';
  grid.innerHTML = html;
}

function jmSelectSurfer(i) {
  const sel = document.getElementById(`jmSN${i}`);
  const customInp = document.getElementById(`jmSNcustom${i}`);
  const discSel = document.getElementById(`jmSD${i}`);
  const val = sel.value;
  const h = jmGetHeat();
  
  if (val === '') {
    h.surfers[i].name = '';
    h.surfers[i].athlete_id = '';
    h.surfers[i].discipline = '';
    customInp.style.display = 'none';
    if (discSel) discSel.style.display = 'none';
  } else if (val === '__custom') {
    h.surfers[i].athlete_id = '__custom';
    h.surfers[i].name = customInp.value;
    h.surfers[i].discipline = '';
    customInp.style.display = 'block';
    customInp.focus();
    if (discSel) discSel.style.display = 'none';
  } else {
    const ath = DB.athletes.find(a => a.id === val);
    h.surfers[i].name = ath ? ath.name : '';
    h.surfers[i].athlete_id = val;
    customInp.style.display = 'none';
    
    // Populate discipline dropdown
    if (ath && discSel) {
      const discs = getAthleteDisciplines(ath);
      if (discs.length > 1) {
        discSel.innerHTML = discs.map(d => { const di = getDisciplineInfo(d); return `<option value="${d}">${di.label}</option>`; }).join('');
        discSel.style.display = 'block';
        h.surfers[i].discipline = discs[0]; // Default to first
      } else {
        discSel.style.display = 'none';
        h.surfers[i].discipline = discs[0];
      }
    }
  }
  jmSave();
  jmBuildGrid(h);
  jmUpdateSequential();
}

function jmSurferDiscChange(i) {
  const h = jmGetHeat();
  const discSel = document.getElementById(`jmSD${i}`);
  if (discSel) h.surfers[i].discipline = discSel.value;
  jmSave();
}

function jmUpdateSurfer() {
  const h = jmGetHeat();
  JM_COLORS.forEach((c, i) => {
    const sel = document.getElementById('jmSN' + i);
    const customInp = document.getElementById('jmSNcustom' + i);
    const discSel = document.getElementById('jmSD' + i);
    if (sel && sel.value === '__custom' && customInp) {
      h.surfers[i].name = customInp.value;
      h.surfers[i].athlete_id = '__custom';
    }
    h.surfers[i].goal = parseFloat(document.getElementById('jmSG' + i).value) || 0;
    if (discSel && discSel.style.display !== 'none') {
      h.surfers[i].discipline = discSel.value;
    }
  });
  jmSave();
  jmBuildGrid(h);
  jmUpdateSequential();
}

function jmUpdateMeta() {
  const h = jmGetHeat();
  h.metadata.heat_number = document.getElementById('jmHeatNum').value;
  h.metadata.category = document.getElementById('jmCategory').value;
  h.metadata.round = document.getElementById('jmRound').value;
  h.metadata.location = document.getElementById('jmLocation').value;
  h.metadata.duration = parseInt(document.getElementById('jmDuration').value) || 20;
  jmSave();
}

function jmCollapseSetup() {
  const h = jmGetHeat();
  document.getElementById('jmSetupForm').classList.add('hidden');
  const mc = document.getElementById('jmMetaCollapsed');
  mc.textContent = `Heat ${h.metadata.heat_number||'?'} ¬∑ ${h.metadata.category||'?'} ¬∑ ${h.metadata.round||'?'} ¬∑ ${h.metadata.location||'?'} ¬∑ ${h.metadata.duration}min`;
  mc.classList.add('active');
}

function jmExpandSetup() {
  document.getElementById('jmSetupForm').classList.remove('hidden');
  document.getElementById('jmMetaCollapsed').classList.remove('active');
}

// TIMER
function jmStartTimer() {
  jmUpdateMeta();
  jmUpdateSurfer();
  const h = jmGetHeat();
  h.started = true;
  jmSave();
  
  jmCollapseSetup();
  document.getElementById('jmTimerBar').style.display = 'flex';
  document.getElementById('jmCloseRow').style.display = 'block';
  document.getElementById('jmStartBtn').disabled = true;
  document.getElementById('jmStartBtn').style.opacity = '.4';
  
  jmStartTime = Date.now();
  const dur = h.metadata.duration;
  document.getElementById('jmTimerDisplay').textContent = `${dur}:00`;
  
  if (jmTimer) clearInterval(jmTimer);
  jmTimer = setInterval(() => {
    const elapsed = Math.floor((Date.now() - jmStartTime) / 1000);
    const total = dur * 60;
    const rem = Math.max(0, total - elapsed);
    const m = Math.floor(rem / 60);
    const s = rem % 60;
    document.getElementById('jmTimerDisplay').textContent = `${m}:${s.toString().padStart(2,'0')}`;
    
    const bar = document.getElementById('jmTimerBar');
    bar.className = 'jm-timer-bar' + (rem <= 60 ? ' critical' : rem <= 300 ? ' warning' : '');
    
    if (rem === 0) { clearInterval(jmTimer); jmTimer = null; }
  }, 250);
}

// SCORING
function jmScoreChange(input) {
  const si = parseInt(input.dataset.si);
  const wi = parseInt(input.dataset.wi);
  const h = jmGetHeat();
  const val = input.value;
  
  if (val === '') {
    h.surfers[si].waves[wi] = null;
    delete jmScoreTimestamps[`${si}-${wi}`];
  } else {
    const n = parseFloat(val);
    if (n >= 0 && n <= 10) {
      h.surfers[si].waves[wi] = n;
      jmScoreTimestamps[`${si}-${wi}`] = Date.now();
    } else {
      input.value = '';
      h.surfers[si].waves[wi] = null;
    }
  }
  jmSave();
  jmUpdateRankings();
  jmUpdateSequential();
}

function jmScoreFocus(si, wi) {
  const key = `${si}-${wi}`;
  if (jmScoreTimestamps[key]) {
    const el = Date.now() - jmScoreTimestamps[key];
    if (el > JM_LOCK_DELAY) {
      const input = document.getElementById(`jm-s${si}-w${wi}`);
      if (!confirm(`‚ö†Ô∏è Score entered ${Math.floor(el/1000)}s ago. Edit?`)) { input.blur(); return; }
      jmScoreTimestamps[key] = Date.now();
    }
  }
}

function jmScoreKey(e, si, wi) {
  if (e.key === 'Enter') {
    e.preventDefault();
    const cur = document.getElementById(`jm-s${si}-w${wi}`);
    if (cur.value) jmScoreChange(cur);
    // Move to next available
    for (let w = wi + 1; w < 20; w++) {
      const nx = document.getElementById(`jm-s${si}-w${w}`);
      if (!nx.disabled) { nx.focus(); return; }
    }
    for (let s = si + 1; s < 5; s++) {
      for (let w = 0; w < 20; w++) {
        const nx = document.getElementById(`jm-s${s}-w${w}`);
        if (nx && !nx.disabled) { nx.focus(); return; }
      }
    }
    cur.blur();
  }
}

function jmUpdateSequential() {
  for (let si = 0; si < 5; si++) {
    let foundEmpty = false;
    for (let wi = 0; wi < 20; wi++) {
      const inp = document.getElementById(`jm-s${si}-w${wi}`);
      if (!inp) continue;
      if (!inp.value) {
        inp.disabled = foundEmpty;
        if (!foundEmpty) foundEmpty = true;
      } else {
        inp.disabled = false;
      }
    }
  }
  // Lock states
  const now = Date.now();
  for (const [key, ts] of Object.entries(jmScoreTimestamps)) {
    const [si, wi] = key.split('-');
    const inp = document.getElementById(`jm-s${si}-w${wi}`);
    if (!inp || !inp.value) continue;
    const el = now - ts;
    inp.classList.toggle('locked', el > JM_LOCK_DELAY);
    inp.classList.toggle('recent', el < 5000);
  }
}

// RANKINGS (ISA rules - ported from Python)
function jmCalcRankings() {
  const h = jmGetHeat();
  const results = h.surfers.map((s, idx) => {
    const valid = s.waves.filter(w => w !== null).sort((a, b) => b - a);
    const top2 = valid.slice(0, 2);
    let total = top2.reduce((a, b) => a + b, 0);
    
    // Interference penalties
    if (s.interference === 1 && top2.length >= 2) total -= top2[1] / 2;
    else if (s.interference === 2 && top2.length >= 2) total -= top2[1];
    else if (s.interference === 3 && top2.length >= 1) total -= top2[0];
    else if (s.interference === 4) {
      if (top2.length >= 1) total -= top2[0] / 2;
      if (top2.length >= 2) total -= top2[1];
    } else if (s.interference === 5) {
      total = 0;
    } else if (s.interference === 6) {
      total = 0;
    }
    total = Math.max(0, total);
    
    const all_wave_avg = valid.length > 0 ? valid.reduce((a, b) => a + b, 0) / valid.length : 0;
    
    return { idx, color: s.color, name: s.name, athlete_id: s.athlete_id || '', top_waves: top2, all_sorted: valid, total, interference: s.interference, all_wave_avg, wave_count: valid.length };
  });
  
  results.sort((a, b) => {
    if (b.total !== a.total) return b.total - a.total;
    const maxW = Math.max(a.all_sorted.length, b.all_sorted.length);
    for (let i = 0; i < maxW; i++) {
      const av = a.all_sorted[i] || 0, bv = b.all_sorted[i] || 0;
      if (bv !== av) return bv - av;
    }
    return 0;
  });
  
  results.forEach((r, i) => r.position = i + 1);
  return results;
}

function jmUpdateRankings() {
  const results = jmCalcRankings();
  const c = document.getElementById('jmRankings');
  const first = results[0]?.total || 0;
  const second = results[1]?.total || 0;
  
  c.innerHTML = results.map(r => {
    const emoji = r.position === 1 ? 'ü•á' : r.position === 2 ? 'ü•à' : r.position === 3 ? 'ü•â' : r.position + '.';
    const wStr = r.top_waves.map(w => w.toFixed(1)).join(' + ') || 'No scores';
    let intStr = r.interference > 0 ? `<span class="jm-rank-int">${JM_INT_LABELS[r.interference]}</span>` : '';
    let need = '';
    if (r.position === 2) {
      const target = first + 0.01;
      const best = r.top_waves[0] || 0;
      const wn = target - best;
      need = wn <= 10 ? `<div class="jm-rank-need">needs ${wn.toFixed(2)} for 1st</div>` : `<div class="jm-rank-need">needs combo ${target.toFixed(2)}</div>`;
    } else if (r.position >= 3) {
      const target = second + 0.01;
      const best = r.top_waves[0] || 0;
      const wn = target - best;
      need = wn <= 10 ? `<div class="jm-rank-need">needs ${wn.toFixed(2)} for 2nd</div>` : `<div class="jm-rank-need">needs combo ${target.toFixed(2)}</div>`;
    }
    return `<div class="jm-rank-item"><div><span style="font-size:18px;margin-right:6px">${emoji}</span><strong>${r.color}</strong>${intStr}<div class="jm-rank-waves">${wStr}${r.wave_count > 0 ? ' ¬∑ avg '+r.all_wave_avg.toFixed(1)+'/wave' : ''}</div>${need}</div><div style="font-size:18px">${r.total.toFixed(2)}</div></div>`;
  }).join('');
  
  // Highlight best scores in grid
  document.querySelectorAll('.jm-score-input').forEach(i => i.classList.remove('best'));
  results.forEach(r => {
    const waves = [];
    for (let w = 0; w < 20; w++) {
      const inp = document.getElementById(`jm-s${r.idx}-w${w}`);
      if (inp && inp.value) waves.push({ w, score: parseFloat(inp.value) });
    }
    waves.sort((a, b) => b.score - a.score);
    waves.slice(0, 2).forEach(wv => {
      const inp = document.getElementById(`jm-s${r.idx}-w${wv.w}`);
      if (inp) inp.classList.add('best');
    });
  });
}

// PRIORITY
function jmSendPriority(si) {
  const h = jmGetHeat();
  const idx = h.priority_order.indexOf(si);
  if (idx >= 0) h.priority_order.splice(idx, 1);
  h.priority_order.push(si);
  jmSave();
  jmUpdatePriority();
}

function jmUpdatePriority() {
  const h = jmGetHeat();
  const ordered = new Set(h.priority_order);
  const tied = [];
  for (let i = 0; i < 5; i++) { if (!ordered.has(i)) tied.push(i); }
  
  const all = [...tied.map(i => ({ idx:i, pos:'TIED' })), ...h.priority_order.map((i, p) => ({ idx:i, pos:tied.length + p + 1 }))];
  
  document.getElementById('jmPriority').innerHTML = all.map(item => {
    const s = h.surfers[item.idx];
    const cls = item.pos === 'TIED' ? 'tied' : '';
    return `<div class="jm-pri-item ${cls}" onclick="jmSendPriority(${item.idx})">
      <div class="jm-pri-num">${item.pos === 'TIED' ? '=' : item.pos}</div>
      <div class="jm-pri-col">${s.color}</div>
      <div class="jm-pri-lbl">${item.pos === 'TIED' ? 'tied' : 'priority'}</div>
    </div>`;
  }).join('');
}

// INTERFERENCE
function jmToggleInt(si) {
  const h = jmGetHeat();
  h.surfers[si].interference = (h.surfers[si].interference + 1) % 7;
  jmSave();
  jmBuildGrid(h);
  jmUpdateSequential();
  jmUpdateRankings();
  if (navigator.vibrate) navigator.vibrate(30);
}

function jmMarkInt(si, wi) {
  const h = jmGetHeat();
  const arr = h.surfers[si].interference_waves;
  const idx = arr.indexOf(wi);
  if (idx >= 0) arr.splice(idx, 1); else arr.push(wi);
  jmSave();
  
  const inp = document.getElementById(`jm-s${si}-w${wi}`);
  const tri = document.getElementById(`jm-tri-${si}-${wi}`);
  if (arr.includes(wi)) { inp.classList.add('int-marked'); tri.style.display = 'block'; }
  else { inp.classList.remove('int-marked'); tri.style.display = 'none'; }
  if (navigator.vibrate) navigator.vibrate(50);
}

// CLOSE / REOPEN / RESET
function jmCloseHeat() {
  try {
  const h = jmGetHeat();
  h.metadata.is_closed = true;
  jmSave();
  
  // Update session tracker
  const results = jmCalcRankings();
  const tracker = DB.judgeTracker;
  h.surfers.forEach(s => {
    const name = (s.name || '').trim();
    if (!name) return;
    const trackerKey = s.discipline ? `${name}||${s.discipline}` : name;
    // Also keep legacy un-keyed entry for backward compat
    if (!tracker[name]) tracker[name] = { heats: [], all_wave_avgs: [], goal: s.goal || 0, athlete_id: s.athlete_id || '' };
    if (!tracker[name].all_wave_avgs) tracker[name].all_wave_avgs = [];
    if (!tracker[name].heats) tracker[name].heats = [];
    const r = results.find(x => x.color === s.color);
    if (r) {
      tracker[name].heats.push(r.total);
      tracker[name].all_wave_avgs.push(r.all_wave_avg);
      // Discipline-keyed tracker
      if (s.discipline && trackerKey !== name) {
        if (!tracker[trackerKey]) tracker[trackerKey] = { heats: [], all_wave_avgs: [], goal: s.goal || 0, athlete_id: s.athlete_id || '', discipline: s.discipline };
        tracker[trackerKey].heats.push(r.total);
        tracker[trackerKey].all_wave_avgs.push(r.all_wave_avg);
      }
    }
  });
  DB.judgeTracker = tracker;
  
  // Save heat results to athlete profiles
  try {
    const athletes = DB.athletes;
    let updated = false;
    results.forEach(r => {
      if (!r.athlete_id || r.athlete_id === '__custom') return;
      const ath = athletes.find(a => a.id === r.athlete_id);
      if (!ath) return;
      if (!ath.heat_history) ath.heat_history = [];
      // Find discipline from surfer slot
      const surferSlot = h.surfers.find(s => s.athlete_id === r.athlete_id);
      const heatDisc = surferSlot?.discipline || getAthleteDiscipline(ath);
      ath.heat_history.push({
        date: new Date().toISOString(),
        heat_number: h.metadata.heat_number || '',
        category: h.metadata.category || '',
        round: h.metadata.round || '',
        location: h.metadata.location || '',
        discipline: heatDisc,
        position: r.position,
        total: r.total,
        all_wave_avg: r.all_wave_avg,
        wave_count: r.wave_count,
        interference: r.interference
      });
      updated = true;
    });
    if (updated) DB.athletes = athletes;
  } catch(e2) { console.error('Athlete profile save error:', e2); }
  
  document.getElementById('jmCloseBtn').style.display = 'none';
  document.getElementById('jmCloseRow').style.display = 'none';
  document.getElementById('jmReopenBtn').style.display = 'inline-block';
  document.getElementById('jmResults').style.display = 'block';
  if (jmTimer) { clearInterval(jmTimer); jmTimer = null; }
  
  jmDisplayResults();
  jmDisplayTracker();
  } catch(e) { alert('Error closing heat: ' + e.message); console.error(e); }
}

function jmDisplayResults() {
  const results = jmCalcRankings();
  document.getElementById('jmResultsContent').innerHTML = results.map(r => {
    const emoji = r.position === 1 ? 'ü•á' : r.position === 2 ? 'ü•à' : r.position === 3 ? 'ü•â' : r.position + '.';
    const wStr = r.top_waves.map(w => w.toFixed(2)).join(' + ');
    const intStr = r.interference > 0 ? ` ¬∑ ${JM_INT_LABELS[r.interference]}: ${JM_INT_DESC[r.interference]}` : '';
    const avgStr = r.wave_count > 0 ? `<div style="font-size:11px;color:var(--text-secondary);margin-top:2px">Avg all waves: ${r.all_wave_avg.toFixed(2)} (${r.wave_count} olas)</div>` : '';
    return `<div class="jm-rank-item"><div><span style="font-size:18px;margin-right:6px">${emoji}</span><strong>${r.color}</strong>${r.name ? ' ¬∑ '+r.name : ''}${intStr}<div class="jm-rank-waves">${wStr}</div>${avgStr}</div><div style="font-size:20px;font-weight:800">${r.total.toFixed(2)}</div></div>`;
  }).join('');
}

function jmDisplayTracker() {
  const tracker = DB.judgeTracker;
  if (Object.keys(tracker).length === 0) return;
  
  let html = '<div style="display:flex;justify-content:flex-end;margin-bottom:8px"><button class="btn btn-sm btn-outline" onclick="jmExportTracker()" style="width:auto;padding:6px 12px;font-size:11px">üìä Export Tracker CSV</button></div>';
  html += '<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:12px;min-width:600px"><thead><tr><th style="text-align:left;padding:8px;background:#1e2a3a;color:var(--text-secondary);border-radius:4px 0 0 0">Surfer</th>';
  for (let i = 1; i <= 6; i++) html += `<th style="padding:8px;background:#1e2a3a;color:var(--text-secondary)">H${i}</th>`;
  html += '<th style="padding:8px;background:#1e2a3a;color:var(--text-secondary)">Avg Total</th><th style="padding:8px;background:#1e2a3a;color:var(--text-secondary)">Avg/Wave</th><th style="padding:8px;background:#1e2a3a;color:var(--text-secondary);border-radius:0 4px 0 0">Goal</th></tr></thead><tbody>';
  
  for (const [name, info] of Object.entries(tracker)) {
    html += `<tr><td style="padding:8px;font-weight:700;border-bottom:1px solid var(--border)">${name}</td>`;
    for (let i = 0; i < 6; i++) {
      const v = info.heats[i];
      html += `<td style="padding:8px;text-align:center;border-bottom:1px solid var(--border);font-variant-numeric:tabular-nums">${v !== undefined ? v.toFixed(2) : '‚Äî'}</td>`;
    }
    const valid = info.heats.filter(h => h != null);
    const avg = valid.length > 0 ? valid.reduce((a, b) => a + b, 0) / valid.length : 0;
    // All-wave average across all heats
    const wAvgs = (info.all_wave_avgs || []).filter(a => a > 0);
    const allWaveAvg = wAvgs.length > 0 ? wAvgs.reduce((a, b) => a + b, 0) / wAvgs.length : 0;
    const avgColor = allWaveAvg >= 6 ? 'var(--green)' : allWaveAvg >= 4 ? 'var(--yellow)' : allWaveAvg > 0 ? 'var(--red)' : 'var(--text-secondary)';
    html += `<td style="padding:8px;text-align:center;border-bottom:1px solid var(--border);font-weight:700;color:var(--accent)">${avg > 0 ? avg.toFixed(2) : '‚Äî'}</td>`;
    html += `<td style="padding:8px;text-align:center;border-bottom:1px solid var(--border);font-weight:700;color:${avgColor}">${allWaveAvg > 0 ? allWaveAvg.toFixed(2) : '‚Äî'}</td>`;
    html += `<td style="padding:8px;text-align:center;border-bottom:1px solid var(--border);color:var(--yellow);font-weight:700">${info.goal > 0 ? info.goal.toFixed(1) : '‚Äî'}</td></tr>`;
  }
  html += '</tbody></table></div>';
  
  document.getElementById('jmTrackerContent').innerHTML = html;
  document.getElementById('jmTracker').style.display = 'block';
}

function jmReopenHeat() {
  const h = jmGetHeat();
  h.metadata.is_closed = false;
  jmSave();
  document.getElementById('jmCloseBtn').style.display = 'inline-block';
  document.getElementById('jmCloseRow').style.display = 'block';
  document.getElementById('jmReopenBtn').style.display = 'none';
  document.getElementById('jmResults').style.display = 'none';
}

function jmResetHeat() {
  if (!confirm('Reset all scores and timer?')) return;
  const h = jmGetHeat();
  h.surfers.forEach(s => { s.waves = new Array(20).fill(null); s.interference = 0; s.interference_waves = []; });
  h.metadata.is_closed = false;
  h.metadata.notes = '';
  h.priority_order = [];
  h.started = false;
  jmSave();
  jmScoreTimestamps = {};
  
  if (jmTimer) { clearInterval(jmTimer); jmTimer = null; }
  document.getElementById('jmTimerBar').style.display = 'none';
  document.getElementById('jmCloseRow').style.display = 'none';
  document.getElementById('jmStartBtn').disabled = false;
  document.getElementById('jmStartBtn').style.opacity = '1';
  document.getElementById('jmResults').style.display = 'none';
  document.getElementById('jmCloseBtn').style.display = 'inline-block';
  document.getElementById('jmReopenBtn').style.display = 'none';
  // Clear surfer setup init so dropdowns refresh
  const sg = document.getElementById('jmSurferSetup');
  if (sg) delete sg.dataset.init;
  jmExpandSetup();
  renderJudge();
}

function jmNotes() { document.getElementById('jmNotesModal').classList.add('active'); }

// EXPORT CSV
function jmExportCSV() {
  const h = jmGetHeat();
  const results = jmCalcRankings();
  let csv = `Heat Number,${h.metadata.heat_number}\nCategory,${h.metadata.category}\nRound,${h.metadata.round}\nLocation,${h.metadata.location}\nDuration,${h.metadata.duration} min\n`;
  if (h.metadata.notes) csv += `Notes,"${h.metadata.notes.replace(/"/g,'""')}"\n`;
  csv += '\nFULL SCORING GRID\nSurfer,' + Array.from({length:20},(_,i)=>'W'+(i+1)).join(',') + '\n';
  h.surfers.forEach(s => {
    csv += s.color + ',' + s.waves.map(w => w !== null ? w.toFixed(2) : '-').join(',') + '\n';
  });
  csv += '\nFINAL RESULTS\nPosition,Surfer,Name,Best Wave,2nd Wave,Total,Avg/Wave,Waves,Interference\n';
  results.forEach(r => {
    const w = r.top_waves.concat([null,null]).slice(0,2);
    csv += `${r.position},${r.color},${r.name},${w[0]!==null&&w[0]!==undefined?w[0].toFixed(2):'-'},${w[1]!==null&&w[1]!==undefined?w[1].toFixed(2):'-'},${r.total.toFixed(2)},${r.all_wave_avg>0?r.all_wave_avg.toFixed(2):'-'},${r.wave_count},${JM_INT_LABELS[r.interference]}\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const cat = h.metadata.category.replace(/\s/g,'') || 'Heat';
  const num = h.metadata.heat_number || '0';
  a.download = `${cat}_H${num}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

function jmExportTracker() {
  const tracker = DB.judgeTracker;
  if (Object.keys(tracker).length === 0) { alert('No tracker data yet'); return; }
  
  const maxHeats = Math.max(...Object.values(tracker).map(t => t.heats.length));
  let csv = 'Surfer';
  for (let i = 1; i <= maxHeats; i++) csv += `,Heat ${i} Total`;
  csv += ',Avg Heat Total,Avg Per Wave,Goal,Status\n';
  
  for (const [name, info] of Object.entries(tracker)) {
    csv += `"${name}"`;
    for (let i = 0; i < maxHeats; i++) {
      csv += `,${info.heats[i] !== undefined ? info.heats[i].toFixed(2) : ''}`;
    }
    const valid = info.heats.filter(h => h != null);
    const avgTotal = valid.length > 0 ? valid.reduce((a, b) => a + b, 0) / valid.length : 0;
    const wAvgs = (info.all_wave_avgs || []).filter(a => a > 0);
    const allWaveAvg = wAvgs.length > 0 ? wAvgs.reduce((a, b) => a + b, 0) / wAvgs.length : 0;
    const best = valid.length > 0 ? Math.max(...valid) : 0;
    const status = info.goal > 0 ? (best >= info.goal ? 'GOAL HIT' : 'In Progress') : '';
    csv += `,${avgTotal > 0 ? avgTotal.toFixed(2) : ''},${allWaveAvg > 0 ? allWaveAvg.toFixed(2) : ''},${info.goal > 0 ? info.goal.toFixed(1) : ''},${status}\n`;
  }
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `KSS_Session_Tracker_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// ============================================================
// BEGINNER MODE
// ============================================================
let begIdx = 0;
let begEval = {};
let begWaves = {}; // key: athlete_id, value: array of wave evals

function renderBeginner() {
  const s = DB.activeSession;
  if (!s || !s.athletes || s.athletes.length === 0) return;
  
  // Load existing data
  if (s.beginnerData) {
    Object.keys(s.beginnerData).forEach(aid => {
      begWaves[aid] = s.beginnerData[aid] || [];
    });
  }
  
  // Initialize begWaves for all athletes
  s.athletes.forEach(id => {
    if (!begWaves[id]) begWaves[id] = [];
  });
  
  begIdx = Math.min(begIdx, s.athletes.length - 1);
  begResetEval();
  begUpdateUI();
}

function begResetEval() {
  begEval = { catching: null, popup: null, balance: null, direction: null, waveType: null, stance: null };
  // Reset button states
  ['begCatching','begPopup','begBalance','begDirection','begWaveType','begStance'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.querySelectorAll('.beg-eval-btn').forEach(b => b.classList.remove('selected'));
  });
  const notes = document.getElementById('begNotes');
  if (notes) notes.value = '';
}

function begSel(group, value, el) {
  const map = { begCatching: 'catching', begPopup: 'popup', begBalance: 'balance', begDirection: 'direction', begWaveType: 'waveType', begStance: 'stance' };
  begEval[map[group]] = value;
  const container = document.getElementById(group);
  container.querySelectorAll('.beg-eval-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
}

function begPrev() {
  const s = DB.activeSession;
  if (!s) return;
  begIdx = (begIdx - 1 + s.athletes.length) % s.athletes.length;
  begResetEval();
  begUpdateUI();
}

function begNext() {
  const s = DB.activeSession;
  if (!s) return;
  begIdx = (begIdx + 1) % s.athletes.length;
  begResetEval();
  begUpdateUI();
}

function begUpdateUI() {
  const s = DB.activeSession;
  if (!s) return;
  const aid = s.athletes[begIdx];
  const ath = DB.athletes.find(a => a.id === aid);
  document.getElementById('begName').textContent = ath ? ath.name : '‚Äî';
  
  const waves = begWaves[aid] || [];
  document.getElementById('begTotal').textContent = waves.length;
  document.getElementById('begStanding').textContent = waves.filter(w => w.popup === 'standing').length;
  document.getElementById('begSolo').textContent = waves.filter(w => w.catching === 'solo').length;
  document.getElementById('begComplete').textContent = waves.filter(w => w.balance === 'complete').length;
  
  // Wave history
  const list = document.getElementById('begWaveList');
  if (waves.length === 0) {
    list.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:12px">Sin intentos a√∫n</div>';
    return;
  }
  
  list.innerHTML = waves.map((w, i) => {
    const tags = [];
    if (w.catching) tags.push(begTagHTML(w.catching, { assisted: 'ü§ù Asistido', timed: '‚è±Ô∏è Timing', solo: 'üèÑ Solo' }[w.catching], { assisted: 'var(--red)', timed: '#f59e0b', solo: 'var(--green)' }[w.catching]));
    if (w.popup) tags.push(begTagHTML(w.popup, { none: '‚ùå No popup', knees: 'ü¶µ Rodillas', standing: '‚úÖ De pie' }[w.popup], { none: 'var(--red)', knees: '#f59e0b', standing: 'var(--green)' }[w.popup]));
    if (w.balance) tags.push(begTagHTML(w.balance, { falls: 'üí• Cae', partial: '‚öñÔ∏è Parcial', complete: 'üèÜ Completo' }[w.balance], { falls: 'var(--red)', partial: '#f59e0b', complete: 'var(--green)' }[w.balance]));
    if (w.direction) tags.push(begTagHTML(w.direction, { none: '‚ùå Sin ctrl', some: '„Ä∞Ô∏è Algo', controls: '‚úÖ Controla' }[w.direction], { none: 'var(--red)', some: '#f59e0b', controls: 'var(--green)' }[w.direction]));
    if (w.waveType) tags.push(begTagHTML(w.waveType, { whitewash: 'ü´ß Espuma', reform: 'üåä Reforma', green: 'üíö Verde' }[w.waveType], 'var(--accent)'));
    
    return `<div class="beg-wave-mini">
      <div class="beg-wave-num">${i + 1}</div>
      <div class="beg-wave-tags">${tags.join('')}</div>
      <button style="background:none;border:none;color:var(--red);font-size:14px;cursor:pointer;flex-shrink:0" onclick="begDeleteWave(${i})">‚úï</button>
    </div>`;
  }).reverse().join('');
}

function begTagHTML(val, text, color) {
  return `<span class="beg-wave-tag" style="background:${color};color:#fff">${text}</span>`;
}

function begLogWave() {
  const s = DB.activeSession;
  if (!s) return;
  const aid = s.athletes[begIdx];
  
  // Validate minimum
  if (!begEval.catching && !begEval.popup) {
    alert('Selecciona al menos Entrada y Pop-up');
    return;
  }
  
  const wave = {
    ...begEval,
    notes: document.getElementById('begNotes').value.trim(),
    time: new Date().toISOString()
  };
  
  if (!begWaves[aid]) begWaves[aid] = [];
  begWaves[aid].push(wave);
  
  // Save to session data
  if (!s.beginnerData) s.beginnerData = {};
  s.beginnerData[aid] = begWaves[aid];
  saveDB();
  
  if (navigator.vibrate) navigator.vibrate(30);
  begResetEval();
  begUpdateUI();
}

function begDeleteWave(idx) {
  const s = DB.activeSession;
  if (!s) return;
  const aid = s.athletes[begIdx];
  if (begWaves[aid]) {
    begWaves[aid].splice(idx, 1);
    if (s.beginnerData) s.beginnerData[aid] = begWaves[aid];
    saveDB();
    begUpdateUI();
  }
}

// Auto-update lock states periodically
setInterval(() => { if (currentView === 'judge') jmUpdateSequential(); }, 2000);

// ============================================================
// INIT
// ============================================================
(function init() {
  // Populate all KSS logos
  document.querySelectorAll('[id$="LogoImg"]').forEach(img => img.src = KSS_LOGO);
  document.getElementById('labWatermark').src = KSS_LOGO;
  
  // Check for active session
  const s = DB.activeSession;
  if (s) {
    showView('session-hub');
  } else {
    renderHome();
  }
  
  // Service worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(e => console.log('SW error:', e));
  }
  
  // Close modal on overlay click
  document.querySelectorAll('.modal-overlay').forEach(m => {
    m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); });
  });
})();
</script>
</body>
</html>
