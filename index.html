<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="theme-color" content="#0f172a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="KSS Coach">
<link rel="apple-touch-icon" href="kss_coach_192.png">
<link rel="manifest" href="manifest.json">
<title>KSS Coach</title>
<style>
:root {
  --bg-primary: #0a0f1a;
  --bg-card: #111827;
  --bg-input: #0d1321;
  --border: #1e2a3a;
  --border-focus: #0ea5e9;
  --text-primary: #e8ecf1;
  --text-secondary: #7a8599;
  --text-muted: #4a556b;
  --accent: #0ea5e9;
  --accent-glow: rgba(14,165,233,.15);
  --green: #22c55e;
  --green-bg: rgba(34,197,94,.12);
  --yellow: #eab308;
  --yellow-bg: rgba(234,179,8,.12);
  --red: #ef4444;
  --red-bg: rgba(239,68,68,.12);
  --orange: #f97316;
  --radius: 10px;
  --radius-sm: 6px;
  --nav-h: 64px;
  --safe-b: env(safe-area-inset-bottom, 0px);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html{overscroll-behavior:none;height:100%}
body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','Segoe UI',sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100%;padding-bottom:calc(var(--nav-h) + var(--safe-b) + 8px);overscroll-behavior:none;-webkit-user-select:none;user-select:none;font-size:15px;line-height:1.5}
input,textarea,select,button{font-family:inherit;-webkit-user-select:text;user-select:text}
button{cursor:pointer;border:none;background:none;color:inherit}

/* === VIEWS === */
.view{display:none;padding:16px 16px 24px;animation:fadeIn .2s ease}
.view.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

/* === NAV === */
.bottom-nav{position:fixed;bottom:0;left:0;right:0;height:calc(var(--nav-h) + var(--safe-b));padding-bottom:var(--safe-b);background:var(--bg-card);border-top:1px solid var(--border);display:flex;z-index:100}
.nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;font-size:10px;color:var(--text-muted);font-weight:600;letter-spacing:.03em;transition:color .15s}
.nav-btn.active{color:var(--accent)}
.nav-btn.disabled{opacity:.3;pointer-events:none}
.nav-btn svg{width:24px;height:24px;stroke:currentColor;fill:none;stroke-width:1.8;stroke-linecap:round;stroke-linejoin:round}

/* === CARDS === */
.card{background:var(--bg-card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px}
.card-header{font-size:13px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.06em;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.card-header svg{width:16px;height:16px}

/* === FORMS === */
.field{margin-bottom:16px}
.field-label{display:block;font-size:12px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px}
.field-input{width:100%;padding:12px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-size:15px;transition:border-color .15s}
.field-input:focus{outline:none;border-color:var(--border-focus)}
select.field-input{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%237a8599'%3E%3Cpath d='M2 4l4 4 4-4'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}

/* === BUTTONS === */
.btn{padding:14px 24px;border-radius:var(--radius-sm);font-size:15px;font-weight:700;text-align:center;transition:all .15s;width:100%;display:block}
.btn-accent{background:var(--accent);color:#fff}
.btn-accent:active{transform:scale(.98);opacity:.9}
.btn-outline{border:1px solid var(--border);color:var(--text-secondary)}
.btn-danger{background:var(--red);color:#fff}
.btn-sm{padding:10px 16px;font-size:13px}

/* === SEGMENT CONTROL === */
.seg-row{display:flex;gap:6px;margin-bottom:16px}
.seg-btn{flex:1;padding:10px 4px;border-radius:var(--radius-sm);border:1px solid var(--border);font-size:13px;font-weight:700;text-align:center;transition:all .15s;color:var(--text-secondary)}
.seg-btn.selected{border-color:var(--accent);color:var(--accent);background:var(--accent-glow)}

/* === SEMAPHORE (Crowd) === */
.sem-row{display:flex;gap:8px}
.sem-btn{flex:1;padding:12px 4px;border-radius:var(--radius-sm);border:2px solid var(--border);font-size:22px;text-align:center;transition:all .15s}
.sem-btn.selected{transform:scale(1.05)}
.sem-btn[data-v="empty"].selected{border-color:var(--green);background:var(--green-bg)}
.sem-btn[data-v="medium"].selected{border-color:var(--yellow);background:var(--yellow-bg)}
.sem-btn[data-v="crowded"].selected{border-color:var(--red);background:var(--red-bg)}

/* === STAR RATING === */
.stars{display:flex;gap:4px}
.star{font-size:28px;color:var(--text-muted);cursor:pointer;transition:color .1s;line-height:1}
.star.active{color:var(--yellow)}

/* === ATHLETE CHIPS === */
.athlete-grid{display:flex;flex-wrap:wrap;gap:8px}
.athlete-chip{padding:10px 16px;border-radius:20px;border:1.5px solid var(--border);font-size:14px;font-weight:600;transition:all .15s;display:flex;align-items:center;gap:6px}
.athlete-chip.selected{border-color:var(--green);background:var(--green-bg);color:var(--green)}
.athlete-chip .avi{width:26px;height:26px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:800;color:#fff}

/* === TACTICAL IQ === */
.tac-header{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:var(--bg-card);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:50}
.tac-athlete-name{font-size:20px;font-weight:800;letter-spacing:-.02em}
.tac-nav-arrow{padding:8px 16px;font-size:22px;color:var(--text-secondary)}
.tac-stat-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
.tac-stat{text-align:center;padding:16px;border-radius:var(--radius);background:var(--bg-card);border:1px solid var(--border)}
.tac-stat-val{font-size:36px;font-weight:800;letter-spacing:-.03em}
.tac-stat-label{font-size:11px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.06em;font-weight:700;margin-top:2px}
.tac-catch{font-size:48px;font-weight:800;text-align:center;padding:20px;border-radius:var(--radius);margin-bottom:16px}
.tac-catch.good{color:var(--green);background:var(--green-bg);border:1px solid rgba(34,197,94,.2)}
.tac-catch.mid{color:var(--yellow);background:var(--yellow-bg);border:1px solid rgba(234,179,8,.2)}
.tac-catch.low{color:var(--red);background:var(--red-bg);border:1px solid rgba(239,68,68,.2)}
.tac-catch-label{font-size:12px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.08em;font-weight:700}

/* Big counters */
.counter-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:16px}
.counter-btn{padding:20px 8px;border-radius:var(--radius);border:2px solid var(--border);text-align:center;font-weight:800;font-size:15px;transition:all .1s;display:flex;flex-direction:column;align-items:center;gap:4px;min-height:90px;justify-content:center}
.counter-btn:active{transform:scale(.95)}
.counter-btn .cnt-icon{font-size:28px}
.counter-btn .cnt-val{font-size:28px;font-weight:800}
.counter-btn.c-paddle{border-color:var(--accent);color:var(--accent);background:rgba(14,165,233,.06)}
.counter-btn.c-catch{border-color:var(--green);color:var(--green);background:rgba(34,197,94,.06)}
.counter-btn.c-fall{border-color:var(--red);color:var(--red);background:rgba(239,68,68,.06)}

/* Eval buttons */
.eval-section{margin-bottom:14px}
.eval-label{font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.06em;margin-bottom:6px}
.eval-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px}
.eval-btn{padding:10px 6px;border-radius:var(--radius-sm);border:1.5px solid var(--border);font-size:12px;font-weight:700;text-align:center;transition:all .12s}
.eval-btn:active{transform:scale(.95)}
.eval-btn.sel-r{border-color:var(--red);color:var(--red);background:var(--red-bg)}
.eval-btn.sel-y{border-color:var(--yellow);color:var(--yellow);background:var(--yellow-bg)}
.eval-btn.sel-g{border-color:var(--green);color:var(--green);background:var(--green-bg)}
.eval-btn.sel-b{border-color:var(--accent);color:var(--accent);background:rgba(14,165,233,.12)}
.eval-btn.sel-a{border-color:#f97316;color:#f97316;background:rgba(249,115,22,.12)}
.eval-btn.sel-m{border-color:var(--text-secondary);color:var(--text-secondary);background:rgba(148,163,184,.12)}

/* Maneuver tags */
.tag-row{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:16px}
.tag-btn{padding:8px 14px;border-radius:16px;border:1.5px solid var(--border);font-size:12px;font-weight:700;transition:all .12s}
.tag-btn.selected{border-color:var(--accent);color:var(--accent);background:var(--accent-glow)}

/* Undo toast */
.undo-toast{position:fixed;bottom:calc(var(--nav-h) + var(--safe-b) + 16px);left:50%;transform:translateX(-50%);background:#333;color:#fff;padding:10px 20px;border-radius:20px;font-size:13px;font-weight:600;z-index:200;display:none;animation:slideUp .25s ease}
.undo-toast.show{display:flex;align-items:center;gap:12px}
.undo-toast button{color:var(--accent);font-weight:800;font-size:13px}
@keyframes slideUp{from{opacity:0;transform:translateX(-50%) translateY(12px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}

/* === OVERVIEW === */
.ov-row{display:flex;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border);gap:12px}
.ov-row:last-child{border:none}
.ov-name{flex:1;font-weight:700;font-size:15px}
.ov-stats{font-size:13px;color:var(--text-secondary);font-weight:600}
.ov-ratio{font-size:18px;font-weight:800;min-width:50px;text-align:right}
.ov-bar{width:100%;height:4px;background:var(--border);border-radius:2px;margin-top:6px}
.ov-bar-fill{height:100%;border-radius:2px;transition:width .3s}

/* === DEBRIEF === */
.db-condition{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.db-tag{padding:6px 12px;border-radius:14px;background:var(--bg-input);border:1px solid var(--border);font-size:12px;font-weight:600;color:var(--text-secondary)}
.db-athlete-card{border:1px solid var(--border);border-radius:var(--radius);padding:14px;margin-bottom:10px;background:var(--bg-card)}
.db-athlete-name{font-size:16px;font-weight:800;margin-bottom:8px}
.db-stat-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:8px}
.db-stat{text-align:center}
.db-stat-v{font-size:20px;font-weight:800}
.db-stat-l{font-size:10px;color:var(--text-secondary);text-transform:uppercase;font-weight:700}
.db-xp{font-size:13px;color:var(--accent);font-weight:700;margin-top:6px}

/* === ATHLETES LIST === */
.ath-item{display:flex;align-items:center;gap:12px;padding:14px 16px;border-bottom:1px solid var(--border)}
.ath-item:last-child{border:none}
.ath-avi{width:40px;height:40px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:800;color:#fff;flex-shrink:0}
.ath-info{flex:1}
.ath-name{font-weight:700;font-size:15px}
.ath-sub{font-size:12px;color:var(--text-secondary)}

/* === MODAL === */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:300;display:none;align-items:flex-end;justify-content:center}
.modal-overlay.active{display:flex}
.modal-sheet{background:var(--bg-card);border-radius:16px 16px 0 0;width:100%;max-width:500px;max-height:85vh;overflow-y:auto;padding:24px 20px calc(20px + var(--safe-b));animation:sheetUp .25s ease}
@keyframes sheetUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-handle{width:36px;height:4px;background:var(--text-muted);border-radius:2px;margin:0 auto 20px}
.modal-title{font-size:18px;font-weight:800;margin-bottom:16px}

/* === TIMER === */
.session-bar{position:sticky;top:0;z-index:50;background:var(--bg-primary);padding:8px 16px;display:none;border-bottom:1px solid var(--border)}
.session-bar.active{display:flex;align-items:center;justify-content:space-between}
.sb-info{font-size:12px;color:var(--text-secondary);font-weight:600}
.sb-time{font-size:18px;font-weight:800;font-variant-numeric:tabular-nums;color:var(--accent)}

/* === UTILITIES === */
.empty-state{text-align:center;padding:40px 20px;color:var(--text-muted)}
.empty-state svg{width:48px;height:48px;margin-bottom:12px;opacity:.4}
.empty-state p{font-size:14px;margin-bottom:16px}
.mt-4{margin-top:16px}.mb-4{margin-bottom:16px}
.text-center{text-align:center}
.text-sm{font-size:13px}
.text-muted{color:var(--text-secondary)}
.flex-between{display:flex;justify-content:space-between;align-items:center}
.gap-2{gap:8px}
/* === JUDGE MODE === */
.jm-setup{padding:16px}
.jm-meta-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.jm-surfer-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px}
.jm-surfer-item{display:flex;flex-direction:column;gap:4px}
.jm-surfer-item label{font-size:11px;font-weight:700;padding:3px 8px;border-radius:4px}
.jm-surfer-item input{padding:8px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-size:13px}
.jm-surfer-item input:focus{outline:none;border-color:var(--border-focus)}
.jm-surfer-item select{padding:8px;background:var(--bg-input);border:1px solid var(--border);border-radius:var(--radius-sm);color:var(--text-primary);font-size:13px;-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 8px center}
.jm-surfer-item select:focus{outline:none;border-color:var(--border-focus)}

.jm-timer-bar{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--green);border-radius:var(--radius);margin-bottom:12px}
.jm-timer-bar.warning{background:var(--yellow)}
.jm-timer-bar.critical{background:var(--red);animation:pulse 1s infinite}
.jm-timer{font-size:36px;font-weight:800;font-variant-numeric:tabular-nums;color:#fff}
.jm-timer-btns{display:flex;gap:6px}
.jm-timer-btn{padding:8px 14px;border-radius:var(--radius-sm);font-size:12px;font-weight:700;color:#fff;border:1px solid rgba(255,255,255,.3)}

.jm-grid-wrap{overflow-x:auto;margin-bottom:12px;-webkit-overflow-scrolling:touch}
.jm-grid{border-collapse:separate;border-spacing:3px;min-width:900px}
.jm-grid th{background:#1e2a3a;color:var(--text-secondary);padding:6px 4px;font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.04em;border-radius:4px;text-align:center;white-space:nowrap}
.jm-grid td{text-align:center;position:relative}
.jm-color-cell{font-weight:700;font-size:12px;padding:10px 6px;border-radius:6px;cursor:pointer;position:relative;white-space:nowrap;transition:transform .1s}
.jm-color-cell:active{transform:scale(.95)}
.jm-color-red{background:#991b1b;color:#fecaca;border:1px solid #7f1d1d}
.jm-color-yellow{background:#854d0e;color:#fef08a;border:1px solid #713f12}
.jm-color-black{background:#0f172a;color:#e2e8f0;border:1px solid #334155}
.jm-color-white{background:#f0f0f0;color:#0f172a;border:1px solid #d1d5db}
.jm-color-blue{background:#1e3a8a;color:#bfdbfe;border:1px solid #1e40af}

.jm-int-badge{position:absolute;bottom:2px;right:2px;font-size:8px;padding:1px 4px;border-radius:3px;font-weight:800;background:#475569;color:#cbd5e1}
.jm-int-badge.l1{background:#f59e0b;color:#fff}
.jm-int-badge.l2{background:#ef4444;color:#fff}
.jm-int-badge.l3{background:#dc2626;color:#fff}
.jm-int-badge.l4{background:#991b1b;color:#fff}
.jm-int-badge.l5{background:#7f1d1d;color:#fff}
.jm-int-badge.l6{background:#000;color:#fff;border:1px solid #ef4444}

.jm-score-input{width:46px;padding:7px 3px;font-size:13px;font-weight:700;text-align:center;border:1px solid var(--border);border-radius:4px;background:var(--bg-input);color:var(--text-primary);-webkit-user-select:text;user-select:text}
.jm-score-input:focus{outline:none;border-color:var(--border-focus);background:var(--bg-card)}
.jm-score-input:disabled{opacity:.25;cursor:not-allowed;background:#060a12}
.jm-score-input.best{background:linear-gradient(135deg,#fbbf24,#f59e0b);border-color:#d97706;color:#78350f}
.jm-score-input.locked{border-color:#475569;opacity:.85}
.jm-score-input.recent{border-color:var(--accent);box-shadow:0 0 4px rgba(14,165,233,.3)}
.jm-score-input.int-marked{border:2px solid var(--red);background:rgba(239,68,68,.1)}
.jm-tri{position:absolute;top:0;right:2px;color:var(--red);font-size:14px;pointer-events:none;display:none}

.jm-rankings{margin-bottom:12px}
.jm-rank-item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;margin-bottom:6px;border-radius:8px;font-weight:700;font-size:14px}
.jm-rank-item:nth-child(1){background:linear-gradient(135deg,#fbbf24,#f59e0b);color:#78350f}
.jm-rank-item:nth-child(2){background:linear-gradient(135deg,#94a3b8,#cbd5e1);color:#0f172a}
.jm-rank-item:nth-child(3){background:linear-gradient(135deg,#d97706,#f59e0b);color:#78350f}
.jm-rank-item:nth-child(n+4){background:#1e2a3a;color:#cbd5e1}
.jm-rank-waves{font-size:11px;opacity:.8;font-weight:500;margin-top:2px}
.jm-rank-need{font-size:11px;font-style:italic;font-weight:700;margin-top:2px}
.jm-rank-int{font-size:11px;padding:1px 5px;border-radius:3px;background:rgba(239,68,68,.2);color:#fca5a5;margin-left:4px}
.jm-priority{display:flex;gap:6px;margin-bottom:12px}
.jm-pri-item{flex:1;text-align:center;padding:10px 4px;border-radius:8px;font-weight:700;cursor:pointer;transition:all .15s}
.jm-pri-item:nth-child(1){background:linear-gradient(135deg,#10b981,#059669);color:#fff}
.jm-pri-item:nth-child(2){background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff}
.jm-pri-item.tied{background:#475569;color:#cbd5e1}
.jm-pri-num{font-size:20px;font-weight:800}
.jm-pri-col{font-size:12px}
.jm-pri-lbl{font-size:9px;text-transform:uppercase;letter-spacing:.04em;opacity:.8}

.jm-results{margin-top:16px}
.jm-meta-collapsed{font-size:12px;color:var(--text-secondary);font-weight:600;margin-bottom:10px;display:none}
.jm-meta-collapsed.active{display:block}
.jm-setup-form.hidden{display:none}
.jm-notes-modal{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:300;display:none;align-items:center;justify-content:center}
.jm-notes-modal.active{display:flex}
.jm-notes-box{background:var(--bg-card);border-radius:12px;padding:20px;width:90%;max-width:500px;border:1px solid var(--border)}

/* ===== PHASE 2: PLAYER CARD ===== */
.pc-header{text-align:center;padding:20px 0 16px}
.pc-avi{width:72px;height:72px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#6366f1);display:inline-flex;align-items:center;justify-content:center;font-size:26px;font-weight:800;color:#fff;margin-bottom:8px}
.pc-name{font-size:22px;font-weight:800}
.pc-sub{font-size:13px;color:var(--text-secondary);margin-top:2px}
.pc-level-tag{display:inline-block;background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff;font-size:11px;font-weight:800;padding:3px 10px;border-radius:20px;margin-top:6px;letter-spacing:.04em}
.pc-xp-bar{height:6px;background:var(--bg-input);border-radius:3px;margin:8px auto 0;width:70%;overflow:hidden}
.pc-xp-fill{height:100%;background:linear-gradient(90deg,var(--accent),#6366f1);border-radius:3px;transition:width .4s}
.pc-xp-text{font-size:10px;color:var(--text-muted);margin-top:4px}

.pc-stats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px}
.pc-stat{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:10px 4px;text-align:center}
.pc-stat-val{font-size:20px;font-weight:800;font-variant-numeric:tabular-nums}
.pc-stat-lbl{font-size:10px;color:var(--text-secondary);margin-top:2px;text-transform:uppercase;letter-spacing:.03em}

.pc-badges{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.pc-badge{display:flex;align-items:center;gap:6px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:8px 10px;font-size:12px}
.pc-badge.earned{border-color:var(--yellow);background:rgba(245,158,11,.08)}
.pc-badge-icon{font-size:20px}
.pc-badge-info{text-align:left}
.pc-badge-name{font-weight:700;font-size:11px}
.pc-badge-desc{font-size:10px;color:var(--text-muted)}
.pc-badge.locked{opacity:.4}

.pc-chart{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:12px}
.pc-chart-title{font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px}
.pc-bar-row{display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:12px}
.pc-bar-label{width:50px;text-align:right;color:var(--text-secondary);font-size:11px;flex-shrink:0}
.pc-bar-track{flex:1;height:14px;background:var(--bg-input);border-radius:7px;overflow:hidden}
.pc-bar-fill{height:100%;border-radius:7px;min-width:2px}
.pc-bar-val{width:35px;font-weight:700;font-variant-numeric:tabular-nums;font-size:11px}

.pc-history{margin-bottom:16px}
.pc-hist-item{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px}
.pc-hist-item:last-child{border-bottom:none}

/* ===== DRILL BANK ===== */
.drill-card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px}
.drill-card.assigned{border-color:var(--accent);border-width:2px}
.drill-header{display:flex;justify-content:space-between;align-items:center}
.drill-name{font-weight:700;font-size:14px}
.drill-cat{font-size:10px;color:var(--text-secondary);background:var(--bg-input);padding:2px 8px;border-radius:4px;text-transform:uppercase;letter-spacing:.04em}
.drill-desc{font-size:12px;color:var(--text-secondary);margin-top:6px;line-height:1.4}
.drill-meta{display:flex;gap:12px;margin-top:8px;font-size:11px;color:var(--text-muted)}
.drill-actions{display:flex;gap:6px;margin-top:10px}
.drill-cat-filter{display:flex;gap:6px;overflow-x:auto;padding-bottom:8px;margin-bottom:12px;-webkit-overflow-scrolling:touch}
.drill-cat-btn{padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;background:var(--bg-card);border:1px solid var(--border);color:var(--text-secondary);white-space:nowrap;cursor:pointer}
.drill-cat-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}

/* ===== PHASE 3: TECH LAB ===== */
.lab-video-wrap{position:relative;background:#000;border-radius:10px;overflow:hidden;margin-bottom:12px}
.lab-video{width:100%;display:block;max-height:50vh}
.lab-canvas{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;touch-action:none}
.lab-canvas.drawing{pointer-events:auto;cursor:crosshair;touch-action:none}

/* Lab Fullscreen Mode */
.lab-fullscreen{position:fixed!important;top:0;left:0;right:0;bottom:0;z-index:9999;background:#000;display:flex;flex-direction:column;border-radius:0;margin:0;padding:0;padding-top:var(--safe-t);padding-bottom:var(--safe-b)}
.lab-fullscreen .lab-video-wrap{flex:1;border-radius:0;margin:0;min-height:0}
.lab-fullscreen .lab-video{max-height:none;height:100%;object-fit:contain}
.lab-fullscreen .lab-controls{padding:6px 12px;background:rgba(0,0,0,.85)}
.lab-fullscreen .lab-tools{padding:0 12px;margin-bottom:6px;background:rgba(0,0,0,.85);justify-content:center}
.lab-fullscreen .lab-tool{background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.2);color:#fff;padding:10px 14px;font-size:13px}
.lab-fullscreen .lab-tool.active{background:var(--accent);border-color:var(--accent)}
.lab-fullscreen .lab-speed-row{display:flex;gap:4px;justify-content:center;padding:2px 12px;background:rgba(0,0,0,.85)}
.lab-fullscreen .lab-speed-row .lab-ctrl-btn{background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.2);color:#fff}
.lab-fullscreen .lab-color-row{display:flex;gap:8px;padding:4px 12px;background:rgba(0,0,0,.85);align-items:center;justify-content:center}
.lab-fullscreen .lab-timeline{background:rgba(255,255,255,.15)}
.lab-fullscreen .lab-time{color:rgba(255,255,255,.7)}
.lab-fullscreen .lab-ctrl-btn{background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.2);color:#fff;width:44px;height:44px}
.lab-fs-close{position:absolute;top:calc(var(--safe-t) + 8px);right:12px;z-index:10000;background:rgba(0,0,0,.7);border:1px solid rgba(255,255,255,.3);color:#fff;width:40px;height:40px;border-radius:50%;font-size:18px;display:flex;align-items:center;justify-content:center;cursor:pointer;-webkit-tap-highlight-color:transparent}
.lab-fs-close:active{transform:scale(.9)}
.lab-fs-expand{position:absolute;top:8px;right:8px;z-index:10;background:rgba(0,0,0,.6);border:none;color:#fff;width:36px;height:36px;border-radius:8px;font-size:16px;display:flex;align-items:center;justify-content:center;cursor:pointer;-webkit-tap-highlight-color:transparent}
.lab-fs-expand:active{transform:scale(.9)}
.lab-controls{display:flex;align-items:center;gap:8px;padding:8px 0}
.lab-ctrl-btn{width:40px;height:40px;border-radius:8px;background:var(--bg-card);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:18px;color:var(--text-primary);cursor:pointer}
.lab-ctrl-btn.active{background:var(--accent);border-color:var(--accent);color:#fff}
.lab-ctrl-btn:active{transform:scale(.92)}
.lab-timeline{flex:1;height:6px;background:var(--bg-input);border-radius:3px;cursor:pointer;position:relative;-webkit-appearance:none;appearance:none}
.lab-timeline::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--accent);cursor:pointer}
.lab-time{font-size:12px;color:var(--text-secondary);font-variant-numeric:tabular-nums;min-width:42px;text-align:center}
.lab-tools{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.lab-tool{padding:8px 12px;border-radius:8px;background:var(--bg-card);border:1px solid var(--border);font-size:12px;font-weight:600;cursor:pointer;color:var(--text-secondary)}
.lab-tool.active{background:var(--accent);border-color:var(--accent);color:#fff}
.lab-color-dot{width:20px;height:20px;border-radius:50%;border:2px solid var(--border);cursor:pointer}
.lab-color-dot.active{border-color:#fff;box-shadow:0 0 0 2px var(--accent)}
.lab-frames{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px}
.lab-frame{border-radius:8px;overflow:hidden;border:1px solid var(--border);cursor:pointer;position:relative}
.lab-frame img{width:100%;display:block;aspect-ratio:16/9;object-fit:cover}
.lab-frame-time{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,.7);font-size:10px;color:#fff;padding:3px 6px;text-align:center}
.lab-compare{display:grid;grid-template-columns:1fr 1fr;gap:4px;margin-bottom:12px}
.lab-compare img{width:100%;border-radius:8px;border:1px solid var(--border)}
.lab-clip{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:10px}
.lab-clip-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.lab-clip-name{font-weight:700;font-size:14px}
.lab-clip-meta{font-size:11px;color:var(--text-muted)}

/* ===== BIOMETRICS ===== */
.bio-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:12px}
.bio-card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:12px;text-align:center}
.bio-val{font-size:22px;font-weight:800;font-variant-numeric:tabular-nums}
.bio-lbl{font-size:10px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.04em;margin-top:2px}
.bio-trend{display:flex;align-items:flex-end;gap:3px;height:40px;justify-content:center;margin-top:6px}
.bio-bar{width:6px;border-radius:3px;min-height:3px}

/* ===== PHASE 4: DASHBOARD ===== */
.dash-hero{text-align:center;padding:12px 0 16px}
.dash-hero-title{font-size:28px;font-weight:800;letter-spacing:-.03em}
.dash-hero-sub{font-size:13px;color:var(--text-secondary);margin-top:2px}
.dash-row{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px}
.dash-kpi{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:10px 6px;text-align:center}
.dash-kpi-val{font-size:20px;font-weight:800;font-variant-numeric:tabular-nums}
.dash-kpi-lbl{font-size:9px;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.05em;margin-top:2px}
.dash-section{margin-bottom:14px}
.dash-section-title{font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.dash-feed-item{display:flex;gap:10px;align-items:flex-start;padding:10px 0;border-bottom:1px solid var(--border)}
.dash-feed-item:last-child{border-bottom:none}
.dash-feed-icon{font-size:18px;margin-top:1px}
.dash-feed-text{font-size:13px;line-height:1.4}
.dash-feed-time{font-size:11px;color:var(--text-muted)}
.dash-ath-mini{display:flex;gap:8px;overflow-x:auto;padding-bottom:6px;-webkit-overflow-scrolling:touch}
.dash-ath-chip{flex-shrink:0;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:10px 12px;text-align:center;min-width:80px;cursor:pointer}
.dash-ath-chip:active{transform:scale(.96)}
.dash-ath-avi{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#6366f1);display:inline-flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;color:#fff;margin-bottom:4px}
.dash-ath-name{font-size:11px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:70px}
.dash-ath-stat{font-size:10px;color:var(--text-muted)}

.tpl-card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:8px;cursor:pointer}
.tpl-card:active{transform:scale(.98)}
.tpl-card-name{font-weight:700;font-size:14px}
.tpl-card-meta{font-size:11px;color:var(--text-secondary);margin-top:3px}

.db-chart{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:12px}
.db-chart canvas{width:100%;height:120px}

/* ===== WORKOUT MODULE ===== */
.wo-ath-card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:10px}
.wo-ath-name{font-weight:700;font-size:14px;margin-bottom:8px}
.wo-drill-row{display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid var(--border);font-size:13px}
.wo-drill-row:last-child{border-bottom:none}
.wo-drill-name{flex:1;font-weight:600}
.wo-check{width:36px;height:36px;border-radius:8px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;flex-shrink:0;-webkit-tap-highlight-color:transparent}
.wo-check:active{transform:scale(.9)}
.wo-check.done{background:var(--green);border-color:var(--green);color:#fff}
.wo-check.fail{background:var(--red);border-color:var(--red);color:#fff}
.wo-quality{display:flex;gap:6px}
.wo-q-btn{width:36px;height:36px;border-radius:8px;border:1px solid var(--border);font-size:14px;display:flex;align-items:center;justify-content:center;cursor:pointer;background:var(--bg-input);-webkit-tap-highlight-color:transparent}
.wo-q-btn:active{transform:scale(.9)}
.wo-q-btn.active{font-weight:800;border-width:2px}

/* ===== HISTORY & PROGRESSION ===== */
.hist-card{background:var(--bg-card);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px;cursor:pointer;-webkit-tap-highlight-color:transparent}
.hist-card:active{background:var(--bg-input)}
.hist-spot{font-weight:800;font-size:15px}
.hist-date{font-size:12px;color:var(--text-muted)}
.hist-stats{display:flex;gap:12px;margin-top:6px;font-size:12px;color:var(--text-secondary)}
.hist-badge{display:inline-flex;align-items:center;gap:3px;background:var(--bg-input);padding:2px 8px;border-radius:6px;font-size:11px;font-weight:600}
.spark-line{position:relative;width:100%;height:100%}
.spark-line svg{width:100%;height:100%}
.sd-ath-card{border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:10px;background:var(--bg-card)}
</style>
</head>
<body>

<!-- SESSION BAR (visible during active session) -->
<div class="session-bar" id="sessionBar">
  <div class="sb-info" id="sbInfo">Parguito ¬∑ 3-4ft</div>
  <div class="sb-time" id="sbTime">00:00</div>
  <div style="display:flex;gap:4px">
    <button class="btn-sm btn-outline" onclick="showView('session-hub')" style="padding:6px 10px;font-size:11px;border-radius:4px;border:1px solid var(--border)">Hub</button>
    <button class="btn-sm btn-outline" onclick="showView('overview')" style="padding:6px 10px;font-size:11px;border-radius:4px;border:1px solid var(--border)">All</button>
  </div>
</div>

<!-- ==================== HOME ==================== -->
<div class="view active" id="view-home">
  <div class="dash-hero">
    <div class="dash-hero-title">KSS Coach</div>
    <div class="dash-hero-sub" id="homeGreeting">Surf Coaching System</div>
  </div>

  <button class="btn btn-accent" onclick="startNewSession()" id="homeStartBtn" style="margin-bottom:16px;font-size:17px;padding:18px">
    ‚ö° Nueva Sesi√≥n
  </button>

  <!-- KPI Row -->
  <div class="dash-row" id="homeKPIs" style="display:none"></div>

  <!-- Quick Athletes Strip -->
  <div class="dash-section" id="homeAthSection" style="display:none">
    <div class="dash-section-title">üë• Equipo</div>
    <div class="dash-ath-mini" id="homeAthStrip"></div>
  </div>

  <!-- Templates -->
  <div class="dash-section" id="homeTplSection" style="display:none">
    <div class="dash-section-title">üìã Templates <button class="text-sm" style="color:var(--accent);font-weight:700;margin-left:auto" onclick="showView('settings')">Gestionar</button></div>
    <div id="homeTplList"></div>
  </div>

  <!-- Needs Attention -->
  <div class="dash-section" id="homeAttentionSection" style="display:none">
    <div class="dash-section-title">‚ö†Ô∏è Necesitan Atenci√≥n</div>
    <div id="homeAttention"></div>
  </div>

  <!-- Recent Activity -->
  <div class="dash-section" id="homeFeedSection" style="display:none">
    <div class="dash-section-title" style="display:flex;justify-content:space-between;align-items:center">
      <span>üì∞ Actividad Reciente</span>
      <button style="font-size:12px;color:var(--accent);font-weight:700" onclick="showView('history')">Ver todo ‚Ä∫</button>
    </div>
    <div class="card" style="padding:10px 12px" id="homeFeed"></div>
  </div>

  <div id="homeEmpty" class="empty-state" style="margin-top:20px">
    <svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="1.5"><path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707"/></svg>
    <p>No tienes sesiones a√∫n.<br>Agrega atletas y arranca tu primera sesi√≥n.</p>
    <button class="btn btn-outline btn-sm" onclick="showView('athletes')" style="width:auto;display:inline-block">Agregar Atletas</button>
  </div>
</div>

<!-- ==================== SESSION CREATOR ==================== -->
<div class="view" id="view-session-setup">
  <div class="flex-between mb-4">
    <button class="text-sm text-muted" onclick="cancelSession()">‚Üê Cancelar</button>
    <div style="font-size:17px;font-weight:800">Nueva Sesi√≥n</div>
    <div style="width:60px"></div>
  </div>

  <!-- Spot -->
  <div class="field">
    <label class="field-label">üìç Spot</label>
    <select class="field-input" id="ssSpot"></select>
  </div>

  <!-- Conditions -->
  <div class="card">
    <div class="card-header">üåä Condiciones</div>
    
    <div class="field">
      <label class="field-label">Tama√±o</label>
      <div class="seg-row" id="ssSize">
        <button class="seg-btn" data-v="1" onclick="segSelect('ssSize',this)">1<br><span style="font-size:10px;font-weight:400">Flat</span></button>
        <button class="seg-btn" data-v="2" onclick="segSelect('ssSize',this)">2<br><span style="font-size:10px;font-weight:400">Small</span></button>
        <button class="seg-btn selected" data-v="3" onclick="segSelect('ssSize',this)">3<br><span style="font-size:10px;font-weight:400">Fun</span></button>
        <button class="seg-btn" data-v="4" onclick="segSelect('ssSize',this)">4<br><span style="font-size:10px;font-weight:400">Solid</span></button>
        <button class="seg-btn" data-v="5" onclick="segSelect('ssSize',this)">5<br><span style="font-size:10px;font-weight:400">Huge</span></button>
      </div>
    </div>

    <div class="field">
      <label class="field-label">Calidad</label>
      <div class="stars" id="ssQuality">
        <span class="star" onclick="starSelect('ssQuality',1)">‚òÖ</span>
        <span class="star" onclick="starSelect('ssQuality',2)">‚òÖ</span>
        <span class="star active" onclick="starSelect('ssQuality',3)">‚òÖ</span>
        <span class="star" onclick="starSelect('ssQuality',4)">‚òÖ</span>
        <span class="star" onclick="starSelect('ssQuality',5)">‚òÖ</span>
      </div>
    </div>

    <div class="field">
      <label class="field-label">Viento</label>
      <select class="field-input" id="ssWind">
        <option value="glassy">üåÖ Glassy (sin viento)</option>
        <option value="offshore">üí® Off-shore (bueno)</option>
        <option value="onshore">üå¨Ô∏è On-shore (malo)</option>
        <option value="cross">‚ÜóÔ∏è Cross-shore (lateral)</option>
      </select>
    </div>

    <div class="field" style="margin-bottom:0">
      <label class="field-label">Crowd</label>
      <div class="sem-row">
        <button class="sem-btn selected" data-v="empty" onclick="semSelect(this)">üü¢<br><span style="font-size:11px">Vac√≠o</span></button>
        <button class="sem-btn" data-v="medium" onclick="semSelect(this)">üü°<br><span style="font-size:11px">Medio</span></button>
        <button class="sem-btn" data-v="crowded" onclick="semSelect(this)">üî¥<br><span style="font-size:11px">Lleno</span></button>
      </div>
    </div>
  </div>

  <!-- Objective -->
  <div class="field">
    <label class="field-label">üéØ Objetivo de la Sesi√≥n</label>
    <input class="field-input" id="ssFocus" placeholder="Ej: T√©cnica de Bottom Turn">
  </div>

  <!-- Athletes -->
  <div class="card">
    <div class="card-header flex-between" style="margin-bottom:8px">
      <span>üë• Atletas</span>
      <button class="text-sm" style="color:var(--accent);font-weight:700" onclick="openAddAthleteModal()">+ Agregar</button>
    </div>
    <div class="athlete-grid" id="ssAthletes"></div>
    <div id="ssAthCount" style="margin-top:10px;font-size:12px;color:var(--text-secondary);font-weight:600"></div>
  </div>

  <button class="btn btn-accent" onclick="launchSession()" id="ssLaunchBtn" style="font-size:17px;padding:18px">
    üèÑ Iniciar Sesi√≥n
  </button>
</div>

<!-- ==================== SESSION HUB ==================== -->
<div class="view" id="view-session-hub">
  <div style="text-align:center;margin:16px 0 20px">
    <div style="font-size:11px;font-weight:700;color:var(--green);text-transform:uppercase;letter-spacing:.08em">‚óè Sesi√≥n Activa</div>
    <div style="font-size:22px;font-weight:800;margin-top:4px" id="hubSpot">‚Äî</div>
    <div style="font-size:13px;color:var(--text-secondary);margin-top:4px" id="hubConditions">‚Äî</div>
    <div style="font-size:28px;font-weight:800;font-variant-numeric:tabular-nums;color:var(--text-primary);margin-top:8px" id="hubTimer">00:00</div>
  </div>

  <!-- Session athletes -->
  <div class="card" style="margin-bottom:12px">
    <div class="card-header" style="margin-bottom:6px">üë• Atletas en Sesi√≥n</div>
    <div id="hubAthletes" style="display:flex;flex-wrap:wrap;gap:6px"></div>
  </div>

  <!-- Objective -->
  <div id="hubFocusCard" class="card" style="margin-bottom:16px;display:none">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.05em;margin-bottom:4px">üéØ Objetivo</div>
    <div id="hubFocus" style="font-size:14px;color:var(--text-primary)"></div>
  </div>

  <!-- Mode selection -->
  <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:16px">
    <button class="btn" onclick="showView('tactical')" style="padding:16px;font-size:15px;background:linear-gradient(135deg,var(--green),#059669);text-align:left;display:flex;align-items:center;gap:14px">
      <span style="font-size:28px">üèÑ</span>
      <div><div style="font-weight:800">Tactical IQ</div><div style="font-size:11px;font-weight:500;opacity:.85;margin-top:1px">Olas + Biomec√°nica</div></div>
    </button>
    <button class="btn" onclick="hubEnterJudge()" style="padding:16px;font-size:15px;background:linear-gradient(135deg,#6366f1,#4f46e5);text-align:left;display:flex;align-items:center;gap:14px">
      <span style="font-size:28px">‚öñÔ∏è</span>
      <div><div style="font-weight:800">Judge Heat</div><div style="font-size:11px;font-weight:500;opacity:.85;margin-top:1px">Scoring ISA 0-10</div></div>
    </button>
    <button class="btn" onclick="showView('workout')" style="padding:16px;font-size:15px;background:linear-gradient(135deg,#f59e0b,#d97706);text-align:left;display:flex;align-items:center;gap:14px">
      <span style="font-size:28px">üí™</span>
      <div><div style="font-weight:800">Workout</div><div style="font-size:11px;font-weight:500;opacity:.85;margin-top:1px">Ejercicios y condici√≥n f√≠sica</div></div>
    </button>
    <button class="btn" onclick="showView('lab')" style="padding:16px;font-size:15px;background:linear-gradient(135deg,#ec4899,#be185d);text-align:left;display:flex;align-items:center;gap:14px">
      <span style="font-size:28px">üé•</span>
      <div><div style="font-weight:800">Tech Lab</div><div style="font-size:11px;font-weight:500;opacity:.85;margin-top:1px">Video an√°lisis y correcci√≥n</div></div>
    </button>
  </div>

  <!-- Quick overview button -->
  <button class="btn btn-outline" onclick="showView('overview')" style="margin-bottom:10px">
    üìä Vista General (Quick Overview)
  </button>

  <!-- End session -->
  <button class="btn" onclick="endSessionFromHub()" style="background:var(--bg-card);border:1px solid var(--red);color:var(--red);font-size:14px;padding:14px">
    üèÅ Finalizar Sesi√≥n
  </button>
</div>

<!-- ==================== TACTICAL IQ ==================== -->
<div class="view" id="view-tactical" style="padding:0 0 24px">
  <!-- Sticky header -->
  <div class="tac-header">
    <button class="tac-nav-arrow" onclick="tacPrev()">‚Äπ</button>
    <div style="text-align:center">
      <div class="tac-athlete-name" id="tacName">‚Äî</div>
      <div style="font-size:11px;color:var(--text-secondary);font-weight:600" id="tacLevel"></div>
    </div>
    <button class="tac-nav-arrow" onclick="tacNext()">‚Ä∫</button>
  </div>

  <div style="padding:12px 16px">
    <!-- MODE TOGGLE: Waves vs Biomechanics -->
    <div style="display:flex;gap:4px;margin-bottom:14px;background:var(--bg-input);border-radius:8px;padding:3px" id="tacModeToggle">
      <button class="seg-btn selected" data-v="waves" onclick="tacSwitchMode('waves',this)" style="flex:1;border-radius:6px;padding:8px;font-size:12px;font-weight:700">üåä Olas</button>
      <button class="seg-btn" data-v="biomech" onclick="tacSwitchMode('biomech',this)" style="flex:1;border-radius:6px;padding:8px;font-size:12px;font-weight:700">ü¶¥ Biomec√°nica</button>
    </div>

    <!-- ===== WAVE MODE (existing) ===== -->
    <div id="tacWaveMode">
      <!-- Catch Ratio -->
      <div class="tac-catch mid" id="tacCatch">
        <div id="tacCatchVal">‚Äî%</div>
        <div class="tac-catch-label">Catch Ratio</div>
      </div>

      <!-- Stats -->
      <div class="tac-stat-row">
        <div class="tac-stat"><div class="tac-stat-val" id="tacPaddled" style="color:var(--accent)">0</div><div class="tac-stat-label">Remadas</div></div>
        <div class="tac-stat"><div class="tac-stat-val" id="tacCaught" style="color:var(--green)">0</div><div class="tac-stat-label">Atrapadas</div></div>
      </div>

      <!-- BIG COUNTER BUTTONS -->
      <div class="counter-row">
        <button class="counter-btn c-paddle" onclick="tacCount('paddle')">
          <span class="cnt-icon">üèä</span>
          <span style="font-size:11px">REM√ì</span>
          <span class="cnt-val" id="tacPaddleBtn">+1</span>
        </button>
        <button class="counter-btn c-catch" onclick="tacCount('catch')">
          <span class="cnt-icon">‚úÖ</span>
          <span style="font-size:11px">ATRAP√ì</span>
          <span class="cnt-val" id="tacCatchBtn">+1</span>
        </button>
        <button class="counter-btn c-fall" onclick="tacCount('fall')">
          <span class="cnt-icon">üí•</span>
          <span style="font-size:11px">CA√çDA</span>
          <span class="cnt-val" id="tacFallBtn">+1</span>
        </button>
      </div>

      <!-- Quick Eval (only visible after catching a wave) -->
      <div id="tacEvalSection" style="display:none">
        <div style="font-size:12px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.06em;margin-bottom:10px">Evaluaci√≥n R√°pida ‚Äî √öltima Ola</div>
      
      <!-- Set or Interset -->
      <div class="eval-section">
        <div class="eval-label">Tipo de Ola</div>
        <div class="eval-row" id="evalWaveType">
          <button class="eval-btn" data-v="set" onclick="evalSet('wave_type',this,'b')" style="flex:1">üåä Set</button>
          <button class="eval-btn" data-v="interset" onclick="evalSet('wave_type',this,'m')" style="flex:1">„Ä∞Ô∏è Interset</button>
        </div>
      </div>

      <!-- Wave Quality -->
      <div class="eval-section">
        <div class="eval-label">Calidad de la Ola</div>
        <div class="eval-row" id="evalWaveQuality">
          <button class="eval-btn" data-v="poor" onclick="evalSet('wave_quality',this,'r')">üí© Pobre</button>
          <button class="eval-btn" data-v="regular" onclick="evalSet('wave_quality',this,'y')">üëå Regular</button>
          <button class="eval-btn" data-v="good" onclick="evalSet('wave_quality',this,'g')">üî• Buena</button>
          <button class="eval-btn" data-v="excellent" onclick="evalSet('wave_quality',this,'a')">‚≠ê Excelente</button>
        </div>
      </div>

      <div class="eval-section">
        <div class="eval-label">Wave Selection</div>
        <div class="eval-row" id="evalSelection">
          <button class="eval-btn" data-v="poor" onclick="evalSet('selection',this,'r')">üî¥ Mala</button>
          <button class="eval-btn" data-v="normal" onclick="evalSet('selection',this,'y')">üü° Normal</button>
          <button class="eval-btn" data-v="excellent" onclick="evalSet('selection',this,'g')">üü¢ Excelente</button>
        </div>
      </div>

      <div class="eval-section">
        <div class="eval-label">Positioning</div>
        <div class="eval-row" id="evalPosition">
          <button class="eval-btn" data-v="poor" onclick="evalSet('position',this,'r')">üî¥ Fuera</button>
          <button class="eval-btn" data-v="normal" onclick="evalSet('position',this,'y')">üü° Ok</button>
          <button class="eval-btn" data-v="excellent" onclick="evalSet('position',this,'g')">üü¢ En el pico</button>
        </div>
      </div>

      <div class="eval-section">
        <div class="eval-label">Commitment</div>
        <div class="eval-row" id="evalCommit">
          <button class="eval-btn" data-v="poor" onclick="evalSet('commit',this,'r')">üî¥ Dud√≥</button>
          <button class="eval-btn" data-v="normal" onclick="evalSet('commit',this,'y')">üü° Normal</button>
          <button class="eval-btn" data-v="excellent" onclick="evalSet('commit',this,'g')">üü¢ Full Send</button>
        </div>
      </div>

      <!-- Maneuver Tags -->
      <div class="eval-label">Maniobras</div>
      <div class="tag-row" id="tacTags">
        <button class="tag-btn" data-m="takeoff" onclick="tagToggle(this)">Take Off</button>
        <button class="tag-btn" data-m="bt" onclick="tagToggle(this)">BT</button>
        <button class="tag-btn" data-m="carving" onclick="tagToggle(this)">Carving</button>
        <button class="tag-btn" data-m="cutback" onclick="tagToggle(this)">Cutback</button>
        <button class="tag-btn" data-m="snap" onclick="tagToggle(this)">Snap</button>
        <button class="tag-btn" data-m="floater" onclick="tagToggle(this)">Floater</button>
        <button class="tag-btn" data-m="aerial" onclick="tagToggle(this)">Aerial</button>
        <button class="tag-btn" data-m="tube" onclick="tagToggle(this)">Tube</button>
        <button class="tag-btn" data-m="reentry" onclick="tagToggle(this)">Re-entry</button>
      </div>

      <button class="btn btn-sm" onclick="confirmWave()" style="margin-top:12px;background:#f97316;color:#fff;font-weight:800;font-size:16px;padding:16px;box-shadow:0 0 20px rgba(249,115,22,.5);border:2px solid #fb923c;letter-spacing:.03em">‚úì CONFIRMAR OLA</button>
    </div>

    <!-- Falls counter visible -->
    <div class="tac-stat-row" style="margin-top:12px">
      <div class="tac-stat"><div class="tac-stat-val" id="tacFalls" style="color:var(--red)">0</div><div class="tac-stat-label">Ca√≠das</div></div>
      <div class="tac-stat"><div class="tac-stat-val" id="tacWaves" style="color:var(--text-primary)">0</div><div class="tac-stat-label">Total Olas</div></div>
    </div>
    </div><!-- end tacWaveMode -->

    <!-- ===== BIOMECHANICS MODE ===== -->
    <div id="tacBioMode" style="display:none">
      <div style="font-size:12px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.06em;margin-bottom:12px">ü¶¥ Evaluaci√≥n Biomec√°nica en Agua</div>

      <!-- Wave counter for biomech -->
      <div style="display:flex;gap:8px;margin-bottom:14px">
        <button class="btn btn-accent" onclick="bioNewWave()" style="flex:1;padding:14px;font-size:15px;font-weight:800">üèÑ Nueva Ola para Evaluar</button>
      </div>
      <div style="font-size:13px;font-weight:700;color:var(--accent);text-align:center;margin-bottom:14px" id="bioWaveCount">Ola #0</div>

      <div id="bioEvalForm" style="display:none">
        <!-- Shoulders -->
        <div class="eval-section">
          <div class="eval-label">Hombros Paralelos</div>
          <div class="eval-row" id="bioShoulders">
            <button class="eval-btn" data-v="poor" onclick="evalSet('bio_shoulders',this,'r')">üî¥ Desalineados</button>
            <button class="eval-btn" data-v="ok" onclick="evalSet('bio_shoulders',this,'y')">üü° Parcial</button>
            <button class="eval-btn" data-v="good" onclick="evalSet('bio_shoulders',this,'g')">üü¢ Paralelos</button>
          </div>
        </div>

        <!-- Knees -->
        <div class="eval-section">
          <div class="eval-label">Rodillas (direcci√≥n)</div>
          <div class="eval-row" id="bioKnees">
            <button class="eval-btn" data-v="poor" onclick="evalSet('bio_knees',this,'r')">üî¥ Cerradas/Abiertas</button>
            <button class="eval-btn" data-v="ok" onclick="evalSet('bio_knees',this,'y')">üü° Parcial</button>
            <button class="eval-btn" data-v="good" onclick="evalSet('bio_knees',this,'g')">üü¢ Hacia adelante</button>
          </div>
        </div>

        <!-- Arms -->
        <div class="eval-section">
          <div class="eval-label">Brazos (direcci√≥n y gu√≠a)</div>
          <div class="eval-row" id="bioArms">
            <button class="eval-btn" data-v="poor" onclick="evalSet('bio_arms',this,'r')">üî¥ Sin gu√≠a</button>
            <button class="eval-btn" data-v="ok" onclick="evalSet('bio_arms',this,'y')">üü° Parcial</button>
            <button class="eval-btn" data-v="good" onclick="evalSet('bio_arms',this,'g')">üü¢ Gu√≠an bien</button>
          </div>
        </div>

        <!-- Compression / Bottom Turn -->
        <div class="eval-section">
          <div class="eval-label">Compresi√≥n en Bottom Turn</div>
          <div class="eval-row" id="bioCompression">
            <button class="eval-btn" data-v="none" onclick="evalSet('bio_compression',this,'r')">üî¥ Sin compresi√≥n</button>
            <button class="eval-btn" data-v="partial" onclick="evalSet('bio_compression',this,'y')">üü° Parcial</button>
            <button class="eval-btn" data-v="full" onclick="evalSet('bio_compression',this,'g')">üü¢ Full compress</button>
          </div>
        </div>

        <!-- Head Position -->
        <div class="eval-section">
          <div class="eval-label">Cabeza / Mirada</div>
          <div class="eval-row" id="bioHead">
            <button class="eval-btn" data-v="poor" onclick="evalSet('bio_head',this,'r')">üî¥ Mirando abajo</button>
            <button class="eval-btn" data-v="ok" onclick="evalSet('bio_head',this,'y')">üü° Inconsistente</button>
            <button class="eval-btn" data-v="good" onclick="evalSet('bio_head',this,'g')">üü¢ Mira al destino</button>
          </div>
        </div>

        <!-- Back Foot -->
        <div class="eval-section">
          <div class="eval-label">Pie Trasero (posici√≥n en tail)</div>
          <div class="eval-row" id="bioBackFoot">
            <button class="eval-btn" data-v="poor" onclick="evalSet('bio_backfoot',this,'r')">üî¥ Centrado</button>
            <button class="eval-btn" data-v="ok" onclick="evalSet('bio_backfoot',this,'y')">üü° Cerca</button>
            <button class="eval-btn" data-v="good" onclick="evalSet('bio_backfoot',this,'g')">üü¢ Sobre el tail</button>
          </div>
        </div>

        <!-- Weight Transfer -->
        <div class="eval-section">
          <div class="eval-label">‚öñÔ∏è Transferencia de Peso</div>
          <div class="eval-row" id="bioWeight">
            <button class="eval-btn" data-v="poor" onclick="evalSet('bio_weight',this,'r')">üî¥ Est√°tico</button>
            <button class="eval-btn" data-v="ok" onclick="evalSet('bio_weight',this,'y')">üü° Parcial</button>
            <button class="eval-btn" data-v="good" onclick="evalSet('bio_weight',this,'g')">üü¢ Fluida</button>
          </div>
        </div>

        <!-- Overall Flow -->
        <div class="eval-section">
          <div class="eval-label">Fluidez General</div>
          <div class="eval-row" id="bioFlow">
            <button class="eval-btn" data-v="1" onclick="evalSet('bio_flow',this,'r')">1</button>
            <button class="eval-btn" data-v="2" onclick="evalSet('bio_flow',this,'r')">2</button>
            <button class="eval-btn" data-v="3" onclick="evalSet('bio_flow',this,'y')">3</button>
            <button class="eval-btn" data-v="4" onclick="evalSet('bio_flow',this,'y')">4</button>
            <button class="eval-btn" data-v="5" onclick="evalSet('bio_flow',this,'g')">5</button>
          </div>
        </div>

        <!-- Notes -->
        <div class="eval-section">
          <div class="eval-label">üìù Notas de Correcci√≥n</div>
          <textarea class="field-input" id="bioNotes" rows="3" placeholder="Ej: Hombro delantero cae en el cutback, necesita rotar m√°s las caderas..."></textarea>
        </div>

        <button class="btn btn-sm" onclick="bioConfirmWave()" style="margin-top:10px;background:#f97316;color:#fff;font-weight:800;font-size:16px;padding:16px;box-shadow:0 0 20px rgba(249,115,22,.5);border:2px solid #fb923c;letter-spacing:.03em;width:100%">‚úì CONFIRMAR EVALUACI√ìN</button>
      </div>

      <!-- Biomech History for current session -->
      <div id="bioHistory" style="margin-top:16px"></div>
    </div><!-- end tacBioMode -->

    <div style="margin-top:20px;display:flex;gap:8px">
      <button class="btn btn-outline btn-sm" onclick="showView('overview')" style="flex:1">üë• Ver Todos</button>
      <button class="btn btn-sm" style="flex:1;background:var(--red);color:#fff" onclick="endSession()">‚ñ† Cerrar Sesi√≥n</button>
    </div>
  </div>
</div>

<!-- ==================== OVERVIEW ==================== -->
<div class="view" id="view-overview" style="padding-top:8px">
  <div class="flex-between mb-4" style="padding:0 4px">
    <div style="font-size:17px;font-weight:800">Sesi√≥n en Vivo</div>
    <button class="text-sm" style="color:var(--accent);font-weight:700" onclick="showView('tactical')">‚Üê Tracking</button>
  </div>
  <div id="ovInfo" style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;font-weight:600"></div>
  <div class="card" style="padding:0;overflow:hidden" id="ovList"></div>
  <div style="margin-top:16px;text-align:center">
    <div style="font-size:13px;color:var(--text-secondary);font-weight:600">Catch Ratio Promedio</div>
    <div id="ovAvg" style="font-size:32px;font-weight:800;color:var(--accent)">‚Äî%</div>
  </div>
  <button class="btn btn-sm" style="margin-top:16px;background:var(--red);color:#fff" onclick="endSession()">‚ñ† Cerrar Sesi√≥n</button>
</div>

<!-- ==================== WORKOUT MODULE ==================== -->
<div class="view" id="view-workout">
  <div class="flex-between mb-4" style="padding:0 4px">
    <button class="text-sm text-muted" onclick="showView('session-hub')">‚Üê Hub</button>
    <div style="font-size:17px;font-weight:800">üí™ Workout</div>
    <div style="width:60px"></div>
  </div>

  <!-- Assign drill to all or individual -->
  <div style="display:flex;gap:8px;margin-bottom:14px">
    <button class="btn btn-accent btn-sm" onclick="woAssignAll()" style="flex:1">üìã Asignar a Todos</button>
    <button class="btn btn-outline btn-sm" onclick="woAssignOne()" style="flex:1">üë§ Asignar Individual</button>
  </div>

  <!-- Athletes workout table -->
  <div id="woAthleteList"></div>

  <!-- Summary -->
  <div class="card" id="woSummary" style="display:none;margin-top:14px">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px">üìä Resumen Workout</div>
    <div id="woSummaryContent"></div>
  </div>
</div>

<!-- Workout Assign Modal -->
<div class="modal-overlay" id="modalWoAssign" onclick="if(event.target===this)this.classList.remove('active')">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
      <div style="font-size:18px;font-weight:800" id="woAssignTitle">Asignar Ejercicio</div>
      <button onclick="document.getElementById('modalWoAssign').classList.remove('active')" style="font-size:20px;padding:4px 8px;color:var(--text-muted)">‚úï</button>
    </div>
    <div id="woAssignTarget" style="font-size:12px;color:var(--text-secondary);margin-bottom:12px"></div>
    
    <!-- Pick from library or custom -->
    <div style="display:flex;gap:4px;margin-bottom:12px;background:var(--bg-input);border-radius:8px;padding:3px">
      <button class="seg-btn selected" onclick="woAssignTab('library',this)" style="flex:1;border-radius:6px;padding:8px;font-size:13px">üìö Biblioteca</button>
      <button class="seg-btn" onclick="woAssignTab('custom',this)" style="flex:1;border-radius:6px;padding:8px;font-size:13px">‚úèÔ∏è Personalizado</button>
    </div>
    
    <div id="woLibraryTab">
      <div class="drill-cat-filter" id="woCatFilter"></div>
      <div id="woLibraryList" style="max-height:50vh;overflow-y:auto;-webkit-overflow-scrolling:touch"></div>
    </div>
    
    <div id="woCustomTab" style="display:none">
      <div class="field"><label class="field-label">Nombre</label><input class="field-input" id="woCustomName" placeholder="Ej: Sprint en arena" autocomplete="off"></div>
      <div class="field"><label class="field-label">Descripci√≥n (opcional)</label><input class="field-input" id="woCustomDesc" placeholder="Descripci√≥n breve" autocomplete="off"></div>
      <div class="field"><label class="field-label">Duraci√≥n</label><input class="field-input" id="woCustomDur" placeholder="Ej: 3 series x 10" autocomplete="off"></div>
      <button class="btn btn-accent" onclick="woAssignCustom()" style="padding:14px;font-size:15px">‚úÖ Asignar</button>
    </div>
  </div>
</div>

<!-- ==================== DEBRIEF ==================== -->
<div class="view" id="view-debrief">
  <div style="font-size:20px;font-weight:800;margin-bottom:4px">üìã Session Debrief</div>
  <div id="dbDate" style="font-size:13px;color:var(--text-secondary);margin-bottom:16px"></div>

  <div class="db-condition" id="dbConditions"></div>

  <div class="card" style="padding:12px">
    <div class="flex-between">
      <span style="font-size:13px;font-weight:700;color:var(--text-secondary)">EQUIPO</span>
      <span id="dbTeamRatio" style="font-size:15px;font-weight:800;color:var(--accent)"></span>
    </div>
    <div id="dbTeamStats" style="font-size:12px;color:var(--text-secondary);margin-top:4px"></div>
  </div>

  <div id="dbAthletes"></div>

  <!-- Visual Chart -->
  <div class="db-chart" id="dbChart" style="display:none">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px">üìä Catch Ratio Comparado</div>
    <div id="dbChartBars"></div>
  </div>

  <div class="field" style="margin-top:16px">
    <label class="field-label">üìù Nota General</label>
    <textarea class="field-input" id="dbNotes" rows="3" placeholder="Notas sobre la sesi√≥n..."></textarea>
  </div>

  <div class="field">
    <label class="field-label">‚≠ê Rating de la Sesi√≥n</label>
    <div class="stars" id="dbRating">
      <span class="star" onclick="starSelect('dbRating',1)">‚òÖ</span>
      <span class="star" onclick="starSelect('dbRating',2)">‚òÖ</span>
      <span class="star" onclick="starSelect('dbRating',3)">‚òÖ</span>
      <span class="star" onclick="starSelect('dbRating',4)">‚òÖ</span>
      <span class="star" onclick="starSelect('dbRating',5)">‚òÖ</span>
    </div>
  </div>

  <button class="btn btn-accent" onclick="saveAndExport()" style="margin-bottom:10px">üíæ Guardar y Exportar CSV</button>
  <button class="btn btn-outline" onclick="saveDebrief(); showView('home')">Guardar sin Exportar</button>
  <button class="btn btn-outline" onclick="saveTemplate()" style="margin-top:8px;border-color:var(--accent);color:var(--accent)">üìã Guardar como Template</button>
</div>

<!-- ==================== ATHLETES ==================== -->
<div class="view" id="view-athletes">
  <div class="flex-between mb-4">
    <div style="font-size:20px;font-weight:800">üë• Mis Atletas</div>
    <button style="color:var(--accent);font-weight:700;font-size:14px" onclick="openAddAthleteModal()">+ Nuevo</button>
  </div>
  <div id="athList"></div>
  <div id="athEmpty" class="empty-state">
    <p>No tienes atletas registrados.</p>
    <button class="btn btn-accent btn-sm" onclick="openAddAthleteModal()" style="width:auto;display:inline-block">Agregar Atleta</button>
  </div>
</div>

<!-- ==================== PLAYER CARD (Phase 2) ==================== -->
<div class="view" id="view-player-card">
  <button class="text-sm text-muted" onclick="showView('athletes')" style="margin-bottom:8px">‚Üê Mis Atletas</button>
  
  <div class="pc-header">
    <div class="pc-avi" id="pcAvi">‚Äî</div>
    <div class="pc-name" id="pcName">‚Äî</div>
    <div class="pc-sub" id="pcSub">‚Äî</div>
    <div class="pc-level-tag" id="pcLevel">‚Äî</div>
    <div class="pc-xp-bar"><div class="pc-xp-fill" id="pcXpFill" style="width:0%"></div></div>
    <div class="pc-xp-text" id="pcXpText">0 / 100 XP</div>
  </div>

  <!-- Quick Stats -->
  <div class="pc-stats" id="pcStats"></div>

  <!-- Badges -->
  <div class="card" style="padding:12px">
    <div class="card-header" style="font-size:13px;margin-bottom:8px">üèÜ Badges</div>
    <div class="pc-badges" id="pcBadges"></div>
  </div>

  <!-- Catch Ratio Trend (Sessions) -->
  <div class="pc-chart" id="pcCatchChart" style="display:none">
    <div class="pc-chart-title">üìà Catch Ratio por Sesi√≥n</div>
    <div id="pcCatchBars"></div>
  </div>

  <!-- Wave Score Distribution (Judge) -->
  <div class="pc-chart" id="pcScoreChart" style="display:none">
    <div class="pc-chart-title">‚öñÔ∏è Distribuci√≥n de Scores</div>
    <div id="pcScoreBars"></div>
  </div>

  <!-- Active Drills -->
  <div class="card" id="pcDrillsCard" style="padding:12px;display:none">
    <div class="card-header flex-between" style="font-size:13px;margin-bottom:8px">
      <span>üèãÔ∏è Drills Asignados</span>
      <button class="text-sm" style="color:var(--accent);font-weight:700" onclick="openDrillPicker()">+ Asignar</button>
    </div>
    <div id="pcDrills"></div>
  </div>

  <!-- Heat History -->
  <div class="card" id="pcHeatCard" style="padding:0;overflow:hidden;display:none">
    <div class="card-header" style="font-size:13px;padding:12px 12px 8px">‚öñÔ∏è Heat History</div>
    <div id="pcHeats"></div>
  </div>

  <!-- Judge Training Sessions -->
  <div class="card" id="pcJudgeTrainCard" style="padding:12px;display:none">
    <div class="card-header" style="font-size:13px;margin-bottom:8px">‚öñÔ∏è Judging en Entrenamiento</div>
    <div id="pcJudgeTrainContent"></div>
  </div>

  <!-- Session History -->
  <div class="card" id="pcSessionCard" style="padding:0;overflow:hidden;display:none">
    <div class="card-header" style="font-size:13px;padding:12px 12px 8px">üèÑ Session History</div>
    <div id="pcSessions"></div>
  </div>

  <!-- Biomechanics Summary -->
  <div class="card" id="pcBioCard" style="padding:12px;display:none">
    <div class="card-header" style="font-size:13px;margin-bottom:8px">ü¶¥ Biomec√°nica</div>
    <div id="pcBioContent"></div>
  </div>

  <!-- Biometrics -->
  <div class="card" style="padding:12px">
    <div class="card-header flex-between" style="font-size:13px;margin-bottom:8px">
      <span>üìä Biometrics</span>
      <button class="text-sm" style="color:var(--accent);font-weight:700" onclick="openBioModal()">+ Registro</button>
    </div>
    <div class="bio-grid" id="pcBioGrid"></div>
    <div id="pcBioHistory" style="display:none">
      <div style="font-size:11px;color:var(--text-muted);font-weight:600;margin-bottom:4px">√öltimos 7 d√≠as</div>
      <div id="pcBioRows"></div>
    </div>
  </div>

  <!-- Tech Lab Frames for this athlete -->
  <div class="card" id="pcLabCard" style="padding:12px;display:none">
    <div class="card-header flex-between" style="font-size:13px;margin-bottom:8px">
      <span>üé• Tech Lab Frames</span>
      <button class="text-sm" style="color:var(--accent);font-weight:700" onclick="showView('lab')">Ir al Lab</button>
    </div>
    <div class="lab-frames" id="pcLabFrames"></div>
  </div>

  <!-- Actions -->
  <div style="margin-top:16px;display:flex;gap:8px">
    <button class="btn btn-accent" onclick="openProgression(_pcAthleteId, 'player-card')" style="flex:1">üìà Progresi√≥n</button>
    <button class="btn btn-outline" onclick="editAthlete()" style="flex:1">‚úèÔ∏è Editar</button>
    <button class="btn" onclick="deleteAthleteFromCard()" style="flex:1;background:var(--bg-card);border:1px solid var(--red);color:var(--red)">üóëÔ∏è</button>
  </div>
</div>

<!-- ==================== DRILL BANK (Phase 2) ==================== -->
<div class="view" id="view-drills">
  <div class="flex-between mb-4">
    <button class="text-sm text-muted" onclick="showView(window._drillReturnView||'athletes')">‚Üê Volver</button>
    <div style="font-size:17px;font-weight:800">üèãÔ∏è Drill Bank</div>
    <div style="width:50px"></div>
  </div>
  
  <!-- Category filter -->
  <div class="drill-cat-filter" id="drillCatFilter"></div>
  
  <!-- Drill list -->
  <div id="drillList"></div>
</div>

<!-- ==================== DRILL PICKER MODAL ==================== -->
<div class="modal-overlay" id="modalDrillPicker">
  <div class="modal-sheet" style="max-height:80vh;overflow-y:auto">
    <div class="modal-handle"></div>
    <div class="modal-title">Asignar Drill</div>
    <div class="drill-cat-filter" id="dpCatFilter" style="margin-bottom:8px"></div>
    <div id="dpDrillList"></div>
    <button class="btn btn-outline" onclick="closeModal('modalDrillPicker')" style="margin-top:12px">Cerrar</button>
  </div>
</div>

<!-- ==================== BIOMETRICS MODAL ==================== -->
<div class="modal-overlay" id="modalBio">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">üìä Registro Biom√©trico</div>
    <div class="field">
      <label class="field-label">Peso (kg)</label>
      <input class="field-input" id="bioWeight" type="number" step="0.1" placeholder="70.5">
    </div>
    <div class="field">
      <label class="field-label">Horas de Sue√±o</label>
      <input class="field-input" id="bioSleep" type="number" step="0.5" min="0" max="14" placeholder="8">
    </div>
    <div class="field">
      <label class="field-label">Nivel de Energ√≠a (1-10)</label>
      <div class="seg-row" id="bioEnergy" style="flex-wrap:wrap;gap:4px">
        <button class="seg-btn" data-v="1" onclick="segSelect('bioEnergy',this)" style="min-width:32px;padding:8px 4px">1</button>
        <button class="seg-btn" data-v="2" onclick="segSelect('bioEnergy',this)" style="min-width:32px;padding:8px 4px">2</button>
        <button class="seg-btn" data-v="3" onclick="segSelect('bioEnergy',this)" style="min-width:32px;padding:8px 4px">3</button>
        <button class="seg-btn" data-v="4" onclick="segSelect('bioEnergy',this)" style="min-width:32px;padding:8px 4px">4</button>
        <button class="seg-btn" data-v="5" onclick="segSelect('bioEnergy',this)" style="min-width:32px;padding:8px 4px">5</button>
        <button class="seg-btn" data-v="6" onclick="segSelect('bioEnergy',this)" style="min-width:32px;padding:8px 4px">6</button>
        <button class="seg-btn" data-v="7" onclick="segSelect('bioEnergy',this)" style="min-width:32px;padding:8px 4px">7</button>
        <button class="seg-btn selected" data-v="8" onclick="segSelect('bioEnergy',this)" style="min-width:32px;padding:8px 4px">8</button>
        <button class="seg-btn" data-v="9" onclick="segSelect('bioEnergy',this)" style="min-width:32px;padding:8px 4px">9</button>
        <button class="seg-btn" data-v="10" onclick="segSelect('bioEnergy',this)" style="min-width:32px;padding:8px 4px">10</button>
      </div>
    </div>
    <div class="field">
      <label class="field-label">Dolor / Lesi√≥n</label>
      <div class="seg-row" id="bioPain">
        <button class="seg-btn selected" data-v="none" onclick="segSelect('bioPain',this)">Sin dolor</button>
        <button class="seg-btn" data-v="mild" onclick="segSelect('bioPain',this)">Leve</button>
        <button class="seg-btn" data-v="moderate" onclick="segSelect('bioPain',this)">Moderado</button>
        <button class="seg-btn" data-v="severe" onclick="segSelect('bioPain',this)">Severo</button>
      </div>
    </div>
    <div class="field">
      <label class="field-label">Zona de dolor (opcional)</label>
      <input class="field-input" id="bioPainZone" placeholder="Hombro derecho, espalda baja...">
    </div>
    <div class="field">
      <label class="field-label">Notas</label>
      <input class="field-input" id="bioNotes" placeholder="C√≥mo me siento hoy...">
    </div>
    <button class="btn btn-accent" onclick="saveBio()">Guardar Registro</button>
    <button class="btn btn-outline" onclick="closeModal('modalBio')" style="margin-top:8px">Cancelar</button>
  </div>
</div>

<!-- ==================== TECH LAB (Phase 3) ==================== -->
<div class="view" id="view-lab">
  <div style="font-size:20px;font-weight:800;margin-bottom:16px">üé• Tech Lab</div>

  <!-- Upload / Record -->
  <div class="card" id="labUploadCard">
    <div class="card-header" style="margin-bottom:10px">Cargar Video</div>
    <div style="display:flex;gap:8px">
      <label class="btn btn-accent" style="flex:1;text-align:center;cursor:pointer;padding:14px">
        üì∑ Grabar
        <input type="file" accept="video/*" capture="environment" onchange="labLoadVideo(this)" style="display:none">
      </label>
      <label class="btn btn-outline" style="flex:1;text-align:center;cursor:pointer;padding:14px">
        üìÅ Galer√≠a
        <input type="file" accept="video/*" onchange="labLoadVideo(this)" style="display:none">
      </label>
    </div>
    <!-- Athlete selector -->
    <div class="field" style="margin-top:10px;margin-bottom:0">
      <label class="field-label">Vincular a Atleta</label>
      <select class="field-input" id="labAthlete"><option value="">‚Äî Sin vincular ‚Äî</option></select>
    </div>
  </div>

  <!-- Video Player + Canvas -->
  <div id="labPlayerSection" style="display:none">
    <div id="labFsContainer">
      <button class="lab-fs-close" id="labFsClose" onclick="labExitFullscreen()" style="display:none">‚úï</button>
      <div class="lab-video-wrap">
        <video class="lab-video" id="labVideo" playsinline></video>
        <canvas class="lab-canvas" id="labCanvas"></canvas>
        <button class="lab-fs-expand" onclick="labEnterFullscreen()" id="labFsExpand" title="Pantalla completa">‚õ∂</button>
      </div>

      <!-- Playback controls -->
      <div class="lab-controls">
        <button class="lab-ctrl-btn" onclick="labStep(-1)" title="Frame atr√°s">‚è™</button>
        <button class="lab-ctrl-btn" id="labPlayBtn" onclick="labTogglePlay()">‚ñ∂Ô∏è</button>
        <button class="lab-ctrl-btn" onclick="labStep(1)" title="Frame adelante">‚è©</button>
        <input type="range" class="lab-timeline" id="labTimeline" min="0" max="100" value="0" step="0.1" oninput="labSeek(this.value)">
        <div class="lab-time" id="labTime">0:00</div>
      </div>

      <!-- Speed control -->
      <div class="lab-speed-row" style="display:flex;gap:4px;margin-bottom:12px;justify-content:center">
        <button class="lab-ctrl-btn" onclick="labSpeed(0.25)" style="font-size:11px;width:auto;padding:0 8px">0.25x</button>
        <button class="lab-ctrl-btn" onclick="labSpeed(0.5)" style="font-size:11px;width:auto;padding:0 8px">0.5x</button>
        <button class="lab-ctrl-btn active" onclick="labSpeed(1)" style="font-size:11px;width:auto;padding:0 8px" id="labSpeedNormal">1x</button>
        <button class="lab-ctrl-btn" onclick="labSpeed(2)" style="font-size:11px;width:auto;padding:0 8px">2x</button>
      </div>

      <!-- Drawing tools -->
      <div class="lab-tools" id="labTools">
        <button class="lab-tool" onclick="labSetTool('none',this)">üëÜ Mover</button>
        <button class="lab-tool" onclick="labSetTool('pen',this)">‚úèÔ∏è Dibujar</button>
        <button class="lab-tool" onclick="labSetTool('arrow',this)">‚û°Ô∏è Flecha</button>
        <button class="lab-tool" onclick="labSetTool('angle',this)">üìê √Ångulo</button>
        <button class="lab-tool" onclick="labClearDraw()">üóëÔ∏è Borrar</button>
        <button class="lab-tool" onclick="labCapture()" style="background:var(--green);border-color:var(--green);color:#fff">üì∏ Capturar</button>
      </div>

      <!-- Color picker -->
      <div class="lab-color-row" style="display:flex;gap:8px;margin-bottom:16px;align-items:center">
        <span style="font-size:11px;color:var(--text-muted)">Color:</span>
        <div class="lab-color-dot active" style="background:#ef4444" onclick="labSetColor('#ef4444',this)"></div>
        <div class="lab-color-dot" style="background:#f59e0b" onclick="labSetColor('#f59e0b',this)"></div>
        <div class="lab-color-dot" style="background:#22c55e" onclick="labSetColor('#22c55e',this)"></div>
        <div class="lab-color-dot" style="background:#3b82f6" onclick="labSetColor('#3b82f6',this)"></div>
        <div class="lab-color-dot" style="background:#ffffff" onclick="labSetColor('#ffffff',this)"></div>
        <span style="font-size:11px;color:var(--text-muted);margin-left:auto">Grosor:</span>
        <button class="lab-ctrl-btn" onclick="labStrokeWidth=2;this.style.borderColor='var(--accent)'" style="font-size:9px;width:28px;height:28px">S</button>
        <button class="lab-ctrl-btn" onclick="labStrokeWidth=4;this.style.borderColor='var(--accent)'" style="font-size:11px;width:28px;height:28px;border-color:var(--accent)">M</button>
        <button class="lab-ctrl-btn" onclick="labStrokeWidth=7;this.style.borderColor='var(--accent)'" style="font-size:14px;width:28px;height:28px">L</button>
      </div>
    </div>
  </div>

  <!-- Captured Frames -->
  <div id="labFramesSection" style="display:none">
    <div class="flex-between" style="margin-bottom:8px">
      <div style="font-size:13px;font-weight:700">üì∏ Frames Capturados</div>
      <button class="text-sm" style="color:var(--accent);font-weight:700" onclick="labCompareMode()">Comparar</button>
    </div>
    <div class="lab-frames" id="labFrames"></div>
  </div>

  <!-- Compare View -->
  <div id="labCompareSection" style="display:none">
    <div class="flex-between" style="margin-bottom:8px">
      <div style="font-size:13px;font-weight:700">üîç Comparar</div>
      <button class="text-sm" style="color:var(--text-muted)" onclick="document.getElementById('labCompareSection').style.display='none'">‚úï Cerrar</button>
    </div>
    <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px">Selecciona 2 frames para comparar side-by-side</div>
    <div class="lab-compare" id="labCompare"></div>
    <div class="lab-frames" id="labCompareSelect"></div>
  </div>

  <!-- Saved clips list -->
  <div id="labClipSection">
    <div style="font-size:13px;font-weight:700;margin-bottom:8px">üé¨ Clips Guardados</div>
    <div id="labClips"></div>
    <div id="labClipsEmpty" style="font-size:12px;color:var(--text-muted);text-align:center;padding:16px">No hay clips guardados a√∫n</div>
  </div>
</div>

<!-- ==================== SESSION HISTORY ==================== -->
<div class="view" id="view-history">
  <div style="font-size:20px;font-weight:800;margin-bottom:4px">üìö Historial de Sesiones</div>
  <div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px" id="histCount"></div>
  
  <!-- Filters -->
  <div style="display:flex;gap:6px;margin-bottom:12px">
    <select class="field-input" id="histSpotFilter" onchange="renderHistory()" style="flex:1;font-size:13px;padding:8px">
      <option value="">Todos los spots</option>
    </select>
    <select class="field-input" id="histAthleteFilter" onchange="renderHistory()" style="flex:1;font-size:13px;padding:8px">
      <option value="">Todos los atletas</option>
    </select>
  </div>
  
  <div id="histList"></div>
  <div id="histEmpty" style="text-align:center;color:var(--text-muted);padding:40px 0;display:none">
    <div style="font-size:36px;margin-bottom:8px">üìã</div>
    <div>Sin sesiones guardadas a√∫n</div>
  </div>
</div>

<!-- ==================== SESSION DETAIL ==================== -->
<div class="view" id="view-session-detail">
  <button class="text-sm text-muted" onclick="showView('history')" style="margin-bottom:8px">‚Üê Historial</button>
  <div style="font-size:18px;font-weight:800;margin-bottom:4px" id="sdTitle"></div>
  <div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px" id="sdMeta"></div>
  
  <div class="db-condition" id="sdConditions"></div>
  
  <!-- Team stats -->
  <div class="card" style="padding:12px;margin-bottom:12px">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.05em;margin-bottom:8px">EQUIPO</div>
    <div id="sdTeamStats"></div>
  </div>
  
  <!-- Athlete cards -->
  <div id="sdAthletes"></div>
  
  <!-- Charts -->
  <div id="sdCharts"></div>
  
  <!-- Notes -->
  <div class="card" id="sdNotesCard" style="padding:12px;display:none">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:6px">üìù Notas del Coach</div>
    <div id="sdNotes" style="font-size:13px;line-height:1.5"></div>
  </div>
  
  <button class="btn btn-outline btn-sm" onclick="exportSessionCSVById(window._sdSessionIdx)" style="margin-top:12px">üì• Exportar CSV</button>
</div>

<!-- ==================== PROGRESSION ==================== -->
<div class="view" id="view-progress">
  <button class="text-sm text-muted" onclick="showView(_progressReturn || 'athletes')" style="margin-bottom:8px">‚Üê Atr√°s</button>
  <div style="font-size:20px;font-weight:800;margin-bottom:4px" id="progTitle"></div>
  <div style="font-size:12px;color:var(--text-secondary);margin-bottom:16px" id="progSubtitle"></div>
  
  <!-- Stat summaries -->
  <div class="dash-row" id="progKPIs" style="margin-bottom:16px"></div>
  
  <!-- Catch ratio trend -->
  <div class="card" style="padding:12px;margin-bottom:12px">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:8px">üìà Catch Ratio</div>
    <div id="progCatchChart" style="height:120px;position:relative"></div>
  </div>
  
  <!-- Bio trend -->
  <div class="card" id="progBioCard" style="padding:12px;margin-bottom:12px;display:none">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:8px">ü¶¥ Biomec√°nica Promedio</div>
    <div id="progBioBars"></div>
  </div>
  
  <!-- Maneuver frequency -->
  <div class="card" style="padding:12px;margin-bottom:12px">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:8px">üèÑ Maniobras Frecuentes</div>
    <div id="progManeuvers"></div>
  </div>
  
  <!-- XP timeline -->
  <div class="card" style="padding:12px;margin-bottom:12px">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:8px">‚ú® XP Acumulado</div>
    <div id="progXPChart" style="height:100px;position:relative"></div>
  </div>
  
  <!-- Session list for this athlete -->
  <div class="card" style="padding:12px">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:8px">üóìÔ∏è Sesiones</div>
    <div id="progSessions"></div>
  </div>
</div>

<!-- ==================== SETTINGS ==================== -->
<div class="view" id="view-settings">
  <div style="font-size:20px;font-weight:800;margin-bottom:20px">‚öôÔ∏è Configuraci√≥n</div>

  <div class="card">
    <div class="card-header">üìç Spots</div>
    <div id="setSpotList"></div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <input class="field-input" id="setNewSpot" placeholder="Nuevo spot..." style="flex:1">
      <button class="btn btn-accent btn-sm" onclick="addSpot()" style="width:auto;padding:10px 20px">+</button>
    </div>
  </div>

  <div class="card">
    <div class="card-header">üìã Session Templates</div>
    <div id="setTplList"></div>
    <div id="setTplEmpty" style="font-size:12px;color:var(--text-muted);padding:4px 0">Sin templates guardados. Crea uno desde el debrief de una sesi√≥n.</div>
  </div>

  <div class="card">
    <div class="card-header">üèãÔ∏è Drill Bank</div>
    <button class="btn btn-outline btn-sm" onclick="window._drillReturnView='settings';showView('drills')" style="margin-bottom:8px">Explorar Ejercicios</button>
    <div id="setCustomDrills"></div>
    <div style="display:flex;gap:6px;margin-top:8px">
      <input class="field-input" id="setNewDrillName" placeholder="Nombre del ejercicio" style="flex:1">
      <button class="btn btn-accent btn-sm" onclick="addCustomDrill()" style="width:auto;padding:8px 12px">+ Agregar</button>
    </div>
  </div>

  <div class="card">
    <div class="card-header">üìä Datos</div>
    <button class="btn btn-outline btn-sm" onclick="exportAllData()" style="margin-bottom:8px">üì• Exportar Todos los Datos (CSV)</button>
    <button class="btn btn-sm" style="background:var(--red);color:#fff" onclick="confirmClearData()">üóëÔ∏è Borrar Todos los Datos</button>
  </div>

  <div style="text-align:center;margin-top:24px;color:var(--text-muted);font-size:12px">
    KSS Coach v5.0 ¬∑ Phase 5<br>Karibe Surf Score
  </div>
</div>

<!-- ==================== ADD ATHLETE MODAL ==================== -->
<div class="modal-overlay" id="modalAddAthlete">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">Nuevo Atleta</div>
    <div class="field">
      <label class="field-label">Nombre</label>
      <input class="field-input" id="maName" placeholder="Nombre completo">
    </div>
    <div class="field">
      <label class="field-label">Stance</label>
      <div class="seg-row" id="maStance">
        <button class="seg-btn selected" data-v="regular" onclick="segSelect('maStance',this)">Regular</button>
        <button class="seg-btn" data-v="goofy" onclick="segSelect('maStance',this)">Goofy</button>
      </div>
    </div>
    <div class="field">
      <label class="field-label">Edad</label>
      <input class="field-input" id="maAge" type="number" placeholder="15" min="5" max="60">
    </div>
    <button class="btn btn-accent" onclick="saveNewAthlete()">Guardar Atleta</button>
    <button class="btn btn-outline" onclick="closeModal('modalAddAthlete')" style="margin-top:8px">Cancelar</button>
  </div>
</div>

<!-- UNDO TOAST -->
<div class="undo-toast" id="undoToast">
  <span id="undoText"></span>
  <button onclick="undoLastAction()">UNDO</button>
</div>

<!-- ==================== JUDGE MODE ==================== -->
<div class="view" id="view-judge" style="padding:8px 8px 24px">
  <!-- Collapsed metadata -->
  <div class="jm-meta-collapsed" id="jmMetaCollapsed"></div>
  
  <!-- Setup form -->
  <div class="jm-setup-form" id="jmSetupForm">
    <div style="font-size:17px;font-weight:800;margin-bottom:12px">‚öñÔ∏è Judge Mode</div>
    <div class="card">
      <div class="card-header">Heat Info</div>
      <div class="jm-meta-grid">
        <div class="field" style="margin-bottom:8px"><label class="field-label">Heat #</label><input class="field-input" id="jmHeatNum" placeholder="1"></div>
        <div class="field" style="margin-bottom:8px"><label class="field-label">Category</label><input class="field-input" id="jmCategory" placeholder="Open Men"></div>
        <div class="field" style="margin-bottom:8px"><label class="field-label">Round</label><input class="field-input" id="jmRound" placeholder="Quarter Final"></div>
        <div class="field" style="margin-bottom:8px"><label class="field-label">Location</label><input class="field-input" id="jmLocation" placeholder="Parguito"></div>
      </div>
      <div class="field" style="margin-bottom:0"><label class="field-label">Duration (min)</label><input class="field-input" id="jmDuration" type="number" value="20" min="5" max="60" style="width:100px"></div>
    </div>
    <div class="card">
      <div class="card-header">üë• Surfers</div>
      <div class="jm-surfer-grid" id="jmSurferSetup"></div>
    </div>
  </div>

  <!-- Timer bar -->
  <div class="jm-timer-bar" id="jmTimerBar" style="display:none">
    <div class="jm-timer" id="jmTimerDisplay">20:00</div>
    <div class="jm-timer-btns">
      <button class="jm-timer-btn" onclick="jmNotes()" title="Notes">üìù</button>
      <button class="jm-timer-btn" id="jmCloseBtn" onclick="jmCloseHeat()">üèÅ Close</button>
      <button class="jm-timer-btn" id="jmReopenBtn" onclick="jmReopenHeat()" style="display:none">üîì Reopen</button>
    </div>
  </div>

  <!-- Start / Reset buttons -->
  <div style="display:flex;gap:8px;margin-bottom:8px">
    <button class="btn btn-accent" id="jmStartBtn" onclick="jmStartTimer()" style="flex:1;padding:14px">‚ñ∂Ô∏è Start Heat</button>
    <button class="btn btn-outline" onclick="jmResetHeat()" style="width:auto;padding:14px 20px">üîÑ</button>
  </div>
  <div id="jmCloseRow" style="display:none;margin-bottom:12px">
    <button class="btn" id="jmCloseBtn2" onclick="jmCloseHeat()" style="width:100%;padding:14px;background:var(--red);font-size:15px;font-weight:800">üèÅ Cerrar Heat</button>
  </div>

  <!-- Score Grid -->
  <div class="card" style="padding:10px;overflow:hidden">
    <div class="jm-grid-wrap">
      <table class="jm-grid" id="jmGrid"></table>
    </div>
  </div>

  <!-- Priority -->
  <div class="card" style="padding:12px">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;text-align:center">üéØ Priority (tap surfer to send right ‚Üí)</div>
    <div class="jm-priority" id="jmPriority"></div>
  </div>

  <!-- Live Rankings -->
  <div class="card" style="padding:12px">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;text-align:center">üìä Live Rankings</div>
    <div class="jm-rankings" id="jmRankings"></div>
  </div>

  <!-- Results (after close) -->
  <div class="jm-results" id="jmResults" style="display:none">
    <div class="card">
      <div class="card-header">üèÜ Final Results</div>
      <div id="jmResultsContent"></div>
      <div style="display:flex;gap:8px;margin-top:12px">
        <button class="btn btn-sm btn-outline" onclick="jmExportCSV()" style="flex:1">üìä CSV</button>
      </div>
    </div>
  </div>

  <!-- Session Tracker -->
  <div id="jmTracker" style="display:none;margin-top:12px">
    <div class="card">
      <div class="card-header">üìà Session Tracker</div>
      <div style="overflow-x:auto" id="jmTrackerContent"></div>
    </div>
  </div>
</div>

<!-- Judge Notes Modal -->
<div class="jm-notes-modal" id="jmNotesModal" onclick="if(event.target===this)this.classList.remove('active')">
  <div class="jm-notes-box">
    <div class="flex-between mb-4"><span style="font-weight:800">üìù Heat Notes</span><button onclick="document.getElementById('jmNotesModal').classList.remove('active')" style="font-size:18px">‚úï</button></div>
    <textarea class="field-input" id="jmNotesText" rows="6" placeholder="Notes..."></textarea>
  </div>
</div>

<!-- ==================== BOTTOM NAV ==================== -->
<nav class="bottom-nav">
  <button class="nav-btn active" data-view="home" onclick="showView('home')">
    <svg viewBox="0 0 24 24"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0a1 1 0 01-1-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 01-1 1"/></svg>
    Home
  </button>
  <button class="nav-btn" data-view="athletes" onclick="showView('athletes')">
    <svg viewBox="0 0 24 24"><path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
    Atletas
  </button>
  <button class="nav-btn" data-view="judge" onclick="showView('judge')">
    <svg viewBox="0 0 24 24"><path d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"/></svg>
    Judge
  </button>
  <button class="nav-btn" data-view="lab" onclick="showView('lab')">
    <svg viewBox="0 0 24 24"><path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
    Lab
  </button>
  <button class="nav-btn" data-view="settings" onclick="showView('settings')">
    <svg viewBox="0 0 24 24"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><circle cx="12" cy="12" r="3"/></svg>
    Config
  </button>
</nav>

<script>
// ============================================================
// STORAGE LAYER
// ============================================================
const DB = {
  _get(k, def) { try { return JSON.parse(localStorage.getItem('kss_' + k)) || def; } catch { return def; } },
  _set(k, v) { localStorage.setItem('kss_' + k, JSON.stringify(v)); },
  _cache: { activeSession: undefined },
  
  get athletes() { return this._get('athletes', []); },
  set athletes(v) { this._set('athletes', v); },
  
  get spots() { return this._get('spots', ['Parguito', 'El Tirano', 'Los Caracas', 'Playa El Agua']); },
  set spots(v) { this._set('spots', v); },
  
  get sessions() { return this._get('sessions', []); },
  set sessions(v) { this._set('sessions', v); },
  
  get activeSession() {
    if (this._cache.activeSession === undefined) {
      this._cache.activeSession = this._get('active_session', null);
    }
    return this._cache.activeSession;
  },
  set activeSession(v) {
    this._cache.activeSession = v;
    this._set('active_session', v);
  },
  
  // Flush in-memory activeSession to localStorage (call after mutations)
  saveActive() {
    if (this._cache.activeSession !== undefined) {
      this._set('active_session', this._cache.activeSession);
    }
  },
  
  get coach() { return this._get('coach', { name: 'Coach' }); },
  set coach(v) { this._set('coach', v); },
  
  get judgeHeat() { return this._get('judge_heat', null); },
  set judgeHeat(v) { this._set('judge_heat', v); },
  
  get judgeTracker() { return this._get('judge_tracker', {}); },
  set judgeTracker(v) { this._set('judge_tracker', v); },

  get labFrames() { return this._get('lab_frames', []); },
  set labFrames(v) { this._set('lab_frames', v); },

  get templates() { return this._get('templates', []); },
  set templates(v) { this._set('templates', v); },

  get customDrills() { return this._get('custom_drills', []); },
  set customDrills(v) { this._set('custom_drills', v); },

  genId() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 7); }
};

// ============================================================
// VIEW ROUTER
// ============================================================
let currentView = 'home';
let sessionTimer = null;
let sessionStartTime = null;

function showView(id) {
  // Session bar visible across all views during active session
  const s = DB.activeSession;
  
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  const el = document.getElementById('view-' + id);
  if (el) el.classList.add('active');
  
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  const nav = document.querySelector(`.nav-btn[data-view="${id}"]`);
  if (nav) nav.classList.add('active');
  
  currentView = id;
  
  // Close any open modals
  document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
  
  // Clean up hub timer when leaving hub
  if (id !== 'session-hub' && typeof hubTimerInterval !== 'undefined' && hubTimerInterval) {
    clearInterval(hubTimerInterval);
    hubTimerInterval = null;
  }
  
  // Lifecycle hooks
  if (id === 'home') renderHome();
  if (id === 'athletes') renderAthletes();
  if (id === 'player-card') renderPlayerCard();
  if (id === 'drills') renderDrillBank();
  if (id === 'lab') renderLab();
  if (id === 'settings') renderSettings();
  if (id === 'session-setup') renderSessionSetup();
  if (id === 'session-hub') renderSessionHub();
  if (id === 'tactical') renderTactical();
  if (id === 'overview') renderOverview();
  if (id === 'debrief') renderDebrief();
  if (id === 'judge') renderJudge();
  if (id === 'workout') renderWorkout();
  if (id === 'history') renderHistory();
  if (id === 'session-detail') renderSessionDetail();
  if (id === 'progress') renderProgress();
  
  // Session bar
  updateSessionBar();
}

function updateSessionBar() {
  const bar = document.getElementById('sessionBar');
  const s = DB.activeSession;
  if (s) {
    const sizeNames = { 1: 'Flat', 2: '1-2ft', 3: '2-4ft', 4: '4-6ft', 5: '+6ft' };
    bar.querySelector('#sbInfo').textContent = `${s.spot} ¬∑ ${sizeNames[s.wave_size] || ''} ¬∑ ${s.wind_condition}`;
    bar.classList.add('active');
    if (!sessionTimer) startSessionTimer();
  } else {
    bar.classList.remove('active');
  }
  
  // Dynamic nav: swap Home/Athletes for Hub/Track during session
  updateNavBar(!!s);
}

function updateNavBar(hasSession) {
  const nav = document.querySelector('.bottom-nav');
  if (!nav) return;
  const btns = nav.querySelectorAll('.nav-btn');
  
  if (hasSession) {
    // Slot 0: Hub (was Home)
    btns[0].setAttribute('data-view', 'session-hub');
    btns[0].onclick = () => showView('session-hub');
    btns[0].querySelector('svg').innerHTML = '<path d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>';
    btns[0].lastChild.textContent = 'Hub';
    
    // Slot 1: Track (was Athletes)
    btns[1].setAttribute('data-view', 'tactical');
    btns[1].onclick = () => showView('tactical');
    btns[1].querySelector('svg').innerHTML = '<path d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>';
    btns[1].lastChild.textContent = 'Track';
  } else {
    // Restore defaults
    btns[0].setAttribute('data-view', 'home');
    btns[0].onclick = () => showView('home');
    btns[0].querySelector('svg').innerHTML = '<path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0a1 1 0 01-1-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 01-1 1"/>';
    btns[0].lastChild.textContent = 'Home';
    
    btns[1].setAttribute('data-view', 'athletes');
    btns[1].onclick = () => showView('athletes');
    btns[1].querySelector('svg').innerHTML = '<path d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>';
    btns[1].lastChild.textContent = 'Atletas';
  }
  
  // Highlight active
  nav.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  const active = nav.querySelector(`.nav-btn[data-view="${currentView}"]`);
  if (active) active.classList.add('active');
}

function startSessionTimer() {
  const s = DB.activeSession;
  if (!s) return;
  sessionStartTime = new Date(s.started_at);
  sessionTimer = setInterval(() => {
    const diff = Math.floor((Date.now() - sessionStartTime.getTime()) / 1000);
    const m = String(Math.floor(diff / 60)).padStart(2, '0');
    const sec = String(diff % 60).padStart(2, '0');
    document.getElementById('sbTime').textContent = `${m}:${sec}`;
  }, 1000);
}

function stopSessionTimer() {
  if (sessionTimer) { clearInterval(sessionTimer); sessionTimer = null; }
}

// ============================================================
// HOME
// ============================================================
function renderHome() {
  const sessions = DB.sessions;
  const athletes = DB.athletes;
  const s = DB.activeSession;
  const templates = DB.templates;
  
  // Greeting based on time
  const hour = new Date().getHours();
  const greeting = hour < 12 ? 'Buenos d√≠as' : hour < 18 ? 'Buenas tardes' : 'Buenas noches';
  const coach = DB.coach;
  document.getElementById('homeGreeting').textContent = `${greeting}${coach.name !== 'Coach' ? ', ' + coach.name : ''}`;
  
  // If active session, change button
  const btn = document.getElementById('homeStartBtn');
  if (s) {
    btn.textContent = 'üèÑ Volver a Sesi√≥n';
    btn.onclick = () => showView('session-hub');
  } else {
    btn.textContent = '‚ö° Nueva Sesi√≥n';
    btn.onclick = () => startNewSession();
  }
  
  // KPIs
  const kpiDiv = document.getElementById('homeKPIs');
  if (sessions.length > 0 || athletes.length > 0) {
    kpiDiv.style.display = 'grid';
    const totalWaves = sessions.reduce((sum, s) => sum + Object.values(s.athlete_data || {}).reduce((a, d) => a + (d.caught || 0), 0), 0);
    const totalHeats = athletes.reduce((sum, a) => sum + (a.heat_history || []).length, 0);
    
    kpiDiv.innerHTML = [
      { val: sessions.length, lbl: 'Sesiones', color: 'var(--accent)' },
      { val: totalWaves, lbl: 'Olas', color: 'var(--green)' },
      { val: totalHeats, lbl: 'Heats', color: '#a855f7' },
    ].map(k => `<div class="dash-kpi"><div class="dash-kpi-val" style="color:${k.color}">${k.val}</div><div class="dash-kpi-lbl">${k.lbl}</div></div>`).join('');
  } else { kpiDiv.style.display = 'none'; }
  
  // Athletes strip
  const athSection = document.getElementById('homeAthSection');
  if (athletes.length > 0) {
    athSection.style.display = 'block';
    document.getElementById('homeAthStrip').innerHTML = athletes.map(a => {
      const initials = a.name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
      const lvl = calcLevel(a.xp_total || 0);
      return `<div class="dash-ath-chip" onclick="openPlayerCard('${a.id}')">
        <div class="dash-ath-avi">${initials}</div>
        <div class="dash-ath-name">${a.name.split(' ')[0]}</div>
        <div class="dash-ath-stat">${LEVEL_NAMES[lvl.level]}</div>
      </div>`;
    }).join('');
  } else { athSection.style.display = 'none'; }
  
  // Templates
  const tplSection = document.getElementById('homeTplSection');
  if (templates.length > 0) {
    tplSection.style.display = 'block';
    document.getElementById('homeTplList').innerHTML = templates.slice(0, 3).map(t => {
      const athNames = (t.athlete_ids || []).map(id => {
        const a = athletes.find(x => x.id === id);
        return a ? a.name.split(' ')[0] : '?';
      }).join(', ');
      return `<div class="tpl-card" onclick="loadTemplate('${t.id}')">
        <div class="tpl-card-name">üìã ${t.name}</div>
        <div class="tpl-card-meta">üìç ${t.spot} ¬∑ üåä ${t.wave_size || '?'}ft ¬∑ ${athNames || 'Sin atletas'}</div>
      </div>`;
    }).join('');
  } else { tplSection.style.display = 'none'; }
  
  // Needs Attention
  const attSection = document.getElementById('homeAttentionSection');
  if (athletes.length > 0 && sessions.length >= 2) {
    const alerts = [];
    athletes.forEach(a => {
      // Declining catch ratio
      const athSessions = sessions.filter(s => s.athlete_data && s.athlete_data[a.id]).slice(-3);
      if (athSessions.length >= 2) {
        const ratios = athSessions.map(s => {
          const d = s.athlete_data[a.id];
          return d.paddled > 0 ? d.caught / d.paddled * 100 : 0;
        });
        const trend = ratios[ratios.length - 1] - ratios[0];
        if (trend < -15) {
          alerts.push({ icon: 'üìâ', text: `${a.name.split(' ')[0]}: catch ratio cay√≥ ${Math.abs(Math.round(trend))}% en √∫ltimas sesiones`, color: 'var(--red)' });
        }
      }
      // Pain reported
      const bio = a.biometrics || [];
      if (bio.length > 0) {
        const last = bio[bio.length - 1];
        if (last.pain === 'moderate' || last.pain === 'severe') {
          alerts.push({ icon: 'ü©π', text: `${a.name.split(' ')[0]}: report√≥ dolor ${last.pain === 'severe' ? 'severo' : 'moderado'}${last.painZone ? ' en ' + last.painZone : ''}`, color: 'var(--yellow)' });
        }
      }
      // Low energy
      if ((a.biometrics || []).length > 0) {
        const last = a.biometrics[a.biometrics.length - 1];
        if (last.energy <= 4) {
          alerts.push({ icon: 'üîã', text: `${a.name.split(' ')[0]}: energ√≠a baja (${last.energy}/10)`, color: 'var(--yellow)' });
        }
      }
    });
    
    if (alerts.length > 0) {
      attSection.style.display = 'block';
      document.getElementById('homeAttention').innerHTML = '<div class="card" style="padding:10px 12px">' +
        alerts.slice(0, 4).map(a => `<div style="display:flex;gap:8px;align-items:center;padding:6px 0;font-size:13px;border-bottom:1px solid var(--border)"><span>${a.icon}</span><span style="color:${a.color}">${a.text}</span></div>`).join('') + '</div>';
    } else { attSection.style.display = 'none'; }
  } else { attSection.style.display = 'none'; }
  
  // Activity Feed
  const feedSection = document.getElementById('homeFeedSection');
  if (sessions.length > 0) {
    feedSection.style.display = 'block';
    const feed = [];
    
    // Last 5 sessions (module-aware)
    sessions.slice(-5).reverse().forEach(s => {
      const d = new Date(s.date || s.started_at);
      const dateStr = new Intl.DateTimeFormat('es', { day:'numeric', month:'short' }).format(d);
      const mods = s.modules_used || [];
      const hasTac = !s.modules_used || mods.includes('tactical');
      const athCount = Object.keys(s.athlete_data || {}).length;
      
      let detail;
      if (hasTac) {
        const totalCaught = Object.values(s.athlete_data || {}).reduce((a, d) => a + (d.caught || 0), 0);
        const totalPaddled = Object.values(s.athlete_data || {}).reduce((a, d) => a + (d.paddled || 0), 0);
        const ratio = totalPaddled > 0 ? Math.round(totalCaught / totalPaddled * 100) : 0;
        detail = `${athCount} atletas ¬∑ ${totalCaught} olas ¬∑ ${ratio}% catch`;
      } else {
        const modLabels = mods.map(m => m==='judge'?'‚öñÔ∏è Judge':m==='workout'?'üí™ Workout':m==='biomech'?'ü¶¥ Bio':m).join(', ');
        detail = `${athCount} atletas ¬∑ ${modLabels || 'sesi√≥n'}`;
      }
      feed.push({ icon: 'üèÑ', text: `<strong>${s.spot}</strong> ¬∑ ${detail}`, time: dateStr });
    });
    
    // Last 3 heats from athletes
    const allHeats = [];
    athletes.forEach(a => (a.heat_history || []).forEach(h => allHeats.push({ ...h, athlete: a.name })));
    allHeats.sort((a, b) => new Date(b.date) - new Date(a.date));
    allHeats.slice(0, 3).forEach(h => {
      const dateStr = new Intl.DateTimeFormat('es', { day:'numeric', month:'short' }).format(new Date(h.date));
      const pos = h.position === 1 ? 'ü•á' : h.position === 2 ? 'ü•à' : h.position === 3 ? 'ü•â' : `${h.position}th`;
      feed.push({ icon: '‚öñÔ∏è', text: `<strong>${h.athlete.split(' ')[0]}</strong> ¬∑ Heat ${h.heat_number || '?'} ¬∑ ${pos} ¬∑ ${h.total.toFixed(1)}pts`, time: dateStr });
    });
    
    document.getElementById('homeFeed').innerHTML = feed.slice(0, 6).map(f =>
      `<div class="dash-feed-item"><span class="dash-feed-icon">${f.icon}</span><div><div class="dash-feed-text">${f.text}</div><div class="dash-feed-time">${f.time}</div></div></div>`
    ).join('') || '<div style="font-size:12px;color:var(--text-muted);text-align:center;padding:8px">Sin actividad reciente</div>';
  } else { feedSection.style.display = 'none'; }
  
  // Empty state
  document.getElementById('homeEmpty').style.display = sessions.length === 0 && athletes.length === 0 ? 'block' : 'none';
}

// ============================================================
// SESSION CREATOR
// ============================================================
function startNewSession() {
  if (DB.athletes.length === 0) {
    openAddAthleteModal();
    return;
  }
  showView('session-setup');
}

function renderSessionSetup() {
  // Spots dropdown
  const spotSel = document.getElementById('ssSpot');
  const spots = DB.spots;
  spotSel.innerHTML = spots.map(s => `<option value="${s}">${s}</option>`).join('');
  
  // Pre-select last used spot
  const sessions = DB.sessions;
  if (sessions.length > 0) {
    spotSel.value = sessions[sessions.length - 1].spot;
  }
  
  // Athletes
  renderSSAthletes();
}

function renderSSAthletes() {
  const container = document.getElementById('ssAthletes');
  const athletes = DB.athletes;
  const sessions = DB.sessions;
  
  // Pre-select from last session
  const lastAthletes = sessions.length > 0 ? Object.keys(sessions[sessions.length - 1].athlete_data) : [];
  
  if (!window._ssSelected) {
    window._ssSelected = new Set(lastAthletes.length > 0 ? lastAthletes : athletes.map(a => a.id));
  }
  
  container.innerHTML = athletes.map(a => {
    const sel = window._ssSelected.has(a.id);
    const initials = a.name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
    return `<button class="athlete-chip ${sel ? 'selected' : ''}" onclick="toggleSSAthlete('${a.id}',this)">
      <span class="avi">${initials}</span>${a.name.split(' ')[0]}
    </button>`;
  }).join('');
  
  const cnt = window._ssSelected.size;
  document.getElementById('ssAthCount').textContent = cnt > 0 ? `‚úì ${cnt} atleta${cnt > 1 ? 's' : ''} ¬∑ +${cnt * 10} XP` : 'Selecciona al menos 1 atleta';
}

function toggleSSAthlete(id, el) {
  if (window._ssSelected.has(id)) { window._ssSelected.delete(id); el.classList.remove('selected'); }
  else { window._ssSelected.add(id); el.classList.add('selected'); }
  const cnt = window._ssSelected.size;
  document.getElementById('ssAthCount').textContent = cnt > 0 ? `‚úì ${cnt} atleta${cnt > 1 ? 's' : ''} ¬∑ +${cnt * 10} XP` : 'Selecciona al menos 1 atleta';
}

function cancelSession() {
  window._ssSelected = null;
  showView('home');
}

function launchSession() {
  const spot = document.getElementById('ssSpot').value;
  const size = getSegValue('ssSize');
  const quality = getStarValue('ssQuality');
  const wind = document.getElementById('ssWind').value;
  const crowd = document.querySelector('.sem-btn.selected')?.dataset.v || 'empty';
  const focus = document.getElementById('ssFocus').value;
  const selectedIds = Array.from(window._ssSelected || []);
  
  if (selectedIds.length === 0) { alert('Selecciona al menos un atleta'); return; }
  
  // Build athlete data
  const athleteData = {};
  selectedIds.forEach(id => {
    athleteData[id] = {
      paddled: 0,
      caught: 0,
      falls: 0,
      waves: [] // Array of wave objects
    };
  });
  
  const session = {
    id: DB.genId(),
    spot,
    wave_size: parseInt(size),
    wave_quality: parseInt(quality),
    wind_condition: wind,
    crowd_factor: crowd,
    focus_area: focus,
    started_at: new Date().toISOString(),
    athlete_data: athleteData,
    status: 'active',
    modules_used: [], // auto-detected on close
    judge_data: null   // captured from tracker on close
  };
  
  DB.activeSession = session;
  DB.judgeTracker = {}; // Reset tracker for new session
  window._ssSelected = null;
  window._tacIdx = 0;
  window._pendingWave = null;
  
  showView('session-hub');
}

// ============================================================
// SESSION HUB
// ============================================================
let hubTimerInterval = null;

function renderSessionHub() {
  const s = DB.activeSession;
  if (!s) { showView('home'); return; }
  
  const sizeNames = { 1:'Flat', 2:'1-2ft', 3:'2-4ft', 4:'4-6ft', 5:'+6ft' };
  const qualityStr = '‚òÖ'.repeat(s.wave_quality) + '‚òÜ'.repeat(5 - s.wave_quality);
  const windNames = { glassy:'Glassy', offshore:'Off-shore', onshore:'On-shore', cross:'Cross-shore' };
  const crowdNames = { empty:'üü¢ Vac√≠o', medium:'üü° Medio', crowded:'üî¥ Lleno' };
  
  document.getElementById('hubSpot').textContent = s.spot;
  document.getElementById('hubConditions').textContent = `${sizeNames[s.wave_size]} ¬∑ ${qualityStr} ¬∑ ${windNames[s.wind_condition]} ¬∑ ${crowdNames[s.crowd_factor]}`;
  
  // Focus
  const focusCard = document.getElementById('hubFocusCard');
  if (s.focus_area) {
    focusCard.style.display = 'block';
    document.getElementById('hubFocus').textContent = s.focus_area;
  } else {
    focusCard.style.display = 'none';
  }
  
  // Athletes
  const athletes = DB.athletes;
  const ids = Object.keys(s.athlete_data);
  document.getElementById('hubAthletes').innerHTML = ids.map(id => {
    const ath = athletes.find(a => a.id === id);
    if (!ath) return '';
    const data = s.athlete_data[id];
    const caught = data.caught || 0;
    const paddled = data.paddled || 0;
    const ratio = paddled > 0 ? Math.round(caught / paddled * 100) : 0;
    const hasData = paddled > 0;
    return `<div style="background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:13px;display:flex;align-items:center;gap:8px">
      <span class="avi" style="width:28px;height:28px;font-size:11px">${ath.name.split(' ').map(w=>w[0]).join('').slice(0,2).toUpperCase()}</span>
      <span style="font-weight:700">${ath.name.split(' ')[0]}</span>
      ${hasData ? `<span style="font-size:11px;color:var(--text-secondary);margin-left:auto">${caught}/${paddled} ¬∑ ${ratio}%</span>` : ''}
    </div>`;
  }).join('');
  
  // Hub timer
  if (!hubTimerInterval) {
    const startTime = new Date(s.started_at);
    hubTimerInterval = setInterval(() => {
      const diff = Math.floor((Date.now() - startTime.getTime()) / 1000);
      const m = String(Math.floor(diff / 60)).padStart(2, '0');
      const sec = String(diff % 60).padStart(2, '0');
      const el = document.getElementById('hubTimer');
      if (el) el.textContent = `${m}:${sec}`;
    }, 1000);
  }
}

function hubEnterJudge() {
  const s = DB.activeSession;
  if (!s) return;
  
  const athletes = DB.athletes;
  const ids = Object.keys(s.athlete_data);
  
  // Reset judge heat cache so it picks up fresh data
  window._jmHeatCache = null;
  
  // Pre-populate judge surfers from session athletes (max 5)
  const h = jmGetHeat();
  const surferAthletes = ids.slice(0, 5);
  
  surferAthletes.forEach((id, i) => {
    const ath = athletes.find(a => a.id === id);
    if (ath && h.surfers[i]) {
      h.surfers[i].name = ath.name;
      h.surfers[i].athlete_id = id;
    }
  });
  
  // Pre-fill location from session
  h.metadata.location = s.spot;
  
  jmSave();
  
  // Clear surfer setup init flag so dropdowns refresh with pre-selected values
  const sg = document.getElementById('jmSurferSetup');
  if (sg) delete sg.dataset.init;
  
  showView('judge');
}

function endSessionFromHub() {
  if (!confirm('¬øFinalizar esta sesi√≥n? Podr√°s revisar el debrief.')) return;
  
  // Stop hub timer
  if (hubTimerInterval) { clearInterval(hubTimerInterval); hubTimerInterval = null; }
  
  // Auto-confirm any pending wave
  if (window._pendingWave) confirmWave();
  stopSessionTimer();
  
  showView('debrief');
}

// ============================================================
// TACTICAL IQ
// ============================================================
function renderTactical() {
  const s = DB.activeSession;
  if (!s) { showView('home'); return; }
  
  const ids = Object.keys(s.athlete_data);
  if (window._tacIdx === undefined || window._tacIdx >= ids.length) window._tacIdx = 0;
  
  const currentId = ids[window._tacIdx];
  const athlete = DB.athletes.find(a => a.id === currentId);
  const data = s.athlete_data[currentId];
  
  document.getElementById('tacName').textContent = athlete ? athlete.name : 'Atleta';
  document.getElementById('tacLevel').textContent = athlete ? `Nivel ${athlete.level || 1} ¬∑ ${athlete.stance || 'Regular'}` : '';
  
  // Stats
  document.getElementById('tacPaddled').textContent = data.paddled;
  document.getElementById('tacCaught').textContent = data.caught;
  document.getElementById('tacFalls').textContent = data.falls;
  document.getElementById('tacWaves').textContent = data.waves.length;
  
  // Catch ratio
  const ratio = data.paddled > 0 ? Math.round(data.caught / data.paddled * 100) : 0;
  const catchEl = document.getElementById('tacCatch');
  document.getElementById('tacCatchVal').textContent = data.paddled > 0 ? ratio + '%' : '‚Äî%';
  catchEl.className = 'tac-catch ' + (ratio >= 60 ? 'good' : ratio >= 40 ? 'mid' : data.paddled > 0 ? 'low' : 'mid');
  
  // Reset eval section
  document.getElementById('tacEvalSection').style.display = window._pendingWave ? 'block' : 'none';
  if (!window._pendingWave) resetEvalUI();
  
  updateSessionBar();
}

function tacPrev() {
  const s = DB.activeSession;
  if (!s) return;
  const ids = Object.keys(s.athlete_data);
  window._tacIdx = (window._tacIdx - 1 + ids.length) % ids.length;
  window._pendingWave = null;
  renderTactical();
}

function tacNext() {
  const s = DB.activeSession;
  if (!s) return;
  const ids = Object.keys(s.athlete_data);
  window._tacIdx = (window._tacIdx + 1) % ids.length;
  window._pendingWave = null;
  renderTactical();
}

function tacCount(type) {
  const s = DB.activeSession;
  if (!s) return;
  const ids = Object.keys(s.athlete_data);
  const currentId = ids[window._tacIdx];
  const data = s.athlete_data[currentId];
  
  if (type === 'paddle') {
    data.paddled++;
    showUndoToast('Remada +1', () => { data.paddled = Math.max(0, data.paddled - 1); saveSession(); renderTactical(); });
  } else if (type === 'catch') {
    data.caught++;
    if (data.paddled < data.caught) data.paddled = data.caught; // Auto-correct
    // Show eval section for this wave
    window._pendingWave = { type: 'caught', timestamp: new Date().toISOString(), wave_type: null, wave_quality: null, selection: null, position: null, commit: null, maneuvers: [] };
    document.getElementById('tacEvalSection').style.display = 'block';
    resetEvalUI();
    showUndoToast('Atrapada +1', () => { 
      data.caught = Math.max(0, data.caught - 1); 
      window._pendingWave = null;
      document.getElementById('tacEvalSection').style.display = 'none';
      saveSession(); renderTactical(); 
    });
  } else if (type === 'fall') {
    data.falls++;
    data.paddled++;
    if (data.paddled < data.caught + data.falls) data.paddled = data.caught + data.falls;
    // Record fall wave
    data.waves.push({ type: 'fall', timestamp: new Date().toISOString() });
    showUndoToast('Ca√≠da +1', () => { 
      data.falls = Math.max(0, data.falls - 1); 
      data.paddled = Math.max(0, data.paddled - 1);
      data.waves.pop(); 
      saveSession(); renderTactical(); 
    });
  }
  
  // Haptic
  if (navigator.vibrate) navigator.vibrate(30);
  
  saveSession();
  renderTactical();
}

function evalSet(field, el, color) {
  const parent = el.parentElement;
  parent.querySelectorAll('.eval-btn').forEach(b => b.className = 'eval-btn');
  el.classList.add('sel-' + color);
  if (window._pendingWave) window._pendingWave[field] = el.dataset.v;
  if (window._pendingBio) window._pendingBio[field] = el.dataset.v;
}

function tagToggle(el) {
  el.classList.toggle('selected');
  if (window._pendingWave) {
    const m = el.dataset.m;
    const idx = window._pendingWave.maneuvers.indexOf(m);
    if (idx >= 0) window._pendingWave.maneuvers.splice(idx, 1);
    else window._pendingWave.maneuvers.push(m);
  }
}

function confirmWave() {
  if (!window._pendingWave) return;
  const s = DB.activeSession;
  const ids = Object.keys(s.athlete_data);
  const currentId = ids[window._tacIdx];
  s.athlete_data[currentId].waves.push({ ...window._pendingWave });
  window._pendingWave = null;
  document.getElementById('tacEvalSection').style.display = 'none';
  saveSession();
  renderTactical();
  if (navigator.vibrate) navigator.vibrate([30, 50, 30]);
}

function resetEvalUI() {
  document.querySelectorAll('#tacEvalSection .eval-btn').forEach(b => b.className = 'eval-btn');
  document.querySelectorAll('#tacTags .tag-btn').forEach(b => b.classList.remove('selected'));
}

// ============================================================
// TACTICAL IQ: MODE SWITCH & BIOMECHANICS
// ============================================================
window._tacMode = 'waves';
window._bioWaveCount = 0;
window._pendingBio = null;

function tacSwitchMode(mode, el) {
  window._tacMode = mode;
  // Toggle buttons
  document.querySelectorAll('#tacModeToggle .seg-btn').forEach(b => b.classList.remove('selected'));
  if (el) el.classList.add('selected');
  
  document.getElementById('tacWaveMode').style.display = mode === 'waves' ? 'block' : 'none';
  document.getElementById('tacBioMode').style.display = mode === 'biomech' ? 'block' : 'none';
  
  if (mode === 'biomech') renderBioHistory();
}

function bioNewWave() {
  window._bioWaveCount++;
  document.getElementById('bioWaveCount').textContent = `Ola #${window._bioWaveCount}`;
  document.getElementById('bioEvalForm').style.display = 'block';
  
  // Reset all bio eval buttons
  ['bioShoulders','bioKnees','bioArms','bioCompression','bioHead','bioBackFoot','bioWeight','bioFlow'].forEach(id => {
    document.querySelectorAll(`#${id} .eval-btn`).forEach(b => b.className = 'eval-btn');
  });
  document.getElementById('bioNotes').value = '';
  
  window._pendingBio = {
    wave_num: window._bioWaveCount,
    timestamp: new Date().toISOString(),
    bio_shoulders: null,
    bio_knees: null,
    bio_arms: null,
    bio_compression: null,
    bio_head: null,
    bio_backfoot: null,
    bio_weight: null,
    bio_flow: null,
    notes: ''
  };
  
  if (navigator.vibrate) navigator.vibrate(50);
}

function bioConfirmWave() {
  if (!window._pendingBio) return;
  const s = DB.activeSession;
  if (!s) return;
  
  const ids = Object.keys(s.athlete_data);
  const currentId = ids[window._tacIdx];
  if (!currentId) return;
  
  // Save notes
  window._pendingBio.notes = document.getElementById('bioNotes').value.trim();
  
  // Ensure biomech array exists
  if (!s.athlete_data[currentId].biomech) s.athlete_data[currentId].biomech = [];
  s.athlete_data[currentId].biomech.push({ ...window._pendingBio });
  
  window._pendingBio = null;
  document.getElementById('bioEvalForm').style.display = 'none';
  saveSession();
  renderBioHistory();
  
  if (navigator.vibrate) navigator.vibrate([30, 50, 30]);
}

function renderBioHistory() {
  const s = DB.activeSession;
  if (!s) return;
  const ids = Object.keys(s.athlete_data);
  const currentId = ids[window._tacIdx];
  if (!currentId) return;
  
  const biomech = s.athlete_data[currentId].biomech || [];
  const div = document.getElementById('bioHistory');
  
  if (biomech.length === 0) {
    div.innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:13px;padding:12px">Sin evaluaciones a√∫n. Toca "Nueva Ola" para comenzar.</div>';
    return;
  }
  
  const colorMap = { poor: 'üî¥', ok: 'üü°', good: 'üü¢', none: 'üî¥', partial: 'üü°', full: 'üü¢' };
  const scoreLabel = v => `${colorMap[v] || '‚ö™'} ${bioScore(v)}`;
  const numColor = v => { const n = parseInt(v); return n >= 4 ? 'üü¢' : n >= 3 ? 'üü°' : 'üî¥'; };
  
  div.innerHTML = '<div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px">üìã Historial Biomec√°nica</div>' +
    biomech.slice().reverse().map(b => {
      const checks = [
        b.bio_shoulders ? `Hombros ${scoreLabel(b.bio_shoulders)}` : null,
        b.bio_knees ? `Rodillas ${scoreLabel(b.bio_knees)}` : null,
        b.bio_arms ? `Brazos ${scoreLabel(b.bio_arms)}` : null,
        b.bio_compression ? `Compresi√≥n ${scoreLabel(b.bio_compression)}` : null,
        b.bio_head ? `Cabeza ${scoreLabel(b.bio_head)}` : null,
        b.bio_backfoot ? `Pie trasero ${scoreLabel(b.bio_backfoot)}` : null,
        b.bio_weight ? `Peso ${scoreLabel(b.bio_weight)}` : null,
        b.bio_flow ? `Fluidez ${numColor(b.bio_flow)} ${b.bio_flow}/5` : null,
      ].filter(Boolean);
      
      return `<div class="card" style="padding:10px 12px;margin-bottom:8px">
        <div style="font-size:13px;font-weight:700;margin-bottom:6px">üèÑ Ola #${b.wave_num}</div>
        <div style="font-size:12px;color:var(--text-secondary);display:flex;flex-wrap:wrap;gap:6px">${checks.map(c => `<span style="background:var(--bg-input);padding:2px 6px;border-radius:4px">${c}</span>`).join('')}</div>
        ${b.notes ? `<div style="font-size:12px;color:var(--text-primary);margin-top:6px;padding:6px 8px;background:var(--bg-input);border-radius:6px;line-height:1.4">üìù ${b.notes}</div>` : ''}
      </div>`;
    }).join('');
}

// ============================================================
// DEBRIEF SUMMARY HELPERS
// ============================================================
// Universal bio scoring: poor/none=1, ok/partial=50, good/full=100, empty=0
function bioScore(v) {
  if (!v) return 0;
  if (v === 'good' || v === 'full') return 100;
  if (v === 'ok' || v === 'partial') return 50;
  return 1; // poor, none, or any other value
}

function bioAvgScore(bio, field) {
  const vals = bio.map(b => b[field]).filter(Boolean);
  if (vals.length === 0) return 0;
  return Math.round(vals.reduce((sum, v) => sum + bioScore(v), 0) / vals.length);
}

function renderBioSummaryHTML(ad) {
  const bio = ad.biomech || [];
  if (bio.length === 0) return '';
  
  const fields = ['bio_shoulders','bio_knees','bio_arms','bio_compression','bio_head','bio_backfoot','bio_weight'];
  const labels = ['Hombros','Rodillas','Brazos','Compresi√≥n','Cabeza','Pie','Peso'];
  
  let summary = fields.map((f, i) => {
    const avg = bioAvgScore(bio, f);
    return `<span style="font-size:11px">${labels[i]} ${avg >= 60 ? 'üü¢' : avg >= 30 ? 'üü°' : avg > 0 ? 'üî¥' : '‚ö™'}${avg}</span>`;
  }).join(' ¬∑ ');
  
  // Average flow
  const flows = bio.map(b => parseInt(b.bio_flow)).filter(n => !isNaN(n));
  const avgFlow = flows.length > 0 ? (flows.reduce((a,b)=>a+b,0)/flows.length).toFixed(1) : '‚Äî';
  
  // Collect all notes
  const notes = bio.map(b => b.notes).filter(Boolean);
  
  return `<div style="margin-top:8px;padding:8px;background:var(--bg-input);border-radius:8px">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:4px">ü¶¥ Biomec√°nica (${bio.length} olas)</div>
    <div style="display:flex;flex-wrap:wrap;gap:4px">${summary}</div>
    <div style="font-size:12px;margin-top:4px">Fluidez promedio: <strong>${avgFlow}/5</strong></div>
    ${notes.length > 0 ? `<div style="font-size:11px;color:var(--text-secondary);margin-top:4px">${notes.map(n => `üìù ${n}`).join('<br>')}</div>` : ''}
  </div>`;
}

function renderWorkoutSummaryHTML(ad) {
  const wo = ad.workouts || [];
  if (wo.length === 0) return '';
  
  const done = wo.filter(w => w.completed).length;
  const total = wo.length;
  const goodQ = wo.filter(w => w.quality === 'good').length;
  
  return `<div style="margin-top:8px;padding:8px;background:var(--bg-input);border-radius:8px">
    <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:4px">üí™ Workout</div>
    <div style="font-size:12px">${done}/${total} completados ${goodQ > 0 ? `¬∑ ${goodQ} buenos` : ''}</div>
    <div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:4px">${wo.map(w => {
      const icon = w.completed ? (w.quality === 'good' ? 'üü¢' : w.quality === 'regular' ? 'üü°' : 'üî¥') : '‚¨ú';
      return `<span style="font-size:11px;background:var(--bg-card);padding:2px 6px;border-radius:4px">${icon} ${w.name}</span>`;
    }).join('')}</div>
  </div>`;
}

// ============================================================
// WORKOUT MODULE
// ============================================================
window._woAssignTarget = 'all'; // 'all' or athlete id
window._woActiveCat = 'Todos';

function renderWorkout() {
  const s = DB.activeSession;
  if (!s) { showView('home'); return; }
  
  const athletes = DB.athletes;
  const ids = Object.keys(s.athlete_data);
  const container = document.getElementById('woAthleteList');
  
  let html = '';
  ids.forEach(id => {
    const a = athletes.find(x => x.id === id);
    const ad = s.athlete_data[id];
    if (!ad.workouts) ad.workouts = [];
    
    html += `<div class="wo-ath-card">
      <div class="wo-ath-name">${a ? a.name : 'Atleta'} 
        <button style="float:right;font-size:11px;color:var(--accent);font-weight:700" onclick="woAssignOne('${id}')">+ Ejercicio</button>
      </div>`;
    
    if (ad.workouts.length === 0) {
      html += `<div style="font-size:12px;color:var(--text-muted);text-align:center;padding:8px">Sin ejercicios asignados</div>`;
    } else {
      ad.workouts.forEach((w, wi) => {
        const checkClass = w.completed ? (w.quality === 'poor' ? 'fail' : 'done') : '';
        html += `<div class="wo-drill-row">
          <div class="wo-check ${checkClass}" onclick="woToggleComplete('${id}',${wi})">${w.completed ? '‚úì' : ''}</div>
          <div class="wo-drill-name">${w.name}${w.duration ? `<br><span style="font-size:10px;color:var(--text-muted)">${w.duration}</span>` : ''}</div>
          <div class="wo-quality">
            <div class="wo-q-btn ${w.quality === 'good' ? 'active' : ''}" onclick="woSetQuality('${id}',${wi},'good')" style="${w.quality === 'good' ? 'background:var(--green);color:#fff;border-color:var(--green)' : ''}">üëç</div>
            <div class="wo-q-btn ${w.quality === 'regular' ? 'active' : ''}" onclick="woSetQuality('${id}',${wi},'regular')" style="${w.quality === 'regular' ? 'background:var(--yellow);color:#fff;border-color:var(--yellow)' : ''}">üëå</div>
            <div class="wo-q-btn ${w.quality === 'poor' ? 'active' : ''}" onclick="woSetQuality('${id}',${wi},'poor')" style="${w.quality === 'poor' ? 'background:var(--red);color:#fff;border-color:var(--red)' : ''}">üëé</div>
          </div>
        </div>`;
      });
    }
    html += `</div>`;
  });
  
  container.innerHTML = html || '<div style="text-align:center;color:var(--text-muted);padding:20px">No hay atletas en sesi√≥n</div>';
  
  // Summary
  const allWorkouts = ids.flatMap(id => (s.athlete_data[id].workouts || []));
  const sumDiv = document.getElementById('woSummary');
  if (allWorkouts.length > 0) {
    sumDiv.style.display = 'block';
    const done = allWorkouts.filter(w => w.completed).length;
    document.getElementById('woSummaryContent').innerHTML = `
      <div style="font-size:14px;font-weight:700">${done}/${allWorkouts.length} ejercicios completados</div>
      <div style="height:8px;background:var(--bg-input);border-radius:4px;margin-top:8px;overflow:hidden">
        <div style="height:100%;width:${allWorkouts.length > 0 ? Math.round(done/allWorkouts.length*100) : 0}%;background:var(--green);border-radius:4px;transition:width .3s"></div>
      </div>
    `;
  } else { sumDiv.style.display = 'none'; }
}

function woAssignAll() {
  window._woAssignTarget = 'all';
  document.getElementById('woAssignTitle').textContent = 'Asignar a Todos';
  document.getElementById('woAssignTarget').textContent = 'Se asignar√° a todos los atletas de la sesi√≥n';
  woRenderLibrary();
  document.getElementById('modalWoAssign').classList.add('active');
}

function woAssignOne(athleteId) {
  const s = DB.activeSession;
  if (!s) return;
  
  if (!athleteId) {
    // Prompt to pick athlete
    const ids = Object.keys(s.athlete_data);
    const athletes = DB.athletes;
    if (ids.length === 1) { athleteId = ids[0]; }
    else {
      const names = ids.map(id => { const a = athletes.find(x => x.id === id); return a ? a.name : id; });
      const choice = prompt('Atleta:\n' + ids.map((id, i) => `${i+1}. ${names[i]}`).join('\n') + '\n\nEscribe el n√∫mero:');
      if (!choice) return;
      athleteId = ids[parseInt(choice) - 1];
      if (!athleteId) return;
    }
  }
  
  window._woAssignTarget = athleteId;
  const a = DB.athletes.find(x => x.id === athleteId);
  document.getElementById('woAssignTitle').textContent = 'Asignar Ejercicio';
  document.getElementById('woAssignTarget').textContent = `Para: ${a ? a.name : 'Atleta'}`;
  woRenderLibrary();
  document.getElementById('modalWoAssign').classList.add('active');
}

function woAssignTab(tab, el) {
  document.querySelectorAll('#modalWoAssign .seg-btn').forEach(b => b.classList.remove('selected'));
  if (el) el.classList.add('selected');
  document.getElementById('woLibraryTab').style.display = tab === 'library' ? 'block' : 'none';
  document.getElementById('woCustomTab').style.display = tab === 'custom' ? 'block' : 'none';
}

function woRenderLibrary() {
  const allDrills = [...DRILL_LIBRARY, ...DB.customDrills];
  const cats = ['Todos', ...new Set(allDrills.map(d => d.cat))];
  
  document.getElementById('woCatFilter').innerHTML = cats.map(c =>
    `<button class="drill-cat-btn ${c === window._woActiveCat ? 'active' : ''}" onclick="woFilterCat('${c}')">${c}</button>`
  ).join('');
  
  const filtered = window._woActiveCat === 'Todos' ? allDrills : allDrills.filter(d => d.cat === window._woActiveCat);
  document.getElementById('woLibraryList').innerHTML = filtered.map(d => {
    const safeName = (d.name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
    const safeDur = (d.duration || '').replace(/'/g, "\\'");
    return `<div style="padding:14px 12px;border-bottom:1px solid var(--border);cursor:pointer;-webkit-tap-highlight-color:transparent" onclick="woSelectDrill('${d.id}','${safeName}','${safeDur}')" ontouchstart="this.style.background='var(--bg-input)'" ontouchend="this.style.background=''">
      <div style="font-weight:700;font-size:14px">${d.icon || 'üèãÔ∏è'} ${d.name}</div>
      <div style="font-size:12px;color:var(--text-muted);margin-top:2px">${d.duration || ''} ¬∑ ${d.cat}</div>
    </div>`;
  }).join('');
}

function woFilterCat(cat) {
  window._woActiveCat = cat;
  woRenderLibrary();
}

function woSelectDrill(drillId, name, duration) {
  const s = DB.activeSession;
  if (!s) return;
  
  const workout = { id: DB.genId(), drill_id: drillId, name, duration, completed: false, quality: null, notes: '' };
  
  if (window._woAssignTarget === 'all') {
    Object.keys(s.athlete_data).forEach(id => {
      if (!s.athlete_data[id].workouts) s.athlete_data[id].workouts = [];
      s.athlete_data[id].workouts.push({ ...workout, id: DB.genId() });
    });
  } else {
    if (!s.athlete_data[window._woAssignTarget].workouts) s.athlete_data[window._woAssignTarget].workouts = [];
    s.athlete_data[window._woAssignTarget].workouts.push(workout);
  }
  
  saveSession();
  document.getElementById('modalWoAssign').classList.remove('active');
  renderWorkout();
}

function woAssignCustom() {
  const name = document.getElementById('woCustomName').value.trim();
  if (!name) { alert('Nombre requerido'); return; }
  const desc = document.getElementById('woCustomDesc').value.trim();
  const dur = document.getElementById('woCustomDur').value.trim();
  
  // Save to custom drills library
  const custom = DB.customDrills;
  const newDrill = { id: 'custom_' + DB.genId(), name, desc, duration: dur, cat: 'Custom', icon: '‚≠ê', level: 'Todos' };
  custom.push(newDrill);
  DB.customDrills = custom;
  
  // Assign to session
  woSelectDrill(newDrill.id, name, dur);
  
  // Reset form
  document.getElementById('woCustomName').value = '';
  document.getElementById('woCustomDesc').value = '';
  document.getElementById('woCustomDur').value = '';
}

function woToggleComplete(athId, woIdx) {
  const s = DB.activeSession;
  if (!s) return;
  const w = s.athlete_data[athId].workouts[woIdx];
  w.completed = !w.completed;
  if (!w.completed) w.quality = null;
  saveSession();
  renderWorkout();
  if (navigator.vibrate) navigator.vibrate(30);
}

function woSetQuality(athId, woIdx, quality) {
  const s = DB.activeSession;
  if (!s) return;
  const w = s.athlete_data[athId].workouts[woIdx];
  w.quality = quality;
  w.completed = true;
  saveSession();
  renderWorkout();
}

function saveSession() {
  DB.saveActive();
}

// ============================================================
// OVERVIEW
// ============================================================
function renderOverview() {
  const s = DB.activeSession;
  if (!s) { showView('home'); return; }
  
  const sizeNames = { 1: 'Flat', 2: '1-2ft', 3: '2-4ft', 4: '4-6ft', 5: '+6ft' };
  document.getElementById('ovInfo').textContent = `${s.spot} ¬∑ ${sizeNames[s.wave_size]} ¬∑ ${s.focus_area || ''}`;
  
  const athletes = DB.athletes;
  const ids = Object.keys(s.athlete_data);
  let totalPaddled = 0, totalCaught = 0;
  
  let html = '';
  ids.forEach((id, i) => {
    const a = athletes.find(x => x.id === id);
    const d = s.athlete_data[id];
    const ratio = d.paddled > 0 ? Math.round(d.caught / d.paddled * 100) : 0;
    const color = ratio >= 60 ? 'var(--green)' : ratio >= 40 ? 'var(--yellow)' : d.paddled > 0 ? 'var(--red)' : 'var(--text-muted)';
    totalPaddled += d.paddled;
    totalCaught += d.caught;
    
    html += `<div class="ov-row" onclick="window._tacIdx=${i};showView('tactical')" style="cursor:pointer">
      <div class="ov-name">${a ? a.name.split(' ')[0] : 'Atleta'}</div>
      <div class="ov-stats">${d.paddled}/${d.caught}</div>
      <div class="ov-ratio" style="color:${color}">${d.paddled > 0 ? ratio + '%' : '‚Äî'}</div>
    </div>`;
  });
  
  document.getElementById('ovList').innerHTML = html;
  const avgRatio = totalPaddled > 0 ? Math.round(totalCaught / totalPaddled * 100) : 0;
  document.getElementById('ovAvg').textContent = totalPaddled > 0 ? avgRatio + '%' : '‚Äî%';
  
  updateSessionBar();
}

// ============================================================
// END SESSION ‚Üí DEBRIEF
// ============================================================
function endSession() {
  if (!confirm('¬øCerrar la sesi√≥n actual?')) return;
  // Auto-confirm any pending wave
  if (window._pendingWave) confirmWave();
  stopSessionTimer();
  showView('debrief');
}

function renderDebrief() {
  const s = DB.activeSession;
  if (!s) { showView('home'); return; }
  
  const d = new Date(s.started_at);
  document.getElementById('dbDate').textContent = new Intl.DateTimeFormat('es', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }).format(d);
  
  // Conditions tags
  const sizeNames = { 1: 'Flat', 2: '1-2ft', 3: '2-4ft', 4: '4-6ft', 5: '+6ft' };
  const windNames = { glassy: 'üåÖ Glassy', offshore: 'üí® Off-shore', onshore: 'üå¨Ô∏è On-shore', cross: '‚ÜóÔ∏è Cross-shore' };
  const crowdNames = { empty: 'üü¢ Vac√≠o', medium: 'üü° Medio', crowded: 'üî¥ Lleno' };
  
  let tags = `<span class="db-tag">üìç ${s.spot}</span>`;
  tags += `<span class="db-tag">üåä ${sizeNames[s.wave_size]}</span>`;
  tags += `<span class="db-tag">${'‚≠ê'.repeat(s.wave_quality)}</span>`;
  tags += `<span class="db-tag">${windNames[s.wind_condition]}</span>`;
  tags += `<span class="db-tag">${crowdNames[s.crowd_factor]}</span>`;
  if (s.focus_area) tags += `<span class="db-tag">üéØ ${s.focus_area}</span>`;
  document.getElementById('dbConditions').innerHTML = tags;
  
  // Detect modules
  const mods = detectModulesUsed(s);
  const hasTactical = mods.includes('tactical');
  const hasJudge = mods.includes('judge');
  const hasBiomech = mods.includes('biomech');
  const hasWorkout = mods.includes('workout');
  
  // Modules used badge
  const modLabels = { tactical: 'üèÑ Tactical', biomech: 'ü¶¥ Bio', judge: '‚öñÔ∏è Judge', workout: 'üí™ Workout', lab: 'üé• Lab' };
  const modBadges = mods.map(m => `<span class="hist-badge">${modLabels[m] || m}</span>`).join(' ');
  
  // Team stats
  const ids = Object.keys(s.athlete_data);
  let totalP = 0, totalC = 0, totalF = 0;
  if (hasTactical) {
    ids.forEach(id => { const d = s.athlete_data[id]; totalP += d.paddled; totalC += d.caught; totalF += d.falls; });
  }
  const teamRatio = totalP > 0 ? Math.round(totalC / totalP * 100) : 0;
  
  if (hasTactical) {
    document.getElementById('dbTeamRatio').textContent = `Catch Ratio: ${teamRatio}%`;
    document.getElementById('dbTeamStats').textContent = `${ids.length} atletas ¬∑ ${totalP} remadas ¬∑ ${totalC} atrapadas ¬∑ ${totalF} ca√≠das`;
  } else {
    document.getElementById('dbTeamRatio').textContent = '';
    document.getElementById('dbTeamStats').innerHTML = `${ids.length} atletas ¬∑ ${modBadges}`;
  }
  
  // Per athlete
  const athletes = DB.athletes;
  let athHtml = '';
  ids.forEach(id => {
    const a = athletes.find(x => x.id === id);
    const ad = s.athlete_data[id];
    
    athHtml += `<div class="db-athlete-card">
      <div class="db-athlete-name">${a ? a.name : 'Atleta'}</div>`;
    
    // Tactical section (only if used)
    if (hasTactical) {
      const ratio = ad.paddled > 0 ? Math.round(ad.caught / ad.paddled * 100) : 0;
      const ratioColor = ratio >= 60 ? 'var(--green)' : ratio >= 40 ? 'var(--yellow)' : 'var(--red)';
      const maneuvers = {};
      ad.waves.forEach(w => { if (w.maneuvers) w.maneuvers.forEach(m => { maneuvers[m] = (maneuvers[m] || 0) + 1; }); });
      const manStr = Object.entries(maneuvers).map(([m, c]) => `${m.toUpperCase()}√ó${c}`).join(' ');
      
      athHtml += `<div class="db-stat-grid">
        <div class="db-stat"><div class="db-stat-v">${ad.paddled}</div><div class="db-stat-l">Rem√≥</div></div>
        <div class="db-stat"><div class="db-stat-v">${ad.caught}</div><div class="db-stat-l">Atrap√≥</div></div>
        <div class="db-stat"><div class="db-stat-v" style="color:${ratioColor}">${ratio}%</div><div class="db-stat-l">Catch</div></div>
      </div>
      ${ad.falls > 0 ? `<div style="font-size:12px;color:var(--red);font-weight:600">üí• ${ad.falls} ca√≠da${ad.falls > 1 ? 's' : ''}</div>` : ''}
      ${manStr ? `<div style="font-size:12px;color:var(--text-secondary);margin-top:4px">üèÑ ${manStr}</div>` : ''}`;
    }
    
    // Judge section
    if (hasJudge) {
      const js = getJudgeSummaryForAthlete(id);
      if (js) {
        const scoreColor = js.avg_wave >= 6 ? 'var(--green)' : js.avg_wave >= 4 ? 'var(--yellow)' : js.avg_wave > 0 ? 'var(--red)' : 'var(--text-muted)';
        athHtml += `<div style="margin-top:8px;padding:8px;background:var(--bg-input);border-radius:8px">
          <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:4px">‚öñÔ∏è Judging (${js.heat_count} heat${js.heat_count > 1 ? 's' : ''})</div>
          <div class="db-stat-grid">
            <div class="db-stat"><div class="db-stat-v" style="color:var(--accent)">${js.avg_total.toFixed(2)}</div><div class="db-stat-l">Avg Heat</div></div>
            <div class="db-stat"><div class="db-stat-v" style="color:${scoreColor}">${js.avg_wave.toFixed(2)}</div><div class="db-stat-l">Avg/Ola</div></div>
            ${js.goal > 0 ? `<div class="db-stat"><div class="db-stat-v" style="color:var(--yellow)">${js.goal.toFixed(1)}</div><div class="db-stat-l">Goal</div></div>` : ''}
          </div>
          <div style="font-size:11px;color:var(--text-secondary);margin-top:4px">${js.heats.map((h, i) => `H${i+1}: ${h.toFixed(2)}`).join(' ¬∑ ')}</div>
        </div>`;
      }
    }
    
    athHtml += renderBioSummaryHTML(ad);
    athHtml += renderWorkoutSummaryHTML(ad);
    
    // XP (calculated now)
    let xp = ad.xp_earned || 10;
    athHtml += `<div class="db-xp">‚ú® +${xp} XP</div>`;
    athHtml += `</div>`;
  });
  document.getElementById('dbAthletes').innerHTML = athHtml;
  
  // Visual catch ratio chart (only if tactical used)
  if (hasTactical && ids.length > 0) {
    const chart = document.getElementById('dbChart');
    chart.style.display = 'block';
    document.getElementById('dbChartBars').innerHTML = ids.map(id => {
      const a = athletes.find(x => x.id === id);
      const ad = s.athlete_data[id];
      const ratio = ad.paddled > 0 ? Math.round(ad.caught / ad.paddled * 100) : 0;
      const color = ratio >= 60 ? 'var(--green)' : ratio >= 40 ? 'var(--yellow)' : 'var(--red)';
      return `<div class="pc-bar-row"><div class="pc-bar-label">${(a ? a.name.split(' ')[0] : '?').slice(0,6)}</div><div class="pc-bar-track"><div class="pc-bar-fill" style="width:${ratio}%;background:${color}"></div></div><div class="pc-bar-val">${ratio}%</div></div>`;
    }).join('');
  } else {
    document.getElementById('dbChart').style.display = 'none';
  }
}

// Helper: get judge summary for an athlete from the tracker
function getJudgeSummaryForAthlete(athId) {
  const tracker = DB.judgeTracker;
  for (const [name, info] of Object.entries(tracker)) {
    if (info.athlete_id === athId) {
      const valid = (info.heats || []).filter(h => h != null);
      const avg = valid.length > 0 ? valid.reduce((a, b) => a + b, 0) / valid.length : 0;
      const wAvgs = (info.all_wave_avgs || []).filter(a => a > 0);
      const allWaveAvg = wAvgs.length > 0 ? wAvgs.reduce((a, b) => a + b, 0) / wAvgs.length : 0;
      return { heats: info.heats || [], heat_count: valid.length, avg_total: avg, avg_wave: allWaveAvg, goal: info.goal || 0 };
    }
  }
  return null;
}

function detectModulesUsed(s) {
  const mods = [];
  const ids = Object.keys(s.athlete_data || {});
  
  // Tactical: any paddled/caught/waves
  if (ids.some(id => { const d = s.athlete_data[id]; return (d.paddled || 0) > 0 || (d.caught || 0) > 0 || (d.waves || []).length > 0; })) {
    mods.push('tactical');
  }
  
  // Biomech: any biomech evaluations
  if (ids.some(id => (s.athlete_data[id].biomech || []).length > 0)) {
    mods.push('biomech');
  }
  
  // Judge: tracker has data
  const tracker = DB.judgeTracker;
  if (Object.keys(tracker).length > 0) {
    mods.push('judge');
  }
  
  // Workout: any workouts assigned
  if (ids.some(id => (s.athlete_data[id].workouts || []).length > 0)) {
    mods.push('workout');
  }
  
  // Lab: check if any frames captured during session
  if (ids.some(id => (s.athlete_data[id].lab_frames || []).length > 0)) {
    mods.push('lab');
  }
  
  return mods;
}

function saveDebrief() {
  const s = DB.activeSession;
  if (!s) return;
  
  s.status = 'completed';
  s.ended_at = new Date().toISOString();
  s.date = s.started_at;
  s.coach_notes = document.getElementById('dbNotes').value;
  s.coach_rating = getStarValue('dbRating');
  
  // Calculate duration
  const start = new Date(s.started_at);
  const end = new Date(s.ended_at);
  s.duration_min = Math.round((end - start) / 60000);
  
  // Detect which modules were actually used
  s.modules_used = detectModulesUsed(s);
  
  // Capture judge tracker data into session
  const tracker = DB.judgeTracker;
  if (Object.keys(tracker).length > 0) {
    s.judge_data = JSON.parse(JSON.stringify(tracker));
    
    // Also save per-athlete judge summaries
    for (const [name, info] of Object.entries(tracker)) {
      const athId = info.athlete_id;
      if (athId && s.athlete_data[athId]) {
        const valid = (info.heats || []).filter(h => h != null);
        const avg = valid.length > 0 ? valid.reduce((a, b) => a + b, 0) / valid.length : 0;
        const wAvgs = (info.all_wave_avgs || []).filter(a => a > 0);
        const allWaveAvg = wAvgs.length > 0 ? wAvgs.reduce((a, b) => a + b, 0) / wAvgs.length : 0;
        
        s.athlete_data[athId].judge_summary = {
          heats: info.heats || [],
          heat_count: valid.length,
          avg_heat_total: parseFloat(avg.toFixed(2)),
          avg_wave_score: parseFloat(allWaveAvg.toFixed(2)),
          all_wave_avgs: info.all_wave_avgs || [],
          goal: info.goal || 0
        };
      }
    }
  }
  
  // Add XP to athletes (module-aware)
  const athletes = DB.athletes;
  const usedTactical = s.modules_used.includes('tactical');
  const usedJudge = s.modules_used.includes('judge');
  const usedWorkout = s.modules_used.includes('workout');
  const usedBiomech = s.modules_used.includes('biomech');
  
  Object.keys(s.athlete_data).forEach(id => {
    const a = athletes.find(x => x.id === id);
    if (!a) return;
    const ad = s.athlete_data[id];
    
    let xp = 10; // Base attendance XP
    
    if (usedTactical) {
      const ratio = ad.paddled > 0 ? ad.caught / ad.paddled : 0;
      if (ratio >= 0.7) xp += 25;
      if (ad.falls === 0 && ad.caught > 0) xp += 40;
      const goodWaves = ad.waves.filter(w => w.selection === 'excellent').length;
      xp += goodWaves * 15;
    }
    
    if (usedJudge && ad.judge_summary) {
      xp += ad.judge_summary.heat_count * 10;
      if (ad.judge_summary.avg_wave_score >= 6) xp += 30;
      else if (ad.judge_summary.avg_wave_score >= 4) xp += 15;
    }
    
    if (usedWorkout) {
      const wo = ad.workouts || [];
      const done = wo.filter(w => w.completed).length;
      xp += done * 5;
      xp += wo.filter(w => w.quality === 'good').length * 5;
    }
    
    if (usedBiomech) {
      const bio = ad.biomech || [];
      xp += bio.length * 5;
    }
    
    ad.xp_earned = xp; // Store for display
    a.xp_total = (a.xp_total || 0) + xp;
    a.sessions_count = (a.sessions_count || 0) + 1;
  });
  DB.athletes = athletes;
  
  // Save session
  const sessions = DB.sessions;
  sessions.push(s);
  DB.sessions = sessions;
  
  // Clear active
  DB.activeSession = null;
  stopSessionTimer();
}

function saveAndExport() {
  saveDebrief();
  exportSessionCSV();
  showView('home');
}

function saveTemplate() {
  const s = DB.activeSession || DB.sessions[DB.sessions.length - 1];
  if (!s) { alert('No hay sesi√≥n activa'); return; }
  
  const name = prompt('Nombre del template:', `${s.spot} - ${s.focus_area || 'Sesi√≥n'}`);
  if (!name) return;
  
  const tpl = {
    id: DB.genId(),
    name,
    spot: s.spot,
    wave_size: s.wave_size,
    wave_quality: s.wave_quality,
    wind_condition: s.wind_condition,
    crowd_factor: s.crowd_factor,
    focus_area: s.focus_area,
    athlete_ids: Object.keys(s.athlete_data || {}),
    created_at: new Date().toISOString()
  };
  
  const templates = DB.templates;
  templates.push(tpl);
  DB.templates = templates;
  alert('‚úÖ Template guardado');
}

function loadTemplate(id) {
  const tpl = DB.templates.find(t => t.id === id);
  if (!tpl) return;
  
  // Start session setup
  if (DB.athletes.length === 0) { openAddAthleteModal(); return; }
  showView('session-setup');
  
  // Auto-fill fields after render
  setTimeout(() => {
    // Spot
    const spotSel = document.getElementById('ssSpot');
    for (let i = 0; i < spotSel.options.length; i++) {
      if (spotSel.options[i].value === tpl.spot) { spotSel.selectedIndex = i; break; }
    }
    // Size
    const sizeBtn = document.querySelector(`#ssSize .seg-btn[data-v="${tpl.wave_size}"]`);
    if (sizeBtn) segSelect('ssSize', sizeBtn);
    // Quality
    if (tpl.wave_quality) starSelect('ssQuality', tpl.wave_quality);
    // Wind
    const windBtn = document.querySelector(`#ssWind .seg-btn[data-v="${tpl.wind_condition}"]`);
    if (windBtn) segSelect('ssWind', windBtn);
    // Crowd
    const crowdBtn = document.querySelector(`#ssCrowd .seg-btn[data-v="${tpl.crowd_factor}"]`);
    if (crowdBtn) segSelect('ssCrowd', crowdBtn);
    // Focus
    if (tpl.focus_area) document.getElementById('ssFocus').value = tpl.focus_area;
    // Athletes
    if (tpl.athlete_ids && tpl.athlete_ids.length > 0) {
      const checks = document.querySelectorAll('#ssAthList input[type="checkbox"]');
      checks.forEach(cb => {
        cb.checked = tpl.athlete_ids.includes(cb.value);
      });
    }
  }, 100);
}

function deleteTemplate(id) {
  if (!confirm('¬øEliminar este template?')) return;
  DB.templates = DB.templates.filter(t => t.id !== id);
  renderSettings();
}

// ============================================================
// EXPORT CSV
// ============================================================
function exportSessionCSV() {
  const sessions = DB.sessions;
  if (sessions.length === 0) return;
  const s = sessions[sessions.length - 1];
  const athletes = DB.athletes;
  
  // Flat BI-ready format: one row per athlete, all data as columns
  const headers = [
    'timestamp','spot','wave_size','wave_quality','wind','crowd','focus','duration_min','coach_rating',
    'modules_used',
    'athlete',
    'paddled','caught','falls','catch_ratio',
    'waves_total','maneuvers',
    'selection_poor','selection_normal','selection_excellent',
    'position_poor','position_normal','position_excellent',
    'commit_poor','commit_normal','commit_excellent',
    'xp',
    'bio_evals','bio_shoulders_score','bio_knees_score','bio_arms_score',
    'bio_compression_score','bio_head_score','bio_backfoot_score','bio_weight_score',
    'bio_avg_flow','bio_notes',
    'judge_heats','judge_h1','judge_h2','judge_h3','judge_h4','judge_h5','judge_h6',
    'judge_avg_heat','judge_avg_wave','judge_goal',
    'workout_total','workout_completed','workout_good','workout_regular','workout_poor',
    'coach_notes'
  ];
  
  const modsStr = (s.modules_used || []).join(';');
  let csv = headers.join(',') + '\n';
  
  Object.keys(s.athlete_data).forEach(id => {
    const a = athletes.find(x => x.id === id);
    const d = s.athlete_data[id];
    const usedTactical = (s.modules_used || []).includes('tactical');
    const ratio = usedTactical && d.paddled > 0 ? Math.round(d.caught / d.paddled * 100) : '';
    
    // Tactical aggregates (only if module used)
    const maneuvers = {};
    let sel = { poor: 0, normal: 0, excellent: 0 };
    let pos = { poor: 0, normal: 0, excellent: 0 };
    let com = { poor: 0, normal: 0, excellent: 0 };
    if (usedTactical) {
      d.waves.forEach(w => {
        if (w.maneuvers) w.maneuvers.forEach(m => maneuvers[m] = (maneuvers[m] || 0) + 1);
        if (w.selection) sel[w.selection] = (sel[w.selection] || 0) + 1;
        if (w.position) pos[w.position] = (pos[w.position] || 0) + 1;
        if (w.commit) com[w.commit] = (com[w.commit] || 0) + 1;
      });
    }
    const xp = d.xp_earned || 10;
    const manStr = Object.entries(maneuvers).map(([m, c]) => `${m}:${c}`).join(';');
    
    // Biomechanics aggregates
    const bio = d.biomech || [];
    const flows = bio.map(b => parseInt(b.bio_flow)).filter(n => !isNaN(n));
    const avgFlow = flows.length > 0 ? (flows.reduce((a,b)=>a+b,0)/flows.length).toFixed(1) : '';
    const bioNotes = bio.map(b => b.notes).filter(Boolean).join(' | ');
    
    // Workout aggregates
    const wo = d.workouts || [];
    const woDone = wo.filter(w => w.completed).length;
    const woGood = wo.filter(w => w.quality === 'good').length;
    const woReg = wo.filter(w => w.quality === 'regular').length;
    const woPoor = wo.filter(w => w.quality === 'poor').length;
    
    const esc = (v) => `"${String(v || '').replace(/"/g, '""')}"`;
    
    // Judge data
    const js = d.judge_summary || {};
    const jHeats = js.heats || [];
    
    const row = [
      s.date || s.started_at,
      esc(s.spot),
      s.wave_size,
      s.wave_quality,
      s.wind_condition,
      s.crowd_factor,
      esc(s.focus_area || ''),
      s.duration_min || '',
      s.coach_rating || '',
      esc(modsStr),
      esc(a ? a.name : id),
      usedTactical ? d.paddled : '',
      usedTactical ? d.caught : '',
      usedTactical ? d.falls : '',
      ratio,
      usedTactical ? d.waves.length : '',
      esc(manStr),
      usedTactical ? sel.poor : '', usedTactical ? sel.normal : '', usedTactical ? sel.excellent : '',
      usedTactical ? pos.poor : '', usedTactical ? pos.normal : '', usedTactical ? pos.excellent : '',
      usedTactical ? com.poor : '', usedTactical ? com.normal : '', usedTactical ? com.excellent : '',
      xp,
      bio.length || '',
      bio.length > 0 ? bioAvgScore(bio, 'bio_shoulders') : '',
      bio.length > 0 ? bioAvgScore(bio, 'bio_knees') : '',
      bio.length > 0 ? bioAvgScore(bio, 'bio_arms') : '',
      bio.length > 0 ? bioAvgScore(bio, 'bio_compression') : '',
      bio.length > 0 ? bioAvgScore(bio, 'bio_head') : '',
      bio.length > 0 ? bioAvgScore(bio, 'bio_backfoot') : '',
      bio.length > 0 ? bioAvgScore(bio, 'bio_weight') : '',
      avgFlow,
      esc(bioNotes),
      jHeats.length || '',
      jHeats[0] != null ? jHeats[0].toFixed(2) : '',
      jHeats[1] != null ? jHeats[1].toFixed(2) : '',
      jHeats[2] != null ? jHeats[2].toFixed(2) : '',
      jHeats[3] != null ? jHeats[3].toFixed(2) : '',
      jHeats[4] != null ? jHeats[4].toFixed(2) : '',
      jHeats[5] != null ? jHeats[5].toFixed(2) : '',
      js.avg_heat_total != null ? js.avg_heat_total : '',
      js.avg_wave_score != null ? js.avg_wave_score : '',
      js.goal || '',
      wo.length || '',
      woDone || '',
      woGood || '',
      woReg || '',
      woPoor || '',
      esc(s.coach_notes || '')
    ];
    
    csv += row.join(',') + '\n';
  });
  
  // Download
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `KSS_Session_${s.spot.replace(/\s/g, '')}_${new Date(s.date).toISOString().slice(0, 10)}.csv`;
  link.click();
  URL.revokeObjectURL(url);
}

function exportAllData() {
  const data = {
    athletes: DB.athletes,
    sessions: DB.sessions,
    spots: DB.spots,
    exported_at: new Date().toISOString()
  };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `KSS_Coach_Backup_${new Date().toISOString().slice(0, 10)}.json`;
  link.click();
  URL.revokeObjectURL(url);
}

// ============================================================
// SESSION HISTORY
// ============================================================
function renderHistory() {
  const sessions = DB.sessions.slice().reverse();
  const athletes = DB.athletes;
  const spotFilter = document.getElementById('histSpotFilter').value;
  const athFilter = document.getElementById('histAthleteFilter').value;
  
  // Populate filter options
  const spots = [...new Set(sessions.map(s => s.spot))];
  const spotSel = document.getElementById('histSpotFilter');
  if (spotSel.options.length <= 1) {
    spots.forEach(sp => { const o = document.createElement('option'); o.value = sp; o.textContent = sp; spotSel.appendChild(o); });
  }
  const athSel = document.getElementById('histAthleteFilter');
  if (athSel.options.length <= 1) {
    athletes.forEach(a => { const o = document.createElement('option'); o.value = a.id; o.textContent = a.name; athSel.appendChild(o); });
  }
  
  let filtered = sessions;
  if (spotFilter) filtered = filtered.filter(s => s.spot === spotFilter);
  if (athFilter) filtered = filtered.filter(s => s.athlete_data && s.athlete_data[athFilter]);
  
  document.getElementById('histCount').textContent = `${filtered.length} sesi√≥n${filtered.length !== 1 ? 'es' : ''}`;
  
  if (filtered.length === 0) {
    document.getElementById('histList').innerHTML = '';
    document.getElementById('histEmpty').style.display = 'block';
    return;
  }
  document.getElementById('histEmpty').style.display = 'none';
  
  const allSessions = DB.sessions;
  document.getElementById('histList').innerHTML = filtered.map(s => {
    const idx = allSessions.indexOf(s);
    const ids = Object.keys(s.athlete_data || {});
    const athCount = ids.length;
    const date = new Date(s.date || s.started_at);
    const dateStr = new Intl.DateTimeFormat('es', { weekday:'short', day:'numeric', month:'short', year:'numeric' }).format(date);
    const sizeNames = { 1:'Flat', 2:'1-2ft', 3:'2-4ft', 4:'4-6ft', 5:'+6ft' };
    const mods = s.modules_used || [];
    const hasTactical = !s.modules_used || mods.includes('tactical');
    const hasJudge = mods.includes('judge');
    
    // Aggregate stats (only from tactical)
    let totalP = 0, totalC = 0, totalF = 0;
    if (hasTactical) {
      ids.forEach(id => { const d = s.athlete_data[id]; totalP += d.paddled || 0; totalC += d.caught || 0; totalF += d.falls || 0; });
    }
    const bioCount = ids.reduce((sum, id) => sum + (s.athlete_data[id].biomech || []).length, 0);
    const woCount = ids.reduce((sum, id) => sum + (s.athlete_data[id].workouts || []).length, 0);
    const judgeHeats = ids.reduce((sum, id) => sum + ((s.athlete_data[id].judge_summary || {}).heat_count || 0), 0);
    
    let badges = '';
    if (hasJudge && judgeHeats > 0) badges += `<span class="hist-badge">‚öñÔ∏è ${judgeHeats}h</span>`;
    if (bioCount > 0) badges += `<span class="hist-badge">ü¶¥ ${bioCount}</span>`;
    if (woCount > 0) badges += `<span class="hist-badge">üí™ ${woCount}</span>`;
    if (s.duration_min) badges += `<span class="hist-badge">‚è±Ô∏è ${s.duration_min}m</span>`;
    
    // Right side metric
    let rightHtml = '';
    if (hasTactical && totalP > 0) {
      const ratio = Math.round(totalC / totalP * 100);
      const ratioColor = ratio >= 60 ? 'var(--green)' : ratio >= 40 ? 'var(--yellow)' : 'var(--red)';
      rightHtml = `<div style="font-size:22px;font-weight:800;color:${ratioColor}">${ratio}%</div><div style="font-size:10px;color:var(--text-muted)">catch</div>`;
    } else if (hasJudge) {
      const avgScores = ids.map(id => (s.athlete_data[id].judge_summary||{}).avg_wave_score||0).filter(v=>v>0);
      const teamAvg = avgScores.length > 0 ? (avgScores.reduce((a,b)=>a+b,0)/avgScores.length).toFixed(1) : '‚Äî';
      rightHtml = `<div style="font-size:22px;font-weight:800;color:var(--accent)">${teamAvg}</div><div style="font-size:10px;color:var(--text-muted)">avg/ola</div>`;
    } else {
      rightHtml = `<div style="font-size:18px">‚úì</div>`;
    }
    
    // Bottom stats
    let statsHtml = `<span>üë• ${athCount}</span>`;
    if (hasTactical && totalP > 0) statsHtml += `<span>üèÑ ${totalC}/${totalP} olas</span>`;
    if (totalF > 0) statsHtml += `<span>üí• ${totalF}</span>`;
    statsHtml += badges;
    
    return `<div class="hist-card" onclick="openSessionDetail(${idx})">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div>
          <div class="hist-spot">${s.spot}</div>
          <div class="hist-date">${dateStr} ¬∑ ${sizeNames[s.wave_size] || ''} ¬∑ ${s.wind_condition || ''}</div>
        </div>
        <div style="text-align:right">${rightHtml}</div>
      </div>
      <div class="hist-stats">${statsHtml}</div>
    </div>`;
  }).join('');
}

function openSessionDetail(idx) {
  window._sdSessionIdx = idx;
  showView('session-detail');
}

function exportSessionCSVById(idx) {
  // Temporarily swap sessions array to export specific session
  const sessions = DB.sessions;
  if (idx === undefined || !sessions[idx]) return;
  const orig = sessions.length;
  const s = sessions[idx];
  // Push to end temporarily for exportSessionCSV which grabs last
  sessions.push(s);
  DB.sessions = sessions;
  exportSessionCSV();
  sessions.pop();
  DB.sessions = sessions;
}

// ============================================================
// SESSION DETAIL
// ============================================================
function renderSessionDetail() {
  const s = DB.sessions[window._sdSessionIdx];
  if (!s) { showView('history'); return; }
  const athletes = DB.athletes;
  const mods = s.modules_used || [];
  const hasTactical = !s.modules_used || mods.includes('tactical');
  const hasJudge = mods.includes('judge');
  
  const date = new Date(s.date || s.started_at);
  const dateStr = new Intl.DateTimeFormat('es', { weekday:'long', day:'numeric', month:'long', year:'numeric' }).format(date);
  const sizeNames = { 1:'Flat', 2:'1-2ft', 3:'2-4ft', 4:'4-6ft', 5:'+6ft' };
  
  document.getElementById('sdTitle').textContent = s.spot;
  const modLabels = { tactical:'üèÑ Tactical', biomech:'ü¶¥ Bio', judge:'‚öñÔ∏è Judge', workout:'üí™ Workout', lab:'üé• Lab' };
  const modBadges = mods.length > 0 ? mods.map(m => modLabels[m]||m).join(' ¬∑ ') : '';
  document.getElementById('sdMeta').textContent = `${dateStr} ¬∑ ${s.duration_min ? s.duration_min + ' min' : ''}${modBadges ? ' ¬∑ ' + modBadges : ''}`;
  
  // Conditions
  document.getElementById('sdConditions').innerHTML = `
    <span class="db-cond-tag">${sizeNames[s.wave_size] || ''}</span>
    <span class="db-cond-tag">${'‚≠ê'.repeat(s.wave_quality || 0)}</span>
    <span class="db-cond-tag">${s.wind_condition || ''}</span>
    <span class="db-cond-tag">${s.crowd_factor || ''}</span>
    ${s.focus_area ? `<span class="db-cond-tag">üéØ ${s.focus_area}</span>` : ''}
  `;
  
  const ids = Object.keys(s.athlete_data || {});
  let totalP = 0, totalC = 0;
  
  // Athlete cards
  let athHtml = '';
  ids.forEach(id => {
    const a = athletes.find(x => x.id === id);
    const d = s.athlete_data[id];
    
    athHtml += `<div class="sd-ath-card">
      <div style="font-weight:800;font-size:14px;margin-bottom:8px">${a ? a.name : 'Atleta'}</div>`;
    
    if (hasTactical && d.paddled > 0) {
      const ratio = Math.round(d.caught / d.paddled * 100);
      const ratioColor = ratio >= 60 ? 'var(--green)' : ratio >= 40 ? 'var(--yellow)' : 'var(--red)';
      totalP += d.paddled || 0;
      totalC += d.caught || 0;
      
      const maneuvers = {};
      d.waves.forEach(w => { if (w.maneuvers) w.maneuvers.forEach(m => maneuvers[m] = (maneuvers[m] || 0) + 1); });
      const manStr = Object.entries(maneuvers).map(([m, c]) => `${m.toUpperCase()}√ó${c}`).join(' ');
      
      athHtml += `<div class="db-stat-grid">
        <div class="db-stat"><div class="db-stat-v">${d.paddled}</div><div class="db-stat-l">Rem√≥</div></div>
        <div class="db-stat"><div class="db-stat-v">${d.caught}</div><div class="db-stat-l">Atrap√≥</div></div>
        <div class="db-stat"><div class="db-stat-v" style="color:${ratioColor}">${ratio}%</div><div class="db-stat-l">Catch</div></div>
      </div>
      ${d.falls > 0 ? `<div style="font-size:12px;color:var(--red);font-weight:600">üí• ${d.falls} ca√≠da${d.falls > 1 ? 's' : ''}</div>` : ''}
      ${manStr ? `<div style="font-size:12px;color:var(--text-secondary);margin-top:6px">üèÑ ${manStr}</div>` : ''}`;
    }
    
    // Judge summary
    if (d.judge_summary) {
      const js = d.judge_summary;
      const scoreColor = js.avg_wave_score >= 6 ? 'var(--green)' : js.avg_wave_score >= 4 ? 'var(--yellow)' : 'var(--red)';
      athHtml += `<div style="margin-top:8px;padding:8px;background:var(--bg-input);border-radius:8px">
        <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:4px">‚öñÔ∏è Judging (${js.heat_count} heat${js.heat_count>1?'s':''})</div>
        <div class="db-stat-grid">
          <div class="db-stat"><div class="db-stat-v" style="color:var(--accent)">${js.avg_heat_total.toFixed(2)}</div><div class="db-stat-l">Avg Heat</div></div>
          <div class="db-stat"><div class="db-stat-v" style="color:${scoreColor}">${js.avg_wave_score.toFixed(2)}</div><div class="db-stat-l">Avg/Ola</div></div>
        </div>
        <div style="font-size:11px;color:var(--text-secondary);margin-top:4px">${js.heats.map((h,i)=>`H${i+1}: ${h.toFixed(2)}`).join(' ¬∑ ')}</div>
      </div>`;
    }
    
    athHtml += renderBioSummaryHTML(d);
    athHtml += renderWorkoutSummaryHTML(d);
    athHtml += `</div>`;
  });
  document.getElementById('sdAthletes').innerHTML = athHtml;
  
  // Team stats (adapted to modules)
  if (hasTactical && totalP > 0) {
    const teamRatio = Math.round(totalC / totalP * 100);
    document.getElementById('sdTeamStats').innerHTML = `
      <div class="db-stat-grid">
        <div class="db-stat"><div class="db-stat-v">${ids.length}</div><div class="db-stat-l">Atletas</div></div>
        <div class="db-stat"><div class="db-stat-v">${totalC}/${totalP}</div><div class="db-stat-l">Olas</div></div>
        <div class="db-stat"><div class="db-stat-v" style="color:${teamRatio>=60?'var(--green)':teamRatio>=40?'var(--yellow)':'var(--red)'}">${teamRatio}%</div><div class="db-stat-l">Catch</div></div>
      </div>`;
  } else {
    document.getElementById('sdTeamStats').innerHTML = `<div class="db-stat-grid">
      <div class="db-stat"><div class="db-stat-v">${ids.length}</div><div class="db-stat-l">Atletas</div></div>
    </div>`;
  }
  
  // Catch ratio chart (only if tactical)
  if (hasTactical && ids.length > 1 && totalP > 0) {
    document.getElementById('sdCharts').innerHTML = `<div class="card" style="padding:12px;margin-bottom:12px">
      <div style="font-size:11px;font-weight:700;color:var(--text-secondary);text-transform:uppercase;margin-bottom:8px">üìä Catch Ratio Comparado</div>
      ${ids.map(id => {
        const a = athletes.find(x => x.id === id);
        const d = s.athlete_data[id];
        const r = d.paddled > 0 ? Math.round(d.caught / d.paddled * 100) : 0;
        const c = r >= 60 ? 'var(--green)' : r >= 40 ? 'var(--yellow)' : 'var(--red)';
        return `<div class="pc-bar-row"><div class="pc-bar-label">${(a?a.name.split(' ')[0]:'?').slice(0,8)}</div><div class="pc-bar-track"><div class="pc-bar-fill" style="width:${r}%;background:${c}"></div></div><div class="pc-bar-val">${r}%</div></div>`;
      }).join('')}
    </div>`;
  } else { document.getElementById('sdCharts').innerHTML = ''; }
  
  // Notes
  if (s.coach_notes) {
    document.getElementById('sdNotesCard').style.display = 'block';
    document.getElementById('sdNotes').textContent = s.coach_notes;
  } else { document.getElementById('sdNotesCard').style.display = 'none'; }
}

// ============================================================
// ATHLETE PROGRESSION
// ============================================================
let _progressAthleteId = null;
let _progressReturn = 'athletes';

function openProgression(athleteId, returnView) {
  _progressAthleteId = athleteId;
  _progressReturn = returnView || 'athletes';
  showView('progress');
}

function renderProgress() {
  const a = DB.athletes.find(x => x.id === _progressAthleteId);
  if (!a) { showView('athletes'); return; }
  
  const sessions = DB.sessions.filter(s => s.athlete_data && s.athlete_data[a.id]);
  document.getElementById('progTitle').textContent = a.name;
  document.getElementById('progSubtitle').textContent = `${sessions.length} sesiones ¬∑ Nivel ${a.level || 'Intermedio'}`;
  
  if (sessions.length === 0) {
    document.getElementById('progKPIs').innerHTML = '<div style="text-align:center;color:var(--text-muted);padding:20px;width:100%">Sin datos de sesiones a√∫n</div>';
    return;
  }
  
  // Aggregate stats (module-aware)
  let totalP = 0, totalC = 0, totalF = 0, totalXP = 0;
  const catchRatios = [];
  const allManeuvers = {};
  const allBio = [];
  
  sessions.forEach(s => {
    const d = s.athlete_data[a.id];
    const mods = s.modules_used || [];
    const hasTactical = !s.modules_used || mods.includes('tactical');
    
    if (hasTactical) {
      totalP += d.paddled || 0;
      totalC += d.caught || 0;
      totalF += d.falls || 0;
      
      const ratio = d.paddled > 0 ? Math.round(d.caught / d.paddled * 100) : null;
      if (ratio !== null) catchRatios.push({ date: s.date || s.started_at, ratio, spot: s.spot });
      
      d.waves.forEach(w => {
        if (w.maneuvers) w.maneuvers.forEach(m => allManeuvers[m] = (allManeuvers[m] || 0) + 1);
      });
    }
    
    totalXP += d.xp_earned || 10;
    (d.biomech || []).forEach(b => allBio.push(b));
  });
  
  const avgRatio = catchRatios.length > 0 ? Math.round(catchRatios.reduce((s, r) => s + r.ratio, 0) / catchRatios.length) : 0;
  const avgColor = avgRatio >= 60 ? 'var(--green)' : avgRatio >= 40 ? 'var(--yellow)' : 'var(--red)';
  
  // Trend arrow
  let trend = '';
  if (catchRatios.length >= 3) {
    const recent = catchRatios.slice(-3).reduce((s, r) => s + r.ratio, 0) / 3;
    const older = catchRatios.slice(0, 3).reduce((s, r) => s + r.ratio, 0) / Math.min(3, catchRatios.length);
    trend = recent > older + 5 ? 'üìà' : recent < older - 5 ? 'üìâ' : '‚û°Ô∏è';
  }
  
  // KPIs
  document.getElementById('progKPIs').innerHTML = `
    <div class="dash-kpi"><div class="dash-kpi-val" style="color:${avgColor}">${avgRatio}% ${trend}</div><div class="dash-kpi-lbl">Catch Prom.</div></div>
    <div class="dash-kpi"><div class="dash-kpi-val">${totalC}/${totalP}</div><div class="dash-kpi-lbl">Olas Total</div></div>
    <div class="dash-kpi"><div class="dash-kpi-val" style="color:var(--accent)">${totalXP}</div><div class="dash-kpi-lbl">XP Total</div></div>
  `;
  
  // Catch ratio sparkline
  if (catchRatios.length >= 2) {
    const w = 300, h = 100, pad = 8;
    const pts = catchRatios.map((r, i) => {
      const x = pad + (i / (catchRatios.length - 1)) * (w - pad * 2);
      const y = h - pad - (r.ratio / 100) * (h - pad * 2);
      return `${x},${y}`;
    });
    const line = pts.join(' ');
    const areaPath = `M${pts[0]} ${pts.map(p => `L${p}`).join(' ')} L${pad + ((catchRatios.length - 1) / (catchRatios.length - 1)) * (w - pad * 2)},${h - pad} L${pad},${h - pad} Z`;
    
    document.getElementById('progCatchChart').innerHTML = `
      <svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none" style="width:100%;height:100%">
        <defs><linearGradient id="cg" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="var(--accent)" stop-opacity=".3"/>
          <stop offset="100%" stop-color="var(--accent)" stop-opacity=".02"/>
        </linearGradient></defs>
        <line x1="${pad}" y1="${h - pad - 60 / 100 * (h - pad * 2)}" x2="${w - pad}" y2="${h - pad - 60 / 100 * (h - pad * 2)}" stroke="var(--text-muted)" stroke-width=".5" stroke-dasharray="4,4"/>
        <path d="${areaPath}" fill="url(#cg)"/>
        <polyline points="${line}" fill="none" stroke="var(--accent)" stroke-width="2.5" stroke-linejoin="round" stroke-linecap="round"/>
        ${catchRatios.map((r, i) => {
          const x = pad + (i / (catchRatios.length - 1)) * (w - pad * 2);
          const y = h - pad - (r.ratio / 100) * (h - pad * 2);
          return `<circle cx="${x}" cy="${y}" r="3.5" fill="var(--accent)"/>`;
        }).join('')}
      </svg>
      <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--text-muted);margin-top:2px">
        ${catchRatios.map(r => `<span>${new Intl.DateTimeFormat('es', {day:'numeric', month:'short'}).format(new Date(r.date))}</span>`).join('')}
      </div>
    `;
  } else {
    document.getElementById('progCatchChart').innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:12px;padding:20px">Necesita al menos 2 sesiones para ver tendencia</div>';
  }
  
  // Biomechanics bars
  if (allBio.length > 0) {
    document.getElementById('progBioCard').style.display = 'block';
    const fields = ['bio_shoulders','bio_knees','bio_arms','bio_compression','bio_head','bio_backfoot','bio_weight'];
    const labels = ['Hombros','Rodillas','Brazos','Compresi√≥n','Cabeza','Pie Trasero','Trans. Peso'];
    
    document.getElementById('progBioBars').innerHTML = fields.map((f, i) => {
      const avg = bioAvgScore(allBio, f);
      const color = avg >= 60 ? 'var(--green)' : avg >= 30 ? 'var(--yellow)' : avg > 0 ? 'var(--red)' : 'var(--text-muted)';
      return `<div class="pc-bar-row"><div class="pc-bar-label">${labels[i]}</div><div class="pc-bar-track"><div class="pc-bar-fill" style="width:${avg}%;background:${color}"></div></div><div class="pc-bar-val">${avg}</div></div>`;
    }).join('');
  } else { document.getElementById('progBioCard').style.display = 'none'; }
  
  // Maneuvers frequency
  const sorted = Object.entries(allManeuvers).sort((a, b) => b[1] - a[1]);
  if (sorted.length > 0) {
    const maxCount = sorted[0][1];
    document.getElementById('progManeuvers').innerHTML = sorted.slice(0, 10).map(([m, c]) => {
      const pct = Math.round(c / maxCount * 100);
      return `<div class="pc-bar-row"><div class="pc-bar-label">${m.toUpperCase()}</div><div class="pc-bar-track"><div class="pc-bar-fill" style="width:${pct}%;background:var(--accent)"></div></div><div class="pc-bar-val">${c}</div></div>`;
    }).join('');
  } else {
    document.getElementById('progManeuvers').innerHTML = '<div style="color:var(--text-muted);font-size:12px">Sin datos</div>';
  }
  
  // XP timeline (uses xp_earned from session data)
  if (sessions.length >= 2) {
    let cumXP = 0;
    const xpPts = sessions.map(s => {
      const d = s.athlete_data[a.id];
      cumXP += d.xp_earned || 10;
      return { date: s.date || s.started_at, xp: cumXP };
    });
    
    const w = 300, h = 80, pad = 8;
    const maxXP = xpPts[xpPts.length - 1].xp;
    const pts = xpPts.map((p, i) => {
      const x = pad + (i / (xpPts.length - 1)) * (w - pad * 2);
      const y = h - pad - (p.xp / maxXP) * (h - pad * 2);
      return `${x},${y}`;
    });
    
    document.getElementById('progXPChart').innerHTML = `
      <svg viewBox="0 0 ${w} ${h}" preserveAspectRatio="none" style="width:100%;height:100%">
        <polyline points="${pts.join(' ')}" fill="none" stroke="var(--accent)" stroke-width="2.5" stroke-linejoin="round"/>
        <circle cx="${pts[pts.length-1].split(',')[0]}" cy="${pts[pts.length-1].split(',')[1]}" r="4" fill="var(--accent)"/>
      </svg>
      <div style="text-align:right;font-size:11px;font-weight:700;color:var(--accent)">${totalXP} XP</div>
    `;
  } else {
    document.getElementById('progXPChart').innerHTML = `<div style="text-align:center;font-size:20px;font-weight:800;color:var(--accent);padding:20px">${totalXP} XP</div>`;
  }
  
  // Session list (module-aware)
  document.getElementById('progSessions').innerHTML = sessions.slice().reverse().map(s => {
    const d = s.athlete_data[a.id];
    const mods = s.modules_used || [];
    const hasTac = !s.modules_used || mods.includes('tactical');
    const dateStr = new Intl.DateTimeFormat('es', { day:'numeric', month:'short' }).format(new Date(s.date || s.started_at));
    const idx = DB.sessions.indexOf(s);
    
    let detail, rightSide;
    if (hasTac && d.paddled > 0) {
      const ratio = Math.round(d.caught / d.paddled * 100);
      const color = ratio >= 60 ? 'var(--green)' : ratio >= 40 ? 'var(--yellow)' : 'var(--red)';
      detail = `${d.caught}/${d.paddled} olas`;
      rightSide = `<div style="font-weight:800;font-size:16px;color:${color}">${ratio}%</div>`;
    } else if (d.judge_summary) {
      detail = `${d.judge_summary.heat_count} heats`;
      rightSide = `<div style="font-weight:800;font-size:16px;color:var(--accent)">${d.judge_summary.avg_heat_total.toFixed(1)}</div>`;
    } else {
      const modIcons = mods.map(m => m==='workout'?'üí™':m==='biomech'?'ü¶¥':m==='lab'?'üé•':'').join('');
      detail = modIcons || 'sesi√≥n';
      rightSide = `<div style="font-size:12px;color:var(--text-muted)">‚úì</div>`;
    }
    
    return `<div class="pc-hist-item" onclick="openSessionDetail(${idx})" style="cursor:pointer">
      <div><strong>${s.spot}</strong><div style="font-size:11px;color:var(--text-muted)">${dateStr} ¬∑ ${detail}</div></div>
      ${rightSide}
    </div>`;
  }).join('');
}

// ============================================================
// ATHLETES
// ============================================================
function renderAthletes() {
  const athletes = DB.athletes;
  const container = document.getElementById('athList');
  const empty = document.getElementById('athEmpty');
  
  if (athletes.length === 0) {
    container.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';
  
  container.innerHTML = '<div class="card" style="padding:0;overflow:hidden">' + athletes.map(a => {
    const initials = a.name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
    const xp = a.xp_total || 0;
    const lvl = calcLevel(xp);
    const sessCount = a.sessions_count || 0;
    const heatCount = (a.heat_history || []).length;
    
    return `<div class="ath-item" onclick="openPlayerCard('${a.id}')" style="cursor:pointer">
      <div class="ath-avi">${initials}</div>
      <div class="ath-info">
        <div class="ath-name">${a.name}</div>
        <div class="ath-sub">${LEVEL_NAMES[lvl.level]} (Lv${lvl.level}) ¬∑ ${a.stance || 'Regular'} ¬∑ ${sessCount}s ${heatCount}h ¬∑ ${xp} XP</div>
      </div>
      <span style="color:var(--text-muted);font-size:14px">‚Ä∫</span>
    </div>`;
  }).join('') + '</div>';
}

function openAddAthleteModal() {
  document.getElementById('maName').value = '';
  document.getElementById('maAge').value = '';
  window._editAthleteId = null;
  segSelect('maStance', document.querySelector('#maStance .seg-btn[data-v="regular"]'));
  document.getElementById('modalAddAthlete').classList.add('active');
  setTimeout(() => document.getElementById('maName').focus(), 300);
}

function closeModal(id) {
  document.getElementById(id).classList.remove('active');
}

function saveNewAthlete() {
  const name = document.getElementById('maName').value.trim();
  if (!name) { alert('Ingresa el nombre del atleta'); return; }
  
  const stance = getSegValue('maStance');
  const age = parseInt(document.getElementById('maAge').value) || null;
  
  const athletes = DB.athletes;
  
  if (window._editAthleteId) {
    // Edit mode
    const a = athletes.find(x => x.id === window._editAthleteId);
    if (a) { a.name = name; a.stance = stance; a.age = age; }
    window._editAthleteId = null;
  } else {
    // New athlete
    athletes.push({
      id: DB.genId(),
      name,
      stance,
      age,
      level: 1,
      xp_total: 0,
      sessions_count: 0,
      drills_completed: 0,
      assigned_drills: [],
      heat_history: [],
      created_at: new Date().toISOString()
    });
  }
  DB.athletes = athletes;
  
  closeModal('modalAddAthlete');
  
  if (currentView === 'athletes') renderAthletes();
  if (currentView === 'session-setup') renderSSAthletes();
  if (currentView === 'player-card') renderPlayerCard();
}

function deleteAthlete(id) {
  if (!confirm('¬øEliminar este atleta?')) return;
  DB.athletes = DB.athletes.filter(a => a.id !== id);
  renderAthletes();
}

// ============================================================
// PHASE 2: GAMIFICATION ENGINE
// ============================================================
const XP_THRESHOLDS = [0, 100, 400, 1000, 2000, 3500, 5700, 8700, 12700, 18200];
const LEVEL_NAMES = { 1:'Kook', 2:'Grom', 3:'Grom+', 4:'Ripper', 5:'Ripper+', 6:'Charger', 7:'Charger+', 8:'Pro', 9:'Pro+', 10:'Legend' };
const LEVEL_COLORS = { 1:'#94a3b8', 2:'#38bdf8', 3:'#38bdf8', 4:'#22c55e', 5:'#22c55e', 6:'#f59e0b', 7:'#f59e0b', 8:'#a855f7', 9:'#a855f7', 10:'#ef4444' };

function calcLevel(xp) {
  let level = 1;
  for (let i = 1; i < XP_THRESHOLDS.length; i++) {
    if (xp >= XP_THRESHOLDS[i]) level = i + 1;
  }
  const curr = XP_THRESHOLDS[level - 1] || 0;
  const next = XP_THRESHOLDS[level] || XP_THRESHOLDS[XP_THRESHOLDS.length - 1] + 5000;
  const pct = Math.min(100, ((xp - curr) / (next - curr)) * 100);
  return { level, name: LEVEL_NAMES[level], xp, curr, next, pct };
}

const BADGE_DEFS = [
  { id:'first_session', icon:'üåä', name:'Primera Sesi√≥n', desc:'Completa tu primera sesi√≥n', check: a => (a.sessions_count||0) >= 1 },
  { id:'ten_sessions', icon:'üîü', name:'10 Sesiones', desc:'Completa 10 sesiones', check: a => (a.sessions_count||0) >= 10 },
  { id:'wave_hunter', icon:'üèÑ', name:'Cazador de Olas', desc:'Atrapa 50 olas', check: a => getTotalCaught(a) >= 50 },
  { id:'wave_machine', icon:'üåä', name:'M√°quina de Olas', desc:'Atrapa 200 olas', check: a => getTotalCaught(a) >= 200 },
  { id:'sharp_eye', icon:'üëÅÔ∏è', name:'Ojo Agudo', desc:'Catch ratio > 60%', check: a => getOverallCatchRatio(a) > 60 },
  { id:'sniper', icon:'üéØ', name:'Sniper', desc:'Catch ratio > 80%', check: a => getOverallCatchRatio(a) > 80 },
  { id:'competitor', icon:'‚öñÔ∏è', name:'Competidor', desc:'Completa tu primer heat', check: a => (a.heat_history||[]).length >= 1 },
  { id:'heat_veteran', icon:'üèÖ', name:'Veterano', desc:'Completa 10 heats', check: a => (a.heat_history||[]).length >= 10 },
  { id:'podium', icon:'ü•á', name:'Podio', desc:'Termina 1ro en un heat', check: a => (a.heat_history||[]).some(h => h.position === 1) },
  { id:'high_scorer', icon:'üíé', name:'High Scorer', desc:'Avg por ola > 6.0', check: a => getAvgWaveScore(a) > 6 },
  { id:'drill_starter', icon:'üèãÔ∏è', name:'Entrenador', desc:'Completa tu primer drill', check: a => (a.drills_completed||0) >= 1 },
  { id:'drill_master', icon:'üí™', name:'Drill Master', desc:'Completa 20 drills', check: a => (a.drills_completed||0) >= 20 },
];

function getTotalCaught(a) {
  const sessions = DB.sessions;
  let total = 0;
  sessions.forEach(s => {
    if (s.athlete_data && s.athlete_data[a.id] && (!s.modules_used || s.modules_used.includes('tactical')))
      total += s.athlete_data[a.id].caught || 0;
  });
  return total;
}

function getTotalPaddled(a) {
  const sessions = DB.sessions;
  let total = 0;
  sessions.forEach(s => {
    if (s.athlete_data && s.athlete_data[a.id] && (!s.modules_used || s.modules_used.includes('tactical')))
      total += s.athlete_data[a.id].paddled || 0;
  });
  return total;
}

function getOverallCatchRatio(a) {
  const p = getTotalPaddled(a);
  return p > 0 ? Math.round(getTotalCaught(a) / p * 100) : 0;
}

function getAvgWaveScore(a) {
  const heats = a.heat_history || [];
  const avgs = heats.filter(h => h.all_wave_avg > 0).map(h => h.all_wave_avg);
  return avgs.length > 0 ? avgs.reduce((s, v) => s + v, 0) / avgs.length : 0;
}

function getEarnedBadges(a) {
  return BADGE_DEFS.map(b => ({ ...b, earned: b.check(a) }));
}

// ============================================================
// PHASE 2: PLAYER CARD
// ============================================================
let _pcAthleteId = null;

function openPlayerCard(id) {
  _pcAthleteId = id;
  showView('player-card');
}

function renderPlayerCard() {
  const a = DB.athletes.find(x => x.id === _pcAthleteId);
  if (!a) { showView('athletes'); return; }
  
  const initials = a.name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
  const lvl = calcLevel(a.xp_total || 0);
  
  // Header
  document.getElementById('pcAvi').textContent = initials;
  document.getElementById('pcName').textContent = a.name;
  document.getElementById('pcSub').textContent = `${a.stance || 'Regular'} ¬∑ ${a.age ? a.age + ' a√±os' : ''}`;
  document.getElementById('pcLevel').textContent = `${lvl.name} ¬∑ Nivel ${lvl.level}`;
  document.getElementById('pcLevel').style.background = `linear-gradient(135deg,${LEVEL_COLORS[lvl.level]},${LEVEL_COLORS[Math.min(10,lvl.level+1)]})`;
  document.getElementById('pcXpFill').style.width = lvl.pct + '%';
  document.getElementById('pcXpText').textContent = `${lvl.xp} / ${lvl.next} XP`;
  
  // Stats
  const sessCount = a.sessions_count || 0;
  const heatCount = (a.heat_history || []).length;
  const totalCaught = getTotalCaught(a);
  const catchRatio = getOverallCatchRatio(a);
  const avgScore = getAvgWaveScore(a);
  
  document.getElementById('pcStats').innerHTML = [
    { val: sessCount, lbl: 'Sesiones', color: 'var(--accent)' },
    { val: totalCaught, lbl: 'Olas', color: 'var(--green)' },
    { val: catchRatio + '%', lbl: 'Catch %', color: catchRatio >= 60 ? 'var(--green)' : catchRatio >= 40 ? 'var(--yellow)' : 'var(--red)' },
    { val: avgScore > 0 ? avgScore.toFixed(1) : '‚Äî', lbl: 'Avg Score', color: avgScore >= 6 ? 'var(--green)' : avgScore >= 4 ? 'var(--yellow)' : 'var(--text-primary)' },
  ].map(s => `<div class="pc-stat"><div class="pc-stat-val" style="color:${s.color}">${s.val}</div><div class="pc-stat-lbl">${s.lbl}</div></div>`).join('');
  
  // Badges
  const badges = getEarnedBadges(a);
  const earned = badges.filter(b => b.earned);
  const locked = badges.filter(b => !b.earned);
  document.getElementById('pcBadges').innerHTML = 
    earned.map(b => `<div class="pc-badge earned"><span class="pc-badge-icon">${b.icon}</span><div class="pc-badge-info"><div class="pc-badge-name">${b.name}</div><div class="pc-badge-desc">${b.desc}</div></div></div>`).join('') +
    locked.slice(0, 4).map(b => `<div class="pc-badge locked"><span class="pc-badge-icon">üîí</span><div class="pc-badge-info"><div class="pc-badge-name">${b.name}</div><div class="pc-badge-desc">${b.desc}</div></div></div>`).join('');
  
  // Catch Ratio Chart (only from tactical sessions)
  const sessions = DB.sessions;
  const athSessions = sessions.filter(s => s.athlete_data && s.athlete_data[a.id] && (!s.modules_used || s.modules_used.includes('tactical'))).slice(-8);
  const catchChart = document.getElementById('pcCatchChart');
  if (athSessions.length > 0) {
    catchChart.style.display = 'block';
    document.getElementById('pcCatchBars').innerHTML = athSessions.map((s, i) => {
      const d = s.athlete_data[a.id];
      const ratio = d.paddled > 0 ? Math.round(d.caught / d.paddled * 100) : 0;
      const color = ratio >= 60 ? 'var(--green)' : ratio >= 40 ? 'var(--yellow)' : 'var(--red)';
      const label = s.spot.split(' ')[0].slice(0, 6);
      return `<div class="pc-bar-row"><div class="pc-bar-label">${label}</div><div class="pc-bar-track"><div class="pc-bar-fill" style="width:${ratio}%;background:${color}"></div></div><div class="pc-bar-val">${ratio}%</div></div>`;
    }).join('');
  } else { catchChart.style.display = 'none'; }
  
  // Score Distribution Chart (from heats)
  const heats = a.heat_history || [];
  const scoreChart = document.getElementById('pcScoreChart');
  if (heats.length > 0) {
    scoreChart.style.display = 'block';
    const recent = heats.slice(-8);
    document.getElementById('pcScoreBars').innerHTML = recent.map(h => {
      const pct = Math.min(100, (h.total / 20) * 100);
      const avgPct = h.all_wave_avg > 0 ? Math.min(100, (h.all_wave_avg / 10) * 100) : 0;
      const color = h.all_wave_avg >= 6 ? 'var(--green)' : h.all_wave_avg >= 4 ? 'var(--yellow)' : 'var(--red)';
      const label = `H${h.heat_number||'?'}`;
      return `<div class="pc-bar-row"><div class="pc-bar-label">${label}</div><div class="pc-bar-track"><div class="pc-bar-fill" style="width:${pct}%;background:var(--accent)"></div></div><div class="pc-bar-val">${h.total.toFixed(1)}</div></div>
      <div class="pc-bar-row" style="margin-top:-2px"><div class="pc-bar-label" style="font-size:9px">avg/w</div><div class="pc-bar-track" style="height:8px"><div class="pc-bar-fill" style="width:${avgPct}%;background:${color};height:100%"></div></div><div class="pc-bar-val" style="font-size:10px">${h.all_wave_avg.toFixed(1)}</div></div>`;
    }).join('');
  } else { scoreChart.style.display = 'none'; }
  
  // Active Drills
  const drills = a.assigned_drills || [];
  const drillsCard = document.getElementById('pcDrillsCard');
  drillsCard.style.display = 'block';
  if (drills.length > 0) {
    document.getElementById('pcDrills').innerHTML = drills.map(d => {
      const def = DRILL_LIBRARY.find(x => x.id === d.drill_id);
      if (!def) return '';
      return `<div class="drill-card" style="margin-bottom:6px;padding:10px">
        <div class="drill-header"><span class="drill-name">${def.icon} ${def.name}</span>
        <div style="display:flex;gap:4px">
          <button class="btn btn-sm" onclick="completeDrill('${a.id}','${d.drill_id}')" style="width:auto;padding:4px 10px;font-size:11px;background:var(--green)">‚úì</button>
          <button class="btn btn-sm" onclick="unassignDrill('${a.id}','${d.drill_id}')" style="width:auto;padding:4px 8px;font-size:11px;background:var(--bg-input)">√ó</button>
        </div></div>
        <div class="drill-desc">${def.desc}</div>
      </div>`;
    }).join('');
  } else {
    document.getElementById('pcDrills').innerHTML = '<div style="font-size:12px;color:var(--text-muted);padding:4px 0">Sin drills asignados</div>';
  }
  
  // Heat History
  const heatCard = document.getElementById('pcHeatCard');
  if (heats.length > 0) {
    heatCard.style.display = 'block';
    document.getElementById('pcHeats').innerHTML = heats.slice().reverse().slice(0, 10).map(h => {
      const posEmoji = h.position === 1 ? 'ü•á' : h.position === 2 ? 'ü•à' : h.position === 3 ? 'ü•â' : h.position + 'th';
      const d = new Date(h.date);
      const dateStr = new Intl.DateTimeFormat('es', { day:'numeric', month:'short' }).format(d);
      return `<div class="pc-hist-item"><div><strong>${posEmoji}</strong> H${h.heat_number||'?'} ¬∑ ${h.category||'?'} ¬∑ ${h.round||'?'}<div style="font-size:11px;color:var(--text-muted)">${dateStr} ¬∑ ${h.location||'?'} ¬∑ avg ${h.all_wave_avg?.toFixed(1)||'?'}/wave</div></div><div style="font-weight:800;font-size:16px">${h.total.toFixed(2)}</div></div>`;
    }).join('');
  } else { heatCard.style.display = 'none'; }
  
  // Session History (module-aware display)
  const athSess = sessions.filter(s => s.athlete_data && s.athlete_data[a.id]);
  const sessCard = document.getElementById('pcSessionCard');
  if (athSess.length > 0) {
    sessCard.style.display = 'block';
    document.getElementById('pcSessions').innerHTML = athSess.slice().reverse().slice(0, 10).map(s => {
      const d = s.athlete_data[a.id];
      const mods = s.modules_used || [];
      const hasTac = !s.modules_used || mods.includes('tactical');
      const dateStr = new Intl.DateTimeFormat('es', { day:'numeric', month:'short' }).format(new Date(s.date || s.started_at));
      
      let detail = '';
      let rightSide = '';
      
      if (hasTac && d.paddled > 0) {
        const ratio = Math.round(d.caught / d.paddled * 100);
        detail = `${d.caught}/${d.paddled} olas`;
        rightSide = `<div style="font-weight:800;font-size:16px;color:${ratio>=60?'var(--green)':ratio>=40?'var(--yellow)':'var(--red)'}">${ratio}%</div>`;
      } else if (d.judge_summary) {
        detail = `${d.judge_summary.heat_count} heats ¬∑ avg ${d.judge_summary.avg_wave_score.toFixed(1)}/ola`;
        rightSide = `<div style="font-weight:800;font-size:16px;color:var(--accent)">${d.judge_summary.avg_heat_total.toFixed(1)}</div>`;
      } else {
        const modLabels = mods.map(m => m === 'workout' ? 'üí™' : m === 'biomech' ? 'ü¶¥' : m === 'lab' ? 'üé•' : '').join('');
        detail = modLabels || 'sesi√≥n';
        rightSide = `<div style="font-size:12px;color:var(--text-muted)">‚úì</div>`;
      }
      
      return `<div class="pc-hist-item"><div><strong>${s.spot}</strong><div style="font-size:11px;color:var(--text-muted)">${dateStr} ¬∑ ${detail}</div></div>${rightSide}</div>`;
    }).join('');
  } else { sessCard.style.display = 'none'; }
  
  // Judge Training Sessions (from session judge_summary)
  const judgeSessions = athSess.filter(s => s.athlete_data[a.id].judge_summary);
  const judgeTrainCard = document.getElementById('pcJudgeTrainCard');
  if (judgeTrainCard) {
    if (judgeSessions.length > 0) {
      judgeTrainCard.style.display = 'block';
      let totalHeats = 0, allAvgWaves = [], allAvgTotals = [];
      judgeSessions.forEach(s => {
        const js = s.athlete_data[a.id].judge_summary;
        totalHeats += js.heat_count || 0;
        if (js.avg_wave_score > 0) allAvgWaves.push(js.avg_wave_score);
        if (js.avg_heat_total > 0) allAvgTotals.push(js.avg_heat_total);
      });
      const overallWaveAvg = allAvgWaves.length > 0 ? allAvgWaves.reduce((a,b)=>a+b,0)/allAvgWaves.length : 0;
      const overallHeatAvg = allAvgTotals.length > 0 ? allAvgTotals.reduce((a,b)=>a+b,0)/allAvgTotals.length : 0;
      const wColor = overallWaveAvg >= 6 ? 'var(--green)' : overallWaveAvg >= 4 ? 'var(--yellow)' : 'var(--red)';
      
      let html = `<div class="db-stat-grid" style="margin-bottom:8px">
        <div class="db-stat"><div class="db-stat-v">${judgeSessions.length}</div><div class="db-stat-l">Sesiones</div></div>
        <div class="db-stat"><div class="db-stat-v">${totalHeats}</div><div class="db-stat-l">Heats</div></div>
        <div class="db-stat"><div class="db-stat-v" style="color:${wColor}">${overallWaveAvg.toFixed(1)}</div><div class="db-stat-l">Avg/Ola</div></div>
        <div class="db-stat"><div class="db-stat-v" style="color:var(--accent)">${overallHeatAvg.toFixed(1)}</div><div class="db-stat-l">Avg Heat</div></div>
      </div>`;
      
      // Recent sessions
      html += judgeSessions.slice(-5).reverse().map(s => {
        const js = s.athlete_data[a.id].judge_summary;
        const dateStr = new Intl.DateTimeFormat('es', { day:'numeric', month:'short' }).format(new Date(s.date || s.started_at));
        return `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px">
          <div>${s.spot} ¬∑ ${dateStr} ¬∑ ${js.heat_count} heat${js.heat_count>1?'s':''}</div>
          <div style="font-weight:700;color:var(--accent)">${js.avg_heat_total.toFixed(1)}</div>
        </div>`;
      }).join('');
      
      document.getElementById('pcJudgeTrainContent').innerHTML = html;
    } else { judgeTrainCard.style.display = 'none'; }
  }
  
  // Biomechanics history across sessions
  const allBio = athSess.flatMap(s => (s.athlete_data[a.id].biomech || []).map(b => ({ ...b, spot: s.spot, date: s.date || s.started_at })));
  const bioCard = document.getElementById('pcBioCard');
  if (bioCard) {
    if (allBio.length > 0) {
      bioCard.style.display = 'block';
      const fields = ['bio_shoulders','bio_knees','bio_arms','bio_compression','bio_head','bio_backfoot','bio_weight'];
      const labels = ['Hombros','Rodillas','Brazos','Compresi√≥n','Cabeza','Pie Trasero','Trans. Peso'];
      
      let barsHtml = fields.map((f, i) => {
        const avg = bioAvgScore(allBio, f);
        const color = avg >= 60 ? 'var(--green)' : avg >= 30 ? 'var(--yellow)' : avg > 0 ? 'var(--red)' : 'var(--text-muted)';
        return `<div class="pc-bar-row"><div class="pc-bar-label">${labels[i]}</div><div class="pc-bar-track"><div class="pc-bar-fill" style="width:${avg}%;background:${color}"></div></div><div class="pc-bar-val">${avg}</div></div>`;
      }).join('');
      
      const flows = allBio.map(b => parseInt(b.bio_flow)).filter(n => !isNaN(n));
      const avgFlow = flows.length > 0 ? (flows.reduce((a,b)=>a+b,0)/flows.length).toFixed(1) : '‚Äî';
      
      document.getElementById('pcBioContent').innerHTML = `
        <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px">${allBio.length} evaluaciones biomec√°nicas</div>
        ${barsHtml}
        <div style="font-size:13px;margin-top:8px">Fluidez promedio: <strong>${avgFlow}/5</strong></div>
      `;
    } else { bioCard.style.display = 'none'; }
  }
  
  // Biometrics
  renderBiometrics(a);
  
  // Lab frames for this athlete
  renderLabFramesForAthlete(a);
}

function deleteAthleteFromCard() {
  if (!confirm('¬øEliminar este atleta y todo su historial?')) return;
  DB.athletes = DB.athletes.filter(a => a.id !== _pcAthleteId);
  showView('athletes');
}

function editAthlete() {
  const a = DB.athletes.find(x => x.id === _pcAthleteId);
  if (!a) return;
  document.getElementById('maName').value = a.name;
  document.getElementById('maAge').value = a.age || '';
  segSelect('maStance', document.querySelector(`#maStance .seg-btn[data-v="${a.stance||'regular'}"]`));
  window._editAthleteId = _pcAthleteId;
  document.getElementById('modalAddAthlete').classList.add('active');
}

// ============================================================
// PHASE 2: DRILL BANK
// ============================================================
const DRILL_LIBRARY = [
  // PADDLING
  { id:'d01', cat:'Paddling', icon:'üèä', name:'Sprint Paddle', desc:'5 sprints de 20 seg con 10 seg descanso. Enf√≥cate en la cadencia y mantener la cabeza baja.', duration:'5 min', level:'Todos' },
  { id:'d02', cat:'Paddling', icon:'üèä', name:'Duck Dive Drill', desc:'Practica duck dive en espuma con tabla grande. Repite 10 veces sin perder ritmo de remada.', duration:'10 min', level:'Grom+' },
  { id:'d03', cat:'Paddling', icon:'üèä', name:'Endurance Paddle', desc:'Rema continuo por 15 min manteniendo postura. Ideal como calentamiento.', duration:'15 min', level:'Todos' },
  
  // POP-UP
  { id:'d04', cat:'Pop-up', icon:'ü§∏', name:'Pop-up en Arena', desc:'20 repeticiones de pop-up en la arena. Tiempo objetivo: < 1 segundo. Enf√≥cate en un movimiento fluido.', duration:'10 min', level:'Kook' },
  { id:'d05', cat:'Pop-up', icon:'ü§∏', name:'Pop-up con Giro', desc:'Pop-up + giro inmediato 45¬∞. Simula el take-off en olas con √°ngulo. 15 reps por lado.', duration:'10 min', level:'Grom+' },
  
  // BOTTOM TURN
  { id:'d06', cat:'Bottom Turn', icon:'üí™', name:'BT Compression', desc:'En espuma: enf√≥cate en flexionar las rodillas y comprimir al fondo de la ola antes de subir. 10 olas.', duration:'20 min', level:'Grom+' },
  { id:'d07', cat:'Bottom Turn', icon:'üí™', name:'BT Rail Engage', desc:'Toma 5 olas concentr√°ndote solo en hundir el rail durante el bottom turn. Mano trasera toca el agua.', duration:'20 min', level:'Ripper' },
  
  // MANEUVERS
  { id:'d08', cat:'Maniobras', icon:'üî•', name:'Cutback Drill', desc:'Toma 5 olas y enf√≥cate en hacer cutback completo volviendo a la espuma. Prioriza el arco.', duration:'25 min', level:'Ripper' },
  { id:'d09', cat:'Maniobras', icon:'üî•', name:'Snap Practice', desc:'En secci√≥n vertical, practica snaps con m√°xima rotaci√≥n. 5 olas enfocado solo en el snap.', duration:'20 min', level:'Ripper+' },
  { id:'d10', cat:'Maniobras', icon:'üî•', name:'Floater Line', desc:'Busca secciones cerrando para practicar floaters. Enf√≥cate en timing y aterrizaje. 5 intentos.', duration:'20 min', level:'Ripper' },
  { id:'d11', cat:'Maniobras', icon:'üî•', name:'Re-entry Drill', desc:'En olas con labio definido, practica re-entries. Enf√≥cate en el timing del lip.', duration:'20 min', level:'Charger' },
  
  // WAVE READING
  { id:'d12', cat:'Lectura', icon:'üëÅÔ∏è', name:'Set Prediction', desc:'Desde la orilla, predice cu√°l ola del set ser√° la mejor. Cuenta sets por 15 min. Anota aciertos.', duration:'15 min', level:'Todos' },
  { id:'d13', cat:'Lectura', icon:'üëÅÔ∏è', name:'Lineup Study', desc:'Observa el lineup 10 min antes de entrar. Identifica: pico, corriente, secci√≥n m√°s larga, frecuencia de sets.', duration:'10 min', level:'Todos' },
  { id:'d14', cat:'Lectura', icon:'üëÅÔ∏è', name:'Priority Game', desc:'En sesi√≥n con amigos, practica reglas de prioridad ISA. Trabaja posicionamiento sin interferir.', duration:'30 min', level:'Grom+' },
  
  // FITNESS
  { id:'d15', cat:'Fitness', icon:'üèãÔ∏è', name:'Indo Board 5min', desc:'5 minutos de balance en Indo Board o similar. Trabaja front/backside shifts.', duration:'5 min', level:'Todos' },
  { id:'d16', cat:'Fitness', icon:'üèãÔ∏è', name:'Core Circuit', desc:'30s plank + 15 V-ups + 20 russian twists + 10 superman. 3 rondas.', duration:'15 min', level:'Todos' },
  { id:'d17', cat:'Fitness', icon:'üèãÔ∏è', name:'Squat Series', desc:'20 squats + 10 jump squats + 10 pistol squats (por pierna). Potencia para bottom turns.', duration:'10 min', level:'Grom+' },
  
  // MENTAL
  { id:'d18', cat:'Mental', icon:'üß†', name:'Visualizaci√≥n', desc:'Cierra los ojos y visualiza tu sesi√≥n ideal: el take-off perfecto, la maniobra, la salida. 5 minutos.', duration:'5 min', level:'Todos' },
  { id:'d19', cat:'Mental', icon:'üß†', name:'Heat Simulation', desc:'Antes de competir: visualiza tu heat. Prioridad, selecci√≥n de olas, combinaci√≥n de scores.', duration:'10 min', level:'Ripper+' },
];

const DRILL_CATS = ['Todos', 'Paddling', 'Pop-up', 'Bottom Turn', 'Maniobras', 'Lectura', 'Fitness', 'Mental'];

function renderDrillBank() {
  let activeCat = window._drillCat || 'Todos';
  
  // Category filters
  document.getElementById('drillCatFilter').innerHTML = DRILL_CATS.map(c =>
    `<button class="drill-cat-btn ${c === activeCat ? 'active' : ''}" onclick="filterDrills('${c}')">${c}</button>`
  ).join('');
  
  // Filtered drills
  const filtered = activeCat === 'Todos' ? DRILL_LIBRARY : DRILL_LIBRARY.filter(d => d.cat === activeCat);
  
  document.getElementById('drillList').innerHTML = filtered.map(d => {
    return `<div class="drill-card">
      <div class="drill-header"><span class="drill-name">${d.icon} ${d.name}</span><span class="drill-cat">${d.cat}</span></div>
      <div class="drill-desc">${d.desc}</div>
      <div class="drill-meta"><span>‚è±Ô∏è ${d.duration}</span><span>üìä ${d.level}</span></div>
    </div>`;
  }).join('');
}

function filterDrills(cat) {
  window._drillCat = cat;
  renderDrillBank();
}

function openDrillPicker() {
  const a = DB.athletes.find(x => x.id === _pcAthleteId);
  if (!a) return;
  const assigned = (a.assigned_drills || []).map(d => d.drill_id);
  let activeCat = 'Todos';
  
  function render(cat) {
    activeCat = cat;
    document.getElementById('dpCatFilter').innerHTML = DRILL_CATS.map(c =>
      `<button class="drill-cat-btn ${c === activeCat ? 'active' : ''}" onclick="dpFilter('${c}')">${c}</button>`
    ).join('');
    
    const filtered = activeCat === 'Todos' ? DRILL_LIBRARY : DRILL_LIBRARY.filter(d => d.cat === activeCat);
    document.getElementById('dpDrillList').innerHTML = filtered.map(d => {
      const isAssigned = assigned.includes(d.id);
      return `<div class="drill-card ${isAssigned ? 'assigned' : ''}" style="padding:10px">
        <div class="drill-header">
          <span class="drill-name" style="font-size:13px">${d.icon} ${d.name}</span>
          ${isAssigned ? '<span style="color:var(--green);font-size:12px;font-weight:700">‚úì Asignado</span>' : 
            `<button class="btn btn-sm" onclick="assignDrill('${a.id}','${d.id}')" style="width:auto;padding:4px 10px;font-size:11px;background:var(--accent)">+ Asignar</button>`}
        </div>
        <div class="drill-desc" style="font-size:11px">${d.desc}</div>
      </div>`;
    }).join('');
  }
  
  window.dpFilter = (cat) => render(cat);
  render('Todos');
  document.getElementById('modalDrillPicker').classList.add('active');
}

function assignDrill(athId, drillId) {
  const athletes = DB.athletes;
  const a = athletes.find(x => x.id === athId);
  if (!a) return;
  if (!a.assigned_drills) a.assigned_drills = [];
  if (a.assigned_drills.some(d => d.drill_id === drillId)) return;
  a.assigned_drills.push({ drill_id: drillId, assigned_at: new Date().toISOString() });
  DB.athletes = athletes;
  openDrillPicker(); // Refresh picker
  renderPlayerCard(); // Refresh card
}

function unassignDrill(athId, drillId) {
  const athletes = DB.athletes;
  const a = athletes.find(x => x.id === athId);
  if (!a) return;
  a.assigned_drills = (a.assigned_drills || []).filter(d => d.drill_id !== drillId);
  DB.athletes = athletes;
  renderPlayerCard();
}

function completeDrill(athId, drillId) {
  const athletes = DB.athletes;
  const a = athletes.find(x => x.id === athId);
  if (!a) return;
  
  // Remove from assigned
  a.assigned_drills = (a.assigned_drills || []).filter(d => d.drill_id !== drillId);
  
  // Track completion
  a.drills_completed = (a.drills_completed || 0) + 1;
  
  // Award XP
  a.xp_total = (a.xp_total || 0) + 25;
  
  DB.athletes = athletes;
  renderPlayerCard();
  
  if (navigator.vibrate) navigator.vibrate([30, 50, 30]);
}

// ============================================================
// PHASE 3: TECH LAB - VIDEO ANALYSIS
// ============================================================
let labVideoFile = null;
let labDrawTool = 'none';
let labDrawColor = '#ef4444';
let labStrokeWidth = 4;
let labDrawing = false;
let labDrawPoints = [];
let labAnnotations = [];
let labAnglePoints = [];
let labIsFullscreen = false;

function labEnterFullscreen() {
  const container = document.getElementById('labFsContainer');
  const nav = document.querySelector('.bottom-nav');
  
  container.classList.add('lab-fullscreen');
  if (nav) nav.style.display = 'none';
  document.getElementById('labFsClose').style.display = 'flex';
  document.getElementById('labFsExpand').style.display = 'none';
  document.body.style.overflow = 'hidden';
  labIsFullscreen = true;
  
  // Try native fullscreen API (works on some mobile browsers)
  try {
    if (container.requestFullscreen) container.requestFullscreen();
    else if (container.webkitRequestFullscreen) container.webkitRequestFullscreen();
  } catch(e) { /* CSS fullscreen fallback is fine */ }
  
  // Force screen to stay on if possible
  try { if (navigator.wakeLock) navigator.wakeLock.request('screen'); } catch(e) {}
  
  // Resize canvas after layout settles
  setTimeout(labResizeCanvas, 100);
}

function labExitFullscreen() {
  const container = document.getElementById('labFsContainer');
  const nav = document.querySelector('.bottom-nav');
  
  container.classList.remove('lab-fullscreen');
  if (nav) nav.style.display = '';
  document.getElementById('labFsClose').style.display = 'none';
  document.getElementById('labFsExpand').style.display = 'flex';
  document.body.style.overflow = '';
  labIsFullscreen = false;
  
  // Exit native fullscreen
  try {
    if (document.exitFullscreen) document.exitFullscreen();
    else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
  } catch(e) {}
  
  setTimeout(labResizeCanvas, 100);
}

// Listen for ESC / native fullscreen exit
document.addEventListener('fullscreenchange', () => {
  if (!document.fullscreenElement && labIsFullscreen) labExitFullscreen();
});
document.addEventListener('webkitfullscreenchange', () => {
  if (!document.webkitFullscreenElement && labIsFullscreen) labExitFullscreen();
});

function renderLab() {
  // Populate athlete dropdown
  const sel = document.getElementById('labAthlete');
  const athletes = DB.athletes;
  sel.innerHTML = '<option value="">‚Äî Sin vincular ‚Äî</option>' +
    athletes.map(a => `<option value="${a.id}">${a.name}</option>`).join('');
  
  // Render saved frames
  renderLabFrames();
  renderLabClips();
}

function labLoadVideo(input) {
  const file = input.files[0];
  if (!file) return;
  labVideoFile = file;
  
  const video = document.getElementById('labVideo');
  const url = URL.createObjectURL(file);
  video.src = url;
  video.load();
  
  video.onloadedmetadata = () => {
    document.getElementById('labPlayerSection').style.display = 'block';
    document.getElementById('labTimeline').max = video.duration;
    labResizeCanvas();
    labAnnotations = [];
  };
  
  video.ontimeupdate = () => {
    if (!video.paused) {
      document.getElementById('labTimeline').value = video.currentTime;
      labUpdateTime();
    }
  };
  
  video.onended = () => {
    document.getElementById('labPlayBtn').textContent = '‚ñ∂Ô∏è';
  };
}

function labResizeCanvas() {
  const video = document.getElementById('labVideo');
  const canvas = document.getElementById('labCanvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.style.width = '100%';
  canvas.style.height = '100%';
}

function labTogglePlay() {
  const video = document.getElementById('labVideo');
  const btn = document.getElementById('labPlayBtn');
  if (video.paused) {
    video.play();
    btn.textContent = '‚è∏Ô∏è';
  } else {
    video.pause();
    btn.textContent = '‚ñ∂Ô∏è';
  }
}

function labStep(dir) {
  const video = document.getElementById('labVideo');
  video.pause();
  document.getElementById('labPlayBtn').textContent = '‚ñ∂Ô∏è';
  // ~30fps = 0.033s per frame
  video.currentTime = Math.max(0, Math.min(video.duration, video.currentTime + dir * 0.033));
  document.getElementById('labTimeline').value = video.currentTime;
  labUpdateTime();
}

function labSeek(val) {
  const video = document.getElementById('labVideo');
  video.currentTime = parseFloat(val);
  labUpdateTime();
}

function labSpeed(rate) {
  const video = document.getElementById('labVideo');
  video.playbackRate = rate;
  document.querySelectorAll('.lab-controls + div .lab-ctrl-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
}

function labUpdateTime() {
  const video = document.getElementById('labVideo');
  const t = video.currentTime;
  const m = Math.floor(t / 60);
  const s = Math.floor(t % 60);
  const ms = Math.floor((t % 1) * 10);
  document.getElementById('labTime').textContent = `${m}:${s.toString().padStart(2,'0')}.${ms}`;
}

function labSetTool(tool, el) {
  labDrawTool = tool;
  const canvas = document.getElementById('labCanvas');
  
  document.querySelectorAll('.lab-tool').forEach(b => b.classList.remove('active'));
  if (el) el.classList.add('active');
  
  // Remove all listeners
  canvas.onmousedown = canvas.onmousemove = canvas.onmouseup = null;
  canvas.ontouchstart = canvas.ontouchmove = canvas.ontouchend = canvas.ontouchcancel = null;
  
  if (tool === 'none') {
    canvas.classList.remove('drawing');
  } else {
    canvas.classList.add('drawing');
    // Mouse events
    canvas.onmousedown = labPointerDown;
    canvas.onmousemove = labPointerMove;
    canvas.onmouseup = labPointerUp;
    // Touch events (iOS/tablet)
    canvas.ontouchstart = (e) => { e.preventDefault(); labPointerDown(labTouchToMouse(e)); };
    canvas.ontouchmove = (e) => { e.preventDefault(); labPointerMove(labTouchToMouse(e)); };
    canvas.ontouchend = (e) => { e.preventDefault(); labPointerUp(labTouchToMouse(e)); };
    canvas.ontouchcancel = (e) => { labDrawing = false; };
  }
}

function labTouchToMouse(te) {
  const t = te.touches[0] || te.changedTouches[0];
  return { clientX: t.clientX, clientY: t.clientY, preventDefault: () => {} };
}

function labGetPos(e) {
  const canvas = document.getElementById('labCanvas');
  const rect = canvas.getBoundingClientRect();
  return {
    x: (e.clientX - rect.left) / rect.width * canvas.width,
    y: (e.clientY - rect.top) / rect.height * canvas.height
  };
}

function labPointerDown(e) {
  e.preventDefault();
  labDrawing = true;
  const pos = labGetPos(e);
  
  if (labDrawTool === 'pen') {
    labDrawPoints = [pos];
  } else if (labDrawTool === 'arrow') {
    labDrawPoints = [pos];
  } else if (labDrawTool === 'angle') {
    labAnglePoints.push(pos);
    if (labAnglePoints.length === 3) {
      labAnnotations.push({ type: 'angle', points: [...labAnglePoints], color: labDrawColor, width: labStrokeWidth });
      labAnglePoints = [];
      labRedraw();
    } else {
      labRedraw();
    }
    labDrawing = false;
    return;
  }
}

function labPointerMove(e) {
  if (!labDrawing) return;
  e.preventDefault();
  const pos = labGetPos(e);
  
  if (labDrawTool === 'pen') {
    labDrawPoints.push(pos);
    labRedraw();
    // Draw current stroke
    const ctx = document.getElementById('labCanvas').getContext('2d');
    ctx.beginPath();
    ctx.strokeStyle = labDrawColor;
    ctx.lineWidth = labStrokeWidth;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    labDrawPoints.forEach((p, i) => {
      if (i === 0) ctx.moveTo(p.x, p.y);
      else ctx.lineTo(p.x, p.y);
    });
    ctx.stroke();
  } else if (labDrawTool === 'arrow') {
    labRedraw();
    const ctx = document.getElementById('labCanvas').getContext('2d');
    labDrawArrow(ctx, labDrawPoints[0], pos, labDrawColor, labStrokeWidth);
  }
}

function labPointerUp(e) {
  if (!labDrawing) return;
  labDrawing = false;
  const pos = labGetPos(e);
  
  if (labDrawTool === 'pen' && labDrawPoints.length > 1) {
    labAnnotations.push({ type: 'pen', points: [...labDrawPoints], color: labDrawColor, width: labStrokeWidth });
  } else if (labDrawTool === 'arrow') {
    labAnnotations.push({ type: 'arrow', from: labDrawPoints[0], to: pos, color: labDrawColor, width: labStrokeWidth });
  }
  labDrawPoints = [];
  labRedraw();
}

function labDrawArrow(ctx, from, to, color, width) {
  ctx.beginPath();
  ctx.strokeStyle = color;
  ctx.fillStyle = color;
  ctx.lineWidth = width;
  ctx.moveTo(from.x, from.y);
  ctx.lineTo(to.x, to.y);
  ctx.stroke();
  
  // Arrowhead
  const angle = Math.atan2(to.y - from.y, to.x - from.x);
  const headLen = 15 + width * 2;
  ctx.beginPath();
  ctx.moveTo(to.x, to.y);
  ctx.lineTo(to.x - headLen * Math.cos(angle - Math.PI / 6), to.y - headLen * Math.sin(angle - Math.PI / 6));
  ctx.lineTo(to.x - headLen * Math.cos(angle + Math.PI / 6), to.y - headLen * Math.sin(angle + Math.PI / 6));
  ctx.closePath();
  ctx.fill();
}

function labRedraw() {
  const canvas = document.getElementById('labCanvas');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  
  labAnnotations.forEach(a => {
    if (a.type === 'pen') {
      ctx.beginPath();
      ctx.strokeStyle = a.color;
      ctx.lineWidth = a.width;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      a.points.forEach((p, i) => { if (i === 0) ctx.moveTo(p.x, p.y); else ctx.lineTo(p.x, p.y); });
      ctx.stroke();
    } else if (a.type === 'arrow') {
      labDrawArrow(ctx, a.from, a.to, a.color, a.width);
    } else if (a.type === 'angle') {
      const [p1, p2, p3] = a.points;
      ctx.beginPath();
      ctx.strokeStyle = a.color;
      ctx.lineWidth = a.width;
      ctx.moveTo(p1.x, p1.y);
      ctx.lineTo(p2.x, p2.y);
      ctx.lineTo(p3.x, p3.y);
      ctx.stroke();
      
      // Calculate and display angle
      const a1 = Math.atan2(p1.y - p2.y, p1.x - p2.x);
      const a2 = Math.atan2(p3.y - p2.y, p3.x - p2.x);
      let deg = Math.abs((a2 - a1) * 180 / Math.PI);
      if (deg > 180) deg = 360 - deg;
      
      // Arc
      ctx.beginPath();
      ctx.arc(p2.x, p2.y, 30, Math.min(a1, a2), Math.max(a1, a2));
      ctx.stroke();
      
      // Label
      ctx.font = 'bold 16px sans-serif';
      ctx.fillStyle = a.color;
      ctx.fillText(Math.round(deg) + '¬∞', p2.x + 35, p2.y - 10);
      
      // Dots on vertices
      [p1, p2, p3].forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
        ctx.fillStyle = a.color;
        ctx.fill();
      });
    }
  });
  
  // Draw angle points in progress
  if (labAnglePoints.length > 0) {
    ctx.fillStyle = labDrawColor;
    labAnglePoints.forEach(p => {
      ctx.beginPath();
      ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
      ctx.fill();
    });
    if (labAnglePoints.length === 2) {
      ctx.beginPath();
      ctx.strokeStyle = labDrawColor;
      ctx.lineWidth = labStrokeWidth;
      ctx.setLineDash([5, 5]);
      ctx.moveTo(labAnglePoints[0].x, labAnglePoints[0].y);
      ctx.lineTo(labAnglePoints[1].x, labAnglePoints[1].y);
      ctx.stroke();
      ctx.setLineDash([]);
    }
  }
}

function labClearDraw() {
  labAnnotations = [];
  labAnglePoints = [];
  const canvas = document.getElementById('labCanvas');
  canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
}

function labSetColor(color, el) {
  labDrawColor = color;
  document.querySelectorAll('.lab-color-dot').forEach(d => d.classList.remove('active'));
  if (el) el.classList.add('active');
}

function labCapture() {
  const video = document.getElementById('labVideo');
  const canvas = document.getElementById('labCanvas');
  
  // Create composite: video frame + annotations
  const tmpCanvas = document.createElement('canvas');
  tmpCanvas.width = video.videoWidth;
  tmpCanvas.height = video.videoHeight;
  const ctx = tmpCanvas.getContext('2d');
  
  // Draw video frame
  ctx.drawImage(video, 0, 0);
  
  // Draw annotations on top
  ctx.drawImage(canvas, 0, 0);
  
  // Convert to data URL (compressed)
  const dataUrl = tmpCanvas.toDataURL('image/jpeg', 0.7);
  
  const athId = document.getElementById('labAthlete').value;
  const frame = {
    id: DB.genId(),
    athlete_id: athId || null,
    timestamp: video.currentTime,
    image: dataUrl,
    created_at: new Date().toISOString()
  };
  
  try {
    const frames = DB.labFrames;
    frames.push(frame);
    DB.labFrames = frames;
  } catch(e) {
    // localStorage might be full
    alert('Error guardando frame. Storage puede estar lleno. Intenta eliminar frames antiguos.');
    console.error(e);
    return;
  }
  
  renderLabFrames();
  if (navigator.vibrate) navigator.vibrate(30);
}

function renderLabFrames() {
  const frames = DB.labFrames;
  const section = document.getElementById('labFramesSection');
  
  if (frames.length === 0) {
    section.style.display = 'none';
    return;
  }
  section.style.display = 'block';
  
  document.getElementById('labFrames').innerHTML = frames.slice().reverse().map(f => {
    const t = f.timestamp || 0;
    const m = Math.floor(t / 60);
    const s = Math.floor(t % 60);
    const timeStr = `${m}:${s.toString().padStart(2,'0')}`;
    const ath = f.athlete_id ? (DB.athletes.find(a => a.id === f.athlete_id)?.name?.split(' ')[0] || '') : '';
    return `<div class="lab-frame" onclick="labFrameActions('${f.id}')">
      <img src="${f.image}" loading="lazy">
      <div class="lab-frame-time">${timeStr} ${ath ? '¬∑ '+ath : ''}</div>
    </div>`;
  }).join('');
}

function labFrameActions(id) {
  const action = confirm('¬øEliminar este frame?\n\nOK = Eliminar\nCancel = Mantener');
  if (action) {
    DB.labFrames = DB.labFrames.filter(f => f.id !== id);
    renderLabFrames();
  }
}

function labCompareMode() {
  const frames = DB.labFrames;
  if (frames.length < 2) { alert('Necesitas al menos 2 frames para comparar'); return; }
  
  const section = document.getElementById('labCompareSection');
  section.style.display = 'block';
  
  window._labCompare = [];
  
  document.getElementById('labCompare').innerHTML = '<div style="text-align:center;color:var(--text-muted);font-size:12px;padding:20px;grid-column:span 2">Selecciona 2 frames abajo</div>';
  
  document.getElementById('labCompareSelect').innerHTML = frames.slice().reverse().map(f => {
    const t = f.timestamp || 0;
    const timeStr = `${Math.floor(t/60)}:${Math.floor(t%60).toString().padStart(2,'0')}`;
    return `<div class="lab-frame" onclick="labSelectCompare('${f.id}')" style="border-color:var(--border)">
      <img src="${f.image}" loading="lazy">
      <div class="lab-frame-time">${timeStr}</div>
    </div>`;
  }).join('');
}

function labSelectCompare(id) {
  const frames = DB.labFrames;
  const f = frames.find(x => x.id === id);
  if (!f) return;
  
  if (!window._labCompare) window._labCompare = [];
  if (window._labCompare.length >= 2) window._labCompare = [];
  window._labCompare.push(f);
  
  if (window._labCompare.length === 2) {
    document.getElementById('labCompare').innerHTML = window._labCompare.map(f => 
      `<img src="${f.image}">`
    ).join('');
  }
}

function renderLabClips() {
  const frames = DB.labFrames;
  const empty = document.getElementById('labClipsEmpty');
  const container = document.getElementById('labClips');
  
  if (frames.length === 0) {
    empty.style.display = 'block';
    container.innerHTML = '';
    return;
  }
  empty.style.display = 'none';
  
  // Group by athlete
  const byAth = {};
  frames.forEach(f => {
    const key = f.athlete_id || '_unlinked';
    if (!byAth[key]) byAth[key] = [];
    byAth[key].push(f);
  });
  
  container.innerHTML = Object.entries(byAth).map(([athId, aFrames]) => {
    const name = athId === '_unlinked' ? 'Sin vincular' : (DB.athletes.find(a => a.id === athId)?.name || 'Atleta');
    return `<div class="lab-clip">
      <div class="lab-clip-header"><span class="lab-clip-name">${name}</span><span class="lab-clip-meta">${aFrames.length} frames</span></div>
    </div>`;
  }).join('');
}

// ============================================================
// PHASE 3: BIOMETRICS
// ============================================================
function openBioModal() {
  document.getElementById('bioWeight').value = '';
  document.getElementById('bioSleep').value = '';
  document.getElementById('bioPainZone').value = '';
  document.getElementById('bioNotes').value = '';
  segSelect('bioEnergy', document.querySelector('#bioEnergy .seg-btn[data-v="8"]'));
  segSelect('bioPain', document.querySelector('#bioPain .seg-btn[data-v="none"]'));
  document.getElementById('modalBio').classList.add('active');
}

function saveBio() {
  const weight = parseFloat(document.getElementById('bioWeight').value) || null;
  const sleep = parseFloat(document.getElementById('bioSleep').value) || null;
  const energy = parseInt(getSegValue('bioEnergy')) || 8;
  const pain = getSegValue('bioPain') || 'none';
  const painZone = document.getElementById('bioPainZone').value.trim();
  const notes = document.getElementById('bioNotes').value.trim();
  
  if (!weight && !sleep) { alert('Ingresa al menos peso o horas de sue√±o'); return; }
  
  const entry = {
    id: DB.genId(),
    date: new Date().toISOString(),
    weight, sleep, energy, pain, painZone, notes
  };
  
  const a = DB.athletes.find(x => x.id === _pcAthleteId);
  if (!a) { alert('No se encontr√≥ el atleta'); return; }
  
  const athletes = DB.athletes;
  const ath = athletes.find(x => x.id === _pcAthleteId);
  if (!ath.biometrics) ath.biometrics = [];
  ath.biometrics.push(entry);
  
  // XP for tracking biometrics
  ath.xp_total = (ath.xp_total || 0) + 10;
  
  DB.athletes = athletes;
  closeModal('modalBio');
  renderPlayerCard();
  
  if (navigator.vibrate) navigator.vibrate(30);
}

function renderBiometrics(a) {
  const bio = a.biometrics || [];
  const grid = document.getElementById('pcBioGrid');
  const histSection = document.getElementById('pcBioHistory');
  
  if (bio.length === 0) {
    grid.innerHTML = '<div style="grid-column:span 2;font-size:12px;color:var(--text-muted);text-align:center;padding:8px">Sin registros. Toca "+ Registro" para empezar.</div>';
    histSection.style.display = 'none';
    return;
  }
  
  const latest = bio[bio.length - 1];
  const last7 = bio.slice(-7);
  
  const painEmoji = { none: '‚úÖ', mild: 'üü°', moderate: 'üü†', severe: 'üî¥' };
  const painLabel = { none: 'Sin dolor', mild: 'Leve', moderate: 'Moderado', severe: 'Severo' };
  
  // Grid cards with mini trends
  const avgEnergy = last7.reduce((s, b) => s + (b.energy || 0), 0) / last7.length;
  const avgSleep = last7.filter(b => b.sleep).reduce((s, b) => s + b.sleep, 0) / (last7.filter(b => b.sleep).length || 1);
  
  grid.innerHTML = `
    <div class="bio-card">
      <div class="bio-val">${latest.weight ? latest.weight + '<span style="font-size:12px">kg</span>' : '‚Äî'}</div>
      <div class="bio-lbl">Peso</div>
      <div class="bio-trend">${last7.map(b => {
        const h = b.weight ? Math.max(5, (b.weight / 120) * 40) : 3;
        return `<div class="bio-bar" style="height:${h}px;background:var(--accent)"></div>`;
      }).join('')}</div>
    </div>
    <div class="bio-card">
      <div class="bio-val">${latest.sleep ? latest.sleep + '<span style="font-size:12px">h</span>' : '‚Äî'}</div>
      <div class="bio-lbl">Sue√±o</div>
      <div class="bio-trend">${last7.map(b => {
        const h = b.sleep ? Math.max(5, (b.sleep / 10) * 40) : 3;
        const c = b.sleep >= 7 ? 'var(--green)' : b.sleep >= 5 ? 'var(--yellow)' : 'var(--red)';
        return `<div class="bio-bar" style="height:${h}px;background:${c}"></div>`;
      }).join('')}</div>
    </div>
    <div class="bio-card">
      <div class="bio-val" style="color:${avgEnergy>=7?'var(--green)':avgEnergy>=5?'var(--yellow)':'var(--red)'}">${latest.energy}/10</div>
      <div class="bio-lbl">Energ√≠a</div>
      <div class="bio-trend">${last7.map(b => {
        const h = Math.max(5, (b.energy / 10) * 40);
        const c = b.energy >= 7 ? 'var(--green)' : b.energy >= 5 ? 'var(--yellow)' : 'var(--red)';
        return `<div class="bio-bar" style="height:${h}px;background:${c}"></div>`;
      }).join('')}</div>
    </div>
    <div class="bio-card">
      <div class="bio-val">${painEmoji[latest.pain] || '‚úÖ'}</div>
      <div class="bio-lbl">${painLabel[latest.pain] || 'Sin dolor'}</div>
      ${latest.painZone ? `<div style="font-size:10px;color:var(--text-muted);margin-top:4px">${latest.painZone}</div>` : ''}
    </div>
  `;
  
  // History rows
  if (bio.length > 1) {
    histSection.style.display = 'block';
    document.getElementById('pcBioRows').innerHTML = bio.slice().reverse().slice(0, 7).map(b => {
      const d = new Intl.DateTimeFormat('es', { day:'numeric', month:'short' }).format(new Date(b.date));
      return `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid var(--border);font-size:12px">
        <span style="color:var(--text-muted);width:50px">${d}</span>
        <span>${b.weight ? b.weight+'kg' : '‚Äî'}</span>
        <span>${b.sleep ? b.sleep+'h' : '‚Äî'}</span>
        <span>‚ö°${b.energy}</span>
        <span>${painEmoji[b.pain]||'‚úÖ'}</span>
      </div>`;
    }).join('');
  } else { histSection.style.display = 'none'; }
}

function renderLabFramesForAthlete(a) {
  const frames = DB.labFrames.filter(f => f.athlete_id === a.id);
  const card = document.getElementById('pcLabCard');
  
  if (frames.length === 0) { card.style.display = 'none'; return; }
  card.style.display = 'block';
  
  document.getElementById('pcLabFrames').innerHTML = frames.slice(-6).reverse().map(f => {
    const t = f.timestamp || 0;
    const timeStr = `${Math.floor(t/60)}:${Math.floor(t%60).toString().padStart(2,'0')}`;
    return `<div class="lab-frame"><img src="${f.image}" loading="lazy"><div class="lab-frame-time">${timeStr}</div></div>`;
  }).join('');
}

// ============================================================
// SETTINGS
// ============================================================
function renderSettings() {
  const spots = DB.spots;
  document.getElementById('setSpotList').innerHTML = spots.map((s, i) => 
    `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
      <span style="font-size:14px">${s}</span>
      <button onclick="removeSpot(${i})" style="color:var(--text-muted);font-size:16px;padding:4px 8px">√ó</button>
    </div>`
  ).join('');
  
  // Templates
  const templates = DB.templates;
  const tplList = document.getElementById('setTplList');
  const tplEmpty = document.getElementById('setTplEmpty');
  if (templates.length > 0) {
    tplEmpty.style.display = 'none';
    tplList.innerHTML = templates.map(t => 
      `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
        <div><div style="font-size:14px;font-weight:600">${t.name}</div><div style="font-size:11px;color:var(--text-muted)">${t.spot} ¬∑ ${(t.athlete_ids||[]).length} atletas</div></div>
        <button onclick="deleteTemplate('${t.id}')" style="color:var(--text-muted);font-size:16px;padding:4px 8px">√ó</button>
      </div>`
    ).join('');
  } else {
    tplEmpty.style.display = 'block';
    tplList.innerHTML = '';
  }
  
  // Custom drills
  const customs = DB.customDrills;
  document.getElementById('setCustomDrills').innerHTML = customs.length > 0 ? 
    customs.map((d, i) => 
      `<div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)">
        <span style="font-size:13px">‚≠ê ${d.name}</span>
        <button onclick="removeCustomDrill(${i})" style="color:var(--text-muted);font-size:16px;padding:4px 8px">√ó</button>
      </div>`
    ).join('') : '<div style="font-size:12px;color:var(--text-muted);padding:4px 0">Sin ejercicios personalizados</div>';
}

function addSpot() {
  const input = document.getElementById('setNewSpot');
  const name = input.value.trim();
  if (!name) return;
  const spots = DB.spots;
  if (!spots.includes(name)) { spots.push(name); DB.spots = spots; }
  input.value = '';
  renderSettings();
}

function removeSpot(i) {
  const spots = DB.spots;
  if (spots.length <= 1) { alert('Necesitas al menos un spot'); return; }
  spots.splice(i, 1);
  DB.spots = spots;
  renderSettings();
}

function addCustomDrill() {
  const input = document.getElementById('setNewDrillName');
  const name = input.value.trim();
  if (!name) return;
  const customs = DB.customDrills;
  customs.push({ id: 'custom_' + DB.genId(), name, desc: '', duration: '', cat: 'Custom', icon: '‚≠ê', level: 'Todos' });
  DB.customDrills = customs;
  input.value = '';
  renderSettings();
}

function removeCustomDrill(i) {
  const customs = DB.customDrills;
  customs.splice(i, 1);
  DB.customDrills = customs;
  renderSettings();
}

function confirmClearData() {
  if (confirm('‚ö†Ô∏è ¬øBorrar TODOS los datos? Esta acci√≥n no se puede deshacer.')) {
    if (confirm('¬øEst√°s seguro? Se borrar√°n atletas, sesiones y configuraci√≥n.')) {
      localStorage.clear();
      location.reload();
    }
  }
}

// ============================================================
// UI HELPERS
// ============================================================
function segSelect(groupId, el) {
  document.querySelectorAll(`#${groupId} .seg-btn`).forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
}

function getSegValue(groupId) {
  return document.querySelector(`#${groupId} .seg-btn.selected`)?.dataset.v || '3';
}

function starSelect(groupId, n) {
  document.querySelectorAll(`#${groupId} .star`).forEach((s, i) => {
    s.classList.toggle('active', i < n);
  });
  document.getElementById(groupId).dataset.value = n;
}

function getStarValue(groupId) {
  return parseInt(document.getElementById(groupId).dataset?.value) || 3;
}

function semSelect(el) {
  document.querySelectorAll('.sem-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
}

let _undoTimer = null;
function showUndoToast(text, undoFn) {
  const toast = document.getElementById('undoToast');
  document.getElementById('undoText').textContent = text;
  window._undoFn = undoFn;
  toast.classList.add('show');
  clearTimeout(_undoTimer);
  _undoTimer = setTimeout(() => { toast.classList.remove('show'); window._undoFn = null; }, 3000);
}

function undoLastAction() {
  if (window._undoFn) { window._undoFn(); window._undoFn = null; }
  document.getElementById('undoToast').classList.remove('show');
  clearTimeout(_undoTimer);
}

// ============================================================
// JUDGE MODE
// ============================================================
const JM_COLORS = ['Red', 'Yellow', 'Black', 'White', 'Blue'];
const JM_COLOR_CSS = { Red:'jm-color-red', Yellow:'jm-color-yellow', Black:'jm-color-black', White:'jm-color-white', Blue:'jm-color-blue' };
const JM_INT_LABELS = { 0:'‚Äî', 1:'INT-1', 2:'INT-2', 3:'INT-3', 4:'2√óINT', 5:'2√óINT', 6:'DQ' };
const JM_INT_DESC = { 0:'', 1:'¬Ω 2nd (Non-Pri)', 2:'0 2nd (Priority)', 3:'0 1st (Last 5min)', 4:'¬Ω 1st + 0 2nd', 5:'0 both', 6:'DISQUALIFIED' };
let jmTimer = null;
let jmStartTime = null;
let jmScoreTimestamps = {};
const JM_LOCK_DELAY = 30000;

function jmGetHeat() {
  if (!window._jmHeatCache) {
    let h = DB.judgeHeat;
    if (!h) {
      h = {
        metadata: { heat_number:'', category:'', round:'', location:'', duration:20, is_closed:false, notes:'' },
        surfers: JM_COLORS.map(c => ({ color:c, name:'', athlete_id:'', goal:0, waves:new Array(20).fill(null), interference:0, interference_waves:[] })),
        priority_order: [],
        started: false
      };
      DB.judgeHeat = h;
    }
    window._jmHeatCache = h;
  }
  return window._jmHeatCache;
}
function jmSave() { DB.judgeHeat = window._jmHeatCache; }

function renderJudge() {
  const h = jmGetHeat();
  const athletes = DB.athletes;
  // Surfer setup fields
  const sg = document.getElementById('jmSurferSetup');
  if (sg && !sg.dataset.init) {
    sg.dataset.init = '1';
    sg.innerHTML = JM_COLORS.map((c, i) => {
      const lbl = c === 'Red' ? 'color:#fecaca;background:#991b1b' : c === 'Yellow' ? 'color:#fef08a;background:#854d0e' : c === 'Black' ? 'color:#e2e8f0;background:#0f172a' : c === 'White' ? 'color:#0f172a;background:#f0f0f0' : 'color:#bfdbfe;background:#1e3a8a';
      const curId = h.surfers[i].athlete_id || '';
      const curName = h.surfers[i].name || '';
      let opts = '<option value="">‚Äî Vac√≠o ‚Äî</option>';
      athletes.forEach(a => {
        const sel = a.id === curId ? 'selected' : '';
        opts += `<option value="${a.id}" ${sel}>${a.name}</option>`;
      });
      opts += `<option value="__custom" ${curId === '__custom' ? 'selected' : ''}>‚úèÔ∏è Otro...</option>`;
      return `<div class="jm-surfer-item"><label style="${lbl}">${c}</label><select id="jmSN${i}" onchange="jmSelectSurfer(${i})">
        ${opts}</select><input placeholder="Nombre manual" id="jmSNcustom${i}" value="${curId === '__custom' ? curName : ''}" onchange="jmUpdateSurfer()" style="display:${curId === '__custom' ? 'block' : 'none'}"><input type="number" placeholder="Goal" step="0.1" min="0" max="20" id="jmSG${i}" value="${h.surfers[i].goal||''}" onchange="jmUpdateSurfer()"></div>`;
    }).join('');
  }
  // Duration
  document.getElementById('jmDuration').value = h.metadata.duration;
  document.getElementById('jmHeatNum').value = h.metadata.heat_number;
  document.getElementById('jmCategory').value = h.metadata.category;
  document.getElementById('jmRound').value = h.metadata.round;
  document.getElementById('jmLocation').value = h.metadata.location;
  
  // Build score grid
  jmBuildGrid(h);
  
  // Rankings + priority
  jmUpdateRankings();
  jmUpdatePriority();
  
  // Timer state
  if (h.started) {
    document.getElementById('jmSetupForm').querySelector('.card:first-of-type .card-header').parentElement.parentElement.querySelector('.jm-setup-form') || null;
    jmCollapseSetup();
    document.getElementById('jmTimerBar').style.display = 'flex';
    document.getElementById('jmCloseRow').style.display = 'block';
    document.getElementById('jmStartBtn').disabled = true;
    document.getElementById('jmStartBtn').style.opacity = '.4';
  }
  
  // Closed state
  if (h.metadata.is_closed) {
    document.getElementById('jmCloseBtn').style.display = 'none';
    document.getElementById('jmCloseRow').style.display = 'none';
    document.getElementById('jmReopenBtn').style.display = 'inline-block';
    document.getElementById('jmResults').style.display = 'block';
    jmDisplayResults();
  } else {
    document.getElementById('jmResults').style.display = 'none';
  }
  
  // Sequential + lock states
  jmUpdateSequential();
}

function jmBuildGrid(h) {
  const grid = document.getElementById('jmGrid');
  let html = '<thead><tr><th>Surfer</th>';
  for (let w = 1; w <= 20; w++) html += `<th>W${w}</th>`;
  html += '</tr></thead><tbody>';
  
  h.surfers.forEach((s, si) => {
    const intLvl = s.interference > 0 ? ` l${s.interference}` : '';
    const intText = s.interference > 0 ? JM_INT_LABELS[s.interference] : 'INT';
    html += `<tr><td class="jm-color-cell ${JM_COLOR_CSS[s.color]}" onclick="jmSendPriority(${si})">
      ${s.color}${s.name ? '<br><span style="font-size:10px;font-weight:500;opacity:.8">'+s.name.split(' ')[0]+'</span>':''}
      <span class="jm-int-badge${intLvl}" onclick="event.stopPropagation();jmToggleInt(${si})" title="Tap to cycle interference">${intText}</span>
    </td>`;
    for (let wi = 0; wi < 20; wi++) {
      const val = s.waves[wi] !== null ? s.waves[wi] : '';
      const intMarked = s.interference_waves.includes(wi);
      const cls = [intMarked ? 'int-marked' : ''].filter(Boolean).join(' ');
      html += `<td><input type="number" class="jm-score-input ${cls}" min="0" max="10" step="0.1" inputmode="decimal"
        id="jm-s${si}-w${wi}" data-si="${si}" data-wi="${wi}" value="${val}"
        onchange="jmScoreChange(this)" onfocus="jmScoreFocus(${si},${wi})"
        onkeydown="jmScoreKey(event,${si},${wi})"
        ondblclick="jmMarkInt(${si},${wi})">
        <span class="jm-tri" id="jm-tri-${si}-${wi}" ${intMarked?'style="display:block"':''}>‚ñ≤</span></td>`;
    }
    html += '</tr>';
  });
  html += '</tbody>';
  grid.innerHTML = html;
}

function jmSelectSurfer(i) {
  const sel = document.getElementById(`jmSN${i}`);
  const customInp = document.getElementById(`jmSNcustom${i}`);
  const val = sel.value;
  const h = jmGetHeat();
  
  if (val === '') {
    h.surfers[i].name = '';
    h.surfers[i].athlete_id = '';
    customInp.style.display = 'none';
  } else if (val === '__custom') {
    h.surfers[i].athlete_id = '__custom';
    h.surfers[i].name = customInp.value;
    customInp.style.display = 'block';
    customInp.focus();
  } else {
    const ath = DB.athletes.find(a => a.id === val);
    h.surfers[i].name = ath ? ath.name : '';
    h.surfers[i].athlete_id = val;
    customInp.style.display = 'none';
  }
  jmSave();
  jmBuildGrid(h);
  jmUpdateSequential();
}

function jmUpdateSurfer() {
  const h = jmGetHeat();
  JM_COLORS.forEach((c, i) => {
    const sel = document.getElementById('jmSN' + i);
    const customInp = document.getElementById('jmSNcustom' + i);
    if (sel && sel.value === '__custom' && customInp) {
      h.surfers[i].name = customInp.value;
      h.surfers[i].athlete_id = '__custom';
    }
    h.surfers[i].goal = parseFloat(document.getElementById('jmSG' + i).value) || 0;
  });
  jmSave();
  jmBuildGrid(h);
  jmUpdateSequential();
}

function jmUpdateMeta() {
  const h = jmGetHeat();
  h.metadata.heat_number = document.getElementById('jmHeatNum').value;
  h.metadata.category = document.getElementById('jmCategory').value;
  h.metadata.round = document.getElementById('jmRound').value;
  h.metadata.location = document.getElementById('jmLocation').value;
  h.metadata.duration = parseInt(document.getElementById('jmDuration').value) || 20;
  jmSave();
}

function jmCollapseSetup() {
  const h = jmGetHeat();
  document.getElementById('jmSetupForm').classList.add('hidden');
  const mc = document.getElementById('jmMetaCollapsed');
  mc.textContent = `Heat ${h.metadata.heat_number||'?'} ¬∑ ${h.metadata.category||'?'} ¬∑ ${h.metadata.round||'?'} ¬∑ ${h.metadata.location||'?'} ¬∑ ${h.metadata.duration}min`;
  mc.classList.add('active');
}

function jmExpandSetup() {
  document.getElementById('jmSetupForm').classList.remove('hidden');
  document.getElementById('jmMetaCollapsed').classList.remove('active');
}

// TIMER
function jmStartTimer() {
  jmUpdateMeta();
  jmUpdateSurfer();
  const h = jmGetHeat();
  h.started = true;
  jmSave();
  
  jmCollapseSetup();
  document.getElementById('jmTimerBar').style.display = 'flex';
  document.getElementById('jmCloseRow').style.display = 'block';
  document.getElementById('jmStartBtn').disabled = true;
  document.getElementById('jmStartBtn').style.opacity = '.4';
  
  jmStartTime = Date.now();
  const dur = h.metadata.duration;
  document.getElementById('jmTimerDisplay').textContent = `${dur}:00`;
  
  if (jmTimer) clearInterval(jmTimer);
  jmTimer = setInterval(() => {
    const elapsed = Math.floor((Date.now() - jmStartTime) / 1000);
    const total = dur * 60;
    const rem = Math.max(0, total - elapsed);
    const m = Math.floor(rem / 60);
    const s = rem % 60;
    document.getElementById('jmTimerDisplay').textContent = `${m}:${s.toString().padStart(2,'0')}`;
    
    const bar = document.getElementById('jmTimerBar');
    bar.className = 'jm-timer-bar' + (rem <= 60 ? ' critical' : rem <= 300 ? ' warning' : '');
    
    if (rem === 0) { clearInterval(jmTimer); jmTimer = null; }
  }, 250);
}

// SCORING
function jmScoreChange(input) {
  const si = parseInt(input.dataset.si);
  const wi = parseInt(input.dataset.wi);
  const h = jmGetHeat();
  const val = input.value;
  
  if (val === '') {
    h.surfers[si].waves[wi] = null;
    delete jmScoreTimestamps[`${si}-${wi}`];
  } else {
    const n = parseFloat(val);
    if (n >= 0 && n <= 10) {
      h.surfers[si].waves[wi] = n;
      jmScoreTimestamps[`${si}-${wi}`] = Date.now();
    } else {
      input.value = '';
      h.surfers[si].waves[wi] = null;
    }
  }
  jmSave();
  jmUpdateRankings();
  jmUpdateSequential();
}

function jmScoreFocus(si, wi) {
  const key = `${si}-${wi}`;
  if (jmScoreTimestamps[key]) {
    const el = Date.now() - jmScoreTimestamps[key];
    if (el > JM_LOCK_DELAY) {
      const input = document.getElementById(`jm-s${si}-w${wi}`);
      if (!confirm(`‚ö†Ô∏è Score entered ${Math.floor(el/1000)}s ago. Edit?`)) { input.blur(); return; }
      jmScoreTimestamps[key] = Date.now();
    }
  }
}

function jmScoreKey(e, si, wi) {
  if (e.key === 'Enter') {
    e.preventDefault();
    const cur = document.getElementById(`jm-s${si}-w${wi}`);
    if (cur.value) jmScoreChange(cur);
    // Move to next available
    for (let w = wi + 1; w < 20; w++) {
      const nx = document.getElementById(`jm-s${si}-w${w}`);
      if (!nx.disabled) { nx.focus(); return; }
    }
    for (let s = si + 1; s < 5; s++) {
      for (let w = 0; w < 20; w++) {
        const nx = document.getElementById(`jm-s${s}-w${w}`);
        if (nx && !nx.disabled) { nx.focus(); return; }
      }
    }
    cur.blur();
  }
}

function jmUpdateSequential() {
  for (let si = 0; si < 5; si++) {
    let foundEmpty = false;
    for (let wi = 0; wi < 20; wi++) {
      const inp = document.getElementById(`jm-s${si}-w${wi}`);
      if (!inp) continue;
      if (!inp.value) {
        inp.disabled = foundEmpty;
        if (!foundEmpty) foundEmpty = true;
      } else {
        inp.disabled = false;
      }
    }
  }
  // Lock states
  const now = Date.now();
  for (const [key, ts] of Object.entries(jmScoreTimestamps)) {
    const [si, wi] = key.split('-');
    const inp = document.getElementById(`jm-s${si}-w${wi}`);
    if (!inp || !inp.value) continue;
    const el = now - ts;
    inp.classList.toggle('locked', el > JM_LOCK_DELAY);
    inp.classList.toggle('recent', el < 5000);
  }
}

// RANKINGS (ISA rules - ported from Python)
function jmCalcRankings() {
  const h = jmGetHeat();
  const results = h.surfers.map((s, idx) => {
    const valid = s.waves.filter(w => w !== null).sort((a, b) => b - a);
    const top2 = valid.slice(0, 2);
    let total = top2.reduce((a, b) => a + b, 0);
    
    // Interference penalties
    if (s.interference === 1 && top2.length >= 2) total -= top2[1] / 2;
    else if (s.interference === 2 && top2.length >= 2) total -= top2[1];
    else if (s.interference === 3 && top2.length >= 1) total -= top2[0];
    else if (s.interference === 4) {
      if (top2.length >= 1) total -= top2[0] / 2;
      if (top2.length >= 2) total -= top2[1];
    } else if (s.interference === 5) {
      total = 0;
    } else if (s.interference === 6) {
      total = 0;
    }
    total = Math.max(0, total);
    
    const all_wave_avg = valid.length > 0 ? valid.reduce((a, b) => a + b, 0) / valid.length : 0;
    
    return { idx, color: s.color, name: s.name, athlete_id: s.athlete_id || '', top_waves: top2, all_sorted: valid, total, interference: s.interference, all_wave_avg, wave_count: valid.length };
  });
  
  results.sort((a, b) => {
    if (b.total !== a.total) return b.total - a.total;
    const maxW = Math.max(a.all_sorted.length, b.all_sorted.length);
    for (let i = 0; i < maxW; i++) {
      const av = a.all_sorted[i] || 0, bv = b.all_sorted[i] || 0;
      if (bv !== av) return bv - av;
    }
    return 0;
  });
  
  results.forEach((r, i) => r.position = i + 1);
  return results;
}

function jmUpdateRankings() {
  const results = jmCalcRankings();
  const c = document.getElementById('jmRankings');
  const first = results[0]?.total || 0;
  const second = results[1]?.total || 0;
  
  c.innerHTML = results.map(r => {
    const emoji = r.position === 1 ? 'ü•á' : r.position === 2 ? 'ü•à' : r.position === 3 ? 'ü•â' : r.position + '.';
    const wStr = r.top_waves.map(w => w.toFixed(1)).join(' + ') || 'No scores';
    let intStr = r.interference > 0 ? `<span class="jm-rank-int">${JM_INT_LABELS[r.interference]}</span>` : '';
    let need = '';
    if (r.position === 2) {
      const target = first + 0.01;
      const best = r.top_waves[0] || 0;
      const wn = target - best;
      need = wn <= 10 ? `<div class="jm-rank-need">needs ${wn.toFixed(2)} for 1st</div>` : `<div class="jm-rank-need">needs combo ${target.toFixed(2)}</div>`;
    } else if (r.position >= 3) {
      const target = second + 0.01;
      const best = r.top_waves[0] || 0;
      const wn = target - best;
      need = wn <= 10 ? `<div class="jm-rank-need">needs ${wn.toFixed(2)} for 2nd</div>` : `<div class="jm-rank-need">needs combo ${target.toFixed(2)}</div>`;
    }
    return `<div class="jm-rank-item"><div><span style="font-size:18px;margin-right:6px">${emoji}</span><strong>${r.color}</strong>${intStr}<div class="jm-rank-waves">${wStr}${r.wave_count > 0 ? ' ¬∑ avg '+r.all_wave_avg.toFixed(1)+'/wave' : ''}</div>${need}</div><div style="font-size:18px">${r.total.toFixed(2)}</div></div>`;
  }).join('');
  
  // Highlight best scores in grid
  document.querySelectorAll('.jm-score-input').forEach(i => i.classList.remove('best'));
  results.forEach(r => {
    const waves = [];
    for (let w = 0; w < 20; w++) {
      const inp = document.getElementById(`jm-s${r.idx}-w${w}`);
      if (inp && inp.value) waves.push({ w, score: parseFloat(inp.value) });
    }
    waves.sort((a, b) => b.score - a.score);
    waves.slice(0, 2).forEach(wv => {
      const inp = document.getElementById(`jm-s${r.idx}-w${wv.w}`);
      if (inp) inp.classList.add('best');
    });
  });
}

// PRIORITY
function jmSendPriority(si) {
  const h = jmGetHeat();
  const idx = h.priority_order.indexOf(si);
  if (idx >= 0) h.priority_order.splice(idx, 1);
  h.priority_order.push(si);
  jmSave();
  jmUpdatePriority();
}

function jmUpdatePriority() {
  const h = jmGetHeat();
  const ordered = new Set(h.priority_order);
  const tied = [];
  for (let i = 0; i < 5; i++) { if (!ordered.has(i)) tied.push(i); }
  
  const all = [...tied.map(i => ({ idx:i, pos:'TIED' })), ...h.priority_order.map((i, p) => ({ idx:i, pos:tied.length + p + 1 }))];
  
  document.getElementById('jmPriority').innerHTML = all.map(item => {
    const s = h.surfers[item.idx];
    const cls = item.pos === 'TIED' ? 'tied' : '';
    return `<div class="jm-pri-item ${cls}" onclick="jmSendPriority(${item.idx})">
      <div class="jm-pri-num">${item.pos === 'TIED' ? '=' : item.pos}</div>
      <div class="jm-pri-col">${s.color}</div>
      <div class="jm-pri-lbl">${item.pos === 'TIED' ? 'tied' : 'priority'}</div>
    </div>`;
  }).join('');
}

// INTERFERENCE
function jmToggleInt(si) {
  const h = jmGetHeat();
  h.surfers[si].interference = (h.surfers[si].interference + 1) % 7;
  jmSave();
  jmBuildGrid(h);
  jmUpdateSequential();
  jmUpdateRankings();
  if (navigator.vibrate) navigator.vibrate(30);
}

function jmMarkInt(si, wi) {
  const h = jmGetHeat();
  const arr = h.surfers[si].interference_waves;
  const idx = arr.indexOf(wi);
  if (idx >= 0) arr.splice(idx, 1); else arr.push(wi);
  jmSave();
  
  const inp = document.getElementById(`jm-s${si}-w${wi}`);
  const tri = document.getElementById(`jm-tri-${si}-${wi}`);
  if (arr.includes(wi)) { inp.classList.add('int-marked'); tri.style.display = 'block'; }
  else { inp.classList.remove('int-marked'); tri.style.display = 'none'; }
  if (navigator.vibrate) navigator.vibrate(50);
}

// CLOSE / REOPEN / RESET
function jmCloseHeat() {
  try {
  const h = jmGetHeat();
  h.metadata.is_closed = true;
  jmSave();
  
  // Update session tracker
  const results = jmCalcRankings();
  const tracker = DB.judgeTracker;
  h.surfers.forEach(s => {
    const name = (s.name || '').trim();
    if (!name) return;
    if (!tracker[name]) tracker[name] = { heats: [], all_wave_avgs: [], goal: s.goal || 0, athlete_id: s.athlete_id || '' };
    if (!tracker[name].all_wave_avgs) tracker[name].all_wave_avgs = [];
    if (!tracker[name].heats) tracker[name].heats = [];
    const r = results.find(x => x.color === s.color);
    if (r) {
      tracker[name].heats.push(r.total);
      tracker[name].all_wave_avgs.push(r.all_wave_avg);
    }
  });
  DB.judgeTracker = tracker;
  
  // Save heat results to athlete profiles
  try {
    const athletes = DB.athletes;
    let updated = false;
    results.forEach(r => {
      if (!r.athlete_id || r.athlete_id === '__custom') return;
      const ath = athletes.find(a => a.id === r.athlete_id);
      if (!ath) return;
      if (!ath.heat_history) ath.heat_history = [];
      ath.heat_history.push({
        date: new Date().toISOString(),
        heat_number: h.metadata.heat_number || '',
        category: h.metadata.category || '',
        round: h.metadata.round || '',
        location: h.metadata.location || '',
        position: r.position,
        total: r.total,
        all_wave_avg: r.all_wave_avg,
        wave_count: r.wave_count,
        interference: r.interference
      });
      updated = true;
    });
    if (updated) DB.athletes = athletes;
  } catch(e2) { console.error('Athlete profile save error:', e2); }
  
  document.getElementById('jmCloseBtn').style.display = 'none';
  document.getElementById('jmCloseRow').style.display = 'none';
  document.getElementById('jmReopenBtn').style.display = 'inline-block';
  document.getElementById('jmResults').style.display = 'block';
  if (jmTimer) { clearInterval(jmTimer); jmTimer = null; }
  
  jmDisplayResults();
  jmDisplayTracker();
  } catch(e) { alert('Error closing heat: ' + e.message); console.error(e); }
}

function jmDisplayResults() {
  const results = jmCalcRankings();
  document.getElementById('jmResultsContent').innerHTML = results.map(r => {
    const emoji = r.position === 1 ? 'ü•á' : r.position === 2 ? 'ü•à' : r.position === 3 ? 'ü•â' : r.position + '.';
    const wStr = r.top_waves.map(w => w.toFixed(2)).join(' + ');
    const intStr = r.interference > 0 ? ` ¬∑ ${JM_INT_LABELS[r.interference]}: ${JM_INT_DESC[r.interference]}` : '';
    const avgStr = r.wave_count > 0 ? `<div style="font-size:11px;color:var(--text-secondary);margin-top:2px">Avg all waves: ${r.all_wave_avg.toFixed(2)} (${r.wave_count} olas)</div>` : '';
    return `<div class="jm-rank-item"><div><span style="font-size:18px;margin-right:6px">${emoji}</span><strong>${r.color}</strong>${r.name ? ' ¬∑ '+r.name : ''}${intStr}<div class="jm-rank-waves">${wStr}</div>${avgStr}</div><div style="font-size:20px;font-weight:800">${r.total.toFixed(2)}</div></div>`;
  }).join('');
}

function jmDisplayTracker() {
  const tracker = DB.judgeTracker;
  if (Object.keys(tracker).length === 0) return;
  
  let html = '<div style="display:flex;justify-content:flex-end;margin-bottom:8px"><button class="btn btn-sm btn-outline" onclick="jmExportTracker()" style="width:auto;padding:6px 12px;font-size:11px">üìä Export Tracker CSV</button></div>';
  html += '<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:12px;min-width:600px"><thead><tr><th style="text-align:left;padding:8px;background:#1e2a3a;color:var(--text-secondary);border-radius:4px 0 0 0">Surfer</th>';
  for (let i = 1; i <= 6; i++) html += `<th style="padding:8px;background:#1e2a3a;color:var(--text-secondary)">H${i}</th>`;
  html += '<th style="padding:8px;background:#1e2a3a;color:var(--text-secondary)">Avg Total</th><th style="padding:8px;background:#1e2a3a;color:var(--text-secondary)">Avg/Wave</th><th style="padding:8px;background:#1e2a3a;color:var(--text-secondary);border-radius:0 4px 0 0">Goal</th></tr></thead><tbody>';
  
  for (const [name, info] of Object.entries(tracker)) {
    html += `<tr><td style="padding:8px;font-weight:700;border-bottom:1px solid var(--border)">${name}</td>`;
    for (let i = 0; i < 6; i++) {
      const v = info.heats[i];
      html += `<td style="padding:8px;text-align:center;border-bottom:1px solid var(--border);font-variant-numeric:tabular-nums">${v !== undefined ? v.toFixed(2) : '‚Äî'}</td>`;
    }
    const valid = info.heats.filter(h => h != null);
    const avg = valid.length > 0 ? valid.reduce((a, b) => a + b, 0) / valid.length : 0;
    // All-wave average across all heats
    const wAvgs = (info.all_wave_avgs || []).filter(a => a > 0);
    const allWaveAvg = wAvgs.length > 0 ? wAvgs.reduce((a, b) => a + b, 0) / wAvgs.length : 0;
    const avgColor = allWaveAvg >= 6 ? 'var(--green)' : allWaveAvg >= 4 ? 'var(--yellow)' : allWaveAvg > 0 ? 'var(--red)' : 'var(--text-secondary)';
    html += `<td style="padding:8px;text-align:center;border-bottom:1px solid var(--border);font-weight:700;color:var(--accent)">${avg > 0 ? avg.toFixed(2) : '‚Äî'}</td>`;
    html += `<td style="padding:8px;text-align:center;border-bottom:1px solid var(--border);font-weight:700;color:${avgColor}">${allWaveAvg > 0 ? allWaveAvg.toFixed(2) : '‚Äî'}</td>`;
    html += `<td style="padding:8px;text-align:center;border-bottom:1px solid var(--border);color:var(--yellow);font-weight:700">${info.goal > 0 ? info.goal.toFixed(1) : '‚Äî'}</td></tr>`;
  }
  html += '</tbody></table></div>';
  
  document.getElementById('jmTrackerContent').innerHTML = html;
  document.getElementById('jmTracker').style.display = 'block';
}

function jmReopenHeat() {
  const h = jmGetHeat();
  h.metadata.is_closed = false;
  jmSave();
  document.getElementById('jmCloseBtn').style.display = 'inline-block';
  document.getElementById('jmCloseRow').style.display = 'block';
  document.getElementById('jmReopenBtn').style.display = 'none';
  document.getElementById('jmResults').style.display = 'none';
}

function jmResetHeat() {
  if (!confirm('Reset all scores and timer?')) return;
  const h = jmGetHeat();
  h.surfers.forEach(s => { s.waves = new Array(20).fill(null); s.interference = 0; s.interference_waves = []; });
  h.metadata.is_closed = false;
  h.metadata.notes = '';
  h.priority_order = [];
  h.started = false;
  jmSave();
  jmScoreTimestamps = {};
  
  if (jmTimer) { clearInterval(jmTimer); jmTimer = null; }
  document.getElementById('jmTimerBar').style.display = 'none';
  document.getElementById('jmCloseRow').style.display = 'none';
  document.getElementById('jmStartBtn').disabled = false;
  document.getElementById('jmStartBtn').style.opacity = '1';
  document.getElementById('jmResults').style.display = 'none';
  document.getElementById('jmCloseBtn').style.display = 'inline-block';
  document.getElementById('jmReopenBtn').style.display = 'none';
  // Clear surfer setup init so dropdowns refresh
  const sg = document.getElementById('jmSurferSetup');
  if (sg) delete sg.dataset.init;
  jmExpandSetup();
  renderJudge();
}

function jmNotes() { document.getElementById('jmNotesModal').classList.add('active'); }

// EXPORT CSV
function jmExportCSV() {
  const h = jmGetHeat();
  const results = jmCalcRankings();
  let csv = `Heat Number,${h.metadata.heat_number}\nCategory,${h.metadata.category}\nRound,${h.metadata.round}\nLocation,${h.metadata.location}\nDuration,${h.metadata.duration} min\n`;
  if (h.metadata.notes) csv += `Notes,"${h.metadata.notes.replace(/"/g,'""')}"\n`;
  csv += '\nFULL SCORING GRID\nSurfer,' + Array.from({length:20},(_,i)=>'W'+(i+1)).join(',') + '\n';
  h.surfers.forEach(s => {
    csv += s.color + ',' + s.waves.map(w => w !== null ? w.toFixed(2) : '-').join(',') + '\n';
  });
  csv += '\nFINAL RESULTS\nPosition,Surfer,Name,Best Wave,2nd Wave,Total,Avg/Wave,Waves,Interference\n';
  results.forEach(r => {
    const w = r.top_waves.concat([null,null]).slice(0,2);
    csv += `${r.position},${r.color},${r.name},${w[0]!==null&&w[0]!==undefined?w[0].toFixed(2):'-'},${w[1]!==null&&w[1]!==undefined?w[1].toFixed(2):'-'},${r.total.toFixed(2)},${r.all_wave_avg>0?r.all_wave_avg.toFixed(2):'-'},${r.wave_count},${JM_INT_LABELS[r.interference]}\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  const cat = h.metadata.category.replace(/\s/g,'') || 'Heat';
  const num = h.metadata.heat_number || '0';
  a.download = `${cat}_H${num}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

function jmExportTracker() {
  const tracker = DB.judgeTracker;
  if (Object.keys(tracker).length === 0) { alert('No tracker data yet'); return; }
  
  const maxHeats = Math.max(...Object.values(tracker).map(t => t.heats.length));
  let csv = 'Surfer';
  for (let i = 1; i <= maxHeats; i++) csv += `,Heat ${i} Total`;
  csv += ',Avg Heat Total,Avg Per Wave,Goal,Status\n';
  
  for (const [name, info] of Object.entries(tracker)) {
    csv += `"${name}"`;
    for (let i = 0; i < maxHeats; i++) {
      csv += `,${info.heats[i] !== undefined ? info.heats[i].toFixed(2) : ''}`;
    }
    const valid = info.heats.filter(h => h != null);
    const avgTotal = valid.length > 0 ? valid.reduce((a, b) => a + b, 0) / valid.length : 0;
    const wAvgs = (info.all_wave_avgs || []).filter(a => a > 0);
    const allWaveAvg = wAvgs.length > 0 ? wAvgs.reduce((a, b) => a + b, 0) / wAvgs.length : 0;
    const best = valid.length > 0 ? Math.max(...valid) : 0;
    const status = info.goal > 0 ? (best >= info.goal ? 'GOAL HIT' : 'In Progress') : '';
    csv += `,${avgTotal > 0 ? avgTotal.toFixed(2) : ''},${allWaveAvg > 0 ? allWaveAvg.toFixed(2) : ''},${info.goal > 0 ? info.goal.toFixed(1) : ''},${status}\n`;
  }
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `KSS_Session_Tracker_${new Date().toISOString().slice(0,10)}.csv`;
  a.click();
  URL.revokeObjectURL(url);
}

// Auto-update lock states periodically
setInterval(() => { if (currentView === 'judge') jmUpdateSequential(); }, 2000);

// ============================================================
// INIT
// ============================================================
(function init() {
  // Check for active session
  const s = DB.activeSession;
  if (s) {
    showView('session-hub');
  } else {
    renderHome();
  }
  
  // Service worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js').catch(e => console.log('SW error:', e));
  }
  
  // Close modal on overlay click
  document.querySelectorAll('.modal-overlay').forEach(m => {
    m.addEventListener('click', e => { if (e.target === m) m.classList.remove('active'); });
  });
})();
</script>
</body>
</html>
